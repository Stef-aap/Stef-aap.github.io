<html>
<head>
<title>Source file exported to file</title>
</head>
<!-- Generated by SynEdit HTML exporter -->
<body text="#000000" bgcolor="#FFFFFF">
<pre>
<code><font  size=3 face="Courier New"><font color="#808080"><i>-- -----------------------------------------------------------------------------
-- &lt;title JAL library for control of the ADS1211
-- &lt;License
-- freeware, under the terms of the GNU GPL
--  Copyright (C) 2002 Stef Mientki  
-- mailto:S.Mientki@mailbox.kun.nl
-- -----------------------------------------------------------------------------
-- &lt;Description
-- Library for the control of the ADS1211 
--     (4 channel, 24 bit ADC, 1 channel=16kHz, 4 channel=1kHz)
-- with slight modifications also usable for the ADS1210, ADS1212, ADS1213
--
-- Hardware settings should be done through a local copy of ADS1211_LIBS_INS
--
--
-- &lt;non-tag
-- procedures
--   ADS1211_reset      hardware reset, calibrate, set normal mode
--   ADS1211_calibrate  calibrate, set normal mode
--   ADS1211_sleep      put ADC in sleep
--   ADS1211_wakeup     wakeup ADC
--   ADS1211_read_cmd   read both command registers (debugging)
--   ADS1211_read_ADC_24  read 24 bits ADC value
--
-- Data is transported through the variable
--   ADS1211_dor = ADS1211_dor3 . ADS1211_dor2 . ADS1211_dor1
--
-- &lt;Version: 3.1    ,04-06-2004, Stef Mientki
--    - small improvements to the reset procedure
--		- 100 msec delay in reset replaced by wait for ready
-- 
-- &lt;Version: 3.0    ,07-03-2003, Stef Mientki
--    - Control through MSSP (besides USART) added
--		- pin names changed, so macro pin definitions can be used
--
-- &lt;Version: 2.0    ,25-02-2003, Stef Mientki
--    - Maximum SPI clockrate increased from Fin/5 to Fin/4
--
-- &lt;Version: 1.0    ,29-02-2002, Stef Mientki
--    - orginal release
--
-- -----------------------------------------------------------------------------
-- -----------------------------------------------------------------------------



-- -----------------------------------------------------------------------------
-- &lt;Example 
-- ------(comment is preceeded by '--', program code preceeded by ';'
-- -----------------------------------------------------------------------------
-- ;make local copy of ADS1211_LIBS_INS, edit paramaters, include in main program
;    include ADS1211_libs_ins
;
-- ;reset ADC (multiple SPI devices assumed, so CS must be controled)
;    CS_ADC0 = low
;    ADS1211_reset
;    CS_ADC0 = high
;
-- ;read a 24 bit ADC value into ADS1211_dor2 . ADS1211_dor1 . ADS1211_dor0
;    CS_DAC0 = low
;    ADS1211_read_ADC_24
;    CS_DAC0 = high
-- -----------------------------------------------------------------------------


-- &lt;code
-- -----------------------------------------------------------------------------
-- first test ADC clockfrequency
-- -----------------------------------------------------------------------------
</i></font><b>if </b><font color="#000080">ADS1211_Fin <b>&lt; </b></font><font color="#FF0000">1_200_000 </font><b>then
  </b><font color="#800080"><i>pragma </i></font><b>error   </b><font color="#808080"><i>-- clock frequency of ADC possible too low for this routines
                 -- especially t9 .. t11 and t15 should be checked
</i></font><b>end if
</b><font color="#808080"><i>-- -----------------------------------------------------------------------------



-- -----------------------------------------------------------------------------
-- test if SPI baudrate not too high
-- -----------------------------------------------------------------------------
</i></font><b>if </b><font color="#FF0000">baudrate </font><font color="#000080"><b>&gt; </b>ADS1211_Fin <b>/ </b></font><font color="#FF0000">4 </font><b>then
  </b><font color="#800080"><i>pragma </i></font><b>error   </b><font color="#808080"><i>-- Baudrate too high for the ADC clock frequency
</i></font><b>end if
</b><font color="#808080"><i>-- -----------------------------------------------------------------------------



-- general delay routines
</i></font><font color="#FF00FF">include delay_20Mc

</font><font color="#808080"><i>-- all SPI routines
</i></font><font color="#FF00FF">include rs232_hw
include master_sync_ser_port

</font><font color="#808080"><i>-- for reversing bits
</i></font><font color="#FF00FF">include bit_calcs


</font><font color="#808080"><i>-- definitions of the DATA registers, to be filled by the user
</i></font><b>var volatile byte </b><font color="#000080">ADS1211_dor3  </font><font color="#808080"><i>-- MSB
</i></font><b>var volatile byte </b><font color="#000080">ADS1211_dor2
</font><b>var volatile byte </b><font color="#000080">ADS1211_dor1  </font><font color="#808080"><i>-- LSB
</i></font><b>var volatile byte </b><font color="#000080">ADS1211_chan <b>= </b></font><font color="#FF0000">0

</font><font color="#808080"><i>-- 100 * Txin in [ usec], for calculating reset pulses
</i></font><b>const </b><font color="#000080">_ADS1211_Txin_100 <b>= ( </b></font><font color="#FF0000">100 </font><font color="#000080"><b>* </b></font><font color="#FF0000">1_000_000 </font><font color="#000080"><b>) / </b>ADS1211_Fin
</font><b>if </b><font color="#000080">_ADS1211_Txin_100 <b>!= </b></font><font color="#FF0000">10 </font><b>then
  </b><font color="#800080"><i>pragma </i></font><b>error
end if


</b><font color="#808080"><i>-- codes are NOT reversed
</i></font><b>const </b><font color="#000080">_ADS1211_mode_normal         <b>= </b></font><font color="#FF0000">0b_0000_0000
</font><b>const </b><font color="#000080">_ADS1211_mode_self_cal       <b>= </b></font><font color="#FF0000">0b_0010_0000
</font><b>const </b><font color="#000080">_ADS1211_mode_offset_cal     <b>= </b></font><font color="#FF0000">0b_0100_0000
</font><b>const </b><font color="#000080">_ADS1211_mode_gain_cal       <b>= </b></font><font color="#FF0000">0b_0110_0000
</font><b>const </b><font color="#000080">_ADS1211_mode_pseudo_cal     <b>= </b></font><font color="#FF0000">0b_1000_0000
</font><b>const </b><font color="#000080">_ADS1211_mode_background_cal <b>= </b></font><font color="#FF0000">0b_1010_0000
</font><b>const </b><font color="#000080">_ADS1211_mode_sleep          <b>= </b></font><font color="#FF0000">0b_1100_0000


</font><font color="#808080"><i>-- GAIN * TURBO &lt;= 16
-- Sample frequency, which determines the digital filter characteristic is geiven by
--   Fsamp = ( Fin * Turbo * Gain ) / 512
-- Data output rate is determined by
--   Fdata = ( Fin * Turbo ) / ( 512 * ( decimation + 1)

-- Because the full input amplitude range is needed, gain can't be used,
-- instead Turbo is used to increase bit accuracy for the high sample rates required

-- test of gain and turbo settings
</i></font><b>if </b><font color="#000080"><b>( </b>ADS1211_gain <b>* </b>ADS1211_turbo <b>) &gt; </b></font><font color="#FF0000">16 </font><b>then
  </b><font color="#800080"><i>pragma </i></font><b>error  </b><font color="#808080"><i>-- Gain * Turbo too high
</i></font><b>end if


if </b><font color="#000080"><b>!( ( </b>ADS1211_turbo <b>== </b></font><font color="#FF0000">1 </font><font color="#000080"><b>) | ( </b>ADS1211_turbo <b>== </b></font><font color="#FF0000">2 </font><font color="#000080"><b>) | ( </b>ADS1211_turbo <b>== </b></font><font color="#FF0000">4 </font><font color="#000080"><b>) |
      ( </b>ADS1211_turbo <b>== </b></font><font color="#FF0000">8 </font><font color="#000080"><b>) | ( </b>ADS1211_turbo <b>== </b></font><font color="#FF0000">16 </font><font color="#000080"><b>) ) </b></font><b>then
  </b><font color="#800080"><i>pragma </i></font><b>error  </b><font color="#808080"><i>-- Turbo ratio must be an element of 1, 2, 4, 8, 16
</i></font><b>end if


if </b><font color="#000080"><b>!( ( </b>ADS1211_gain <b>== </b></font><font color="#FF0000">1 </font><font color="#000080"><b>) | ( </b>ADS1211_gain <b>== </b></font><font color="#FF0000">2 </font><font color="#000080"><b>) | ( </b>ADS1211_gain <b>== </b></font><font color="#FF0000">4 </font><font color="#000080"><b>) |
      ( </b>ADS1211_gain <b>== </b></font><font color="#FF0000">8 </font><font color="#000080"><b>) | ( </b>ADS1211_gain <b>== </b></font><font color="#FF0000">16 </font><font color="#000080"><b>) ) </b></font><b>then
  </b><font color="#800080"><i>pragma </i></font><b>error  </b><font color="#808080"><i>-- Gain must be an element of 1, 2, 4, 8, 16
</i></font><b>end if



</b><font color="#808080"><i>-- now define the gain, translated and shifted but NOT reversed
</i></font><b>var byte </b><font color="#000080">_ADS1211_gain
</font><b>if    </b><font color="#000080">ADS1211_gain <b>== </b></font><font color="#FF0000">1 </font><b>then </b><font color="#000080">_ADS1211_gain <b>= </b></font><font color="#FF0000">0b_000_000_00
</font><b>elsif </b><font color="#000080">ADS1211_gain <b>== </b></font><font color="#FF0000">2 </font><b>then </b><font color="#000080">_ADS1211_gain <b>= </b></font><font color="#FF0000">0b_000_001_00
</font><b>elsif </b><font color="#000080">ADS1211_gain <b>== </b></font><font color="#FF0000">4 </font><b>then </b><font color="#000080">_ADS1211_gain <b>= </b></font><font color="#FF0000">0b_000_010_00
</font><b>elsif </b><font color="#000080">ADS1211_gain <b>== </b></font><font color="#FF0000">8 </font><b>then </b><font color="#000080">_ADS1211_gain <b>= </b></font><font color="#FF0000">0b_000_011_00
</font><b>else                         </b><font color="#000080">_ADS1211_gain <b>= </b></font><font color="#FF0000">0b_000_100_00
</font><b>end if

</b><font color="#808080"><i>-- calculation of the decimation ratio
</i></font><b>const </b><font color="#000080">_ADS1211_decimation <b>= ( ( </b>ADS1211_Fin <b>* </b>ADS1211_turbo <b>) /
                              ( </b></font><font color="#FF0000">512 </font><font color="#000080"><b>* </b>ADS1211_Fdata <b>* </b>ADS1211_Nchan <b>* </b>ADS1211_NchanX <b>)
                            ) - </b></font><font color="#FF0000">1

</font><b>const </b><font color="#000080">_ADS1211_decimation_1000 <b>= ( ( </b>ADS1211_Fin <b>* </b>ADS1211_turbo <b>) /
                                   ( </b></font><font color="#FF0000">512 </font><font color="#000080"><b>* </b></font><font color="#FF0000">975 </font><font color="#000080"><b>* </b>ADS1211_Nchan <b>* </b>ADS1211_NchanX <b>)
                                 ) - </b></font><font color="#FF0000">1
</font><b>const </b><font color="#000080">_ADS1211_decimation_500  <b>= ( ( </b>ADS1211_Fin <b>* </b>ADS1211_turbo <b>) /
                                   ( </b></font><font color="#FF0000">512 </font><font color="#000080"><b>* </b></font><font color="#FF0000">500 </font><font color="#000080"><b>* </b>ADS1211_Nchan <b>* </b>ADS1211_NchanX <b>)
                                 ) - </b></font><font color="#FF0000">1
</font><b>const </b><font color="#000080">_ADS1211_decimation_200  <b>= ( ( </b>ADS1211_Fin <b>* </b>ADS1211_turbo <b>) /
                                   ( </b></font><font color="#FF0000">512 </font><font color="#000080"><b>* </b></font><font color="#FF0000">200 </font><font color="#000080"><b>* </b>ADS1211_Nchan <b>* </b>ADS1211_NchanX <b>)
                                 ) - </b></font><font color="#FF0000">1
</font><b>const </b><font color="#000080">_ADS1211_decimation_100  <b>= ( ( </b>ADS1211_Fin <b>* </b>ADS1211_turbo <b>) /
                                   ( </b></font><font color="#FF0000">512 </font><font color="#000080"><b>* </b></font><font color="#FF0000">100 </font><font color="#000080"><b>* </b>ADS1211_Nchan <b>* </b>ADS1211_NchanX <b>)
                                 ) - </b></font><font color="#FF0000">1
</font><b>const </b><font color="#000080">_ADS1211_decimation_50   <b>= ( ( </b>ADS1211_Fin <b>* </b>ADS1211_turbo <b>) /
                                   ( </b></font><font color="#FF0000">512 </font><font color="#000080"><b>* </b></font><font color="#FF0000">50 </font><font color="#000080"><b>* </b>ADS1211_Nchan <b>* </b>ADS1211_NchanX <b>)
                                 ) - </b></font><font color="#FF0000">1
</font><b>const </b><font color="#000080">_ADS1211_decimation_20   <b>= ( ( </b>ADS1211_Fin <b>* </b>ADS1211_turbo <b>) /
                                   ( </b></font><font color="#FF0000">512 </font><font color="#000080"><b>* </b></font><font color="#FF0000">20 </font><font color="#000080"><b>* </b>ADS1211_Nchan <b>* </b>ADS1211_NchanX <b>)
                                 ) - </b></font><font color="#FF0000">1
</font><b>const </b><font color="#000080">_ADS1211_decimation_10   <b>= ( ( </b>ADS1211_Fin <b>* </b>ADS1211_turbo <b>) /
                                   ( </b></font><font color="#FF0000">512 </font><font color="#000080"><b>* </b></font><font color="#FF0000">10 </font><font color="#000080"><b>* </b>ADS1211_Nchan <b>* </b>ADS1211_NchanX <b>)
                                 ) - </b></font><font color="#FF0000">1
</font><b>const </b><font color="#000080">_ADS1211_decimation_5    <b>= ( ( </b>ADS1211_Fin <b>* </b>ADS1211_turbo <b>) /
                                   ( </b></font><font color="#FF0000">512 </font><font color="#000080"><b>* </b></font><font color="#FF0000">5 </font><font color="#000080"><b>* </b>ADS1211_Nchan <b>* </b>ADS1211_NchanX <b>)
                                 ) - </b></font><font color="#FF0000">1


</font><b>var byte </b><font color="#000080">_ADS1211_dcr0
</font><b>var byte </b><font color="#000080">_ADS1211_dcr1
</font><b>var byte </b><font color="#000080">_ADS1211_cmd2       </font><font color="#808080"><i>-- CMD2 = Mode + Gain + channel


</i></font><b>if </b><font color="#000080">_ADS1211_decimation <b>&gt; </b></font><font color="#FF0000">8000 </font><b>then
  </b><font color="#800080"><i>pragma </i></font><b>error  </b><font color="#808080"><i>-- decimation ratio is too high
</i></font><b>elsif </b><font color="#000080">_ADS1211_decimation <b>&lt; </b></font><font color="#FF0000">19 </font><b>then
  </b><font color="#800080"><i>pragma </i></font><b>error  </b><font color="#808080"><i>-- decimation ratio is too low
</i></font><b>else
  </b><font color="#000080">_ADS1211_dcr1 <b>= </b>_ADS1211_decimation <b>/ </b></font><font color="#FF0000">256
  </font><font color="#000080">_ADS1211_dcr0 <b>= </b>_ADS1211_decimation <b>- </b></font><font color="#FF0000">256 </font><font color="#000080"><b>* ( </b>_ADS1211_decimation <b>/ </b></font><font color="#FF0000">256 </font><font color="#000080"><b>)
</b></font><b>end if


</b><font color="#808080"><i>;-- Turbo mode must be added to dcr1 to form CMR1
;if ADS1211_turbo == 1 then
;elsif ADS1211_turbo == 2 then
;  _ADS1211_dcr1 = _ADS1211_dcr1 | 0b_001_00000
;elsif ADS1211_turbo == 4 then
;  _ADS1211_dcr1 = _ADS1211_dcr1 | 0b_010_00000
;elsif ADS1211_turbo == 8 then
;  _ADS1211_dcr1 = _ADS1211_dcr1 | 0b_011_00000
;else
;  _ADS1211_dcr1 = _ADS1211_dcr1 | 0b_100_00000
;end if
;
;-- bits must be reversed if USART is used
;if ADS1211_spi_usart then
;  reverse_bits (_ADS1211_dcr1)
;  reverse_bits (_ADS1211_dcr0)
;end if


-- -----------------------------------------------------------------------------
-- -----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">_ADS1211_set_frequency <b>(</b></font><b>byte in </b><font color="#000080">freq<b>) </b></font><b>is
</b><font color="#C0C0C0">	</font><b>if </b><font color="#000080">ADS1211_turbo <b>== </b></font><font color="#FF0000">1 </font><b>then
</b><font color="#C0C0C0">	</font><b>elsif </b><font color="#000080">ADS1211_turbo <b>== </b></font><font color="#FF0000">2 </font><b>then
</b><font color="#C0C0C0">	  </font><font color="#000080">_ADS1211_dcr1 <b>= </b></font><font color="#FF0000">0b_001_00000
</font><font color="#C0C0C0">	</font><b>elsif </b><font color="#000080">ADS1211_turbo <b>== </b></font><font color="#FF0000">4 </font><b>then
</b><font color="#C0C0C0">	  </font><font color="#000080">_ADS1211_dcr1 <b>= </b></font><font color="#FF0000">0b_010_00000
</font><font color="#C0C0C0">	</font><b>elsif </b><font color="#000080">ADS1211_turbo <b>== </b></font><font color="#FF0000">8 </font><b>then
</b><font color="#C0C0C0">	  </font><font color="#000080">_ADS1211_dcr1 <b>= </b></font><font color="#FF0000">0b_011_00000
</font><font color="#C0C0C0">	</font><b>else
</b><font color="#C0C0C0">	  </font><font color="#000080">_ADS1211_dcr1 <b>= </b></font><font color="#FF0000">0b_100_00000
</font><font color="#C0C0C0">	</font><b>end if

  if    </b><font color="#000080">freq <b>== </b></font><font color="#FF0000">0 </font><b>then  </b><font color="#808080"><i>-- default
    </i></font><font color="#000080">_ADS1211_dcr1 <b>= </b>_ADS1211_dcr1 <b>| (</b>_ADS1211_decimation <b>/ </b></font><font color="#FF0000">256</font><font color="#000080"><b>)
    </b>_ADS1211_dcr0 <b>= </b>_ADS1211_decimation
</font><font color="#C0C0C0">	</font><b>elsif </b><font color="#000080">freq <b>== </b></font><font color="#FF0000">1 </font><b>then  </b><font color="#808080"><i>-- 5 Hz
    </i></font><font color="#000080">_ADS1211_dcr1 <b>= </b>_ADS1211_dcr1 <b>| (</b>_ADS1211_decimation_5 <b>/ </b></font><font color="#FF0000">256</font><font color="#000080"><b>)
    </b>_ADS1211_dcr0 <b>= </b>_ADS1211_decimation_5
</font><font color="#C0C0C0">	</font><b>elsif </b><font color="#000080">freq <b>== </b></font><font color="#FF0000">2 </font><b>then  </b><font color="#808080"><i>-- 10 Hz
    </i></font><font color="#000080">_ADS1211_dcr1 <b>= </b>_ADS1211_dcr1 <b>| (</b>_ADS1211_decimation_10 <b>/ </b></font><font color="#FF0000">256</font><font color="#000080"><b>)
    </b>_ADS1211_dcr0 <b>= </b>_ADS1211_decimation_10
</font><font color="#C0C0C0">	</font><b>elsif </b><font color="#000080">freq <b>== </b></font><font color="#FF0000">3 </font><b>then  </b><font color="#808080"><i>-- 20 Hz
    </i></font><font color="#000080">_ADS1211_dcr1 <b>= </b>_ADS1211_dcr1 <b>| (</b>_ADS1211_decimation_20 <b>/ </b></font><font color="#FF0000">256</font><font color="#000080"><b>)
    </b>_ADS1211_dcr0 <b>= </b>_ADS1211_decimation_20
</font><font color="#C0C0C0">	</font><b>elsif </b><font color="#000080">freq <b>== </b></font><font color="#FF0000">4 </font><b>then  </b><font color="#808080"><i>-- 50 Hz
    </i></font><font color="#000080">_ADS1211_dcr1 <b>= </b>_ADS1211_dcr1 <b>| (</b>_ADS1211_decimation_50 <b>/ </b></font><font color="#FF0000">256</font><font color="#000080"><b>)
    </b>_ADS1211_dcr0 <b>= </b>_ADS1211_decimation_50
</font><font color="#C0C0C0">	</font><b>elsif </b><font color="#000080">freq <b>== </b></font><font color="#FF0000">5 </font><b>then  </b><font color="#808080"><i>-- 100 Hz
    </i></font><font color="#000080">_ADS1211_dcr1 <b>= </b>_ADS1211_dcr1 <b>| (</b>_ADS1211_decimation_100 <b>/ </b></font><font color="#FF0000">256</font><font color="#000080"><b>)
    </b>_ADS1211_dcr0 <b>= </b>_ADS1211_decimation_100
</font><font color="#C0C0C0">	</font><b>elsif </b><font color="#000080">freq <b>== </b></font><font color="#FF0000">6 </font><b>then  </b><font color="#808080"><i>-- 200 Hz
    </i></font><font color="#000080">_ADS1211_dcr1 <b>= </b>_ADS1211_dcr1 <b>| (</b>_ADS1211_decimation_200 <b>/ </b></font><font color="#FF0000">256</font><font color="#000080"><b>)
    </b>_ADS1211_dcr0 <b>= </b>_ADS1211_decimation_200
</font><font color="#C0C0C0">	</font><b>elsif </b><font color="#000080">freq <b>== </b></font><font color="#FF0000">7 </font><b>then  </b><font color="#808080"><i>-- 500 Hz
    </i></font><font color="#000080">_ADS1211_dcr1 <b>= </b>_ADS1211_dcr1 <b>| (</b>_ADS1211_decimation_500 <b>/ </b></font><font color="#FF0000">256</font><font color="#000080"><b>)
    </b>_ADS1211_dcr0 <b>= </b>_ADS1211_decimation_500
</font><font color="#C0C0C0">	</font><b>else </b><font color="#808080"><i>-- freq == 8     -- 1000 Hz
    </i></font><font color="#000080">_ADS1211_dcr1 <b>= </b>_ADS1211_dcr1 <b>| (</b>_ADS1211_decimation_1000 <b>/ </b></font><font color="#FF0000">256</font><font color="#000080"><b>)
    </b>_ADS1211_dcr0 <b>= </b>_ADS1211_decimation_1000
  </font><b>end if

</b><font color="#C0C0C0">	</font><font color="#808080"><i>-- bits must be reversed if USART is used
</i></font><font color="#C0C0C0">	</font><b>if </b><font color="#000080">ADS1211_spi_usart </font><b>then
</b><font color="#C0C0C0">	  </font><font color="#000080">reverse_bits <b>(</b>_ADS1211_dcr1<b>)
</b></font><font color="#C0C0C0">	  </font><font color="#000080">reverse_bits <b>(</b>_ADS1211_dcr0<b>)
</b></font><font color="#C0C0C0">	</font><b>end if

end procedure
</b><font color="#808080"><i>-- -----------------------------------------------------------------------------


-- ADS1211, first MSB downto LSB
-- that's opposite to Tx of 16F628
-- so for all commands all bits must be swapped

-- INSTRUCTION REGISTER non reversed                          (nr of bytes)
</i></font><b>const byte </b><font color="#000080">_ADS1211_ins_read_data_24        <b>= </b></font><font color="#FF0000">0b_1100_0000  </font><font color="#808080"><i>-- (3) 
</i></font><b>const byte </b><font color="#000080">_ADS1211_ins_read_cmd            <b>= </b></font><font color="#FF0000">0b_1110_0100  </font><font color="#808080"><i>-- (4) 
</i></font><b>const byte </b><font color="#000080">_ADS1211_ins_read_cmr1           <b>= </b></font><font color="#FF0000">0b_1000_0100  </font><font color="#808080"><i>-- (1) 
</i></font><b>const byte </b><font color="#000080">_ADS1211_ins_read_offset_cal     <b>= </b></font><font color="#FF0000">0b_1100_1000  </font><font color="#808080"><i>-- (3) 
</i></font><b>const byte </b><font color="#000080">_ADS1211_ins_read_fullscale_cal  <b>= </b></font><font color="#FF0000">0b_1100_1100  </font><font color="#808080"><i>-- (3) 

</i></font><b>const byte </b><font color="#000080">_ADS1211_ins_write_data          <b>= </b></font><font color="#FF0000">0b_0100_0000  </font><font color="#808080"><i>-- (3) 
</i></font><b>const byte </b><font color="#000080">_ADS1211_ins_write_cmd           <b>= </b></font><font color="#FF0000">0b_0110_0100  </font><font color="#808080"><i>-- (4) 
</i></font><b>const byte </b><font color="#000080">_ADS1211_ins_write_cmd2          <b>= </b></font><font color="#FF0000">0b_0000_0101  </font><font color="#808080"><i>-- (1) 
</i></font><b>const byte </b><font color="#000080">_ADS1211_ins_write_offset_cal    <b>= </b></font><font color="#FF0000">0b_0100_1000  </font><font color="#808080"><i>-- (3) 
</i></font><b>const byte </b><font color="#000080">_ADS1211_ins_write_fullscale_cal <b>= </b></font><font color="#FF0000">0b_0100_1100  </font><font color="#808080"><i>-- (3) 

-- INSTRUCTION REGISTER reversed                              (nr of bytes)
</i></font><b>const byte </b><font color="#000080">__ADS1211_ins_read_data_24        <b>= </b></font><font color="#FF0000">0b_0000_0011  </font><font color="#808080"><i>-- (3) 0b_1100_0000
</i></font><b>const byte </b><font color="#000080">__ADS1211_ins_read_offset_cal     <b>= </b></font><font color="#FF0000">0b_0001_0011  </font><font color="#808080"><i>-- (3) 0b_1100_1000
</i></font><b>const byte </b><font color="#000080">__ADS1211_ins_read_fullscale_cal  <b>= </b></font><font color="#FF0000">0b_0011_0011  </font><font color="#808080"><i>-- (3) 0b_1100_1100

</i></font><b>const byte </b><font color="#000080">__ADS1211_ins_write_cmd           <b>= </b></font><font color="#FF0000">0b_0010_0110  </font><font color="#808080"><i>-- (4) 0b_0110_0100
</i></font><b>const byte </b><font color="#000080">__ADS1211_ins_write_cmd2          <b>= </b></font><font color="#FF0000">0b_1010_0000  </font><font color="#808080"><i>-- (1) 0b_0000_0101

-- Command Register 1 (NOT reversed)
-- the defaults are described
</i></font><b>const byte </b><font color="#000080">_ADS1211_cmr1_bias <b>= </b></font><font color="#FF0000">0b_1000_0000  </font><font color="#808080"><i>-- Bias, false = off
</i></font><b>const byte </b><font color="#000080">_ADS1211_cmr1_REF0 <b>= </b></font><font color="#FF0000">0b_0100_0000  </font><font color="#808080"><i>-- REF0, true = on
</i></font><b>const byte </b><font color="#000080">_ADS1211_cmr1_DF2s <b>= </b></font><font color="#FF0000">0b_0010_0000  </font><font color="#808080"><i>-- Data Format, false = 2's complement
</i></font><b>const byte </b><font color="#000080">_ADS1211_cmr1_unip <b>= </b></font><font color="#FF0000">0b_0001_0000  </font><font color="#808080"><i>-- Input Range, false = bipolar
</i></font><b>const byte </b><font color="#000080">_ADS1211_cmr1_BD   <b>= </b></font><font color="#FF0000">0b_0000_1000  </font><font color="#808080"><i>-- Byte Order, false = MSB first
</i></font><b>const byte </b><font color="#000080">_ADS1211_cmr1_msb  <b>= </b></font><font color="#FF0000">0b_0000_0100  </font><font color="#808080"><i>-- Bit Order, false = msb first
</i></font><b>const byte </b><font color="#000080">_ADS1211_cmr1_SDl  <b>= </b></font><font color="#FF0000">0b_0000_0010  </font><font color="#808080"><i>-- Data Output, false = SDIO

-- Here command register 1 is constructed from the user settings
</i></font><b>var volatile byte </b><font color="#000080">_ADS1211_cmr1 <b>= </b></font><font color="#FF0000">0
</font><b>if </b><font color="#000080">ADS1211_bias     </font><b>then </b><font color="#000080">_ADS1211_cmr1 <b>= </b>_ADS1211_cmr1 <b>| </b>_ADS1211_cmr1_bias </font><b>end if
if </b><font color="#000080">ADS1211_REF0     </font><b>then </b><font color="#000080">_ADS1211_cmr1 <b>= </b>_ADS1211_cmr1 <b>| </b>_ADS1211_cmr1_REF0 </font><b>end if
if </b><font color="#000080">ADS1211_offset_binary
                    </font><b>then </b><font color="#000080">_ADS1211_cmr1 <b>= </b>_ADS1211_cmr1 <b>| </b>_ADS1211_cmr1_DF2s </font><b>end if
if </b><font color="#000080">ADS1211_unipolar </font><b>then </b><font color="#000080">_ADS1211_cmr1 <b>= </b>_ADS1211_cmr1 <b>| </b>_ADS1211_cmr1_unip </font><b>end if
if </b><font color="#000080">ADS1211_LSByte   </font><b>then </b><font color="#000080">_ADS1211_cmr1 <b>= </b>_ADS1211_cmr1 <b>| </b>_ADS1211_cmr1_BD   </font><b>end if
if </b><font color="#000080">ADS1211_lsbit    </font><b>then </b><font color="#000080">_ADS1211_cmr1 <b>= </b>_ADS1211_cmr1 <b>| </b>_ADS1211_cmr1_msb  </font><b>end if
if </b><font color="#000080">ADS1211_SDOUT    </font><b>then </b><font color="#000080">_ADS1211_cmr1 <b>= </b>_ADS1211_cmr1 <b>| </b>_ADS1211_cmr1_SDl  </font><b>end if

if </b><font color="#000080">ADS1211_spi_usart </font><b>then
  </b><font color="#000080">reverse_bits <b>(</b>_ADS1211_cmr1<b>)
</b></font><b>end if


</b><font color="#808080"><i>-- -----------------------------------------------------------------------------
-- wait till rdy signal goes from high to low
-- so read and other commands can be synchronized
-- -----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">ADS1211_wait_for_ready </font><b>is
  while </b><font color="#000080"><b>! </b>ADS1211_RDY_pin </font><b>loop end loop
  while </b><font color="#000080">ADS1211_RDY_pin </font><b>loop end loop
end procedure
</b><font color="#808080"><i>-- -----------------------------------------------------------------------------



-- -----------------------------------------------------------------------------
-- Read 24 bits DAC value into ADS1211_dor
-- and setups next channel
-- -----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">ADS1211_set_chan <b>( </b></font><b>byte in </b><font color="#000080">chan <b>) </b></font><b>is
  </b><font color="#000080">_ADS1211_cmd2 <b>= </b>_ADS1211_mode_normal <b>| </b>_ADS1211_gain <b>| </b>chan
  </font><b>if </b><font color="#000080">ADS1211_spi_usart </font><b>then
    </b><font color="#000080">reverse_bits <b>(</b>_ADS1211_cmd2<b>)
    </b>spi_send_hw <b>( </b>__ADS1211_ins_write_cmd2 <b>)
    </b>spi_send_hw <b>( </b>_ADS1211_cmd2 <b>)
  </b></font><b>else
    </b><font color="#000080">spi_send_mssp <b>( </b>_ADS1211_ins_write_cmd2 <b>)
    </b>spi_send_mssp <b>( </b>_ADS1211_cmd2 <b>)
    </b>spi_mssp_wait_until_ready
  </font><b>end if
end procedure
</b><font color="#808080"><i>-- -----------------------------------------------------------------------------


-- -----------------------------------------------------------------------------
-- Read 24 bits DAC value into ADS1211_dor
-- and setups next channel
-- all done in reversed order without waiting,
-- so this will only yield valid results
-- if SPI communication is faster than RDY pulse
-- -----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">ADS1211_read_ADC_24_and_nextchan_fast <b>( </b></font><b>byte in </b><font color="#000080">chan <b>) </b></font><b>is
  if </b><font color="#000080">ADS1211_CS_used </font><b>then
    </b><font color="#800080"><i>pragma </i></font><b>error   </b><font color="#808080"><i>-- if CS used, multiple commands aren't allowed
  </i></font><b>end if
  
  </b><font color="#808080"><i>-- first setup the next channel
  </i></font><font color="#000080">_ADS1211_cmd2 <b>= </b>_ADS1211_mode_normal <b>| </b>_ADS1211_gain <b>| </b>chan
  </font><b>if </b><font color="#000080">ADS1211_spi_usart </font><b>then
    </b><font color="#000080">reverse_bits <b>(</b>_ADS1211_cmd2<b>)
</b></font><font color="#C0C0C0">	  </font><font color="#000080">spi_send_hw <b>( </b>__ADS1211_ins_write_cmd2 <b>)
</b></font><font color="#C0C0C0">	  </font><font color="#000080">spi_send_hw <b>( </b>_ADS1211_cmd2 <b>)
</b></font><font color="#C0C0C0">	
	  </font><font color="#808080"><i>-- then read sampled data
</i></font><font color="#C0C0C0">	  </font><font color="#000080">spi_send_hw <b>( </b>__ADS1211_ins_read_data_24 <b>)
</b></font><font color="#C0C0C0">	  </font><font color="#000080">spi_read_hw <b>( </b>ADS1211_dor3 <b>)
</b></font><font color="#C0C0C0">	  </font><font color="#000080">spi_read_hw <b>( </b>ADS1211_dor2 <b>)
</b></font><font color="#C0C0C0">	  </font><font color="#000080">spi_read_hw <b>( </b>ADS1211_dor1 <b>)
  </b></font><b>else
</b><font color="#C0C0C0">	  </font><font color="#000080">spi_send_mssp <b>( </b>_ADS1211_ins_write_cmd2 <b>)
</b></font><font color="#C0C0C0">	  </font><font color="#000080">spi_send_mssp <b>( </b>_ADS1211_cmd2 <b>)
</b></font><font color="#C0C0C0">	
	  </font><font color="#808080"><i>-- then read sampled data
</i></font><font color="#C0C0C0">	  </font><font color="#000080">spi_send_mssp <b>( </b>_ADS1211_ins_read_data_24 <b>)
</b></font><font color="#C0C0C0">	  </font><font color="#000080">spi_read_mssp <b>( </b>ADS1211_dor3 <b>)
</b></font><font color="#C0C0C0">	  </font><font color="#000080">spi_read_mssp <b>( </b>ADS1211_dor2 <b>)
</b></font><font color="#C0C0C0">	  </font><font color="#000080">spi_read_mssp <b>( </b>ADS1211_dor1 <b>)
    </b>spi_mssp_wait_until_ready
  </font><b>end if
end procedure
</b><font color="#808080"><i>-- -----------------------------------------------------------------------------




-- -----------------------------------------------------------------------------
-- Read 24 bits DAC value into ADS1211_dor
-- -----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">ADS1211_read_ADC_24 </font><b>is
  if </b><font color="#000080">ADS1211_spi_usart </font><b>then
</b><font color="#C0C0C0">	  </font><font color="#000080">spi_send_hw <b>( </b>__ADS1211_ins_read_data_24 <b>)
</b></font><font color="#C0C0C0">	  </font><font color="#000080">spi_read_hw <b>( </b>ADS1211_dor3 <b>)
</b></font><font color="#C0C0C0">	  </font><font color="#000080">spi_read_hw <b>( </b>ADS1211_dor2 <b>)
</b></font><font color="#C0C0C0">	  </font><font color="#000080">spi_read_hw <b>( </b>ADS1211_dor1 <b>)
</b></font><font color="#C0C0C0">	</font><b>else
</b><font color="#C0C0C0">	  </font><font color="#000080">spi_send_mssp <b>( </b>_ADS1211_ins_read_data_24 <b>)
</b></font><font color="#C0C0C0">	  </font><font color="#000080">spi_read_mssp <b>( </b>ADS1211_dor3 <b>)
</b></font><font color="#C0C0C0">	  </font><font color="#000080">spi_read_mssp <b>( </b>ADS1211_dor2 <b>)
</b></font><font color="#C0C0C0">	  </font><font color="#000080">spi_read_mssp <b>( </b>ADS1211_dor1 <b>)
    </b>spi_mssp_wait_until_ready
</font><font color="#C0C0C0">	</font><b>end if
end procedure
</b><font color="#808080"><i>-- -----------------------------------------------------------------------------



-- -----------------------------------------------------------------------------
-- Read Offset Calibration Registers
-- -----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">ADS1211_read_OCR </font><b>is
  if </b><font color="#000080">ADS1211_spi_usart </font><b>then
</b><font color="#C0C0C0">	  </font><font color="#000080">spi_send_hw <b>( </b>__ADS1211_ins_read_offset_cal <b>)
</b></font><font color="#C0C0C0">	  </font><font color="#000080">spi_read_hw <b>( </b>ADS1211_dor3 <b>)
</b></font><font color="#C0C0C0">	  </font><font color="#000080">spi_read_hw <b>( </b>ADS1211_dor2 <b>)
</b></font><font color="#C0C0C0">	  </font><font color="#000080">spi_read_hw <b>( </b>ADS1211_dor1 <b>)
</b></font><font color="#C0C0C0">	</font><b>else
</b><font color="#C0C0C0">	  </font><font color="#000080">spi_send_mssp <b>( </b>_ADS1211_ins_read_offset_cal <b>)
</b></font><font color="#C0C0C0">	  </font><font color="#000080">spi_read_mssp <b>( </b>ADS1211_dor3 <b>)
</b></font><font color="#C0C0C0">	  </font><font color="#000080">spi_read_mssp <b>( </b>ADS1211_dor2 <b>)
</b></font><font color="#C0C0C0">	  </font><font color="#000080">spi_read_mssp <b>( </b>ADS1211_dor1 <b>)
    </b>spi_mssp_wait_until_ready
</font><font color="#C0C0C0">	</font><b>end if
end procedure
</b><font color="#808080"><i>-- -----------------------------------------------------------------------------



-- -----------------------------------------------------------------------------
-- Read FullScale Calibration Registers
-- -----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">ADS1211_read_FCR </font><b>is
  if </b><font color="#000080">ADS1211_spi_usart </font><b>then
</b><font color="#C0C0C0">	  </font><font color="#000080">spi_send_hw <b>( </b>__ADS1211_ins_read_fullscale_cal <b>)
</b></font><font color="#C0C0C0">	  </font><font color="#000080">spi_read_hw <b>( </b>ADS1211_dor3 <b>)
</b></font><font color="#C0C0C0">	  </font><font color="#000080">spi_read_hw <b>( </b>ADS1211_dor2 <b>)
</b></font><font color="#C0C0C0">	  </font><font color="#000080">spi_read_hw <b>( </b>ADS1211_dor1 <b>)
</b></font><font color="#C0C0C0">	</font><b>else
</b><font color="#C0C0C0">	  </font><font color="#000080">spi_send_mssp <b>( </b>_ADS1211_ins_read_fullscale_cal <b>)
</b></font><font color="#C0C0C0">	  </font><font color="#000080">spi_read_mssp <b>( </b>ADS1211_dor3 <b>)
</b></font><font color="#C0C0C0">	  </font><font color="#000080">spi_read_mssp <b>( </b>ADS1211_dor2 <b>)
</b></font><font color="#C0C0C0">	  </font><font color="#000080">spi_read_mssp <b>( </b>ADS1211_dor1 <b>)
    </b>spi_mssp_wait_until_ready
</font><font color="#C0C0C0">	</font><b>end if
end procedure
</b><font color="#808080"><i>-- -----------------------------------------------------------------------------



-- -----------------------------------------------------------------------------
-- wake up ADC en set into normal mode
-- -----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">ADS1211_wakeup </font><b>is
  </b><font color="#000080">_ADS1211_cmd2 <b>= </b>_ADS1211_mode_normal <b>| </b>_ADS1211_gain
  </font><b>if </b><font color="#000080">ADS1211_spi_usart </font><b>then
    </b><font color="#000080">reverse_bits <b>(</b>_ADS1211_cmd2<b>)
    </b>spi_send_hw <b>( </b>__ADS1211_ins_write_cmd2 <b>)
    </b>spi_send_hw <b>( </b>_ADS1211_cmd2 <b>)
  </b></font><b>else
    </b><font color="#000080">spi_send_mssp <b>( </b>_ADS1211_ins_write_cmd2 <b>)
    </b>spi_send_mssp <b>( </b>_ADS1211_cmd2 <b>)
    </b>spi_mssp_wait_until_ready
  </font><b>end if
end procedure
</b><font color="#808080"><i>-- -----------------------------------------------------------------------------



-- -----------------------------------------------------------------------------
-- put ADC into sleep mode
-- -----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">ADS1211_sleep </font><b>is
  </b><font color="#000080">_ADS1211_cmd2 <b>= </b>_ADS1211_mode_normal <b>| </b>_ADS1211_gain
  </font><b>if </b><font color="#000080">ADS1211_spi_usart </font><b>then
    </b><font color="#000080">reverse_bits <b>(</b>_ADS1211_cmd2<b>)
</b></font><font color="#C0C0C0">	  </font><font color="#000080">spi_send_hw <b>( </b>__ADS1211_ins_write_cmd2 <b>)
</b></font><font color="#C0C0C0">	  </font><font color="#000080">spi_send_hw <b>( </b>_ADS1211_cmd2 <b>)
</b></font><font color="#C0C0C0">	</font><b>else
</b><font color="#C0C0C0">	  </font><font color="#000080">spi_send_mssp <b>( </b>_ADS1211_ins_write_cmd2 <b>)
</b></font><font color="#C0C0C0">	  </font><font color="#000080">spi_send_mssp <b>( </b>_ADS1211_cmd2 <b>)
    </b>spi_mssp_wait_until_ready
</font><font color="#C0C0C0">	</font><b>end if
end procedure
</b><font color="#808080"><i>-- -----------------------------------------------------------------------------



-- -----------------------------------------------------------------------------
-- Starts the calibration cycle (and transports complete command register)
-- wait until ready,
-- then normal mode is automatically set, starting at channel ADS1211_chan
-- -----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">ADS1211_settings </font><b>is
  </b><font color="#808080"><i>-- and define the normal mode
  </i></font><font color="#000080">_ADS1211_cmd2 <b>= </b>_ADS1211_mode_normal <b>| </b>_ADS1211_gain <b>| </b>ADS1211_chan
  </font><b>if </b><font color="#000080">ADS1211_spi_usart </font><b>then
    </b><font color="#000080">reverse_bits <b>(</b>_ADS1211_cmd2<b>)
</b></font><font color="#C0C0C0">	  </font><font color="#000080">spi_send_hw <b>( </b>__ADS1211_ins_write_cmd <b>)
</b></font><font color="#C0C0C0">	  </font><font color="#000080">spi_send_hw <b>( </b>_ADS1211_cmr1 <b>)
</b></font><font color="#C0C0C0">	  </font><font color="#000080">spi_send_hw <b>( </b>_ADS1211_cmd2 <b>)
</b></font><font color="#C0C0C0">	  </font><font color="#000080">spi_send_hw <b>( </b>_ADS1211_dcr1 <b>)    </b></font><font color="#808080"><i>-- contains Turbo and MSB of decimation
</i></font><font color="#C0C0C0">	  </font><font color="#000080">spi_send_hw <b>( </b>_ADS1211_dcr0 <b>)    </b></font><font color="#808080"><i>-- contains           LSB of decimation
  </i></font><b>else
</b><font color="#C0C0C0">	  </font><font color="#000080">spi_send_mssp <b>( </b>_ADS1211_ins_write_cmd <b>)
</b></font><font color="#C0C0C0">	  </font><font color="#000080">spi_send_mssp <b>( </b>_ADS1211_cmr1 <b>)
</b></font><font color="#C0C0C0">	  </font><font color="#000080">spi_send_mssp <b>( </b>_ADS1211_cmd2 <b>)
</b></font><font color="#C0C0C0">	  </font><font color="#000080">spi_send_mssp <b>( </b>_ADS1211_dcr1 <b>)    </b></font><font color="#808080"><i>-- contains Turbo and MSB of decimation
</i></font><font color="#C0C0C0">	  </font><font color="#000080">spi_send_mssp <b>( </b>_ADS1211_dcr0 <b>)    </b></font><font color="#808080"><i>-- contains           LSB of decimation
    </i></font><font color="#000080">SPI_mssp_wait_until_ready
  </font><b>end if
  
  </b><font color="#000080">ADS1211_wait_for_ready

</font><b>end procedure
</b><font color="#808080"><i>-- -----------------------------------------------------------------------------



-- -----------------------------------------------------------------------------
-- Starts the calibration cycle (and transports complete command register)
-- wait until ready,
-- then normal mode is automatically set, starting at channel 0
-- -----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">ADS1211_calibrate </font><b>is
  </b><font color="#000080">_ADS1211_cmd2 <b>= </b>_ADS1211_mode_self_cal <b>| </b>_ADS1211_gain <b>| </b>ADS1211_chan
  </font><b>if </b><font color="#000080">ADS1211_spi_usart </font><b>then
    </b><font color="#000080">reverse_bits <b>(</b>_ADS1211_cmd2<b>)
</b></font><font color="#C0C0C0">	  </font><font color="#000080">spi_send_hw <b>( </b>__ADS1211_ins_write_cmd <b>)
</b></font><font color="#C0C0C0">	
	  </font><font color="#000080">spi_send_hw <b>( </b>_ADS1211_cmr1 <b>)
</b></font><font color="#C0C0C0">	  </font><font color="#000080">spi_send_hw <b>( </b>_ADS1211_cmd2 <b>)
</b></font><font color="#C0C0C0">	  </font><font color="#000080">spi_send_hw <b>( </b>_ADS1211_dcr1 <b>)    </b></font><font color="#808080"><i>-- contains Turbo and MSB of decimation
</i></font><font color="#C0C0C0">	  </font><font color="#000080">spi_send_hw <b>( </b>_ADS1211_dcr0 <b>)    </b></font><font color="#808080"><i>-- contains           LSB of decimation
  </i></font><b>else
</b><font color="#C0C0C0">	  </font><font color="#000080">spi_send_mssp <b>( </b>_ADS1211_ins_write_cmd <b>)
</b></font><font color="#C0C0C0">	  </font><font color="#000080">spi_send_mssp <b>( </b>_ADS1211_cmr1 <b>)
</b></font><font color="#C0C0C0">	  </font><font color="#000080">spi_send_mssp <b>( </b>_ADS1211_cmd2 <b>)
</b></font><font color="#C0C0C0">	  </font><font color="#000080">spi_send_mssp <b>( </b>_ADS1211_dcr1 <b>)    </b></font><font color="#808080"><i>-- contains Turbo and MSB of decimation
</i></font><font color="#C0C0C0">	  </font><font color="#000080">spi_send_mssp <b>( </b>_ADS1211_dcr0 <b>)    </b></font><font color="#808080"><i>-- contains           LSB of decimation
    </i></font><font color="#000080">spi_mssp_wait_until_ready
  </font><b>end if
  
  </b><font color="#808080"><i>-- wait till calibration ready
  </i></font><font color="#000080">ADS1211_wait_for_ready
  
</font><b>end procedure
</b><font color="#808080"><i>-- -----------------------------------------------------------------------------


-- -----------------------------------------------------------------------------
-- -----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">ADS1211_set_frequency <b>(</b></font><b>byte in </b><font color="#000080">freq<b>) </b></font><b>is
  </b><font color="#000080">_ADS1211_set_frequency<b>(</b>freq<b>)
  </b>ADS1211_calibrate
</font><b>end procedure
</b><font color="#808080"><i>-- -----------------------------------------------------------------------------


-- -----------------------------------------------------------------------------
-- This procedure is able to reset the ADC in case the power-ON reset fails
--    see page 30 of documentation
-- After reset, the calibration cycle is started
-- and then the normal mode will be entered
-- -----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">ADS1211_reset </font><b>is
  </b><font color="#808080"><i>-- must generate special sequence on the SPI clock line
  </i></font><b>const </b><font color="#000080">_ADS1211_RST1 <b>= (  </b></font><font color="#FF0000">320 </font><font color="#000080"><b>* </b>_ADS1211_Txin_100 <b>) / </b></font><font color="#FF0000">1000
  </font><b>const </b><font color="#000080">_ADS1211_RST2 <b>= ((   </b></font><font color="#FF0000">50 </font><font color="#000080"><b>* </b>_ADS1211_Txin_100 <b>) / </b></font><font color="#FF0000">1000</font><font color="#000080"><b>) + </b></font><font color="#FF0000">1
  </font><b>const </b><font color="#000080">_ADS1211_RST3 <b>= (  </b></font><font color="#FF0000">700 </font><font color="#000080"><b>* </b>_ADS1211_Txin_100 <b>) / </b></font><font color="#FF0000">1000
  </font><b>const </b><font color="#000080">_ADS1211_RST4 <b>= ( </b></font><font color="#FF0000">1100 </font><font color="#000080"><b>* </b>_ADS1211_Txin_100 <b>) / </b></font><font color="#FF0000">1000

  </font><b>if </b><font color="#000080"><b>( </b>_ADS1211_RST1 <b>&gt; </b></font><font color="#FF0000">255 </font><font color="#000080"><b>) | ( </b>_ADS1211_RST2 <b>&gt; </b></font><font color="#FF0000">255 </font><font color="#000080"><b>) |
     ( </b>_ADS1211_RST3 <b>&gt; </b></font><font color="#FF0000">255 </font><font color="#000080"><b>) | ( </b>_ADS1211_RST4 <b>&gt; </b></font><font color="#FF0000">255 </font><font color="#000080"><b>) </b></font><b>then
    </b><font color="#800080"><i>pragma </i></font><b>error </b><font color="#808080"><i>-- ADC Clockfrequency is too low for this routine
  </i></font><b>elsif </b><font color="#000080"><b>( </b>_ADS1211_RST1 <b>== </b></font><font color="#FF0000">0 </font><font color="#000080"><b>) | ( </b>_ADS1211_RST2 <b>== </b></font><font color="#FF0000">0 </font><font color="#000080"><b>) |
        ( </b>_ADS1211_RST3 <b>== </b></font><font color="#FF0000">0 </font><font color="#000080"><b>) | ( </b>_ADS1211_RST4 <b>== </b></font><font color="#FF0000">0 </font><font color="#000080"><b>) </b></font><b>then
    </b><font color="#800080"><i>pragma </i></font><b>error </b><font color="#808080"><i>-- ADC Clockfrequency is too high for this routine
  </i></font><b>else
    if </b><font color="#000080">ADS1211_spi_usart </font><b>then
      </b><font color="#000080">SPEN <b>= </b></font><b>low                     </b><font color="#808080"><i>-- disable SPI mode
    </i></font><b>else
</b><font color="#C0C0C0">		  </font><font color="#000080">SPI_mssp_wait_until_ready
</font><font color="#C0C0C0">			</font><font color="#000080">delay_10us
      SSPEN <b>= </b></font><b>low
    end if
    
    </b><font color="#000080">ADS1211_clock_direction <b>= </b></font><font color="#FF0000">output     </font><font color="#808080"><i>-- be sure to set output mode

    </i></font><font color="#000080">ADS1211_clock_pin <b>= </b></font><b>high
    </b><font color="#000080">delay_10uS <b>( </b>_ADS1211_RST1 <b>)
    </b>ADS1211_clock_pin <b>= </b></font><b>low
    </b><font color="#000080">delay_10uS <b>( </b>_ADS1211_RST2 <b>)
    </b>ADS1211_clock_pin <b>= </b></font><b>high
    </b><font color="#000080">delay_10uS <b>( </b>_ADS1211_RST3 <b>)
    </b>ADS1211_clock_pin <b>= </b></font><b>low
    </b><font color="#000080">delay_10uS <b>( </b>_ADS1211_RST2 <b>)
    </b>ADS1211_clock_pin <b>= </b></font><b>high
    </b><font color="#000080">delay_10uS <b>( </b>_ADS1211_RST4 <b>)
    </b>ADS1211_clock_pin <b>= </b></font><b>low
    </b><font color="#000080">delay_10uS <b>( </b></font><font color="#FF0000">10</font><font color="#000080"><b>)             </b></font><font color="#808080"><i>-- to be sure
    </i></font><b>if </b><font color="#000080">ADS1211_spi_usart </font><b>then
      </b><font color="#000080">SPEN <b>= </b></font><b>high                    </b><font color="#808080"><i>-- enable SPI mode again
    </i></font><b>else
      </b><font color="#000080">SSPEN <b>= </b></font><b>high
    end if

    </b><font color="#808080"><i>-- now calibrate (including settings) and goto into normal mode
</i></font><font color="#C0C0C0">		</font><font color="#000080">ADS1211_wait_for_ready 
    ADS1211_calibrate
  </font><b>end if
end procedure
</b><font color="#808080"><i>-- -----------------------------------------------------------------------------


-- -----------------------------------------------------------------------------
-- initialization
-- -----------------------------------------------------------------------------
-- calibrate can't be done here, because there could be more than 1 SPI
-- device to calibrate, in which case CS must be controled

-- set frequency, only calculates some vars
</i></font><font color="#000080">_ADS1211_set_frequency <b>( </b></font><font color="#FF0000">0 </font><font color="#000080"><b>)
</b></font><font color="#808080"><i>-- -----------------------------------------------------------------------------


</i></font></font>
</code></pre>
</body>
</html>
