<HTML><HEAD><TITLE>Sound & Music</TITLE>
<STYLE type="text/css"><!--
BODY {
  margin: 5px 5px 5px 5px;
  background-color: #EFEFEF;
}

--></STYLE>
<LINK type="text/css" href="rvf.css" rel=STYLESHEET>
<link rel="icon" href="punthoofd.gif" type="image/gif"></HEAD>
<BODY alink=#ff0000>

<P class=RVPS3><SPAN class=RVTS8>April 2002</SPAN></P>
<P><SPAN class=RVTS1>Sound &amp; Music</SPAN></P>
<P>&nbsp;&nbsp;</P>
<P>&nbsp;&nbsp;</P>
<P><A name="introduction"></A>
<SPAN class=RVTS2>Introduction</SPAN></P>
<P>Inspired by the "one litle violin" of Vasile (see&nbsp;<A class=RVTS4 href="http://www.geocities.com/vsurducan/electro/pic/math/music.txt">here</A>) and knowing the cool program&nbsp;<A class=RVTS4 href="http://www.aga.it/%7eguy/lego/index.htm">Brick's Music Studio by Guido Truffelli</A>, combined with my own wish to make a speaking robot, I decided to investigate the possibilities of PIC's producing sounds.</P>
<P>From some experiences with the Mindstorms RCX, I know that speech is quiet difficult and as far as I know impossible with the RCX. So speech, although still a wish of me, is not the current goal of this project, but&nbsp; just making interesting sounds from wav-, midi-files and maybe ringtones.</P>
<P>&nbsp;&nbsp;</P>
<P>&nbsp;&nbsp;</P>
<P><A name="basics"></A>
<SPAN class=RVTS2>Basics&nbsp;</SPAN></P>
<P>Basically there are two ways to make sound; playing fixed tones for a certain periods of time or generating the "exact" time-dependant waveform by some kind of DA-converter.&nbsp; For speech and musical instruments synthesis, often a third method is used: feeding pulses and white noise through time-varying filters. The latter method seems at first sight too complicated to fit into simple PICs.</P>
<P>Because every IO port of a PIC can deliver 25 mA of current and a piëzo-speaker is pure capacitive, you can connect a piëzo speaker directly between any IO-pin and ground (or positive supply if you like).</P>
<P>&nbsp;&nbsp;</P>
<P>&nbsp;&nbsp;</P>
<P><A name="pic_limitations"></A>
<SPAN class=RVTS2>PIC limitations&nbsp;</SPAN></P>
<P>There are few limitations which must be considered</P>
<UL style="text-indent: 0px; margin-left: 24px; list-style:outside;">
<LI>the available memory in PIC's is small&nbsp;</LI>
<LI>memory tables larger then 256 bytes are difficult (maybe even impossible) to handle in JAL&nbsp;</LI>
<LI>due to the above limition and due to the fact that JAL can handle only single bytes, the table values should be restricted to bytes (of 8 bits)&nbsp;</LI>
</UL>
<P>&nbsp;&nbsp;</P>
<P>&nbsp;&nbsp;</P>
<P><A name="timing"></A>
<SPAN class=RVTS2>Timing&nbsp;</SPAN></P>
<P>Both for the frequency and for the duration of a tone we've only 1 byte available, which means a dynamic range of *256.</P>
<P>The most important frequencies are to be expected at the low frequency range from 100 .. 3000 Hz. Translated to period times that means 10 msec downto 330 usec, or for half a period&nbsp; 165 usec to 5 msec.</P>
<P>So now we can define either period=1 to 165 usec or we can define period=255 to 5 msec. The first approach is not a good choice, because we loose too much resolution at the high frequencies, namely period=2 would mean 1500 Hz.</P>
<P>The most obvious choice to generate a constant frequency would be the use of the PWM (Puls Width Modulation) output.</P>
<P>But in the PIC I use most (16F628 @ 20 MHz) the lowest frequency the PWM can generate is about 1.2 kHz, because you can only use a maximum Timer2 prescaler of 16. The larger PIC's have larger pre-scalers.</P>
<P>So here we've to choose to use a timer that generates an interrupt and the constant frequency must be generated by the ISR (interrupt service routine). In this case you can use the Timer2, because interrupts are generated through a post-scaler.</P>
<P>&nbsp;&nbsp;</P>
<P><TABLE width=100% border=1 cellpadding=2 bordercolorlight=#D4D0C8 bordercolordark=#808080 cellspacing=2>
<TR valign=top>
<TD width=346 valign=top>
<P>I've chosen to use Timer0, because it's even available in the smallest PIC's.</P>
<P>Timer0 has a pre-scaler of&nbsp; 2,4,8,...256. Because we want to end up with a lowest frequency of 100 Hz, meaning a half period time of 5 msec, the ISR should be called at a maximum speed of 5ms / 250 = 20 usec. In that case a prescaler of 128, yields 128 * 0.2 us = 25.6 usec.</P>
<P>Due to the calling of an ISR (and therefore the saving of registers) there will be 1 or 2 usec added to this value, so we end up with a base period of 28 usec.</P>
<P>In the final design, I've chosen not to use the pre-scaler, but just preset the timer0 with a value of 128, which yields the same result.</P>
<P>On the right are the frequencies, for the case the half period would be 30 usec.</P>
<P>This seems to be according the goal.</P></TD>
<TD width=361 valign=top>
<P class=RVPS3>&nbsp;<IMG width=386 height=187 src="music_periods.gif"></P></TD>
</TR>
</TABLE>
</P>
<P>&nbsp;&nbsp;</P>
<P>The duration of the puls now also can be timed nicely by the ISR.&nbsp; Counting 255 interrupt request, would yield a time of about 250 * 30 us = 7 msec. So it's nice to define the duration step at 5 msec, in which case the maximum duration is 1.3 seconds, which seems to be far enough.</P>
<P>&nbsp;&nbsp;</P>
<P>&nbsp;&nbsp;</P>
<P><TABLE width=100% border=1 cellpadding=2 bordercolorlight=#D4D0C8 bordercolordark=#808080 cellspacing=2>
<TR valign=top>
<TD width=160 valign=top>
<P>&nbsp;<IMG width=133 height=127 src="music_pjg.gif"></P></TD>
<TD width=547 valign=top>
<P><A name="library_structure"></A>
<SPAN class=RVTS2>Library structure</SPAN></P>
<P>By including (a local copy) of PLAY_MUSIC3_INS.JAL in the main program all the sound and music functions are available.</P>
<P>Change the lookup tables in this file to your needs, set the IO-pin of your choice and the mode in which the music should be played and listen ...</P>
<P>For playing songs basically you can choose between 2 modes:</P>
<UL style="text-indent: 0px; margin-left: 24px; list-style:outside;">
<LI>full interrupt driven (so the PIC can do other things while playing music)&nbsp;</LI>
<LI>full program driven (while playing music the PIC can't do anything else)&nbsp;&nbsp;&nbsp;&nbsp;</LI>
</UL>
</TD>
</TR>
</TABLE>
</P>
<P>&nbsp;&nbsp;</P>
<P>&nbsp;&nbsp;</P>
<P><A name="procedures"></A>
<SPAN class=RVTS2>Procedures</SPAN></P>
<P><TABLE width=100% border=1 cellpadding=2 bordercolorlight=#D4D0C8 bordercolordark=#808080 cellspacing=2>
<TR valign=top>
<TD width=157 valign=top>
<P>Play_Song</P></TD>
<TD width=550 valign=top>
<P>Plays a song (definied in the user lookup tables) from start to finish.</P>
<P>Depending on the mode (interruptdriven / program driven) the PIC can or can't do something during playing of the sound.</P>
<P>In the full interrupt driven mode, the main program can check if the song is still playing by checking if Song_Playing is still true.</P>
<P>In the full interrupt driven mode, a song can be stopped by calling Stop_Song.</P></TD>
</TR>
<TR valign=top>
<TD width=157 valign=top>
<P>Play_Tune</P>
<P>(tune_number)</P></TD>
<TD width=550 valign=top>
<P>Now the lookup table contains a number of (short) tunes, and calling this function will play the selected tune from start to finish.</P>
<P>(it's behaviour is exactly the same as play_song)</P></TD>
</TR>
<TR valign=top>
<TD width=157 valign=top>
<P>Stop_Song</P></TD>
<TD width=550 valign=top>
<P>Only useful if a song is playing in the full interrupt driven mode, to stop playing of the song.</P></TD>
</TR>
<TR valign=top>
<TD width=157 valign=top>
<P>Play_Tone_and_Wait</P>
<P>(period, duration)</P></TD>
<TD width=550 valign=top>
<P>Plays a fixed frequency for a fixed amount of time.</P>
<P>This routine will consume all processor power and will return if the tone is finished.</P></TD>
</TR>
<TR valign=top>
<TD width=157 valign=top>
<P>Play_Tone</P>
<P>(period, duration)</P></TD>
<TD width=550 valign=top>
<P>Plays a fixed frequency for a fixed amount of time.</P>
<P>This function is full interrupt driven and can checked for playing through Song_Playing and stopped by Stop_Song</P></TD>
</TR>
</TABLE>
</P>
<P><SPAN class=RVTS2>&nbsp;&nbsp;</SPAN></P>
<P>&nbsp;&nbsp;</P>
<P><TABLE width=100% border=1 cellpadding=2 bordercolorlight=#D4D0C8 bordercolordark=#808080 cellspacing=2>
<TR valign=top>
<TD width=307 valign=top>
<P><A name="lookup_tables"></A>
<SPAN class=RVTS2>Lookup Tables</SPAN></P>
<P>Here is an example of a lookup table.</P>
<P>the tables contains 2 values per tone</P>
<P>&nbsp;&nbsp; PERIOD</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp; DURATION</P>
<P>Each table can be upto 254 bytes (= 127 frequency / duration combinations) long, but you can use as many tables as you like.</P>
<P>The routines automatically steps from one table to the next.</P>
<P>The PERIOD must be calculated with the next formula</P>
<P>&nbsp;&nbsp; constant = 1_000_000 / ( 60 * frequency[Hz] )</P>
<P>The DURATION must be calculated with the next formula</P>
<P>&nbsp;&nbsp; constant = duration[msec] / 5</P>
<P>if PERIOD=0 and DURATION&lt;&gt;0 then a silent pause is inserted</P>
<P>if DURATION=0 the end of the song is indicated</P>
<P>By these end-markers it's possible to store more songs or couplets into the tables (see the demo)</P></TD>
<TD width=419 valign=top>
<P class=RVPS3>&nbsp;<IMG width=419 height=436 src="music_pic2.gif"></P></TD>
</TR>
</TABLE>
</P>
<P>&nbsp;&nbsp;</P>
<P>&nbsp;&nbsp;</P>
<P><A name="generating_lookup_tables"></A>
<SPAN class=RVTS2>Generating Lookup Tables</SPAN></P>
<P>The most simple way is to use the piano, described below.</P>
<P>A very promissing method is the method used by&nbsp;<A class=RVTS4 href="http://www.aga.it/%7eguy/lego/index.htm">Guido Truffelli</A>.&nbsp;</P>
<P>His program (<A class=RVTS4 href="http://www.aga.it/%7eguy/lego/index.htm">Brick's Music Studio</A>) is able to translate WAV and MDI files into RCX code,&nbsp;</P>
<P>but more interesting he was so kind to add (special for all Jalliens) also lookup tables for JAL. (The JAL extension is not yet released, some small changes have to be made).</P>
<P>Converting MIDI files goes very well . WAV files are more complicated and it will depend on the complexity of the wav-file what the result will be.</P>
<P>Some nice MIDI files to start with are&nbsp;<A class=RVTS4 href="addams_family.mid">Addams-family</A>&nbsp;and&nbsp;<A class=RVTS4 href="flintstones.mid">The Flintsones</A></P>
<P>Ringtones should be nice source, but I'm not familiar with that.</P>
<P>&nbsp;&nbsp;</P>
<P>&nbsp;<IMG width=576 height=193 src="music_bms.gif"></P>
<P>&nbsp;&nbsp;</P>
<P>&nbsp;&nbsp;</P>
<P><TABLE width=100% border=1 cellpadding=2 bordercolorlight=#D4D0C8 bordercolordark=#808080 cellspacing=2>
<TR valign=top>
<TD width=373 valign=top>
<P><A name="piano"></A>
<SPAN class=RVTS2>Piano</SPAN><A href="#introduction"><IMG width=14 height=14 src="top_page.gif"></A></P>
<P>The piano can used to edit and test songs, that can be translated to PIC lookup tables. The sound is generated through the PC speaker, to get a close ressemblance to a PIC-speaker.</P>
<P>JUST TRY IT: Put the Record mode in Append or Insert and start clicking the piano with your mouse, or use the keyboard, where the following key-mapping yields:</P>
<P><SPAN class=RVTS12>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; S&nbsp;&nbsp; D&nbsp;&nbsp; F&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; H&nbsp;&nbsp; J&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Z&nbsp;&nbsp; X&nbsp;&nbsp; C&nbsp;&nbsp; V&nbsp;&nbsp; B&nbsp;&nbsp; N&nbsp;&nbsp; M</SPAN>&nbsp;By pressing the shift key, an octave higher is used.</P>
<P>Left below the piano keyboard, a spinbutton is placed which sets the base octave.</P>
<P>A rest can generated by the Rest-button, the spacebar or automatic through the setting of Pause selection.</P>
<P>PLAY, plays the song from the current cursor position</P>
<P>STOP, stops a song that is playing</P>
<P>SAVE,LOAD, stores/retrieve the song in a file.</P>
<P>TRANSPOSE + / - transposes the complete song 1 octave up or down</P>
<P>Arrow up / down, moves cursor though the songlist</P>
<P>Delete deletes the current line in the songlist</P>
<P>Insert toggels between Append / Insert mode</P>
<P>Finally COPY , converts the song to a PIC lookup table (period + duration as definied above) and places it on the clipboard, so you can paste (ctrl-V) it directly into a JAL file.</P></TD>
<TD width=334 valign=top>
<P class=RVPS3>&nbsp;<IMG width=354 height=443 src="piano.gif"></P></TD>
</TR>
</TABLE>
</P>
<P>&nbsp;&nbsp;</P>
<P>&nbsp;&nbsp;</P>
<P><A name="some_experimental_ideas"></A>
<SPAN class=RVTS2>Some experimental thoughts</SPAN></P>
<P>What are the possibilities if you'ld modulate both ends of a piezo speaker, with different signals ?</P>
<P>What would happen if you modulate the output with a high frequency, could it be possible to modulate the amplitude ?</P>
<P>Would it be possible to generate speech with a riddle of fixed frequencies (with very small time steps) ?</P>
<P>What about generating calculated sinusoidal signals and sending them to a PWM or a 1 bit DA converter.</P>
<P>&nbsp;&nbsp;</P>
<P>&nbsp;&nbsp;</P>
<P><A name="interesting_links"></A>
<SPAN class=RVTS2>Interesting Links</SPAN></P>
<P><A class=RVTS4 href="http://centauri.ezy.net.au/%7efastvid/picsound.htm">1 bit sound-generation</A></P>
<P><A class=RVTS4 href="http://centauri.ezy.net.au/%7efastvid/picsound.htmhttp://www.dattalo.com/technical/software/software.html">AD converter&nbsp;</A>without a real converter</P>
<P><A class=RVTS4 href="http://home.clear.net.nz/pages/joecolquitt/davedong.html">DaveDong</A></P>
<P><A class=RVTS4 href="http://www.embedinc.com/pic/hal.htm">HAL PIC example</A></P>
<P><A class=RVTS4 href="http://www.microchip.com/1000/edit/proceed/archive/9_179/index.htm">Microchip's "add music"</A></P>
<P>A free speech synthesis program&nbsp;<A class=RVTS4 href="http://www.cstr.ed.ac.uk/projects/festival/">Festival</A>&nbsp; ,&nbsp;&nbsp;<A class=RVTS4 href="http://tcts.fpms.ac.be/synthesis/mbrola/">MBROLA</A></P>
<P>Pitch modified speech&nbsp;<A class=RVTS4 href="../../lego_knex/us05987413___tif_2_s0_35_r0.gif">US5987413</A>&nbsp;&nbsp;<A class=RVTS4 href="http://www.delphion.com/">patent</A>&nbsp;&nbsp;</P>
<P>Acoustic analysis of speech&nbsp;&nbsp;<A class=RVTS4 href="http://userpages.chorus.net/cspeech/">CSPeech</A></P>
<P>Converts Dutch or English words to their phonetic transcription&nbsp;&nbsp;&nbsp;&nbsp;<A class=RVTS4 href="http://ilk.kub.nl/g2p-www-demo.html">TreeTalk</A>&nbsp;&nbsp;</P>
<P>WAV and MIDI to RCX translation,&nbsp;&nbsp;<A class=RVTS4 href="http://www.aga.it/%7eguy/lego/index.htm">Guy</A></P>
<P>my own quick and dirty including sources&nbsp;&nbsp;<A class=RVTS4 href="../download/wav2rcx2b.exe">wav2rcx</A>&nbsp;(315k)&nbsp;</P>
</BODY></HTML>
