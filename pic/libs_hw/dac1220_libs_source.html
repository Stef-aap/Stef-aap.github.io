<html>
<head>
<title>JALcc SourceCode exporting of dac1220_libs_source.html</title>
</head>
<!-- Generated by SynEdit HTML exporter -->
<body text="#000000" bgcolor="#FFFFFF">
<pre>
<code><font  size=3 face="Courier New"><font color="#000080"><A href="dac1220_libs.jal">download&nbsp;dac1220_libs.jal</A>
</font><font color="#808080"><i>-- -----------------------------------------------------------------------------
-- &lt;title DAC1220
-- &lt;License
-- freeware, under the terms of the GNU GPL
--  Copyright (C) 2002 Stef Mientki
-- -----------------------------------------------------------------------------
-- &lt;Description
-- Library for the control of the DAC1220 (20 bit DAC)
-- with slight modifications also usable for the DAC1221 (16 bit DAC, 3V !!)
--
-- Hardware settings should be done through a local copy of DAC1220_LIBS_INS
--
-- Data is transported through the variable
--   DAC1220_dir = DAC1220_dir3 . DAC1220_dir2 . DAC1220_dir1
--
-- &lt;non-tag
-- procedures
--   DAC1220_reset        hardware reset, calibrate, set normal mode
--   DAC1220_calibrate    calibrate, set normal mode
--   DAC1220_sleep        put DAC in sleep
--   DAC1220_wakeup       wakeup DAC
--   DAC1220_read_cmd     read both command registers (debugging)
--   DAC1220_set_DAC_24   set 20 bits DAC value
--   DAC1220_set_DAC_16   set 16 bits DAC value
--   DAC1220_read_DAC_24  read Data Input Registers
--
-- &lt;Version: 1.0  29-02-2002, Stef Mientki
--   -  orginal release
-- -----------------------------------------------------------------------------
-- -----------------------------------------------------------------------------



-- -----------------------------------------------------------------------------
-- &lt;Example DAC1220
; -- make local copy of DAC1220_LIBS_INS, edit paramaters, include in main program
;    include dac1220_libs_ins
;
; -- reset DAC (multiple SPI devices assumed, so CS must be controled)
;    CS_DAC0 = low
;    DAC1220_reset
;    CS_DAC0 = high
;
; -- set a 20 bit DAC value (from x = X3 . x2 . x1 )
;    DAC1220_dir3 = x3
;    DAC1220_dir2 = x2
;    DAC1220_dir1 = x1
;    CS_DAC0 = low
;    DAC1220_set_DAC_24
;    CS_DAC0 = high
;
; -- set a 16 bit DAC value (from x = x3 . x2 )
;    DAC1220_dir3 = x3
;    DAC1220_dir2 = x2
;    CS_DAC0 = low
;    DAC1220_set_DAC_16
;    CS_DAC0 = high
-- -----------------------------------------------------------------------------

-- &lt;code



-- -----------------------------------------------------------------------------
-- first test DAC clockfrequency
-- -----------------------------------------------------------------------------
</i></font><b>if </b><font color="#000080">DAC1220_Fin <b>&lt; </b></font><font color="#FF0000">1_200_000 </font><b>then
  </b><font color="#800080"><i>pragma </i></font><b>error   </b><font color="#808080"><i>-- clock frequency of DAC possible too low for this routines
                 -- especially t9 .. t11 and t15 should be checked
</i></font><b>end if
</b><font color="#808080"><i>-- -----------------------------------------------------------------------------



-- -----------------------------------------------------------------------------
-- test if SPI baudrate not too high
-- -----------------------------------------------------------------------------
</i></font><b>if </b><font color="#FF0000">baudrate </font><font color="#000080"><b>&gt; </b>DAC1220_Fin <b>/ </b></font><font color="#FF0000">10 </font><b>then
  </b><font color="#800080"><i>pragma </i></font><b>error   </b><font color="#808080"><i>-- Baudrate too high for the DAC clock frequency
</i></font><b>end if
</b><font color="#808080"><i>-- -----------------------------------------------------------------------------



-- general delay routines
</i></font><font color="#FF00FF">include delay_20Mc


</font><font color="#808080"><i>-- all SPI routines
</i></font><font color="#FF00FF">include rs232_hw



</font><font color="#808080"><i>-- definitions of the DATA registers, to be filled by the user
</i></font><b>var volatile byte </b><font color="#000080">DAC1220_dir3  </font><font color="#808080"><i>-- MSB
</i></font><b>var volatile byte </b><font color="#000080">DAC1220_dir2
</font><b>var volatile byte </b><font color="#000080">DAC1220_dir1  </font><font color="#808080"><i>-- LSB


-- 100 * Txin in [ usec], for calculating reset pulses
</i></font><b>const </b><font color="#000080">_DAC1220_Txin_100 <b>= ( </b></font><font color="#FF0000">100 </font><font color="#000080"><b>* </b></font><font color="#FF0000">1_000_000 </font><font color="#000080"><b>) / </b>DAC1220_Fin


</font><font color="#808080"><i>-- DAC1220, first MSB downto LSB
-- that's opposite to Tx of 16F628
-- so for all commands all bits must be swapped

-- next constants are used to compute command register CMR1 through ORRING
-- already reversed
</i></font><b>const </b><font color="#000080">_DAC1220_ADPT   <b>= </b></font><font color="#FF0000">0b_0001_0001
</font><b>const </b><font color="#000080">_DAC1220_CALPIN <b>= </b></font><font color="#FF0000">0b_0001_0010
</font><b>const </b><font color="#000080">_DAC1220_SH     <b>= </b></font><font color="#FF0000">0b_0001_0100
</font><b>const </b><font color="#000080">_DAC1220_CRST   <b>= </b></font><font color="#FF0000">0b_010100000

</font><font color="#808080"><i>-- next constants are used to compute command register CMR0 through ORRING
-- already reversed
</i></font><b>const </b><font color="#000080">_DAC1220_RES    <b>= </b></font><font color="#FF0000">0b_0000_0001
</font><b>const </b><font color="#000080">_DAC1220_CLR    <b>= </b></font><font color="#FF0000">0b_0000_0010
</font><b>const </b><font color="#000080">_DAC1220_DF     <b>= </b></font><font color="#FF0000">0b_0000_0100
</font><b>const </b><font color="#000080">_DAC1220_DISF   <b>= </b></font><font color="#FF0000">0b_0000_1000
</font><b>const </b><font color="#000080">_DAC1220_BD     <b>= </b></font><font color="#FF0000">0b_0001_0000
</font><b>const </b><font color="#000080">_DAC1220_MSB    <b>= </b></font><font color="#FF0000">0b_0010_0000

</font><font color="#808080"><i>-- constants for mode, should be ORRED to command register CMR0
-- already reversed
</i></font><b>const </b><font color="#000080">_DAC1220_mode_normal   <b>= </b></font><font color="#FF0000">0b_0000_0000
</font><b>const </b><font color="#000080">_DAC1220_mode_self_cal <b>= </b></font><font color="#FF0000">0b_1000_0000
</font><b>const </b><font color="#000080">_DAC1220_mode_sleep    <b>= </b></font><font color="#FF0000">0b_0100_0000



</font><font color="#808080"><i>-- INSTRUCTION REGISTER
-- already reversed                                                        (nr of bytes+normal code)
</i></font><b>const byte </b><font color="#000080">DAC1220_ins_write_data_24       <b>= </b></font><font color="#FF0000">0b_0000_0010  </font><font color="#808080"><i>-- (3) 0b_0100_0000
</i></font><b>const byte </b><font color="#000080">DAC1220_ins_write_data_16       <b>= </b></font><font color="#FF0000">0b_0000_0100  </font><font color="#808080"><i>-- (2) 0b_0010_0000
</i></font><b>const byte </b><font color="#000080">DAC1220_ins_write_cmd           <b>= </b></font><font color="#FF0000">0b_0010_0100  </font><font color="#808080"><i>-- (2) 0b_0010_0100
</i></font><b>const byte </b><font color="#000080">DAC1220_ins_write_cmd2          <b>= </b></font><font color="#FF0000">0b_1010_0000  </font><font color="#808080"><i>-- (1) 0b_0000_0101
</i></font><b>const byte </b><font color="#000080">DAC1220_ins_write_offset        <b>= </b></font><font color="#FF0000">0b_0001_0010  </font><font color="#808080"><i>-- (3) 0b_0100_1000
</i></font><b>const byte </b><font color="#000080">DAC1220_ins_write_fullscale     <b>= </b></font><font color="#FF0000">0b_0011_0010  </font><font color="#808080"><i>-- (3) 0b_0100_1100

</i></font><b>const </b><font color="#000080">_DAC1220_read <b>= </b></font><font color="#FF0000">1
</font><b>const byte </b><font color="#000080">DAC1220_ins_read_data_24        <b>= </b>DAC1220_ins_write_data_24   <b>| </b>_DAC1220_read
</font><b>const byte </b><font color="#000080">DAC1220_ins_read_data_16        <b>= </b>DAC1220_ins_write_data_16   <b>| </b>_DAC1220_read
</font><b>const byte </b><font color="#000080">DAC1220_ins_read_cmd            <b>= </b>DAC1220_ins_write_cmd       <b>| </b>_DAC1220_read
</font><b>const byte </b><font color="#000080">DAC1220_ins_read_offset         <b>= </b>DAC1220_ins_write_offset    <b>| </b>_DAC1220_read
</font><b>const byte </b><font color="#000080">DAC1220_ins_read_fullscale      <b>= </b>DAC1220_ins_write_fullscale <b>| </b>_DAC1220_read



</font><font color="#808080"><i>-- Here command registers is constructed from the user settings
</i></font><b>var volatile byte </b><font color="#000080">DAC1220_cmr1 <b>= </b></font><font color="#FF0000">0
</font><b>var volatile byte </b><font color="#000080">DAC1220_cmr0 <b>= </b></font><font color="#FF0000">0  </font><font color="#808080"><i>-- contains all bits except mode
                                     
</i></font><b>if </b><font color="#000080">DAC1220_ADPT   </font><b>then </b><font color="#000080">DAC1220_cmr1 <b>= </b>DAC1220_cmr1 <b>| </b>_DAC1220_ADPT   </font><b>end if
if </b><font color="#000080">DAC1220_CALPIN </font><b>then </b><font color="#000080">DAC1220_cmr1 <b>= </b>DAC1220_cmr1 <b>| </b>_DAC1220_CALPIN </font><b>end if
if </b><font color="#000080">DAC1220_SH     </font><b>then </b><font color="#000080">DAC1220_cmr1 <b>= </b>DAC1220_cmr1 <b>| </b>_DAC1220_SH     </font><b>end if
if </b><font color="#000080">DAC1220_CRST   </font><b>then </b><font color="#000080">DAC1220_cmr1 <b>= </b>DAC1220_cmr1 <b>| </b>_DAC1220_CRST   </font><b>end if
if </b><font color="#000080">DAC1220_RES    </font><b>then </b><font color="#000080">DAC1220_cmr0 <b>= </b>DAC1220_cmr0 <b>| </b>_DAC1220_RES    </font><b>end if
if </b><font color="#000080">DAC1220_CLR    </font><b>then </b><font color="#000080">DAC1220_cmr0 <b>= </b>DAC1220_cmr0 <b>| </b>_DAC1220_CLR    </font><b>end if
if </b><font color="#000080">DAC1220_DF     </font><b>then </b><font color="#000080">DAC1220_cmr0 <b>= </b>DAC1220_cmr0 <b>| </b>_DAC1220_DF     </font><b>end if
if </b><font color="#000080">DAC1220_DISF   </font><b>then </b><font color="#000080">DAC1220_cmr0 <b>= </b>DAC1220_cmr0 <b>| </b>_DAC1220_DISF   </font><b>end if
if </b><font color="#000080">DAC1220_BD     </font><b>then </b><font color="#000080">DAC1220_cmr0 <b>= </b>DAC1220_cmr0 <b>| </b>_DAC1220_BD     </font><b>end if
if </b><font color="#000080">DAC1220_MSB    </font><b>then </b><font color="#000080">DAC1220_cmr0 <b>= </b>DAC1220_cmr0 <b>| </b>_DAC1220_MSB    </font><b>end if



</b><font color="#808080"><i>-- -----------------------------------------------------------------------------
-- Read 24 bits DAC value into DAC1220_dir
-- -----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">DAC1220_read_DAC_24 </font><b>is
  </b><font color="#000080">spi_send_hw <b>( </b>DAC1220_ins_read_data_24 <b>)
  </b>spi_read_hw <b>( </b>DAC1220_dir3 <b>)
  </b>spi_read_hw <b>( </b>DAC1220_dir2 <b>)
  </b>spi_read_hw <b>( </b>DAC1220_dir1 <b>)
</b></font><b>end procedure
</b><font color="#808080"><i>-- -----------------------------------------------------------------------------



-- -----------------------------------------------------------------------------
-- SET DAC with the (new) 16-bit value from DAC1220_dir
-- -----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">DAC1220_set_DAC_16 </font><b>is
  </b><font color="#000080">spi_send_hw <b>( </b>DAC1220_ins_write_data_16 <b>)
  </b>spi_send_hw <b>( </b>DAC1220_dir3 <b>)
  </b>spi_send_hw <b>( </b>DAC1220_dir2 <b>)
</b></font><b>end procedure
</b><font color="#808080"><i>-- -----------------------------------------------------------------------------



-- -----------------------------------------------------------------------------
-- SET DAC with the (new) 24-bit value from DAC1220_dir
-- -----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">DAC1220_set_DAC_24 </font><b>is
  </b><font color="#000080">spi_send_hw <b>( </b>DAC1220_ins_write_data_24 <b>)
  </b>spi_send_hw <b>( </b>DAC1220_dir3 <b>)
  </b>spi_send_hw <b>( </b>DAC1220_dir2 <b>)
  </b>spi_send_hw <b>( </b>DAC1220_dir1 <b>)
</b></font><b>end procedure
</b><font color="#808080"><i>-- -----------------------------------------------------------------------------



-- -----------------------------------------------------------------------------
-- read command registers from DAC
-- -----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">DAC1220_read_cmd 
 <b>( </b></font><b>byte out </b><font color="#000080">cmr1<b>, </b></font><b>byte out </b><font color="#000080">cmr0 <b>) </b></font><b>is
  </b><font color="#000080">spi_send_hw <b>( </b>DAC1220_ins_read_cmd <b>)
  </b>spi_read_hw <b>( </b>cmr1 <b>)
  </b>spi_read_hw <b>( </b>cmr0 <b>)
</b></font><b>end procedure
</b><font color="#808080"><i>-- -----------------------------------------------------------------------------



-- -----------------------------------------------------------------------------
-- wake up DAC en set into normal mode
-- -----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">DAC1220_wakeup </font><b>is
  </b><font color="#000080">spi_send_hw <b>( </b>DAC1220_ins_write_cmd2 <b>)
  </b>spi_send_hw <b>( </b>DAC1220_cmr0 <b>| </b>_DAC1220_mode_normal <b>)
</b></font><b>end procedure
</b><font color="#808080"><i>-- -----------------------------------------------------------------------------



-- -----------------------------------------------------------------------------
-- put DAC into sleep mode
-- -----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">DAC1220_sleep </font><b>is
  </b><font color="#000080">spi_send_hw <b>( </b>DAC1220_ins_write_cmd2 <b>)
  </b>spi_send_hw <b>( </b>DAC1220_cmr0 <b>| </b>_DAC1220_mode_sleep <b>)
</b></font><b>end procedure
</b><font color="#808080"><i>-- -----------------------------------------------------------------------------



-- -----------------------------------------------------------------------------
-- Starts the calibration cycle (and transports complete command register)
-- wait till it's finished
-- after which normal mode will be set
-- -----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">DAC1220_calibrate </font><b>is
var byte </b><font color="#000080">_DAC1220_N
  </font><font color="#808080"><i>-- now do a selfcalibration
  </i></font><font color="#000080">spi_send_hw <b>( </b>DAC1220_ins_write_cmd <b>)
  </b>spi_send_hw <b>( </b>DAC1220_cmr1 <b>)
  </b>spi_send_hw <b>( </b>DAC1220_cmr0 <b>| </b>_DAC1220_mode_self_cal <b>)


  </b></font><font color="#808080"><i>-- wait till finished 1200 cycli maximum
  </i></font><b>const </b><font color="#000080">_DAC1220_N1 <b>= ( </b></font><font color="#FF0000">120 </font><font color="#000080"><b>* </b></font><font color="#FF0000">1_000_000 </font><font color="#000080"><b>) / </b>DAC1220_Fin
  </font><b>if </b><font color="#000080">_DAC1220_N1 <b>&lt;= </b></font><font color="#FF0000">255 </font><b>then
    </b><font color="#000080">_DAC1220_N <b>= </b>_DAC1220_N1
    delay_10uS <b>( </b>_DAC1220_N <b>)
  </b></font><b>else
    const </b><font color="#000080">_DAC1220_N2 <b>= ( </b></font><font color="#FF0000">12 </font><font color="#000080"><b>* </b></font><font color="#FF0000">100_000 </font><font color="#000080"><b>) / </b>DAC1220_Fin
    </font><b>if </b><font color="#000080">_DAC1220_N2 <b>&lt;= </b></font><font color="#FF0000">255 </font><b>then
      </b><font color="#000080">_DAC1220_N <b>= </b>_DAC1220_N2
      delay_1ms <b>( </b>_DAC1220_N <b>)
    </b></font><b>else
      </b><font color="#800080"><i>pragma </i></font><b>error </b><font color="#808080"><i>-- DAC clock too low
    </i></font><b>end if
  end if

  </b><font color="#808080"><i>-- enter normal mode
  </i></font><font color="#000080">spi_send_hw <b>( </b>DAC1220_ins_write_cmd2 <b>)
  </b>spi_send_hw <b>( </b>DAC1220_cmr0 <b>| </b>_DAC1220_mode_normal <b>)
</b></font><b>end procedure
</b><font color="#808080"><i>-- -----------------------------------------------------------------------------



-- -----------------------------------------------------------------------------
-- This procedure is able to reset the DAC in case the power-ON reset fails
--    see page 10 of documentation
-- After reset, the calibration cycle is started
-- and then the normal mode will be entered
-- -----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">DAC1220_reset </font><b>is
  </b><font color="#808080"><i>-- must generate special sequence on the SPI clock line
  -- _DAC1220_RST2 is made larger then necessary, for easier scope measurements
  </i></font><b>const </b><font color="#000080">_DAC1220_RST1 <b>= (  </b></font><font color="#FF0000">650 </font><font color="#000080"><b>* </b>_DAC1220_Txin_100 <b>) / </b></font><font color="#FF0000">1000
  </font><b>const </b><font color="#000080">_DAC1220_RST2 <b>= (   </b></font><font color="#FF0000">50 </font><font color="#000080"><b>* </b>_DAC1220_Txin_100 <b>) / </b></font><font color="#FF0000">1000
  </font><b>const </b><font color="#000080">_DAC1220_RST3 <b>= ( </b></font><font color="#FF0000">1400 </font><font color="#000080"><b>* </b>_DAC1220_Txin_100 <b>) / </b></font><font color="#FF0000">1000
  </font><b>const </b><font color="#000080">_DAC1220_RST4 <b>= ( </b></font><font color="#FF0000">2200 </font><font color="#000080"><b>* </b>_DAC1220_Txin_100 <b>) / </b></font><font color="#FF0000">1000
  
  </font><b>if </b><font color="#000080"><b>( </b>_DAC1220_RST1 <b>&gt; </b></font><font color="#FF0000">255 </font><font color="#000080"><b>) | ( </b>_DAC1220_RST2 <b>&gt; </b></font><font color="#FF0000">255 </font><font color="#000080"><b>) |
     ( </b>_DAC1220_RST3 <b>&gt; </b></font><font color="#FF0000">255 </font><font color="#000080"><b>) | ( </b>_DAC1220_RST4 <b>&gt; </b></font><font color="#FF0000">255 </font><font color="#000080"><b>) </b></font><b>then
    </b><font color="#800080"><i>pragma </i></font><b>error </b><font color="#808080"><i>-- DAC Clockfrequency is too low for this routine
  </i></font><b>elsif </b><font color="#000080"><b>( </b>_DAC1220_RST1 <b>== </b></font><font color="#FF0000">0 </font><font color="#000080"><b>) | ( </b>_DAC1220_RST2 <b>== </b></font><font color="#FF0000">0 </font><font color="#000080"><b>) |
        ( </b>_DAC1220_RST3 <b>== </b></font><font color="#FF0000">0 </font><font color="#000080"><b>) | ( </b>_DAC1220_RST4 <b>== </b></font><font color="#FF0000">0 </font><font color="#000080"><b>) </b></font><b>then
    </b><font color="#800080"><i>pragma </i></font><b>error </b><font color="#808080"><i>-- DAC Clockfrequency is too high for this routine
  </i></font><b>else
    </b><font color="#000080">SPEN <b>= </b></font><b>low                     </b><font color="#808080"><i>-- disable SPI mode
    </i></font><font color="#000080">DAC1220_clock_dir <b>= </b></font><font color="#FF0000">output     </font><font color="#808080"><i>-- be sure to set output mode
    
    </i></font><font color="#000080">DAC1220_clock <b>= </b></font><b>high
    </b><font color="#000080">delay_10uS <b>( </b>_DAC1220_RST1 <b>)
    </b>DAC1220_clock <b>= </b></font><b>low
    </b><font color="#000080">delay_10uS <b>( </b>_DAC1220_RST2 <b>)
    </b>DAC1220_clock <b>= </b></font><b>high
    </b><font color="#000080">delay_10uS <b>( </b>_DAC1220_RST3 <b>)
    </b>DAC1220_clock <b>= </b></font><b>low
    </b><font color="#000080">delay_10uS <b>( </b>_DAC1220_RST2 <b>)
    </b>DAC1220_clock <b>= </b></font><b>high
    </b><font color="#000080">delay_10uS <b>( </b>_DAC1220_RST4 <b>)
    </b>DAC1220_clock <b>= </b></font><b>low
    </b><font color="#000080">delay_10uS <b>( </b></font><font color="#FF0000">100</font><font color="#000080"><b>)             </b></font><font color="#808080"><i>-- to be sure
    </i></font><font color="#000080">SPEN <b>= </b></font><b>high                    </b><font color="#808080"><i>-- enable SPI mode again

;erbij gezet, anders wordt ie in de simulator niet herkend
</i></font><font color="#000080">delay_100ms
    </font><font color="#808080"><i>-- now calibrate and goto into normal mode
    </i></font><font color="#000080">DAC1220_calibrate
  </font><b>end if
end procedure
</b><font color="#808080"><i>-- -----------------------------------------------------------------------------



-- -----------------------------------------------------------------------------
-- initialization
-- -----------------------------------------------------------------------------
-- calibrate can't be done here, because there could be more than 1 SPI
-- device to calibrate, in which case CS must be controled



</i></font></font>
</code></pre>
</body>
</html>
