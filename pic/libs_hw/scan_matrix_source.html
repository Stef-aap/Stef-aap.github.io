<html>
<head>
<title>JALcc SourceCode exporting of scan_matrix_source.html</title>
</head>
<!-- Generated by SynEdit HTML exporter -->
<body text="#000000" bgcolor="#FFFFFF">
<pre>
<code><font  size=3 face="Courier New"><font color="#000080"><A href="scan_matrix.jal">download&nbsp;scan_matrix.jal</A>
</font><font color="#808080"><i>-- --------------------------------------------------------------------
-- &lt;title scan extended keymatrix
-- &lt;License
-- freeware, under the terms of the GNU GPL
--  Copyright (C) 2002 Stef Mientki
-- -----------------------------------------------------------------------------
-- &lt;Description
-- Scans the extended keymatrix and decodes multiple keys.
--  Every scan only 1 key is returned.
--  If a key is pressed during more than 1 scan,
-- key = 0 (means no key) is inserted inbetween.
--  If multiple keys are pressed, every scan a higher key will be detected.
--  Example: if key 3 and 7 are pressed, succeeding scans will return
-- (remark, here also the zero-key will be inserted)
--    3 , 7 , 0 , 3 , 7 , 0, 3
--
-- for hardware details on the extended keymatrix, see
--   ../PicProg/Pic_switch.htm
--
-- &lt;Version 1.1   ,24-11-2001, Stef Mientki
--    - bug in key-decoding removed
-- &lt;Version 1.0   ,22-11-2001, Stef Mientki
--    - first release
-- --------------------------------------------------------------------

-- -----------------------------------------------------------------------------
-- &lt;Example Scan Matrix
; -- define the number of total scanlines (2 ... 5)
; const byte key_nr_scanlines = 5
;
; -- define the port where scanlines resides
; -- (all scan lines must be on the same port)
; var byte key_port is _portB
;
; -- the scanmatrix must have pull-up resistors at all lines
; -- the user must set the pull-ups active
;  _file_bit_clear ( high_OPTION_REG, low_OPTION_REG, 7 )
;
; -- define the pinnumbers where the scanlines are
; -- always define the maximum number of pins,
; -- The scanlines not used, should be definied as an existing scanline
; -- So if you have only 4 scanlines, define the fifth scanline as
; --    const key_scanpin_5 = key_scanpin_1
; --
; const key_scanpin_1 = 0
; const key_scanpin_2 = 4
; const key_scanpin_3 = 5
; const key_scanpin_4 = 6
; const key_scanpin_5 = 7
;
; -- include scan library
; include scan_matrix
;
; var byte key
; forever loop
;  -- scan keybord
;  scan_keymatrix_ext ( key )
;
;  -- if a different key was pressed, execute the command
;  if key != 0 then
;    asynch_send_hw(key)
;  end if
;
;   ... do other things here, maybe a fixed delay ?
; end loop
-- -----------------------------------------------------------------------------


-- &lt;code


-- --------------------------------------------------------------------
-- define the pin direction bits
-- this seems a lot of energy to reach the right direction bits,
-- but this seems to be the only way
-- (we don't want the user to do double declarations,
--  he/she already declared KEY_SCANPIN_1 etc)
-- --------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">key_scandir_1<b>'</b></font><b>put</b><font color="#000080"><b>( </b></font><b>bit in </b><font color="#000080">x<b>) </b></font><b>is
  if </b><font color="#000080">key_port <b>== </b>PORTA </font><b>then
    var volatile bit </b><font color="#000080">xx </font><b>at </b><font color="#000080">trisa_shadow <b>: </b>key_scanpin_1
    xx <b>= </b>x
    _trisa_flush
  </font><b>else </b><font color="#808080"><i>-- PORTB
    </i></font><b>var volatile bit </b><font color="#000080">xx </font><b>at </b><font color="#000080">trisb_shadow <b>: </b>key_scanpin_1
    xx <b>= </b>x
    _trisb_flush
  </font><b>end if
end procedure
</b><font color="#808080"><i>-- --------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">key_scandir_2<b>'</b></font><b>put</b><font color="#000080"><b>( </b></font><b>bit in </b><font color="#000080">x<b>) </b></font><b>is
  if </b><font color="#000080">key_port <b>== </b>PORTA </font><b>then
    var volatile bit </b><font color="#000080">xx </font><b>at </b><font color="#000080">trisa_shadow <b>: </b>key_scanpin_2
    xx <b>= </b>x
    _trisa_flush
  </font><b>else </b><font color="#808080"><i>-- PORTB
    </i></font><b>var volatile bit </b><font color="#000080">xx </font><b>at </b><font color="#000080">trisb_shadow <b>: </b>key_scanpin_2
    xx <b>= </b>x
    _trisb_flush
  </font><b>end if
end procedure
</b><font color="#808080"><i>-- --------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">key_scandir_3<b>'</b></font><b>put</b><font color="#000080"><b>( </b></font><b>bit in </b><font color="#000080">x<b>) </b></font><b>is
  if </b><font color="#000080">key_port <b>== </b>PORTA </font><b>then
    var volatile bit </b><font color="#000080">xx </font><b>at </b><font color="#000080">trisa_shadow <b>: </b>key_scanpin_3
    xx <b>= </b>x
    _trisa_flush
  </font><b>else </b><font color="#808080"><i>-- PORTB
    </i></font><b>var volatile bit </b><font color="#000080">xx </font><b>at </b><font color="#000080">trisb_shadow <b>: </b>key_scanpin_3
    xx <b>= </b>x
    _trisb_flush
  </font><b>end if
end procedure
</b><font color="#808080"><i>-- --------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">key_scandir_4<b>'</b></font><b>put</b><font color="#000080"><b>( </b></font><b>bit in </b><font color="#000080">x<b>) </b></font><b>is
  if </b><font color="#000080">key_port <b>== </b>PORTA </font><b>then
    var volatile bit </b><font color="#000080">xx </font><b>at </b><font color="#000080">trisa_shadow <b>: </b>key_scanpin_4
    xx <b>= </b>x
    _trisa_flush
  </font><b>else </b><font color="#808080"><i>-- PORTB
    </i></font><b>var volatile bit </b><font color="#000080">xx </font><b>at </b><font color="#000080">trisb_shadow <b>: </b>key_scanpin_4
    xx <b>= </b>x
    _trisb_flush
  </font><b>end if
end procedure
</b><font color="#808080"><i>-- --------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">key_scandir_5<b>'</b></font><b>put</b><font color="#000080"><b>( </b></font><b>bit in </b><font color="#000080">x<b>) </b></font><b>is
  if </b><font color="#000080">key_port <b>== </b>PORTA </font><b>then
    var volatile bit </b><font color="#000080">xx </font><b>at </b><font color="#000080">trisa_shadow <b>: </b>key_scanpin_5
    xx <b>= </b>x
    _trisa_flush
  </font><b>else </b><font color="#808080"><i>-- PORTB
    </i></font><b>var volatile bit </b><font color="#000080">xx </font><b>at </b><font color="#000080">trisb_shadow <b>: </b>key_scanpin_5
    xx <b>= </b>x
    _trisb_flush
  </font><b>end if
end procedure
</b><font color="#808080"><i>-- --------------------------------------------------------------------



-- -----------------------------------------------------------------------------
-- definitions of internal constants and vars
-- -----------------------------------------------------------------------------
</i></font><b>var byte </b><font color="#000080">_key <b>= </b></font><font color="#FF0000">0      </font><font color="#808080"><i>-- the value of the detected key (0=no key, 1...=key)
</i></font><b>var byte </b><font color="#000080">_key_old <b>= </b></font><font color="#FF0000">0  </font><font color="#808080"><i>-- the previous detected key
</i></font><b>var byte </b><font color="#000080">_key_base     </font><font color="#808080"><i>-- counts the active scanline and is used to calculate _key

-- define a variable to be read from the scanlines port
-- and define all scanlines within this variable
</i></font><b>var byte </b><font color="#000080">_key_port_read
</font><b>var volatile bit </b><font color="#000080">_key_scanline_1 </font><b>at </b><font color="#000080">_key_port_read <b>: </b>key_scanpin_1
</font><b>var volatile bit </b><font color="#000080">_key_scanline_2 </font><b>at </b><font color="#000080">_key_port_read <b>: </b>key_scanpin_2
</font><b>var volatile bit </b><font color="#000080">_key_scanline_3 </font><b>at </b><font color="#000080">_key_port_read <b>: </b>key_scanpin_3
</font><b>var volatile bit </b><font color="#000080">_key_scanline_4 </font><b>at </b><font color="#000080">_key_port_read <b>: </b>key_scanpin_4
</font><b>var volatile bit </b><font color="#000080">_key_scanline_5 </font><b>at </b><font color="#000080">_key_port_read <b>: </b>key_scanpin_5

</font><font color="#808080"><i>-- define for every scanline a mask
</i></font><b>const byte </b><font color="#000080">_km1 <b>= </b></font><font color="#FF0000">0b0000_0001 </font><font color="#000080"><b>&lt;&lt; </b>key_scanpin_1
</font><b>const byte </b><font color="#000080">_km2 <b>= </b></font><font color="#FF0000">0b0000_0001 </font><font color="#000080"><b>&lt;&lt; </b>key_scanpin_2
</font><b>const byte </b><font color="#000080">_km3 <b>= </b></font><font color="#FF0000">0b0000_0001 </font><font color="#000080"><b>&lt;&lt; </b>key_scanpin_3
</font><b>const byte </b><font color="#000080">_km4 <b>= </b></font><font color="#FF0000">0b0000_0001 </font><font color="#000080"><b>&lt;&lt; </b>key_scanpin_4
</font><b>const byte </b><font color="#000080">_km5 <b>= </b></font><font color="#FF0000">0b0000_0001 </font><font color="#000080"><b>&lt;&lt; </b>key_scanpin_5

</font><font color="#808080"><i>-- now calculate the total mask for all scanlines
</i></font><b>const byte </b><font color="#000080">_key_mask <b>= </b>_km1 <b>| </b>_km2 <b>| </b>_km3 <b>| </b>_km4 <b>| </b>_km5
</font><b>if </b><font color="#000080"><b>( </b>key_nr_scanlines <b>&lt; </b></font><font color="#FF0000">2 </font><font color="#000080"><b>) | ( </b>key_nr_scanlines <b>&gt; </b></font><font color="#FF0000">5 </font><font color="#000080"><b>) </b></font><b>then
  </b><font color="#800080"><i>pragma </i></font><b>error  </b><font color="#808080"><i>-- number of scanlines must be between 2 and 5
</i></font><b>end if

</b><font color="#808080"><i>-- define special total mask, in which the active scanline is ignored
</i></font><b>const byte </b><font color="#000080">_kmask1 <b>= ! ( </b>_key_mask <b>- </b>_km1 <b>)
</b></font><b>const byte </b><font color="#000080">_kmask2 <b>= ! ( </b>_key_mask <b>- </b>_km2 <b>)
</b></font><b>const byte </b><font color="#000080">_kmask3 <b>= ! ( </b>_key_mask <b>- </b>_km3 <b>)
</b></font><b>const byte </b><font color="#000080">_kmask4 <b>= ! ( </b>_key_mask <b>- </b>_km4 <b>)
</b></font><b>const byte </b><font color="#000080">_kmask5 <b>= ! ( </b>_key_mask <b>- </b>_km5 <b>)

</b></font><font color="#808080"><i>-- make all outputs low, especially doen for the keyboard scanmatrix
</i></font><font color="#000080">key_port <b>= ! </b>_key_mask
</font><font color="#808080"><i>-- -----------------------------------------------------------------------------



-- -----------------------------------------------------------------------------
-- internal routine
-- Decodes a read value from the passive scanlines
-- if no key is found:  _key=0
-- -----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">_keymatrix_ext_decode_scanline </font><b>is
  </b><font color="#808080"><i>-- set the base value of the active scanline
  </i></font><font color="#000080">_key <b>= </b>key_nr_scanlines <b>* </b>_key_base <b>+ </b></font><font color="#FF0000">1
  
  </font><font color="#808080"><i>-- now step through all scanlines to find a pressed key,
  -- which is greater than the previous key
  </i></font><b>if </b><font color="#000080">_key_scanline_1 <b>| ( </b>_key <b>&lt;= </b>_key_old <b>) | ( </b>key_nr_scanlines <b>&lt; </b></font><font color="#FF0000">1 </font><font color="#000080"><b>)  </b></font><b>then
    </b><font color="#000080">_key <b>= </b>_key <b>+ </b></font><font color="#FF0000">1
    </font><b>if </b><font color="#000080">_key_scanline_2 <b>| ( </b>_key <b>&lt;= </b>_key_old<b>) | ( </b>key_nr_scanlines <b>&lt; </b></font><font color="#FF0000">2 </font><font color="#000080"><b>)  </b></font><b>then
      </b><font color="#000080">_key <b>= </b>_key <b>+ </b></font><font color="#FF0000">1
      </font><b>if </b><font color="#000080">_key_scanline_3 <b>| ( </b>_key <b>&lt;= </b>_key_old<b>) | ( </b>key_nr_scanlines <b>&lt; </b></font><font color="#FF0000">3 </font><font color="#000080"><b>)  </b></font><b>then
        </b><font color="#000080">_key <b>= </b>_key <b>+ </b></font><font color="#FF0000">1
        </font><b>if </b><font color="#000080">_key_scanline_4 <b>| ( </b>_key <b>&lt;= </b>_key_old<b>) | ( </b>key_nr_scanlines <b>&lt; </b></font><font color="#FF0000">4 </font><font color="#000080"><b>) </b></font><b>then
          </b><font color="#000080">_key <b>= </b>_key <b>+ </b></font><font color="#FF0000">1
          </font><b>if </b><font color="#000080">_key_scanline_5 <b>| ( </b>_key <b>&lt;= </b>_key_old<b>) | ( </b>key_nr_scanlines <b>&lt; </b></font><font color="#FF0000">5 </font><font color="#000080"><b>) </b></font><b>then
            </b><font color="#000080">_key <b>= </b></font><font color="#FF0000">0
          </font><b>end if
        end if
      end if
    end if
  end if

  </b><font color="#808080"><i>-- if any key detected, save the detected key
  -- for repeating the same key:
  --    if it was the last scan line, also save no key detected
  </i></font><b>if </b><font color="#000080"><b>(</b>_key <b>!= </b></font><font color="#FF0000">0 </font><font color="#000080"><b>) | ( </b>_key_base <b>== ( </b>key_nr_scanlines <b>- </b></font><font color="#FF0000">1 </font><font color="#000080"><b>) ) </b></font><b>then
     </b><font color="#000080">_key_old <b>= </b>_key
  </font><b>end if
  
  </b><font color="#808080"><i>-- increment key_base for the next active scanline
  </i></font><font color="#000080">_key_base <b>= </b>_key_base <b>+ </b></font><font color="#FF0000">1
</font><b>end procedure
</b><font color="#808080"><i>-- -----------------------------------------------------------------------------



-- -----------------------------------------------------------------------------
-- scans the extended keymatrix and decodes multiple keys.
-- every scan only 1 key is returned
-- if a key is pressed during more than 1 scan,
--    key = 0 (means no key) is inserted inbetween
-- if multiple keys are pressed, every scan a higher key will be detected.
-- Example: if key 3 and 7 are pressed, succeeding scans will return
-- (remark, here also the zero-key will be inserted)
--    3 , 7 , 0 , 3 , 7 , 0, 3
-- -----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">scan_keymatrix_ext <b>( </b></font><b>byte out </b><font color="#000080">key2 <b>) </b></font><b>is
  </b><font color="#808080"><i>-- initialize the basevalue of the first scanline
  </i></font><font color="#000080">_key_base <b>= </b></font><font color="#FF0000">0

  </font><font color="#808080"><i>-- if still no key found and scanlines to do
  </i></font><b>if </b><font color="#000080"><b>( </b>key_nr_scanlines <b>&gt;= </b></font><font color="#FF0000">1 </font><font color="#000080"><b>) </b></font><b>then
    </b><font color="#808080"><i>-- activate scanline (the output latch is already set to low !!)
    </i></font><font color="#000080">key_scandir_1 <b>= </b></font><font color="#FF0000">output
    </font><font color="#808080"><i>-- read the port, mask non-scanlines and mask the active scanline
    </i></font><font color="#000080">_key_port_read <b>= ( </b>key_port <b>&amp; </b>_key_mask <b>) | </b>_kmask1
    </font><font color="#808080"><i>-- deactivate the scanline
    </i></font><font color="#000080">key_scandir_1 <b>= </b></font><font color="#FF0000">input
    </font><font color="#808080"><i>-- decode the keys
    </i></font><font color="#000080">_keymatrix_ext_decode_scanline
  </font><b>end if

  </b><font color="#808080"><i>-- if still no key found and scanlines to do
  </i></font><b>if </b><font color="#000080"><b>( </b>_key <b>== </b></font><font color="#FF0000">0 </font><font color="#000080"><b>) &amp; ( </b>key_nr_scanlines <b>&gt;= </b></font><font color="#FF0000">2 </font><font color="#000080"><b>) </b></font><b>then
    </b><font color="#000080">key_scandir_2 <b>= </b></font><font color="#FF0000">output
    </font><font color="#000080">_key_port_read <b>= ( </b>key_port <b>&amp; </b>_key_mask <b>) | </b>_kmask2
    key_scandir_2 <b>= </b></font><font color="#FF0000">input
    </font><font color="#000080">_keymatrix_ext_decode_scanline
  </font><b>end if

  if </b><font color="#000080"><b>( </b>_key <b>== </b></font><font color="#FF0000">0 </font><font color="#000080"><b>) &amp; ( </b>key_nr_scanlines <b>&gt;= </b></font><font color="#FF0000">3 </font><font color="#000080"><b>)  </b></font><b>then
    </b><font color="#000080">key_scandir_3 <b>= </b></font><font color="#FF0000">output
    </font><font color="#000080">_key_port_read <b>= ( </b>key_port <b>&amp; </b>_key_mask <b>) | </b>_kmask3
    key_scandir_3 <b>= </b></font><font color="#FF0000">input
    </font><font color="#000080">_keymatrix_ext_decode_scanline
  </font><b>end if

  if </b><font color="#000080"><b>( </b>_key <b>== </b></font><font color="#FF0000">0 </font><font color="#000080"><b>) &amp; ( </b>key_nr_scanlines <b>&gt;= </b></font><font color="#FF0000">4 </font><font color="#000080"><b>)  </b></font><b>then
    </b><font color="#000080">key_scandir_4 <b>= </b></font><font color="#FF0000">output
    </font><font color="#000080">_key_port_read <b>= ( </b>key_port <b>&amp; </b>_key_mask <b>) | </b>_kmask4
    key_scandir_4 <b>= </b></font><font color="#FF0000">input
    </font><font color="#000080">_keymatrix_ext_decode_scanline
  </font><b>end if

  if </b><font color="#000080"><b>( </b>_key <b>== </b></font><font color="#FF0000">0 </font><font color="#000080"><b>) &amp; ( </b>key_nr_scanlines <b>&gt;= </b></font><font color="#FF0000">5 </font><font color="#000080"><b>)  </b></font><b>then
    </b><font color="#000080">key_scandir_5 <b>= </b></font><font color="#FF0000">output
    </font><font color="#000080">_key_port_read <b>= ( </b>key_port <b>&amp; </b>_key_mask <b>) | </b>_kmask5
    key_scandir_5 <b>= </b></font><font color="#FF0000">input
    </font><font color="#000080">_keymatrix_ext_decode_scanline
  </font><b>end if
  
  </b><font color="#808080"><i>-- transport key to the outher world
  </i></font><font color="#000080">key2 <b>= </b>_key
</font><b>end procedure
</b><font color="#808080"><i>-- -----------------------------------------------------------------------------
</i></font></font>
</code></pre>
</body>
</html>
