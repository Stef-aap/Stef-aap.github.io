<html>
<head>
<title>JALcc SourceCode exporting of pic_adc_source.html</title>
</head>
<!-- Generated by SynEdit HTML exporter -->
<body text="#000000" bgcolor="#FFFFFF">
<pre>
<code><font  size=3 face="Courier New"><font color="#000080"><A href="pic_adc.jal">download&nbsp;pic_adc.jal</A>
</font><font color="#808080"><i>-- -----------------------------------------------------------------------------
-- &lt;title PIC-AD
-- &lt;License
-- freeware, under the terms of the GNU GPL
--  Copyright (C) 2002 Stef Mientki
-- -----------------------------------------------------------------------------
-- &lt;Description
-- Library to use the PIC's AD converter
-- see the example below, how to use it
--
--  procedure PIC_ADC_init			 	
--  procedure PIC_ADC_read_low_res (chan, sample)
--  procedure PIC_ADC_read         (chan, highsample, lowsample)
--
--  hardware, see 16F87x datasheet (DS30292C, p112)
--  number of channels, behind &quot;--&quot; yields only for 16F874 and 16F877
--  no external Vref: Nchan = 1,3,5 -- 6,8
--  only external +Vref: Nchan = 2,4 -- 5,7
--  both external +Vref and - Vref: Nchan = 1,2,3 -- 4,6
--
--  analog channels can still be used as digital outputs, by setting
--      pin = output
--
--  relevant IO pins
--  RA0 = AN0
--  RA1 = AN1
--  RA2 = AN2  or  -Vref
--  RA3 = AN3  or  +Vref
--  RA4 = no analog IO
--  RA5 = AN4
--  next pins only for 16F874 and 16F877
--  RE0 = AN5
--  RE1 = AN6
--  RE2 = AN7
--
-- Background Information
-- I mixed the following libraries with my own ideas
--    f877_modules.jal from Javi
--    janalog.jal from Vasile
--
--
-- Rick Turtel has extended the library with 16F88 support,
-- see http://www.geocities.com/fun_4_me_now20012000/jal_page.html
--
-- &lt;Version: 2.2 23-03-2004, Stef Mienti
--    - errors in IO-direction assignment corrected (was pin_a2=input)
--      (Thanks to Rick Turtel)
--
-- &lt;Version: 2.1 16-10-2003, Stef Mientki, 
--    - 16F87x, 1 channel + NoRef didn't work, bug fixed
--
-- &lt;Version: 2.0 05-04-2003, Stef Mientki, 
--    - 12F675 support added
--
-- &lt;Version: 1.0  10-04-2003, Stef Mientki
--    - orginal release
--    - _PIC_ADC_init_1_Vref  (not tested)
--    - _PIC_ADC_init_2_Vref  (not tested)
-- -----------------------------------------------------------------------------
-- -----------------------------------------------------------------------------


-- -----------------------------------------------------------------------------
-- -----------------------------------------------------------------------------
-- -----------------------------------------------------------------------------
-- &lt;Example PIC-AD
; -- (if you use JALcc, you can copy the complete example below and &quot;uncomment&quot; it)
; -- define the AD converter settings
; const PIC_ADC_Nchan	 	 	 	 	 	= 5	 	 	 	 ;number of selected channels
; const PIC_ADC_NVref						= 0				 ;number of external references
; const PIC_ADC_Rsource					= 20_000   ;maximum source resistance (max recommended = 10 kOhm)
; const PIC_ADC_high_resolution = true		   ;true = high resolution = 10 bits
;												   ;false = low resolution = 8 bits
; -- get the library, after defining the constants
; include pic_adc
;
; -- initialize the AD converter according to the above parameters
; PIC_ADC_init
;
; -- now take a sample 
; -- (choose the correct routine according to the selected resolution)
; PIC_ADC_read (chan, xH, xL)
-- -----------------------------------------------------------------------------


-- &lt;code


-- -----------------------------------------------------------------------------
-- local variables
-- -----------------------------------------------------------------------------
</i></font><b>var volatile byte </b><font color="#000080">_ADCON0_shadow <b>= </b></font><font color="#FF0000">0
</font><b>var volatile byte </b><font color="#000080">_PIC_ADC_conversion_time
</font><font color="#808080"><i>-- -----------------------------------------------------------------------------


-- -----------------------------------------------------------------------------
-- Does an AD conversion with low resolution (8 bit) on the selected channel
-- -----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">PIC_ADC_read_low_res 
  <b>(</b></font><b>byte in </b><font color="#000080">PIC_ADC_chan<b>, </b></font><b>byte out </b><font color="#000080">PIC_ADC_byte<b>) </b></font><b>is
  if </b><font color="#000080">target_chip <b>== </b>pic_12F675 </font><b>then
    </b><font color="#000080">ADCON0 <b>= </b>_ADCON0_shadow <b>| ((</b>PIC_ADC_chan <b>&amp; </b></font><font color="#FF0000">0x03</font><font color="#000080"><b>) &lt;&lt; </b></font><font color="#FF0000">2</font><font color="#000080"><b>) </b></font><font color="#808080"><i>-- setup multiplexer
</i></font><font color="#C0C0C0">	</font><b>else 
    </b><font color="#000080">ADCON0 <b>= </b>_ADCON0_shadow <b>| ((</b>PIC_ADC_chan <b>&amp; </b></font><font color="#FF0000">0x07</font><font color="#000080"><b>) &lt;&lt; </b></font><font color="#FF0000">3</font><font color="#000080"><b>) </b></font><font color="#808080"><i>-- setup multiplexer
  </i></font><b>end if
  </b><font color="#000080">delay_10us <b>(</b>_PIC_ADC_conversion_time<b>)</b></font><font color="#C0C0C0">	 </font><font color="#808080"><i>-- wait acquisition time
  </i></font><font color="#000080">GO <b>= </b></font><font color="#FF0000">true</font><font color="#C0C0C0">	 														 </font><font color="#808080"><i>-- start conversion
  </i></font><b>while </b><font color="#000080">GO </font><b>loop end loop</b><font color="#C0C0C0">								 </font><font color="#808080"><i>-- wait till conversion finished
  </i></font><font color="#000080">PIC_ADC_byte <b>= </b>ADRESH</font><font color="#C0C0C0">									 </font><font color="#808080"><i>-- read high byte 
</i></font><font color="#C0C0C0">																				 </font><font color="#808080"><i>--   (low resolution is left justified !!)
  </i></font><b>if </b><font color="#000080">target_clock <b>&lt;= (</b></font><font color="#FF0000">5_000_000 </font><font color="#000080"><b>/ </b></font><font color="#FF0000">16</font><font color="#000080"><b>)</b></font><font color="#C0C0C0">	</font><b>then</b><font color="#C0C0C0">														
    </font><font color="#000080">delay_10us</font><font color="#C0C0C0">	  											 </font><font color="#808080"><i>-- to satisfy 2*Tad for next conversion
  </i></font><b>end if
end procedure
</b><font color="#808080"><i>-- -----------------------------------------------------------------------------


-- -----------------------------------------------------------------------------
-- Does an AD conversion with high resolution (10 bit) on the selected channel
-- -----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">PIC_ADC_read 
  <b>(</b></font><b>byte in </b><font color="#000080">PIC_ADC_chan<b>, </b></font><b>byte out </b><font color="#000080">PIC_ADC_Hbyte<b>, </b></font><b>byte out </b><font color="#000080">PIC_ADC_Lbyte<b>) </b></font><b>is
  </b><font color="#000080">PIC_ADC_read_low_res <b>(</b>PIC_ADC_chan<b>,</b>PIC_ADC_Hbyte<b>)</b></font><font color="#C0C0C0">	  </font><font color="#808080"><i>-- do conversion and get high byte	
  </i></font><font color="#000080">PIC_ADC_Lbyte <b>= </b>ADRESL</font><font color="#C0C0C0">													</font><font color="#808080"><i>-- get low byte
</i></font><b>end procedure
</b><font color="#808080"><i>-- -----------------------------------------------------------------------------


-- -----------------------------------------------------------------------------
-- internal routine, that
-- calculates aquisition time
-- and determines if right or left justification is optimal
-- -----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">_ad_init_general </font><b>is
</b><font color="#C0C0C0">	</font><font color="#808080"><i>-- if high resolution, right justified, read H + L
</i></font><font color="#C0C0C0">	</font><font color="#808080"><i>-- if low  resolution, left  justified, only read H
  </i></font><b>if </b><font color="#000080">target_chip <b>== </b>pic_12F675 </font><b>then
</b><font color="#C0C0C0">  	</font><b>if </b><font color="#000080">PIC_ADC_high_resolution </font><b>then </b><font color="#000080">_ADCON0_shadow <b>= </b>_ADCON0_shadow <b>| </b></font><font color="#FF0000">0x80 </font><b>end if
  else
</b><font color="#C0C0C0">  	</font><b>if </b><font color="#000080">PIC_ADC_high_resolution </font><b>then </b><font color="#000080">ADCON1 <b>= </b>ADCON1 <b>| </b></font><font color="#FF0000">0x80 </font><b>end if
  end if
</b><font color="#C0C0C0">		
	</font><font color="#808080"><i>-- select the highest possible clock rate
</i></font><font color="#C0C0C0">	</font><font color="#808080"><i>-- that satisfies Tad &gt; 1.6 usec
</i></font><font color="#C0C0C0">	</font><font color="#808080"><i>-- AD converter is always turned ON
  </i></font><b>if </b><font color="#000080">target_chip <b>== </b>pic_12F675 </font><b>then
    </b><font color="#000080">ADCON1 <b>= </b>ADCON1 <b>&amp; </b></font><font color="#FF0000">0b_0000_1111
</font><font color="#C0C0C0">		</font><b>if    </b><font color="#000080">target_clock <b>&gt; </b></font><font color="#FF0000">40_000_000       </font><b>then </b><font color="#000080">ADCON1 <b>= </b>ADCON1 <b>| </b></font><font color="#FF0000">0b_0111_0000
</font><font color="#C0C0C0">		</font><b>elsif </b><font color="#000080">target_clock <b>&gt; </b></font><font color="#FF0000">20_000_000       </font><b>then </b><font color="#000080">ADCON1 <b>= </b>ADCON1 <b>| </b></font><font color="#FF0000">0b_0110_0000
</font><font color="#C0C0C0">		</font><b>elsif </b><font color="#000080">target_clock <b>&gt; </b></font><font color="#FF0000">10_000_000       </font><b>then </b><font color="#000080">ADCON1 <b>= </b>ADCON1 <b>| </b></font><font color="#FF0000">0b_0010_0000
</font><font color="#C0C0C0">		</font><b>elsif </b><font color="#000080">target_clock <b>&gt;  </b></font><font color="#FF0000">5_000_000       </font><b>then </b><font color="#000080">ADCON1 <b>= </b>ADCON1 <b>| </b></font><font color="#FF0000">0b_0101_0000
</font><font color="#C0C0C0">		</font><b>elsif </b><font color="#000080">target_clock <b>&gt; (</b></font><font color="#FF0000">5_000_000 </font><font color="#000080"><b>/ </b></font><font color="#FF0000">2</font><font color="#000080"><b>)  </b></font><b>then </b><font color="#000080">ADCON1 <b>= </b>ADCON1 <b>| </b></font><font color="#FF0000">0b_0001_0000
</font><font color="#C0C0C0">		</font><b>elsif </b><font color="#000080">target_clock <b>&gt; (</b></font><font color="#FF0000">5_000_000 </font><font color="#000080"><b>/ </b></font><font color="#FF0000">4</font><font color="#000080"><b>)  </b></font><b>then </b><font color="#000080">ADCON1 <b>= </b>ADCON1 <b>| </b></font><font color="#FF0000">0b_0100_0000
</font><font color="#C0C0C0">		</font><b>elsif </b><font color="#000080">target_clock <b>&gt; (</b></font><font color="#FF0000">5_000_000 </font><font color="#000080"><b>/ </b></font><font color="#FF0000">8</font><font color="#000080"><b>)  </b></font><b>then </b><font color="#000080">ADCON1 <b>= </b>ADCON1 <b>| </b></font><font color="#FF0000">0b_0000_0000
</font><font color="#C0C0C0">		</font><b>else </b><font color="#000080">ADCON1 <b>= </b>ADCON1 <b>| </b></font><font color="#FF0000">0b_0111_0000
</font><font color="#C0C0C0">		</font><b>end if
  else
</b><font color="#C0C0C0">		</font><b>if    </b><font color="#000080">target_clock <b>&gt;  </b></font><font color="#FF0000">5_000_000       </font><b>then </b><font color="#000080">_ADCON0_shadow <b>= </b></font><font color="#FF0000">0b_1000_0001</font><font color="#C0C0C0">	 
		</font><b>elsif </b><font color="#000080">target_clock <b>&gt; (</b></font><font color="#FF0000">5_000_000 </font><font color="#000080"><b>/ </b></font><font color="#FF0000">4</font><font color="#000080"><b>)  </b></font><b>then </b><font color="#000080">_ADCON0_shadow <b>= </b></font><font color="#FF0000">0b_0100_0001</font><font color="#C0C0C0">	 
		</font><b>elsif </b><font color="#000080">target_clock <b>&gt; (</b></font><font color="#FF0000">5_000_000 </font><font color="#000080"><b>/ </b></font><font color="#FF0000">16</font><font color="#000080"><b>) </b></font><b>then </b><font color="#000080">_ADCON0_shadow <b>= </b></font><font color="#FF0000">0b_0000_0001</font><font color="#C0C0C0">	
		</font><b>else </b><font color="#000080">_ADCON0_shadow <b>= </b></font><font color="#FF0000">0b_1100_0001
</font><font color="#C0C0C0">		</font><b>end if
</b><font color="#C0C0C0">	</font><b>end if
</b><font color="#C0C0C0">	
	</font><font color="#808080"><i>-- calculate AD-conversion time in 10 usec units
</i></font><font color="#C0C0C0">	</font><font color="#808080"><i>-- an extra 10 usec is added to ensure the minimum acquistion time
  </i></font><b>const </b><font color="#000080">PIC_ADC_conversion_delay <b>= (</b></font><font color="#FF0000">10 </font><font color="#000080"><b>+ </b></font><font color="#FF0000">15 </font><font color="#000080"><b>+ (</b>PIC_ADC_Rsource <b>/ </b></font><font color="#FF0000">1_000  </font><font color="#000080"><b>)) / </b></font><font color="#FF0000">10
</font><font color="#C0C0C0">	</font><font color="#000080">_PIC_ADC_conversion_time <b>= </b>PIC_ADC_conversion_delay
</font><b>end procedure
</b><font color="#808080"><i>-- -----------------------------------------------------------------------------


-- -----------------------------------------------------------------------------
-- initializes the PIC AD-converter, when no external Vref is present
-- settings are done according to the special ADC constants
-- sets all the analog pins to input
-- calculates aquisition time
-- and determines if right or left justification is optimal
-- -----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">_PIC_ADC_init_no_Vref </font><b>is
  if </b><font color="#000080">target_chip <b>!= </b>pic_12F675 </font><b>then
</b><font color="#C0C0C0">	  </font><font color="#808080"><i>-- start with left justified
</i></font><font color="#C0C0C0">	  </font><b>if    </b><font color="#000080">PIC_ADC_Nchan <b>== </b></font><font color="#FF0000">1 </font><b>then  </b><font color="#808080"><i>-- chan = 0
</i></font><font color="#C0C0C0">	    </font><font color="#000080">ADCON1 <b>= </b></font><font color="#FF0000">0b_0000_1110  
</font><font color="#C0C0C0">			</font><font color="#000080">pin_A0_direction <b>= </b></font><font color="#FF0000">input</font><font color="#C0C0C0">	 		 		 
	  </font><b>elsif </b><font color="#000080">PIC_ADC_Nchan <b>== </b></font><font color="#FF0000">3 </font><b>then</b><font color="#C0C0C0">	 </font><font color="#808080"><i>-- chan = 0,1,3  (special case!!)
</i></font><font color="#C0C0C0">	    </font><font color="#000080">ADCON1 <b>= </b></font><font color="#FF0000">0b_0000_0100
</font><font color="#C0C0C0">			</font><font color="#000080">pin_A0_direction <b>= </b></font><font color="#FF0000">input</font><font color="#C0C0C0">	 		 		 
			</font><font color="#000080">pin_A1_direction <b>= </b></font><font color="#FF0000">input</font><font color="#C0C0C0">	 		 		 
			</font><font color="#000080">pin_A3_direction <b>= </b></font><font color="#FF0000">input</font><font color="#C0C0C0">	 		 		 
	  </font><b>elsif </b><font color="#000080">PIC_ADC_Nchan <b>== </b></font><font color="#FF0000">5 </font><b>then</b><font color="#C0C0C0">	 </font><font color="#808080"><i>-- chan = 0,1,2,3,4
</i></font><font color="#C0C0C0">	    </font><font color="#000080">ADCON1 <b>= </b></font><font color="#FF0000">0b_0000_0010
</font><font color="#C0C0C0">			</font><font color="#000080">pin_A0_direction <b>= </b></font><font color="#FF0000">input</font><font color="#C0C0C0">	 		 		 
			</font><font color="#000080">pin_A1_direction <b>= </b></font><font color="#FF0000">input</font><font color="#C0C0C0">	 		 		 
			</font><font color="#000080">pin_A2_direction <b>= </b></font><font color="#FF0000">input</font><font color="#C0C0C0">	 		 		 
			</font><font color="#000080">pin_A3_direction <b>= </b></font><font color="#FF0000">input</font><font color="#C0C0C0">	 		 		 
			</font><font color="#000080">pin_A5_direction <b>= </b></font><font color="#FF0000">input</font><font color="#C0C0C0">	 		 		 
	  </font><b>elsif </b><font color="#000080"><b>(</b>PIC_ADC_Nchan <b>== </b></font><font color="#FF0000">6</font><font color="#000080"><b>) &amp; (</b>target_chip <b>== </b>PIC_16F877<b>) </b></font><b>then </b><font color="#808080"><i>-- chan = 0..5
</i></font><font color="#C0C0C0">	    </font><font color="#000080">ADCON1 <b>= </b></font><font color="#FF0000">0b_0000_1001
</font><font color="#C0C0C0">			</font><font color="#000080">pin_A0_direction <b>= </b></font><font color="#FF0000">input</font><font color="#C0C0C0">	 		 		 
			</font><font color="#000080">pin_A1_direction <b>= </b></font><font color="#FF0000">input</font><font color="#C0C0C0">	 		 		 
			</font><font color="#000080">pin_A2_direction <b>= </b></font><font color="#FF0000">input</font><font color="#C0C0C0">	 		 		 
			</font><font color="#000080">pin_A3_direction <b>= </b></font><font color="#FF0000">input</font><font color="#C0C0C0">	 		 		 
			</font><font color="#000080">pin_A5_direction <b>= </b></font><font color="#FF0000">input</font><font color="#C0C0C0">	 		 		 
			</font><font color="#000080">pin_E0_direction <b>= </b></font><font color="#FF0000">input</font><font color="#C0C0C0">	 		 		 
	  </font><b>elsif </b><font color="#000080"><b>(</b>PIC_ADC_Nchan <b>== </b></font><font color="#FF0000">8</font><font color="#000080"><b>) &amp; (</b>target_chip <b>== </b>PIC_16F877<b>) </b></font><b>then </b><font color="#808080"><i>-- chan = 0..7
</i></font><font color="#C0C0C0">	    </font><font color="#000080">ADCON1 <b>= </b></font><font color="#FF0000">0b_0000_0000
</font><font color="#C0C0C0">			</font><font color="#000080">pin_A0_direction <b>= </b></font><font color="#FF0000">input</font><font color="#C0C0C0">	 		 		 
			</font><font color="#000080">pin_A1_direction <b>= </b></font><font color="#FF0000">input</font><font color="#C0C0C0">	 		 		 
			</font><font color="#000080">pin_A2_direction <b>= </b></font><font color="#FF0000">input</font><font color="#C0C0C0">	 		 		 
			</font><font color="#000080">pin_A3_direction <b>= </b></font><font color="#FF0000">input</font><font color="#C0C0C0">	 		 		 
			</font><font color="#000080">pin_A5_direction <b>= </b></font><font color="#FF0000">input</font><font color="#C0C0C0">	 		 		 
			</font><font color="#000080">pin_E0_direction <b>= </b></font><font color="#FF0000">input</font><font color="#C0C0C0">	 		 		 
			</font><font color="#000080">pin_E1_direction <b>= </b></font><font color="#FF0000">input</font><font color="#C0C0C0">	 		 		 
			</font><font color="#000080">pin_E2_direction <b>= </b></font><font color="#FF0000">input</font><font color="#C0C0C0">	 		 		 
	  </font><b>else
</b><font color="#C0C0C0">		  </font><font color="#800080"><i>pragma </i></font><b>error    </b><font color="#808080"><i>-- this number of channels is not available
</i></font><font color="#C0C0C0">		</font><b>end if
</b><font color="#C0C0C0">		
		</font><font color="#808080"><i>-- calculate aquisition delay and optimize justify
</i></font><font color="#C0C0C0">		</font><font color="#000080">_ad_init_general
</font><font color="#C0C0C0">	</font><b>end if
end procedure
</b><font color="#808080"><i>-- -----------------------------------------------------------------------------


-- -----------------------------------------------------------------------------
-- initializes the PIC AD-converter, when only +Vref is present
-- settings are done according to the special ADC constants
-- sets all the analog pins to input
-- calculates aquisition time
-- and determines if right or left justification is optimal
-- -----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">_PIC_ADC_init_1_Vref </font><b>is
  if </b><font color="#000080">target_chip <b>!= </b>pic_12F675 </font><b>then
</b><font color="#C0C0C0">	  </font><font color="#808080"><i>-- start with left justified
</i></font><font color="#C0C0C0">	  </font><b>if    </b><font color="#000080">PIC_ADC_Nchan <b>== </b></font><font color="#FF0000">2 </font><b>then  </b><font color="#808080"><i>-- chan = 0,1
</i></font><font color="#C0C0C0">	    </font><font color="#000080">ADCON1 <b>= </b></font><font color="#FF0000">0b_0000_0101
</font><font color="#C0C0C0">			</font><font color="#000080">pin_A0_direction <b>= </b></font><font color="#FF0000">input</font><font color="#C0C0C0">	 		 		 
			</font><font color="#000080">pin_A1_direction <b>= </b></font><font color="#FF0000">input</font><font color="#C0C0C0">	 		 		 
			</font><font color="#000080">pin_A3_direction <b>= </b></font><font color="#FF0000">input</font><font color="#C0C0C0">					 		 </font><font color="#808080"><i>-- +Vref	 		 		 
</i></font><font color="#C0C0C0">	  </font><b>elsif </b><font color="#000080">PIC_ADC_Nchan <b>== </b></font><font color="#FF0000">4 </font><b>then</b><font color="#C0C0C0">	 </font><font color="#808080"><i>-- chan = 0,1,2
</i></font><font color="#C0C0C0">	    </font><font color="#000080">ADCON1 <b>= </b></font><font color="#FF0000">0b_0000_0011
</font><font color="#C0C0C0">			</font><font color="#000080">pin_A0_direction <b>= </b></font><font color="#FF0000">input</font><font color="#C0C0C0">	 		 		 
			</font><font color="#000080">pin_A1_direction <b>= </b></font><font color="#FF0000">input</font><font color="#C0C0C0">	 		 		 
			</font><font color="#000080">pin_A2_direction <b>= </b></font><font color="#FF0000">input</font><font color="#C0C0C0">	 		 		 
			</font><font color="#000080">pin_A3_direction <b>= </b></font><font color="#FF0000">input</font><font color="#C0C0C0">	 		 		 
	  </font><b>elsif </b><font color="#000080"><b>(</b>PIC_ADC_Nchan <b>== </b></font><font color="#FF0000">5</font><font color="#000080"><b>) &amp; (</b>target_chip <b>== </b>PIC_16F877<b>) </b></font><b>then </b><font color="#808080"><i>-- chan = 0,1,2,4,5
</i></font><font color="#C0C0C0">	    </font><font color="#000080">ADCON1 <b>= </b></font><font color="#FF0000">0b_0000_1001
</font><font color="#C0C0C0">			</font><font color="#000080">pin_A0_direction <b>= </b></font><font color="#FF0000">input</font><font color="#C0C0C0">	 		 		 
			</font><font color="#000080">pin_A1_direction <b>= </b></font><font color="#FF0000">input</font><font color="#C0C0C0">	 		 		 
			</font><font color="#000080">pin_A2_direction <b>= </b></font><font color="#FF0000">input</font><font color="#C0C0C0">	 		 		 
			</font><font color="#000080">pin_A3_direction <b>= </b></font><font color="#FF0000">input</font><font color="#C0C0C0">	 		 		 
			</font><font color="#000080">pin_A5_direction <b>= </b></font><font color="#FF0000">input</font><font color="#C0C0C0">	 		 		 
			</font><font color="#000080">pin_E0_direction <b>= </b></font><font color="#FF0000">input</font><font color="#C0C0C0">	 		 		 
	  </font><b>elsif </b><font color="#000080"><b>(</b>PIC_ADC_Nchan <b>== </b></font><font color="#FF0000">7</font><font color="#000080"><b>) &amp; (</b>target_chip <b>== </b>PIC_16F877<b>) </b></font><b>then </b><font color="#808080"><i>-- chan = 0,1,2,4,5,6,7
</i></font><font color="#C0C0C0">	    </font><font color="#000080">ADCON1 <b>= </b></font><font color="#FF0000">0b_0000_0000
</font><font color="#C0C0C0">			</font><font color="#000080">pin_A0_direction <b>= </b></font><font color="#FF0000">input</font><font color="#C0C0C0">	 		 		 
			</font><font color="#000080">pin_A1_direction <b>= </b></font><font color="#FF0000">input</font><font color="#C0C0C0">	 		 		 
			</font><font color="#000080">pin_A2_direction <b>= </b></font><font color="#FF0000">input</font><font color="#C0C0C0">	 		 		 
			</font><font color="#000080">pin_A3_direction <b>= </b></font><font color="#FF0000">input</font><font color="#C0C0C0">	 		 		 
			</font><font color="#000080">pin_A5_direction <b>= </b></font><font color="#FF0000">input</font><font color="#C0C0C0">	 		 		 
			</font><font color="#000080">pin_E0_direction <b>= </b></font><font color="#FF0000">input</font><font color="#C0C0C0">	 		 		 
			</font><font color="#000080">pin_E1_direction <b>= </b></font><font color="#FF0000">input</font><font color="#C0C0C0">	 		 		 
			</font><font color="#000080">pin_E2_direction <b>= </b></font><font color="#FF0000">input</font><font color="#C0C0C0">	 		 		 
	  </font><b>else
</b><font color="#C0C0C0">		  </font><font color="#800080"><i>pragma </i></font><b>error    </b><font color="#808080"><i>-- this number of channels is not available
</i></font><font color="#C0C0C0">		</font><b>end if
</b><font color="#C0C0C0">		
		</font><font color="#808080"><i>-- calculate aquisition delay and optimize justify
</i></font><font color="#C0C0C0">		</font><font color="#000080">_ad_init_general
  </font><b>end if
end procedure
</b><font color="#808080"><i>-- -----------------------------------------------------------------------------

-- -----------------------------------------------------------------------------
-- initializes the PIC AD-converter, when both +Vref and -Vref are present
-- settings are done according to the special ADC constants
-- sets all the analog pins to input
-- calculates aquisition time
-- and determines if right or left justification is optimal
-- -----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">_PIC_ADC_init_2_Vref </font><b>is
  if </b><font color="#000080">target_chip <b>!= </b>pic_12F675 </font><b>then
</b><font color="#C0C0C0">	  </font><font color="#808080"><i>-- start with left justified
</i></font><font color="#C0C0C0">	  </font><b>if    </b><font color="#000080">PIC_ADC_Nchan <b>== </b></font><font color="#FF0000">1 </font><b>then  </b><font color="#808080"><i>-- chan = 0
</i></font><font color="#C0C0C0">	    </font><font color="#000080">ADCON1 <b>= </b></font><font color="#FF0000">0b_0000_1111
</font><font color="#C0C0C0">			</font><font color="#000080">pin_A0_direction <b>= </b></font><font color="#FF0000">input</font><font color="#C0C0C0">	 		 		 
			</font><font color="#000080">pin_A2_direction <b>= </b></font><font color="#FF0000">input</font><font color="#C0C0C0">	 		 		 		 </font><font color="#808080"><i>-- -Vref
</i></font><font color="#C0C0C0">			</font><font color="#000080">pin_A3_direction <b>= </b></font><font color="#FF0000">input</font><font color="#C0C0C0">					 		 </font><font color="#808080"><i>-- +Vref	 		 		 
</i></font><font color="#C0C0C0">	  </font><b>elsif </b><font color="#000080">PIC_ADC_Nchan <b>== </b></font><font color="#FF0000">2 </font><b>then  </b><font color="#808080"><i>-- chan = 0,1
</i></font><font color="#C0C0C0">	    </font><font color="#000080">ADCON1 <b>= </b></font><font color="#FF0000">0b_0000_1101
</font><font color="#C0C0C0">			</font><font color="#000080">pin_A0_direction <b>= </b></font><font color="#FF0000">input</font><font color="#C0C0C0">	 		 		 
			</font><font color="#000080">pin_A1_direction <b>= </b></font><font color="#FF0000">input</font><font color="#C0C0C0">	 		 		 
			</font><font color="#000080">pin_A2_direction <b>= </b></font><font color="#FF0000">input</font><font color="#C0C0C0">	 		 		 		 </font><font color="#808080"><i>-- -Vref
</i></font><font color="#C0C0C0">			</font><font color="#000080">pin_A3_direction <b>= </b></font><font color="#FF0000">input</font><font color="#C0C0C0">					 		 </font><font color="#808080"><i>-- +Vref	 		 		 
</i></font><font color="#C0C0C0">	  </font><b>elsif </b><font color="#000080">PIC_ADC_Nchan <b>== </b></font><font color="#FF0000">3 </font><b>then</b><font color="#C0C0C0">	 </font><font color="#808080"><i>-- chan = 0,1,4
</i></font><font color="#C0C0C0">	    </font><font color="#000080">ADCON1 <b>= </b></font><font color="#FF0000">0b_0000_1100
</font><font color="#C0C0C0">			</font><font color="#000080">pin_A0_direction <b>= </b></font><font color="#FF0000">input</font><font color="#C0C0C0">	 		 		 
			</font><font color="#000080">pin_A1_direction <b>= </b></font><font color="#FF0000">input</font><font color="#C0C0C0">	 		 		 
			</font><font color="#000080">pin_A2_direction <b>= </b></font><font color="#FF0000">input</font><font color="#C0C0C0">	 		 		 		 </font><font color="#808080"><i>-- -Vref
</i></font><font color="#C0C0C0">			</font><font color="#000080">pin_A3_direction <b>= </b></font><font color="#FF0000">input</font><font color="#C0C0C0">					 		 </font><font color="#808080"><i>-- +Vref	 		 		 
</i></font><font color="#C0C0C0">			</font><font color="#000080">pin_A4_direction <b>= </b></font><font color="#FF0000">input</font><font color="#C0C0C0">	 		 		 
	  </font><b>elsif </b><font color="#000080"><b>(</b>PIC_ADC_Nchan <b>== </b></font><font color="#FF0000">4</font><font color="#000080"><b>) &amp; (</b>target_chip <b>== </b>PIC_16F877<b>) </b></font><b>then </b><font color="#808080"><i>-- chan = 0,1,4,5
</i></font><font color="#C0C0C0">	    </font><font color="#000080">ADCON1 <b>= </b></font><font color="#FF0000">0b_0000_1011
</font><font color="#C0C0C0">			</font><font color="#000080">pin_A0_direction <b>= </b></font><font color="#FF0000">input</font><font color="#C0C0C0">	 		 		 
			</font><font color="#000080">pin_A1_direction <b>= </b></font><font color="#FF0000">input</font><font color="#C0C0C0">	 		 		 
			</font><font color="#000080">pin_A2_direction <b>= </b></font><font color="#FF0000">input</font><font color="#C0C0C0">	 		 		 		 </font><font color="#808080"><i>-- -Vref
</i></font><font color="#C0C0C0">			</font><font color="#000080">pin_A3_direction <b>= </b></font><font color="#FF0000">input</font><font color="#C0C0C0">					 		 </font><font color="#808080"><i>-- +Vref	 		 		 
</i></font><font color="#C0C0C0">			</font><font color="#000080">pin_A5_direction <b>= </b></font><font color="#FF0000">input</font><font color="#C0C0C0">	 		 		 
			</font><font color="#000080">pin_E0_direction <b>= </b></font><font color="#FF0000">input</font><font color="#C0C0C0">	 		 		 
	  </font><b>elsif </b><font color="#000080"><b>(</b>PIC_ADC_Nchan <b>== </b></font><font color="#FF0000">6</font><font color="#000080"><b>) &amp; (</b>target_chip <b>== </b>PIC_16F877<b>) </b></font><b>then </b><font color="#808080"><i>-- chan = 0,1,4,5,6,7
</i></font><font color="#C0C0C0">	    </font><font color="#000080">ADCON1 <b>= </b></font><font color="#FF0000">0b_0000_1000
</font><font color="#C0C0C0">			</font><font color="#000080">pin_A0_direction <b>= </b></font><font color="#FF0000">input</font><font color="#C0C0C0">	 		 		 
			</font><font color="#000080">pin_A1_direction <b>= </b></font><font color="#FF0000">input</font><font color="#C0C0C0">	 		 		 
			</font><font color="#000080">pin_A2_direction <b>= </b></font><font color="#FF0000">input</font><font color="#C0C0C0">	 		 		 		 </font><font color="#808080"><i>-- -Vref
</i></font><font color="#C0C0C0">			</font><font color="#000080">pin_A3_direction <b>= </b></font><font color="#FF0000">input</font><font color="#C0C0C0">					 		 </font><font color="#808080"><i>-- +Vref	 		 		 
</i></font><font color="#C0C0C0">			</font><font color="#000080">pin_A5_direction <b>= </b></font><font color="#FF0000">input</font><font color="#C0C0C0">	 		 		 
			</font><font color="#000080">pin_E0_direction <b>= </b></font><font color="#FF0000">input</font><font color="#C0C0C0">	 		 		 
			</font><font color="#000080">pin_E1_direction <b>= </b></font><font color="#FF0000">input</font><font color="#C0C0C0">	 		 		 
			</font><font color="#000080">pin_E2_direction <b>= </b></font><font color="#FF0000">input</font><font color="#C0C0C0">	 		 		 
	  </font><b>else
</b><font color="#C0C0C0">		  </font><font color="#800080"><i>pragma </i></font><b>error    </b><font color="#808080"><i>-- this number of channels is not available
</i></font><font color="#C0C0C0">		</font><b>end if
</b><font color="#C0C0C0">		
		</font><font color="#808080"><i>-- calculate aquisition delay and optimize justify
</i></font><font color="#C0C0C0">		</font><font color="#000080">_ad_init_general
</font><font color="#C0C0C0">	</font><b>end if
end procedure
</b><font color="#808080"><i>-- -----------------------------------------------------------------------------


-- -----------------------------------------------------------------------------
-- initializes the PIC AD-converter,
-- by calling the correct routine according to the number of external references
-- settings are done according to the special ADC constants
-- sets all the analog pins to input
-- calculates aquisition time
-- and determines if right or left justification is optimal
-- -----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">PIC_ADC_init </font><b>is
  if </b><font color="#000080">target_chip <b>== </b>pic_12F675 </font><b>then
    if    </b><font color="#000080">PIC_ADC_NVref <b>== </b></font><font color="#FF0000">0 </font><b>then
</b><font color="#C0C0C0">		  </font><font color="#000080">_ADCON0_shadow <b>= </b></font><font color="#FF0000">1
</font><font color="#C0C0C0">		</font><b>else
</b><font color="#C0C0C0">		  </font><font color="#000080">_ADCON0_shadow <b>= </b></font><font color="#FF0000">0x41
</font><font color="#C0C0C0">		</font><b>end if

    </b><font color="#000080">ADCON1 <b>= </b>PIC_ADC_Nchan

</font><font color="#C0C0C0">		</font><font color="#808080"><i>-- calculate aquisition delay and optimize justify
</i></font><font color="#C0C0C0">		</font><font color="#000080">_ad_init_general
  </font><b>else
</b><font color="#C0C0C0">	  </font><b>if    </b><font color="#000080">PIC_ADC_NVref <b>== </b></font><font color="#FF0000">0 </font><b>then </b><font color="#000080">_PIC_ADC_init_NO_Vref
</font><font color="#C0C0C0">	  </font><b>elsif </b><font color="#000080">PIC_ADC_NVref <b>== </b></font><font color="#FF0000">1 </font><b>then </b><font color="#000080">_PIC_ADC_init_1_Vref
</font><font color="#C0C0C0">	  </font><b>else                          </b><font color="#000080">_PIC_ADC_init_2_Vref
</font><font color="#C0C0C0">	  </font><b>end if
</b><font color="#C0C0C0">	</font><b>end if
end procedure
</b><font color="#808080"><i>-- -----------------------------------------------------------------------------

</i></font></font>
</code></pre>
</body>
</html>
