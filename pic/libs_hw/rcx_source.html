<html>
<head>
<title>JALcc SourceCode exporting of rcx_source.html</title>
</head>
<!-- Generated by SynEdit HTML exporter -->
<body text="#000000" bgcolor="#FFFFFF">
<pre>
<code><font  size=3 face="Courier New"><font color="#000080"><A href="rcx.jal">download&nbsp;rcx.jal</A>
</font><font color="#808080"><i>-- -----------------------------------------------------------------------------
-- &lt;title RCX remote
-- &lt;License
-- freeware, under the terms of the GNU GPL
--  Copyright (C) 2002 Stef Mientki
-- -----------------------------------------------------------------------------
-- &lt;Description
-- Remote control by IR of the RCX
--
-- &lt;version 1.0  somwhere 2002,  Stef Mientki
--   - original release
-- -----------------------------------------------------------------------------


-- -----------------------------------------------------------------------------
-- &lt;Example RCX
; var volatile bit IR_out is pin_a4           -- IR diode
; var volatile bit IR_dir is pin_a4_direction -- to set it as an ouput
; const bit        IR_off =  high             -- IR diodes between IO and +5V
;                                             -- if IR diodes between IO and GND
;                                             -- then set IR_off = low
; include RCX
;
;    -- motor A forward
;    RCX_motor_A_on = RCX_motor_on
;    RCX_motor_A_direction = RCX_motor_forward
;    RCX_motor_power = RCX_motor_power_A
;    RCX_update_motor (motor_A)
;
; -- see RCX documentation for more examples
; -- program RCX_REMOTE1.JAL is a complete program, with extended remote capabilities
-- -----------------------------------------------------------------------------

-- &lt;code

-- remote commands 0xD2 (always 2 arguments)
</i></font><b>const byte </b><font color="#000080">RCX_remcmd           <b>= </b></font><font color="#FF0000">0xD2
</font><b>const byte </b><font color="#000080">RCX_remcmd_stop      <b>= </b></font><font color="#FF0000">0
</font><b>const byte </b><font color="#000080">RCX_remcmd_Prog1     <b>= </b></font><font color="#FF0000">1
</font><b>const byte </b><font color="#000080">RCX_remcmd_Prog2     <b>= </b></font><font color="#FF0000">2
</font><b>const byte </b><font color="#000080">RCX_remcmd_Prog3     <b>= </b></font><font color="#FF0000">3
</font><b>const byte </b><font color="#000080">RCX_remcmd_Prog4     <b>= </b></font><font color="#FF0000">4
</font><b>const byte </b><font color="#000080">RCX_remcmd_Prog5     <b>= </b></font><font color="#FF0000">5
</font><b>const byte </b><font color="#000080">RCX_remcmd_motA_forw <b>= </b></font><font color="#FF0000">6
</font><b>const byte </b><font color="#000080">RCX_remcmd_motA_back <b>= </b></font><font color="#FF0000">7
</font><b>const byte </b><font color="#000080">RCX_remcmd_motB_forw <b>= </b></font><font color="#FF0000">8
</font><b>const byte </b><font color="#000080">RCX_remcmd_motB_back <b>= </b></font><font color="#FF0000">9
</font><b>const byte </b><font color="#000080">RCX_remcmd_motC_forw <b>= </b></font><font color="#FF0000">10
</font><b>const byte </b><font color="#000080">RCX_remcmd_motC_back <b>= </b></font><font color="#FF0000">11
</font><b>const byte </b><font color="#000080">RCX_remcmd_mess1     <b>= </b></font><font color="#FF0000">12
</font><b>const byte </b><font color="#000080">RCX_remcmd_mess2     <b>= </b></font><font color="#FF0000">13
</font><b>const byte </b><font color="#000080">RCX_remcmd_mess3     <b>= </b></font><font color="#FF0000">14
</font><b>const byte </b><font color="#000080">RCX_remcmd_sound     <b>= </b></font><font color="#FF0000">15

</font><b>const byte </b><font color="#000080">RCX_sound2           <b>= </b></font><font color="#FF0000">16

</font><b>const </b><font color="#000080">RCX_cmd_motorON_AC        <b>= </b></font><font color="#FF0000">17
</font><b>const </b><font color="#000080">RCX_cmd_motorOFF_AC       <b>= </b></font><font color="#FF0000">18
</font><b>const </b><font color="#000080">RCX_cmd_inc_power_AC      <b>= </b></font><font color="#FF0000">19
</font><b>const </b><font color="#000080">RCX_cmd_dec_power_AC      <b>= </b></font><font color="#FF0000">20

</font><b>const </b><font color="#000080">RCX_cmd_motor_A_forw      <b>= </b></font><font color="#FF0000">21
</font><b>const </b><font color="#000080">RCX_cmd_motor_A_back      <b>= </b></font><font color="#FF0000">22
</font><b>const </b><font color="#000080">RCX_cmd_motor_B_forw      <b>= </b></font><font color="#FF0000">23
</font><b>const </b><font color="#000080">RCX_cmd_motor_B_back      <b>= </b></font><font color="#FF0000">24
</font><b>const </b><font color="#000080">RCX_cmd_motor_C_forw      <b>= </b></font><font color="#FF0000">25
</font><b>const </b><font color="#000080">RCX_cmd_motor_C_back      <b>= </b></font><font color="#FF0000">26

</font><b>const </b><font color="#000080">RCX_cmd_motor_power       <b>= </b></font><font color="#FF0000">27
</font><b>const </b><font color="#000080">RCX_cmd_motor_direction   <b>= </b></font><font color="#FF0000">28
</font><b>const </b><font color="#000080">RCX_cmd_motor_on          <b>= </b></font><font color="#FF0000">29
</font><b>const </b><font color="#000080">RCX_cmd_motor_off         <b>= </b></font><font color="#FF0000">30

</font><b>const </b><font color="#000080">RCX_motor_change          <b>= </b></font><font color="#FF0000">31
</font><b>const </b><font color="#000080">RCX_cmd_NULL              <b>= </b></font><font color="#FF0000">32

</font><b>const byte </b><font color="#000080">RCX_cmd_playtone     <b>= </b></font><font color="#FF0000">0x02  </font><font color="#808080"><i>-- var=? , duration (1/100 sec)


-- motorlist ..mmm = ..CBA
</i></font><b>const byte </b><font color="#000080">_RCX_cmd_setpower_AC <b>= </b></font><font color="#FF0000">0x13  </font><font color="#808080"><i>-- 0000_0mmm , 2 , 0..7
</i></font><b>const byte </b><font color="#000080">_RCX_cmd_setpower_B  <b>= </b></font><font color="#FF0000">0x13  </font><font color="#808080"><i>-- 0000_0mmm , 2 , 0..7
</i></font><b>const byte </b><font color="#000080">_RCX_cmd_motor       <b>= </b></font><font color="#FF0000">0x21  </font><font color="#808080"><i>-- sc00_0mmm  s=ON, c=OFF, sc=FLOAT


</i></font><b>var byte </b><font color="#000080">_RCX_motor_power_AC    <b>= </b></font><font color="#FF0000">0
</font><b>var byte </b><font color="#000080">_RCX_motor_power_B     <b>= </b></font><font color="#FF0000">0

</font><b>var byte </b><font color="#000080">RCX_motor_list      </font><font color="#808080"><i>-- xxxx_xCBA
</i></font><b>var byte </b><font color="#000080">RCX_motor_power     </font><font color="#808080"><i>-- 0..7
</i></font><b>var bit  </b><font color="#000080">RCX_motor_direction </font><font color="#808080"><i>-- forward = $80, backwards = 00

-- const byte _RCX_cmd_A_forw      = 0xE1
-- const RCX_cmd_motor_A_forw      = 21
--      ($E1,$16,0),   {Set Motor Direction}
--      ($13,$E4,0),   {Set Motor Power}
--      ($21,$D6,0),   {Set Motor On/Off}

--      ($10,$E7,0),   {Alive}
--      ($30,$C7,2),   {Get Battery Power}
--      ($22,$D5,0),   {Set Time}
--      ($31,$C6,0),   {Set Transmitter Range}
--      ($B1,$46,0),   {Set Power Down Delay}
--      ($60,$97,0),   {Power Off}

--      ($05,$F2,0),   {Set Source}

--      ($12,$E5,2),   {Get Value}
--      ($14,$E3,0),   {Set Var}
--      ($24,$D3,0),   {Add to Var}
--      ($34,$C3,0),   {Subtract Var}
--      ($54,$A3,0),   {Multiply Var}
--      ($44,$B3,0),   {Divide Var}
--      ($84,$73,0),   {AND Var}
--      ($94,$63,0),   {OR Var}
--      ($74,$83,0),   {Absolute Value}
--      ($64,$93,0),   {Sign Var}

--      ($52,$A5,1),   {Set Datalog Size}
--      ($62,$95,1),   {Datalog Next}
--      ($A4,$53,$FF), {Upload DataLog}

--      ($42,$B5,0),   {Set Sensor Mode}
--      ($32,$C5,0),   {Set Sensor Type}
--      ($D1,$26,0),   {Clear Sensor}
--      ($A1,$56,0),   {Clear Timer}

--      ($E1,$16,0),   {Set Motor Direction}
--      ($13,$E4,0),   {Set Motor Power}
--      ($21,$D6,0),   {Set Motor On/Off}

--      ($51,$A6,0),   {Play Sound}
--      ($23,$D4,0),   {Play Tone}
--      ($33,$C4,0),   {Set Display}

--      ($91,$66,0),   {Set Program Number}
--      ($71,$86,0),   {Start Task}
--      ($25,$D2,1),   {Start Task Download}
--      ($45,$B2,1),   {Transfer Data}
--      ($81,$76,0),   {Stop Task}
--      ($50,$A7,0),   {Stop All Tasks}
--      ($61,$96,0),   {Delete Task}
--      ($40,$B7,0),   {Delete All Tasks}
--      ($35,$C2,1),   {Start Subroutine Download}
--      ($C1,$36,0),   {Delete Subroutine}
--      ($70,$87,0),   {Delete All Subroutines}

--      ($15,$E2,4),   {Unlock Brick}
--      ($75,$82,1),   {Start Firmware Download}
--      ($A5,$52,25),  {Unlock Firmware}
--      ($65,$92,0),   {Delete Firmware}
--      ($20,$D7,188), {Get Memory Map}

--      ($D2,$00,0)    {remote command, no reply !!}


-- -----------------------------------------------------------------------------
-- &quot;local&quot; variables,
-- which are global in this unit
-- -----------------------------------------------------------------------------
</i></font><b>var byte </b><font color="#000080">_IR_send_byte          </font><font color="#808080"><i>-- current IR byte to send
</i></font><b>var byte </b><font color="#000080">_IR_send_bitcnt <b>= </b></font><font color="#FF0000">0xFF </font><font color="#808080"><i>-- disable IR-transmission
</i></font><b>var bit  </b><font color="#000080">_IR_send_busy <b>= </b></font><font color="#FF0000">true   </font><font color="#808080"><i>-- must be false
</i></font><b>var bit  </b><font color="#000080">_IR_out_bit            </font><font color="#808080"><i>-- IR send bit transported to interrupt routine

-- 2* 38 kHz / 2400 Baud = 31.7 half-cycles
</i></font><b>const byte </b><font color="#000080">IR_half_cycles_in_bit <b>= </b></font><font color="#FF0000">32

</font><b>var byte </b><font color="#000080">_IR_send_bytecnt       </font><font color="#808080"><i>-- state counter for sending RCX string
</i></font><b>var byte </b><font color="#000080">_IR_send_RCX_cmd       </font><font color="#808080"><i>-- RCX command
</i></font><b>var byte </b><font color="#000080">_IR_send_RCX_narg      </font><font color="#808080"><i>-- number of arguments, depending on RCX command
</i></font><b>var byte </b><font color="#000080">_IR_send_RCX_arg1      </font><font color="#808080"><i>-- first argument to send
</i></font><b>var byte </b><font color="#000080">_IR_send_RCX_arg2      </font><font color="#808080"><i>-- second argument to send
</i></font><b>var byte </b><font color="#000080">_IR_send_RCX_arg3      </font><font color="#808080"><i>-- second argument to send

</i></font><b>var byte </b><font color="#000080">_last_RCX_cmd <b>= </b></font><font color="#FF0000">0      </font><font color="#808080"><i>-- necessary for toggling 0x08 bit

</i></font><b>var byte </b><font color="#000080">_counter_hf_pulses     <b>= </b></font><font color="#FF0000">0  </font><font color="#808080"><i>-- incremented by interrupt routine
</i></font><b>var byte </b><font color="#000080">_counter_hf_pulses_old <b>= </b></font><font color="#FF0000">0  </font><font color="#808080"><i>-- to count the number of interrupts


-- -----------------------------------------------------------------------------
-- -----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">interrupt_init </font><b>is
  </b><font color="#808080"><i>-- disable all interrupts and wait till condition satisfied
  </i></font><b>while </b><font color="#000080">gie </font><b>loop </b><font color="#000080">gie <b>= </b></font><font color="#FF0000">false </font><b>end loop

  var byte </b><font color="#000080">opt </font><b>at </b><font color="#FF0000">0x01
  </font><font color="#800080"><i>assembler
    </i></font><font color="#000080">bsf    _status<b>, </b></font><font color="#FF0000">5      </font><font color="#808080"><i>-- goto BANK 1
    </i></font><font color="#000080">movfw  opt             </font><font color="#808080"><i>-- W = option
    </i></font><font color="#000080">andlw  </font><font color="#FF0000">0b_0101_0000    </font><font color="#808080"><i>-- Enable pull ups,T0source=clkout,
                           -- Prescaler-&gt;T0, prescaler=0
    </i></font><font color="#000080">iorlw  </font><font color="#FF0000">0b_0000_1000    </font><font color="#808080"><i>-- set PSA, (prescaler to watchdog)
    </i></font><font color="#000080">clrwdt                 </font><font color="#808080"><i>-- clear watchdog timer, why ??
    </i></font><font color="#000080">movwf  opt             </font><font color="#808080"><i>-- option = W
    </i></font><font color="#000080">bcf    _status<b>, </b></font><font color="#FF0000">5      </font><font color="#808080"><i>-- goto BANK 0
  </i></font><b>end </b><font color="#800080"><i>assembler

  </i></font><font color="#000080">T0ie <b>= </b></font><font color="#FF0000">true      </font><font color="#808080"><i>-- unmask T0 interrupt
  </i></font><font color="#000080">gie  <b>= </b></font><font color="#FF0000">true      </font><font color="#808080"><i>-- enable (unmasked) interrupts
</i></font><b>end procedure
</b><font color="#808080"><i>-- -----------------------------------------------------------------------------


-- -----------------------------------------------------------------------------
-- 38 kHz oscillator/modulator for the IR-transmitter
-- the oscillator is modulated by IR_OUT_BIT,
-- which is manipulated by the program main loop
--
-- timing is based on a 20 Mc X-tal
-- delay fully in timer0 register, to get as less interrupts as possible
-- -----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">IR_send_interrupt_handler </font><b>is
</b><font color="#000080"><b>&lt;</b></font><font color="#800080"><i>mac</i></font><font color="#000080"><b>&gt; </b>interrupt_sub IR_send_interrupt_handler T0IF </font><font color="#FF0000">5
  </font><font color="#808080"><i>-- first action: preset timer0 counter again
  -- 38 kHz, half period = 13.2 usec
  -- Xtal 20 MHz, T0 = 5 Mhz =&gt; 0.2 usec
  -- so there should be 13.2 / 0.2 = 66 ticks ==&gt; tmr0=-65
  -- for some reason we loose some ticks/instructions, pushes ??
  </i></font><font color="#000080">tmr0 <b>= -</b></font><font color="#FF0000">46

  </font><font color="#808080"><i>-- only control IR diode if necessary,
  -- portpin maybe also used for other purposes
  </i></font><b>if </b><font color="#000080">_IR_send_bytecnt <b>&gt; </b></font><font color="#FF0000">0 </font><b>then
    </b><font color="#808080"><i>-- toggle IR output if &quot;1&quot; else turn it off
    </i></font><b>if </b><font color="#000080">_IR_out_bit </font><b>then </b><font color="#000080">IR_out <b>= ! </b>IR_out
    </font><b>else </b><font color="#000080">IR_out <b>= </b>IR_off
    </font><b>end if
  end if

  </b><font color="#808080"><i>-- increment counter for the outside world
  </i></font><font color="#000080">_counter_hf_pulses <b>= </b>_counter_hf_pulses <b>+ </b></font><font color="#FF0000">1

  </font><font color="#808080"><i>-- last action: clear TOIF to re-enable timer interrupts
  </i></font><font color="#000080">t0if <b>= </b></font><font color="#FF0000">false
</font><b>end procedure
</b><font color="#808080"><i>-- -----------------------------------------------------------------------------


-- -----------------------------------------------------------------------------
-- IR send of next bit, sets up the information for the interrupt routine,
-- which does the IR-modulation 38 kHz .. 40 kHz
-- to start, put data in IR_send_byte, set IR_send_bitcnt=0
-- then waiting for IR_send_bitcnt=11 gives 1 stopbit
-- then waiting for IR_send_bitcnt=12 gives 2 stopbits
-- -----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">IR_send_next_bit </font><b>is
var bit </b><font color="#000080">_current_bit </font><b>at </b><font color="#000080">_IR_send_byte <b>: </b></font><font color="#FF0000">0     </font><font color="#808080"><i>-- start with LSB
</i></font><b>var bit </b><font color="#000080">_IR_send_parity

  </font><b>if </b><font color="#000080">_IR_send_bitcnt <b>== </b></font><font color="#FF0000">0 </font><b>then
    </b><font color="#000080">_IR_out_bit <b>= </b></font><font color="#FF0000">true                        </font><font color="#808080"><i>-- 1 start bit
    </i></font><font color="#000080">_IR_send_parity <b>= </b></font><font color="#FF0000">false                   </font><font color="#808080"><i>-- initialize parity

  </i></font><b>elsif </b><font color="#000080">_IR_send_bitcnt <b>== </b></font><font color="#FF0000">9 </font><b>then
    </b><font color="#000080">_IR_out_bit <b>= </b>_IR_send_parity             </font><font color="#808080"><i>-- parity bit

  </i></font><b>elsif </b><font color="#000080">_IR_send_bitcnt <b>&gt;= </b></font><font color="#FF0000">10
    </font><b>then </b><font color="#000080">_IR_out_bit <b>= </b></font><font color="#FF0000">false                  </font><font color="#808080"><i>-- rest stop bits

  </i></font><b>else
    </b><font color="#000080">_IR_out_bit <b>= ! </b>_current_bit              </font><font color="#808080"><i>-- data is inverted !!
                                              -- IR modulation if &quot;0&quot;
    </i></font><b>if </b><font color="#000080">_current_bit </font><b>then
      </b><font color="#000080">_IR_send_parity <b>= ! </b>_IR_send_parity     </font><font color="#808080"><i>-- track parity
    </i></font><b>end if
    </b><font color="#000080">_IR_send_byte <b>= </b>_IR_send_byte <b>&gt;&gt; </b></font><font color="#FF0000">1        </font><font color="#808080"><i>-- get next bit
  </i></font><b>end if
  
  if </b><font color="#000080">_IR_send_bitcnt <b>&lt; </b></font><font color="#FF0000">0xFF </font><b>then              </b><font color="#808080"><i>-- prevent overflow
    </i></font><font color="#000080">_IR_send_bitcnt <b>= </b>_IR_send_bitcnt <b>+ </b></font><font color="#FF0000">1     </font><font color="#808080"><i>-- update bit count
  </i></font><b>end if
end procedure
</b><font color="#808080"><i>-- -----------------------------------------------------------------------------


-- -----------------------------------------------------------------------------
-- to start:
-- set IR_send_bytecnt to N+1
-- (initially, set IR_send_bitcnt = 0xFF = no start of IR transmitting yet)
--
-- In normal RCX communication as well in remote control commands,
-- all information is transported in a packet.
-- Every command or every complete download is packed in a packet.
-- The packet consists of
--  * HEADER, always 55 FF 00 (in receiving the first byte &quot;55&quot; isn't always
--    reliable)
--  * DATABYTES, where each databyte is followed by it's complement.
--    So if you've to send &quot;55 F7&quot;, you would have to send &quot;55 AA F7 08&quot;
--  * CHECKSUM, that is the sum over all real databytes.
--    Also the checksum is followed by its complement !
--  IMPORTANT, RCX never executes same exact opcode twice in a row,
--  therefor every command has 2 occurences, one with the third bit set and
--  the other with third bit reset.
--  So you've to toggle this third bit if you want a command sent twice.
-- -----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">IR_send_next_RCX_byte </font><b>is
  if </b><font color="#000080">_IR_send_bitcnt <b>&lt;= </b></font><font color="#FF0000">10 </font><b>then </b><font color="#000080">IR_send_next_bit </font><b>end if
  
  </b><font color="#808080"><i>-- this must be a separate if-loop, because RCX expects only 1 stopbit,
  -- on sending the last bit (IR_send_bitcnt = 10 ==&gt; 11),
  -- both the previous loop and this loop must be executed
  </i></font><b>if </b><font color="#000080">_IR_send_bitcnt <b>&gt;= </b></font><font color="#FF0000">11 </font><b>then
    </b><font color="#808080"><i>-- if still more bytes to send, continue
    </i></font><b>if </b><font color="#000080">_IR_send_bytecnt <b>&gt; </b></font><font color="#FF0000">0 </font><b>then
      if </b><font color="#000080">_IR_send_bytecnt <b>== </b></font><font color="#FF0000">14 </font><b>then </b><font color="#000080">_IR_send_byte <b>= </b></font><font color="#FF0000">0x55
      </font><b>elsif </b><font color="#000080">_IR_send_bytecnt <b>== </b></font><font color="#FF0000">13 </font><b>then </b><font color="#000080">_IR_send_byte <b>= </b></font><font color="#FF0000">0xFF
      </font><b>elsif </b><font color="#000080">_IR_send_bytecnt <b>== </b></font><font color="#FF0000">12 </font><b>then </b><font color="#000080">_IR_send_byte <b>= </b></font><font color="#FF0000">0x00
      </font><b>elsif </b><font color="#000080">_IR_send_bytecnt <b>== </b></font><font color="#FF0000">11 </font><b>then
        if </b><font color="#000080">_last_RCX_cmd <b>== </b>_IR_send_RCX_cmd </font><b>then
          </b><font color="#000080">_IR_send_RCX_cmd <b>= </b>_IR_send_RCX_cmd <b>^ </b></font><font color="#FF0000">0x08
        </font><b>end if
        </b><font color="#000080">_last_RCX_cmd <b>= </b>_IR_send_RCX_cmd
        _IR_send_byte <b>= </b>_IR_send_RCX_cmd
      </font><b>elsif </b><font color="#000080">_IR_send_bytecnt <b>== </b></font><font color="#FF0000">10 </font><b>then </b><font color="#000080">_IR_send_byte <b>= </b>_IR_send_RCX_cmd <b>^ </b></font><font color="#FF0000">0xFF
      </font><b>elsif </b><font color="#000080">_IR_send_bytecnt <b>== </b></font><font color="#FF0000">9 </font><b>then
        if </b><font color="#000080">_IR_send_RCX_narg <b>&gt;= </b></font><font color="#FF0000">1 </font><b>then </b><font color="#000080">_IR_send_byte <b>= </b>_IR_send_RCX_arg1
        </font><b>else </b><font color="#000080">_IR_send_bytecnt <b>= </b></font><font color="#FF0000">3 </font><b>end if
      elsif </b><font color="#000080">_IR_send_bytecnt <b>== </b></font><font color="#FF0000">8 </font><b>then </b><font color="#000080">_IR_send_byte <b>= </b>_IR_send_RCX_arg1 <b>^ </b></font><font color="#FF0000">0xFF
      </font><b>elsif </b><font color="#000080">_IR_send_bytecnt <b>== </b></font><font color="#FF0000">7 </font><b>then
        if </b><font color="#000080">_IR_send_RCX_narg <b>&gt;= </b></font><font color="#FF0000">2 </font><b>then </b><font color="#000080">_IR_send_byte <b>= </b>_IR_send_RCX_arg2
        </font><b>else </b><font color="#000080">_IR_send_bytecnt <b>= </b></font><font color="#FF0000">3 </font><b>end if

      elsif </b><font color="#000080">_IR_send_bytecnt <b>== </b></font><font color="#FF0000">6 </font><b>then </b><font color="#000080">_IR_send_byte <b>= </b>_IR_send_RCX_arg2 <b>^ </b></font><font color="#FF0000">0xFF
      </font><b>elsif </b><font color="#000080">_IR_send_bytecnt <b>== </b></font><font color="#FF0000">5 </font><b>then
        if </b><font color="#000080">_IR_send_RCX_narg <b>&gt;= </b></font><font color="#FF0000">3 </font><b>then </b><font color="#000080">_IR_send_byte <b>= </b>_IR_send_RCX_arg3
        </font><b>else </b><font color="#000080">_IR_send_bytecnt <b>= </b></font><font color="#FF0000">3 </font><b>end if


      elsif </b><font color="#000080">_IR_send_bytecnt <b>== </b></font><font color="#FF0000">4 </font><b>then </b><font color="#000080">_IR_send_byte <b>= </b>_IR_send_RCX_arg3 <b>^ </b></font><font color="#FF0000">0xFF
      </font><b>end if

      </b><font color="#808080"><i>-- new test, because in the previous test some states could be jumped over
      </i></font><b>if </b><font color="#000080">_IR_send_bytecnt <b>== </b></font><font color="#FF0000">3 </font><b>then
        if </b><font color="#000080">_IR_send_RCX_narg <b>&gt;= </b></font><font color="#FF0000">1 </font><b>then
          </b><font color="#000080">_IR_send_RCX_cmd <b>= </b>_IR_send_RCX_cmd <b>+ </b>_IR_send_RCX_arg1
          </font><b>if </b><font color="#000080">_IR_send_RCX_narg <b>&gt;= </b></font><font color="#FF0000">2 </font><b>then
            </b><font color="#000080">_IR_send_RCX_cmd <b>= </b>_IR_send_RCX_cmd <b>+ </b>_IR_send_RCX_arg2
            </font><b>if </b><font color="#000080">_IR_send_RCX_narg <b>&gt;= </b></font><font color="#FF0000">3 </font><b>then
              </b><font color="#000080">_IR_send_RCX_cmd <b>= </b>_IR_send_RCX_cmd <b>+ </b>_IR_send_RCX_arg3
            </font><b>end if
          end if
        end if
        </b><font color="#000080">_IR_send_byte <b>= </b>_IR_send_RCX_cmd
      </font><b>elsif </b><font color="#000080">_IR_send_bytecnt <b>== </b></font><font color="#FF0000">2 </font><b>then </b><font color="#000080">_IR_send_byte <b>= </b>_IR_send_RCX_cmd <b>^ </b></font><font color="#FF0000">0xFF
      </font><b>end if

      </b><font color="#808080"><i>-- update byte counter, and start transmission of next byte if not ready
      </i></font><font color="#000080">_IR_send_bytecnt <b>= </b>_IR_send_bytecnt <b>- </b></font><font color="#FF0000">1
      </font><b>if </b><font color="#000080">_IR_send_bytecnt <b>&gt; </b></font><font color="#FF0000">0 </font><b>then </b><font color="#000080">_IR_send_bitcnt <b>= </b></font><font color="#FF0000">0 </font><b>end if
    end if
  end if
end procedure
</b><font color="#808080"><i>-- -----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">IR_send_next_RCX_byte2 </font><b>is
  if </b><font color="#000080">_IR_send_bitcnt <b>&lt;= </b></font><font color="#FF0000">10 </font><b>then </b><font color="#000080">IR_send_next_bit </font><b>end if

  </b><font color="#808080"><i>-- this must be a separate if-loop, because RCX expects only 1 stopbit,
  -- on sending the last bit (IR_send_bitcnt = 10 ==&gt; 11),
  -- both the previous loop and this loop must be executed
  </i></font><b>if </b><font color="#000080">_IR_send_bitcnt <b>&gt;= </b></font><font color="#FF0000">11 </font><b>then
    </b><font color="#808080"><i>-- if still more bytes to send, continue
    </i></font><b>if </b><font color="#000080">_IR_send_bytecnt <b>&gt; </b></font><font color="#FF0000">0 </font><b>then
      if </b><font color="#000080">_IR_send_bytecnt <b>== </b></font><font color="#FF0000">12 </font><b>then </b><font color="#000080">_IR_send_byte <b>= </b></font><font color="#FF0000">0x55
      </font><b>elsif </b><font color="#000080">_IR_send_bytecnt <b>== </b></font><font color="#FF0000">11 </font><b>then </b><font color="#000080">_IR_send_byte <b>= </b></font><font color="#FF0000">0xFF
      </font><b>elsif </b><font color="#000080">_IR_send_bytecnt <b>== </b></font><font color="#FF0000">10 </font><b>then </b><font color="#000080">_IR_send_byte <b>= </b></font><font color="#FF0000">0x00
      </font><b>elsif </b><font color="#000080">_IR_send_bytecnt <b>== </b></font><font color="#FF0000">9 </font><b>then
        if </b><font color="#000080">_last_RCX_cmd <b>== </b>_IR_send_RCX_cmd </font><b>then
          </b><font color="#000080">_IR_send_RCX_cmd <b>= </b>_IR_send_RCX_cmd <b>^ </b></font><font color="#FF0000">0x08
        </font><b>end if
        </b><font color="#000080">_last_RCX_cmd <b>= </b>_IR_send_RCX_cmd
        _IR_send_byte <b>= </b>_IR_send_RCX_cmd
      </font><b>elsif </b><font color="#000080">_IR_send_bytecnt <b>== </b></font><font color="#FF0000">8 </font><b>then </b><font color="#000080">_IR_send_byte <b>= </b>_IR_send_RCX_cmd <b>^ </b></font><font color="#FF0000">0xFF
      </font><b>elsif </b><font color="#000080">_IR_send_bytecnt <b>== </b></font><font color="#FF0000">7 </font><b>then
        if </b><font color="#000080">_IR_send_RCX_narg <b>&gt;= </b></font><font color="#FF0000">1 </font><b>then </b><font color="#000080">_IR_send_byte <b>= </b>_IR_send_RCX_arg1
        </font><b>else </b><font color="#000080">_IR_send_bytecnt <b>= </b></font><font color="#FF0000">3 </font><b>end if
      elsif </b><font color="#000080">_IR_send_bytecnt <b>== </b></font><font color="#FF0000">6 </font><b>then </b><font color="#000080">_IR_send_byte <b>= </b>_IR_send_RCX_arg1 <b>^ </b></font><font color="#FF0000">0xFF
      </font><b>elsif </b><font color="#000080">_IR_send_bytecnt <b>== </b></font><font color="#FF0000">5 </font><b>then
        if </b><font color="#000080">_IR_send_RCX_narg <b>&gt;= </b></font><font color="#FF0000">2 </font><b>then </b><font color="#000080">_IR_send_byte <b>= </b>_IR_send_RCX_arg2
        </font><b>else </b><font color="#000080">_IR_send_bytecnt <b>= </b></font><font color="#FF0000">3 </font><b>end if
      elsif </b><font color="#000080">_IR_send_bytecnt <b>== </b></font><font color="#FF0000">4 </font><b>then </b><font color="#000080">_IR_send_byte <b>= </b>_IR_send_RCX_arg2 <b>^ </b></font><font color="#FF0000">0xFF
      </font><b>end if

      </b><font color="#808080"><i>-- new test, because in the previous test some states could be jumped over
      </i></font><b>if </b><font color="#000080">_IR_send_bytecnt <b>== </b></font><font color="#FF0000">3 </font><b>then
        if </b><font color="#000080">_IR_send_RCX_narg <b>&gt;= </b></font><font color="#FF0000">1 </font><b>then
          </b><font color="#000080">_IR_send_RCX_cmd <b>= </b>_IR_send_RCX_cmd <b>+ </b>_IR_send_RCX_arg1
          </font><b>if </b><font color="#000080">_IR_send_RCX_narg <b>&gt;= </b></font><font color="#FF0000">2 </font><b>then
            </b><font color="#000080">_IR_send_RCX_cmd <b>= </b>_IR_send_RCX_cmd <b>+ </b>_IR_send_RCX_arg2
          </font><b>end if
        end if
        </b><font color="#000080">_IR_send_byte <b>= </b>_IR_send_RCX_cmd
      </font><b>elsif </b><font color="#000080">_IR_send_bytecnt <b>== </b></font><font color="#FF0000">2 </font><b>then </b><font color="#000080">_IR_send_byte <b>= </b>_IR_send_RCX_cmd <b>^ </b></font><font color="#FF0000">0xFF
      </font><b>end if

      </b><font color="#808080"><i>-- update byte counter, and start transmission of next byte if not ready
      </i></font><font color="#000080">_IR_send_bytecnt <b>= </b>_IR_send_bytecnt <b>- </b></font><font color="#FF0000">1
      </font><b>if </b><font color="#000080">_IR_send_bytecnt <b>&gt; </b></font><font color="#FF0000">0 </font><b>then </b><font color="#000080">_IR_send_bitcnt <b>= </b></font><font color="#FF0000">0 </font><b>end if
    end if
  end if
end procedure
</b><font color="#808080"><i>-- -----------------------------------------------------------------------------



-- -----------------------------------------------------------------------------
-- checks if the duration of 1 bit-time is passed
-- -----------------------------------------------------------------------------
</i></font><b>function </b><font color="#000080">RCX_bittime </font><b>return bit is
var byte </b><font color="#000080">_delta

  </font><font color="#808080"><i>-- calculate how many TMR0 interrupts have occured
  </i></font><font color="#000080">_delta <b>= </b>_counter_hf_pulses <b>- </b>_counter_hf_pulses_old

  </font><font color="#808080"><i>-- correct for possible overflow
  </i></font><b>if </b><font color="#000080"><b>(</b>_delta <b>&amp; </b></font><font color="#FF0000">0x80 </font><font color="#000080"><b>) != </b></font><font color="#FF0000">0 </font><b>then
    </b><font color="#000080">_delta <b>= ( ! </b>_delta <b>) + </b></font><font color="#FF0000">1
  </font><b>end if

  if </b><font color="#000080">_delta <b>&gt;= </b>IR_half_cycles_in_bit </font><b>then
     </b><font color="#000080">_counter_hf_pulses_old <b>= </b>_counter_hf_pulses
    </font><b>return </b><font color="#FF0000">false
  </font><b>else
    return </b><font color="#FF0000">true
  </font><b>end if

end function
</b><font color="#808080"><i>-- -----------------------------------------------------------------------------


-- -----------------------------------------------------------------------------
-- prepares are global variables to send a complete RCX-command
-- -----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">RCX_send_command <b>( </b></font><b>byte in </b><font color="#000080">RCX_cmd <b>) </b></font><b>is
  </b><font color="#808080"><i>-- because in the case of a remote command always 1 argument is zero,
  -- it's somewhat more efficient to set both to zero at the start
  </i></font><font color="#000080">_IR_send_RCX_cmd <b>= </b>RCX_remcmd     </font><font color="#808080"><i>-- remote command
  </i></font><font color="#000080">_IR_send_RCX_arg1 <b>= </b></font><font color="#FF0000">0x00          </font><font color="#808080"><i>-- nothing
  </i></font><font color="#000080">_IR_send_RCX_arg2 <b>= </b></font><font color="#FF0000">0x00          </font><font color="#808080"><i>-- nothing
  </i></font><font color="#000080">_IR_send_RCX_arg3 <b>= </b></font><font color="#FF0000">0x00          </font><font color="#808080"><i>-- nothing

  </i></font><b>if </b><font color="#000080">RCX_cmd <b>== </b>RCX_cmd_NULL </font><b>then   </b><font color="#808080"><i>-- special &quot;inbetween&quot; command
  </i></font><b>elsif </b><font color="#000080">RCX_cmd <b>== </b>RCX_remcmd_prog1 </font><b>then
    </b><font color="#000080">_IR_send_RCX_arg1 <b>= </b></font><font color="#FF0000">0x02    </font><font color="#808080"><i>-- Program 1
  </i></font><b>elsif </b><font color="#000080">RCX_cmd <b>== </b>RCX_remcmd_prog2 </font><b>then
    </b><font color="#000080">_IR_send_RCX_arg1 <b>= </b></font><font color="#FF0000">0x04    </font><font color="#808080"><i>-- Program 2
  </i></font><b>elsif </b><font color="#000080">RCX_cmd <b>== </b>RCX_remcmd_prog3 </font><b>then
    </b><font color="#000080">_IR_send_RCX_arg1 <b>= </b></font><font color="#FF0000">0x08    </font><font color="#808080"><i>-- Program 3
  </i></font><b>elsif </b><font color="#000080">RCX_cmd <b>== </b>RCX_remcmd_prog4 </font><b>then
    </b><font color="#000080">_IR_send_RCX_arg1 <b>= </b></font><font color="#FF0000">0x10    </font><font color="#808080"><i>-- Program 4
  </i></font><b>elsif </b><font color="#000080">RCX_cmd <b>== </b>RCX_remcmd_prog5 </font><b>then
    </b><font color="#000080">_IR_send_RCX_arg1 <b>= </b></font><font color="#FF0000">0x20    </font><font color="#808080"><i>-- Program 5
  </i></font><b>elsif </b><font color="#000080">RCX_cmd <b>== </b>RCX_remcmd_stop </font><b>then
    </b><font color="#000080">_IR_send_RCX_arg1 <b>= </b></font><font color="#FF0000">0x40    </font><font color="#808080"><i>-- Stop all programs and motors
  </i></font><b>elsif </b><font color="#000080">RCX_cmd <b>== </b>RCX_remcmd_motA_forw </font><b>then
    </b><font color="#000080">_IR_send_RCX_arg2 <b>= </b></font><font color="#FF0000">0x08    </font><font color="#808080"><i>-- motor A forward
  </i></font><b>elsif </b><font color="#000080">RCX_cmd <b>== </b>RCX_remcmd_motA_back </font><b>then
    </b><font color="#000080">_IR_send_RCX_arg2 <b>= </b></font><font color="#FF0000">0x40    </font><font color="#808080"><i>-- motor A backward
  </i></font><b>elsif </b><font color="#000080">RCX_cmd <b>== </b>RCX_remcmd_motB_forw </font><b>then
    </b><font color="#000080">_IR_send_RCX_arg2 <b>= </b></font><font color="#FF0000">0x10    </font><font color="#808080"><i>-- motor B forward
  </i></font><b>elsif </b><font color="#000080">RCX_cmd <b>== </b>RCX_remcmd_motB_back </font><b>then
    </b><font color="#000080">_IR_send_RCX_arg2 <b>= </b></font><font color="#FF0000">0x80    </font><font color="#808080"><i>-- motor B forward
  </i></font><b>elsif </b><font color="#000080">RCX_cmd <b>== </b>RCX_remcmd_motC_forw </font><b>then
    </b><font color="#000080">_IR_send_RCX_arg2 <b>= </b></font><font color="#FF0000">0x20    </font><font color="#808080"><i>-- motor C forward
  </i></font><b>elsif </b><font color="#000080">RCX_cmd <b>== </b>RCX_remcmd_motC_back </font><b>then
    </b><font color="#000080">_IR_send_RCX_arg1 <b>= </b></font><font color="#FF0000">0x01    </font><font color="#808080"><i>-- nothing
  </i></font><b>elsif </b><font color="#000080">RCX_cmd <b>== </b>RCX_remcmd_mess1 </font><b>then
    </b><font color="#000080">_IR_send_RCX_arg2 <b>= </b></font><font color="#FF0000">0x01    </font><font color="#808080"><i>-- nothing
  </i></font><b>elsif </b><font color="#000080">RCX_cmd <b>== </b>RCX_remcmd_mess2 </font><b>then
    </b><font color="#000080">_IR_send_RCX_arg2 <b>= </b></font><font color="#FF0000">0x02    </font><font color="#808080"><i>-- RCX message 1
  </i></font><b>elsif </b><font color="#000080">RCX_cmd <b>== </b>RCX_remcmd_mess3 </font><b>then
    </b><font color="#000080">_IR_send_RCX_arg2 <b>= </b></font><font color="#FF0000">0x04    </font><font color="#808080"><i>-- nothing
  </i></font><b>elsif </b><font color="#000080">RCX_cmd <b>== </b>RCX_sound2 </font><b>then
    </b><font color="#000080">_IR_send_RCX_cmd  <b>= </b></font><font color="#FF0000">0x51    </font><font color="#808080"><i>-- playsound
    </i></font><font color="#000080">_IR_send_RCX_arg1 <b>= </b></font><font color="#FF0000">0x02    </font><font color="#808080"><i>-- sound = 2

  </i></font><b>elsif </b><font color="#000080">RCX_cmd <b>== </b>RCX_cmd_motorON_AC  </font><b>then
    </b><font color="#000080">_IR_send_RCX_cmd  <b>= </b>_RCX_cmd_motor
    _IR_send_RCX_arg1 <b>= </b></font><font color="#FF0000">0x85

  </font><b>elsif </b><font color="#000080">RCX_cmd <b>== </b>RCX_cmd_inc_power_AC  </font><b>then
    if </b><font color="#000080">_RCX_motor_power_AC <b>&lt;= </b></font><font color="#FF0000">7 </font><b>then
      </b><font color="#000080">_IR_send_RCX_cmd  <b>= </b>_RCX_cmd_setpower_AC
      _IR_send_RCX_arg1 <b>= </b></font><font color="#FF0000">0x85
      </font><font color="#000080">_IR_send_RCX_arg2 <b>= </b></font><font color="#FF0000">2     </font><font color="#808080"><i>-- source is constant
      </i></font><font color="#000080">_RCX_motor_power_AC <b>= </b>_RCX_motor_power_AC <b>+ </b></font><font color="#FF0000">1
      </font><font color="#000080">_IR_send_RCX_arg3 <b>= </b>_RCX_motor_power_AC
    </font><b>end if
  elsif </b><font color="#000080">RCX_cmd <b>== </b>RCX_cmd_dec_power_AC  </font><b>then
    if </b><font color="#000080">_RCX_motor_power_AC <b>&gt; </b></font><font color="#FF0000">0 </font><b>then
      </b><font color="#000080">_IR_send_RCX_cmd  <b>= </b>_RCX_cmd_setpower_AC
      _IR_send_RCX_arg1 <b>= </b></font><font color="#FF0000">0x85
      </font><font color="#000080">_IR_send_RCX_arg2 <b>= </b></font><font color="#FF0000">2     </font><font color="#808080"><i>-- source is constant
      </i></font><font color="#000080">_RCX_motor_power_AC <b>= </b>_RCX_motor_power_AC <b>- </b></font><font color="#FF0000">1
      </font><font color="#000080">_IR_send_RCX_arg3 <b>= </b>_RCX_motor_power_AC
    </font><b>end if
</b><font color="#808080"><i>-- const RCX_cmd_motor_power =
-- const RCX_cmd_motor_direction =
-- const RCX_cmd_motor_on =
-- const RCX_cmd_motor_off =
</i></font><b>var byte </b><font color="#000080">RCX_motor_list     </font><font color="#808080"><i>-- xxxx_xCBA
</i></font><b>var byte </b><font color="#000080">RCX_motor_power


  </font><b>elsif  </b><font color="#000080">RCX_cmd <b>== </b>RCX_cmd_motor_power </font><b>then
    </b><font color="#000080">_IR_send_RCX_cmd  <b>= </b></font><font color="#FF0000">0x13
    </font><font color="#000080">_IR_send_RCX_arg1 <b>= </b>RCX_motor_list  </font><font color="#808080"><i>-- 0000_0CBA
    </i></font><font color="#000080">_IR_send_RCX_arg2 <b>= </b></font><font color="#FF0000">2               </font><font color="#808080"><i>-- source is a constant
    </i></font><font color="#000080">_IR_send_RCX_arg3 <b>= </b>RCX_motor_power </font><font color="#808080"><i>-- power 0..7
                                          -- on RCX displayed as 1..8
      
  </i></font><b>elsif  </b><font color="#000080">RCX_cmd <b>== </b>RCX_cmd_motor_direction </font><b>then
    </b><font color="#000080">_IR_send_RCX_cmd  <b>= </b></font><font color="#FF0000">0xE1
    </font><b>if </b><font color="#000080">RCX_motor_direction </font><b>then
      </b><font color="#000080">_IR_send_RCX_arg1 <b>= </b>RCX_motor_list <b>| </b></font><font color="#FF0000">0x80
    </font><b>else
      </b><font color="#000080">_IR_send_RCX_arg1 <b>= </b>RCX_motor_list
    </font><b>end if
    
  elsif  </b><font color="#000080">RCX_cmd <b>== </b>RCX_cmd_motor_on </font><b>then
    </b><font color="#000080">_IR_send_RCX_cmd  <b>= </b></font><font color="#FF0000">0x21
    </font><font color="#000080">_IR_send_RCX_arg1 <b>= </b>RCX_motor_list <b>| </b></font><font color="#FF0000">0x80
  </font><b>elsif  </b><font color="#000080">RCX_cmd <b>== </b>RCX_cmd_motor_off </font><b>then
    </b><font color="#000080">_IR_send_RCX_cmd  <b>= </b></font><font color="#FF0000">0x21
    </font><font color="#000080">_IR_send_RCX_arg1 <b>= </b>RCX_motor_list <b>| </b></font><font color="#FF0000">0x40


      
</font><font color="#808080"><i>-- const byte _RCX_cmd_A_forw      = 0xE1
-- const RCX_cmd_motor_A_forw      = 21
--      ($E1,$16,0),   {Set Motor Direction}
--      ($13,$E4,0),   {Set Motor Power}
--      ($21,$D6,0),   {Set Motor On/Off}

-- motorlist ..mmm = ..CBA
</i></font><b>const byte </b><font color="#000080">_RCX_cmd_setpower_AC <b>= </b></font><font color="#FF0000">0x13  </font><font color="#808080"><i>-- 0000_0mmm , 2 , 0..7
</i></font><b>const byte </b><font color="#000080">_RCX_cmd_setpower_B  <b>= </b></font><font color="#FF0000">0x13  </font><font color="#808080"><i>-- 0000_0mmm , 2 , 0..7
</i></font><b>const byte </b><font color="#000080">_RCX_cmd_motor       <b>= </b></font><font color="#FF0000">0x21  </font><font color="#808080"><i>-- sc00_0mmm  s=ON, c=OFF, sc=FLOAT
</i></font><b>var byte </b><font color="#000080">_RCX_motor_power_AC    <b>= </b></font><font color="#FF0000">0
</font><b>var byte </b><font color="#000080">_RCX_motor_power_B     <b>= </b></font><font color="#FF0000">0


  </font><b>else
    </b><font color="#000080">_IR_send_RCX_arg1 <b>= </b></font><font color="#FF0000">0x80    </font><font color="#808080"><i>-- remote sound
  </i></font><b>end if

  </b><font color="#808080"><i>-- last 2 bits of cmd is nr args
  </i></font><font color="#000080">_IR_send_RCX_narg <b>= </b>_IR_send_RCX_cmd <b>&amp; </b></font><font color="#FF0000">0x03

  </font><font color="#808080"><i>-- bytecount is always 12 (maximum numebr of bytes to send)
  </i></font><font color="#000080">_IR_send_bytecnt <b>= </b></font><font color="#FF0000">12

  </font><font color="#808080"><i>-- set no start of IR transmitting yet, see procedure IR_send_next_RCX_byte
  </i></font><font color="#000080">_IR_send_bitcnt <b>= </b></font><font color="#FF0000">0xFF

  </font><font color="#808080"><i>-- if the port was used for something else,
  -- ensure it's output now for sending IR data to the RCX
  </i></font><font color="#000080">IR_dir <b>= </b></font><font color="#FF0000">output
</font><b>end procedure
</b><font color="#808080"><i>-- -----------------------------------------------------------------------------


-- -----------------------------------------------------------------------------
-- transmit complete RCX-commandstring and
-- wait till transmission is completed
--
-- it's possible to put these statements into the main program loop,
-- to do something else in the time left (very little),
-- but this is not encouraged, because the timing is very critical
-- -----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">RCX_send_command_and_wait <b>( </b></font><b>byte in </b><font color="#000080">cmd<b>) </b></font><b>is

  </b><font color="#808080"><i>-- prepare RCX command
  -- (start of IR-modulator is done by IR_send_next_RCX_byte)
  </i></font><font color="#000080">RCX_send_command <b>( </b>cmd <b>)

  </b></font><font color="#808080"><i>-- initialize bittimer
  </i></font><font color="#000080">_counter_hf_pulses_old <b>= </b>_counter_hf_pulses

  </font><font color="#808080"><i>-- loop untill all bytes are sent
  </i></font><b>while </b><font color="#000080">_IR_send_bytecnt <b>&gt; </b></font><font color="#FF0000">0 </font><b>loop

    </b><font color="#808080"><i>-- start next bit or byte
    -- (also starts the first bit)
    </i></font><font color="#000080">IR_send_next_RCX_byte
    
    </font><font color="#808080"><i>-- now wait for the duration of 1 bit
    </i></font><b>while </b><font color="#000080">RCX_bittime </font><b>loop
    end loop

  end loop
end procedure
</b><font color="#808080"><i>-- -----------------------------------------------------------------------------


-- -----------------------------------------------------------------------------
-- For non-remote commands, the RCX will give a respons. So the next command
-- from the remote control must wait until this respons is finished.
--
-- This routine may be called for other delay purposes.
-- The delay is about 35 msec
-- -----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">RCX_wait_for_respons </font><b>is
var bit </b><font color="#000080">xxx
  </font><b>for </b><font color="#FF0000">50 </font><b>loop  </b><font color="#808080"><i>-- 40 is too low
    </i></font><b>for </b><font color="#FF0000">250 </font><b>loop
      </b><font color="#000080">xxx <b>= ! </b>xxx
    </font><b>end loop
  end loop
end procedure
</b><font color="#808080"><i>-- -----------------------------------------------------------------------------



-- motorlist ..mmm = ..CBA
-- const byte _RCX_cmd_setpower_AC = 0x13  -- 0000_0mmm , 2 , 0..7
-- const byte _RCX_cmd_setpower_B  = 0x13  -- 0000_0mmm , 2 , 0..7
-- const byte _RCX_cmd_motor       = 0x21  -- sc00_0mmm  s=ON, c=OFF, sc=FLOAT


</i></font><b>const </b><font color="#000080">motor_A <b>= </b></font><font color="#FF0000">1
</font><b>const </b><font color="#000080">motor_B <b>= </b></font><font color="#FF0000">2
</font><b>const </b><font color="#000080">motor_C <b>= </b></font><font color="#FF0000">4
</font><b>var byte </b><font color="#000080">RCX_motor_dir_on <b>= </b></font><font color="#FF0000">0   </font><font color="#808080"><i>-- 0CBA_0CBA msb=forward=0, lsb=on=1
</i></font><b>var byte </b><font color="#000080">RCX_motor_directions </font><b>is </b><font color="#000080">RCX_motor_dir_on

</font><b>var bit </b><font color="#000080">RCX_motor_A_on        </font><b>at </b><font color="#000080">RCX_motor_dir_on <b>: </b></font><font color="#FF0000">0
</font><b>var bit </b><font color="#000080">RCX_motor_B_on        </font><b>at </b><font color="#000080">RCX_motor_dir_on <b>: </b></font><font color="#FF0000">1
</font><b>var bit </b><font color="#000080">RCX_motor_C_on        </font><b>at </b><font color="#000080">RCX_motor_dir_on <b>: </b></font><font color="#FF0000">2
</font><b>var bit </b><font color="#000080">RCX_motor_A_direction </font><b>at </b><font color="#000080">RCX_motor_dir_on <b>: </b></font><font color="#FF0000">4
</font><b>var bit </b><font color="#000080">RCX_motor_B_direction </font><b>at </b><font color="#000080">RCX_motor_dir_on <b>: </b></font><font color="#FF0000">5
</font><b>var bit </b><font color="#000080">RCX_motor_C_direction </font><b>at </b><font color="#000080">RCX_motor_dir_on <b>: </b></font><font color="#FF0000">6

</font><b>const </b><font color="#000080">RCX_motor_forward <b>= </b></font><font color="#FF0000">true
</font><b>const </b><font color="#000080">RCX_motor_backward <b>= ! </b>RCX_motor_forward
</font><b>const </b><font color="#000080">RCX_motor_on      <b>= </b></font><font color="#FF0000">true



</font><font color="#808080"><i>-- -----------------------------------------------------------------------------
-- -----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">RCX_update_motor <b>( </b></font><b>byte in </b><font color="#000080">motor <b>) </b></font><b>is
  </b><font color="#808080"><i>-- not always necessary, but to keep it simple,
  -- always send all motor information
  
  -- first prepare status bytes
  </i></font><font color="#000080">RCX_motor_list <b>= </b>motor
  RCX_motor_direction <b>= (</b>RCX_motor_dir_on <b>&amp; (</b>motor <b>&lt;&lt; </b></font><font color="#FF0000">4</font><font color="#000080"><b>) ) &gt; </b></font><font color="#FF0000">0

  </font><font color="#808080"><i>-- first send motorpower
  </i></font><font color="#000080">RCX_send_command_and_wait <b>( </b>RCX_cmd_motor_power <b>)
  </b>RCX_wait_for_respons

  </font><font color="#808080"><i>-- then send motor direction
  </i></font><font color="#000080">RCX_send_command_and_wait <b>( </b>RCX_cmd_motor_direction <b>)
  </b>RCX_wait_for_respons

  </font><font color="#808080"><i>-- then send motor on/off
  </i></font><b>if </b><font color="#000080"><b>( </b>RCX_motor_dir_on <b>&amp; </b>motor <b>) &gt; </b></font><font color="#FF0000">0 </font><b>then
    </b><font color="#000080">RCX_send_command_and_wait <b>( </b>RCX_cmd_motor_on <b>)
  </b></font><b>else
    </b><font color="#000080">RCX_send_command_and_wait <b>( </b>RCX_cmd_motor_off <b>)
  </b></font><b>end if
end procedure
</b><font color="#808080"><i>-- -----------------------------------------------------------------------------

;procedure aap (byte in x, byte op in out = 5) is
;end procedure




-- -----------------------------------------------------------------------------
-- INITIALIZATION
-- -----------------------------------------------------------------------------
  </i></font><font color="#000080">interrupt_init


</font></font>
</code></pre>
</body>
</html>
