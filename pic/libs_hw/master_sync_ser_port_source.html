<html>
<head>
<title>JALcc SourceCode exporting of master_sync_ser_port_source.html</title>
</head>
<!-- Generated by SynEdit HTML exporter -->
<body text="#000000" bgcolor="#FFFFFF">
<pre>
<code><font  size=3 face="Courier New"><font color="#000080"><A href="master_sync_ser_port.jal">download&nbsp;master_sync_ser_port.jal</A>
</font><font color="#808080"><i>-- -----------------------------------------------------------------------------
-- &lt;title control of the MSSP-SPI module
-- &lt;License
-- freeware, under the terms of the GNU GPL
--  Copyright (C) 2002 Stef Mientki
-- -----------------------------------------------------------------------------
-- &lt;Description
-- --------------------------------------------------------------------
-- library to use the MSSP-SPI module
-- limitations:
--     - only master mode supported
--		 - only SysClock  /4  /16  /64 supported, otherwise error message
--     - Clock/Data timing always according Texas Instruments / Burr Brown SPI

-- procedure SPI_init_mssp
-- procedure SPI_enable_mssp
-- procedure SPI_disable_mssp
-- procedure SPI_init_mssp
-- procedure SPI_mssp_wait_until_ready
-- procedure SPI_send_mssp ( byte in x )
-- procedure SPI_read_mssp( byte out x )

-- &lt;Version: 1.2  17-10-2003  Stef Mientki
--   - SMP-bit (in SSPSTAT) was set wrong, I think ??
--   - const SPI_mode now can select TI, HP modes
--	 - Setting of C3 and C5 direction was not through shadow, fixed !
--
-- &lt;Version: 1.1  1-03-2003  Stef Mientki
--   - procedure SPI_mssp_wait_until_ready added
-- &lt;Version: 1.0  1-03-2003, Stef Mientki
--   -  orginal release
-- --------------------------------------------------------------------



-- --------------------------------------------------------------------
-- &lt;Example SPI
; -- set the SPI-clock frequency, wanted by the user
; -- at the moment only System_clock /4  /16  /64 are supported
; -- for other frequencies TMR2 is required
; -- User must set the required SPI clock rate before including this library
; -- User must select a protocol, to define clock-idle and sampling-edge
;
; const SPI_clock = target_clock / 16  ;20Mc/16 = 1_250_000
; const SPI_mode  = 1                  ;0=TI, 1=HP
; include master_sync_ser_port				 ;include library and initialize
;
-- -----------------------------------------------------------------------------


-- &lt;code


-- --------------------------------------------------------------------
-- global variables
-- --------------------------------------------------------------------
</i></font><b>var volatile bit </b><font color="#000080">_SPI_clock_idle
</font><font color="#808080"><i>-- --------------------------------------------------------------------


-- --------------------------------------------------------------------
-- calculation of the clockfrequency
-- this code is just evaluated during compilation and generates no code
-- --------------------------------------------------------------------
-- this will calculate the SSPM bits 1 too high
-- and if no equality was found the result is zero
</i></font><b>const </b><font color="#000080">__SPI_clock <b>=  </b></font><font color="#FF0000">1 </font><font color="#000080"><b>* ( </b>SPI_clock <b>? (</b>target_clock <b>/ </b></font><font color="#FF0000">4</font><font color="#000080"><b>)  ) +
                     </b></font><font color="#FF0000">2 </font><font color="#000080"><b>* ( </b>SPI_clock <b>? (</b>target_clock <b>/ </b></font><font color="#FF0000">16</font><font color="#000080"><b>) ) +
                     </b></font><font color="#FF0000">3 </font><font color="#000080"><b>* ( </b>SPI_clock <b>? (</b>target_clock <b>/ </b></font><font color="#FF0000">64</font><font color="#000080"><b>) )
</b></font><font color="#808080"><i>-- so the real bits are found by rotating the result
-- 1 step left in the modulo-4 space
</i></font><b>const </b><font color="#000080">_SPI_clock <b>= ( </b>__SPI_clock <b>+ </b></font><font color="#FF0000">3 </font><font color="#000080"><b>) % </b></font><font color="#FF0000">4

</font><font color="#808080"><i>-- at the moment only clock derived from system clock is supported
-- so no TMR2 support
</i></font><b>if </b><font color="#000080">_SPI_clock <b>== </b></font><font color="#FF0000">3 </font><b>then
  </b><font color="#800080"><i>pragma </i></font><b>error  </b><font color="#808080"><i>-- at the moment to TMR2 support
</i></font><b>end if 
</b><font color="#808080"><i>-- --------------------------------------------------------------------


-- --------------------------------------------------------------------
-- enable SPI-mssp
-- this routine will also clear IF and set the correct TRIS registers
-- --------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">SPI_enable_mssp </font><b>is
  </b><font color="#808080"><i>-- enable SPI, CKP(bit4)=clock idle, according to chosen mode
  </i></font><b>if </b><font color="#000080">_SPI_clock_idle <b>== </b></font><b>high then
    </b><font color="#000080">SSPCON <b>= </b></font><font color="#FF0000">0b_0011_0000 </font><font color="#000080"><b>| </b>_SPI_clock 
  </font><b>else
    </b><font color="#000080">SSPCON <b>= </b></font><font color="#FF0000">0b_0010_0000 </font><font color="#000080"><b>| </b>_SPI_clock 
  </font><b>end if
  
  </b><font color="#808080"><i>-- start condition for fast asynchronuous SPI
  </i></font><font color="#000080">SSPIF <b>= </b></font><font color="#FF0000">true

  </font><font color="#808080"><i>-- set clock and SDO as outputs
  </i></font><font color="#000080">port_C_direction <b>= </b>port_C_direction  <b>&amp; </b></font><font color="#FF0000">0b_1101_0111
</font><b>end procedure
</b><font color="#808080"><i>-- --------------------------------------------------------------------


-- --------------------------------------------------------------------
-- disable SPI-mssp
-- --------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">SPI_disable_mssp </font><b>is
  </b><font color="#808080"><i>-- disable SPI, clock idle=low
  </i></font><font color="#000080">SSPCON <b>= </b>SSPCON <b>&amp; </b></font><font color="#FF0000">0b_1101_1111
</font><b>end procedure
</b><font color="#808080"><i>-- --------------------------------------------------------------------


-- --------------------------------------------------------------------
-- init and enable SPI-mssp
-- The following protocols are implemented
-- TI=0 : clock_idle=low, sampling on falling edge
-- HP=1 : clock_idle=high, sampling on rising edge
-- --------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">SPI_init_mssp </font><b>is
  </b><font color="#808080"><i>-- disable all MSSP interrupts
  </i></font><font color="#000080">_PIE1 <b>= </b>_PIE1 <b>&amp; (! </b></font><font color="#FF0000">_b_SSPIE</font><font color="#000080"><b>)

  </b></font><font color="#808080"><i>-- SSPSTAT = SMP - CKE - ...
  -- TI:        0     0
  -- HP:        0     0
  ; SSPSTAT = 0b_1000_0000  Volgens mij is dit niet juist 17-10-2002
  ; immers dit zet SMP=1, dwz een verschoven input data ????
  </i></font><font color="#000080">SSPSTAT <b>= </b></font><font color="#FF0000">0b_0000_0000
  
  </font><b>if </b><font color="#000080">SPI_mode <b>== </b></font><font color="#FF0000">0 </font><b>then
    </b><font color="#000080">_SPI_clock_idle <b>= </b></font><b>low   </b><font color="#808080"><i>-- TI
  </i></font><b>else
    </b><font color="#000080">_SPI_clock_idle <b>= </b></font><b>high</b><font color="#C0C0C0">	</font><font color="#808080"><i>-- HP
  </i></font><b>end if

  </b><font color="#000080">SPI_enable_mssp
</font><b>end procedure
</b><font color="#808080"><i>-- --------------------------------------------------------------------


-- --------------------------------------------------------------------
-- wait till last command (read or write) is finished
-- so calling program can release CS
-- --------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">SPI_mssp_wait_until_ready </font><b>is
  </b><font color="#808080"><i>-- wait till transmission ready 
  </i></font><b>while </b><font color="#000080"><b>! </b>SSPIF </font><b>loop end loop
end procedure
</b><font color="#808080"><i>-- --------------------------------------------------------------------


-- --------------------------------------------------------------------
-- Send a SPI byte
-- assumes SPI is enabled, waits till transmission finished
-- --------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">SPI_send_mssp <b>( </b></font><b>byte in </b><font color="#000080">x <b>) </b></font><b>is
  </b><font color="#808080"><i>-- wait till transmission ready 
  </i></font><b>while </b><font color="#000080"><b>! </b>SSPIF </font><b>loop end loop
  </b><font color="#808080"><i>-- fill SPI buffer
  </i></font><font color="#000080">SSPBUF <b>= </b>x
  </font><font color="#808080"><i>-- clear SSPIF, realy necessary !!
  </i></font><font color="#000080">SSPIF <b>= </b></font><font color="#FF0000">false
</font><b>end procedure
</b><font color="#808080"><i>-- --------------------------------------------------------------------


-- --------------------------------------------------------------------
-- Read a SPI byte
-- assumes SPI is enabled
-- --------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">SPI_read_mssp <b>( </b></font><b>byte out </b><font color="#000080">x <b>) </b></font><b>is
  </b><font color="#808080"><i>-- wait till transmission ready 
  </i></font><b>while  </b><font color="#000080"><b>! </b>SSPIF </font><b>loop end loop
  
  </b><font color="#808080"><i>-- maybe strange, but reception is started by transmitting something !!
  </i></font><font color="#000080">SSPBUF <b>= </b></font><font color="#FF0000">0

  </font><font color="#808080"><i>-- clear SSPIF
  </i></font><font color="#000080">SSPIF <b>= </b></font><font color="#FF0000">false
  
  </font><font color="#808080"><i>-- transport the read data
  </i></font><b>while  </b><font color="#000080"><b>! </b>SSPIF </font><b>loop end loop
  </b><font color="#000080">x <b>= </b>SSPBUF
</font><b>end procedure
</b><font color="#808080"><i>-- --------------------------------------------------------------------


-- --------------------------------------------------------------------
-- initialization, depending on the parameters set by the user
-- --------------------------------------------------------------------
</i></font><font color="#000080">spi_init_mssp
</font><font color="#808080"><i>-- --------------------------------------------------------------------

</i></font></font>
</code></pre>
</body>
</html>
