<html>
<head>
<title>JALcc SourceCode exporting of hd44780_4_source.html</title>
</head>
<!-- Generated by SynEdit HTML exporter -->
<body text="#000000" bgcolor="#FFFFFF">
<pre>
<code><font  size=3 face="Courier New"><font color="#000080"><A href="hd44780_4.jal">download&nbsp;hd44780_4.jal</A>
</font><font color="#808080"><i>-- -----------------------------------------------------------------------------
-- &lt;title LCD control (HD44780)
-- &lt;License
-- freeware, under the terms of the GNU GPL
--  Copyright (C) 2002 Stef Mientki  
-- mailto:S.Mientki@mailbox.kun.nl
-- -----------------------------------------------------------------------------
-- &lt;Description
-- Library for the control of an LCD module, controlled by HD44780 or equivalent.
-- The routines are basically designed for a 2 line display,
-- but with some slight modifications also usable for 1 and 4 line displays
--
-- Hardware settings can be done through a local copy of HD44780_4_INS
--
-- Because in general IO-lines are scarce,
-- only 4 bit control of the LCD is implemented
-- Cursor is always incremented (decrementing has no usefull meaning in western language)
--
-- &lt;non-tag
-- procedures
--    todo ....
--

-- &lt;Version: 1.2    ,01-09-2004, Stef Mientki
--    - Extra delay in Init procedure, after 4-bits setting, 
--      needed for VARITRONIX MDLS-16268-series
--        Problem was a uncomplete reset, after which the total behaviour was instable
--    - procedure LCD_init made explicitly available
--		- added: procedure value_to_LCD_10X_3pos 
--		- added: procedure value_to_LCD_10X_4pos 
--
-- &lt;Version: 1.1    ,07-07-2004, Stef Mientki
--    - Naming of io-pins changed, according JALcc macro definitions
--		- auto-initialisation now includes display clear and display of version
--
-- &lt;Version: 1.0    ,29-03-2002, Stef Mientki
--    - orginal release
--
-- -----------------------------------------------------------------------------
-- -----------------------------------------------------------------------------




-- -----------------------------------------------------------------------------
-- &lt;Example 
; not available
-- -----------------------------------------------------------------------------


-- &lt;code
</i></font><font color="#FF00FF">include delay_20mc


</font><font color="#808080"><i>-- -----------------------------------------------------------------------------
-- these delays are necessary in between certain commands,
-- I guess they should work in all cases
</i></font><b>const </b><font color="#FF0000">_HD44780_short_delay     </font><font color="#000080"><b>= </b></font><font color="#FF0000">5   </font><font color="#808080"><i>-- fast command delay in 10 usec units
                                     -- should be 4=40usec for 250kHz cycle frequency
</i></font><b>const </b><font color="#FF0000">_HD44780_long_delay      </font><font color="#000080"><b>= </b></font><font color="#FF0000">180 </font><font color="#808080"><i>-- fast command delay in 10 usec units
                                     -- should be 165 = 1.65 msec for 250kHz cycle frequency
-- -----------------------------------------------------------------------------


-- -----------------------------------------------------------------------------
-- some constants to control the LCD
-- -----------------------------------------------------------------------------
</i></font><b>const </b><font color="#FF0000">_HD44780_clear_display       </font><font color="#000080"><b>= </b></font><font color="#FF0000">0b_0000_0001
</font><b>const </b><font color="#FF0000">_HD44780_return_home         </font><font color="#000080"><b>= </b></font><font color="#FF0000">0b_0000_0010    </font><font color="#808080"><i>-- LONG DELAY !!

</i></font><b>const </b><font color="#FF0000">_HD44780_display_onoff       </font><font color="#000080"><b>= </b></font><font color="#FF0000">0b_0000_1000
                               
</font><b>const </b><font color="#FF0000">_HD44780_cursor_shift_right  </font><font color="#000080"><b>= </b></font><font color="#FF0000">0b_0001_0100
</font><b>const </b><font color="#FF0000">_HD44780_cursor_shift_left   </font><font color="#000080"><b>= </b></font><font color="#FF0000">0b_0001_0000
</font><b>const </b><font color="#FF0000">_HD44780_display_shift_right </font><font color="#000080"><b>= </b></font><font color="#FF0000">0b_0001_1100
</font><b>const </b><font color="#FF0000">_HD44780_display_shift_left  </font><font color="#000080"><b>= </b></font><font color="#FF0000">0b_0001_1000

</font><b>const </b><font color="#FF0000">_HD44780_set_CGRAM_address   </font><font color="#000080"><b>= </b></font><font color="#FF0000">0b_0100_0000  </font><font color="#808080"><i>-- + 6 bits address
</i></font><b>const </b><font color="#FF0000">_HD44780_set_DDRAM_address   </font><font color="#000080"><b>= </b></font><font color="#FF0000">0b_1000_0000  </font><font color="#808080"><i>-- + 7bits address
-- -----------------------------------------------------------------------------



-- global on/off shadow bits
</i></font><b>var volatile bit </b><font color="#000080">_HD44780_display <b>= </b></font><font color="#FF0000">true
</font><b>var volatile bit </b><font color="#000080">_HD44780_cursor  <b>= </b></font><font color="#FF0000">false
</font><b>var volatile bit </b><font color="#000080">_HD44780_blink   <b>= </b></font><font color="#FF0000">false


</font><font color="#808080"><i>-- other global vraibles
</i></font><b>var volatile byte </b><font color="#000080">LCD_pos <b>= </b></font><font color="#FF0000">0


</font><font color="#808080"><i>-- global variables for animations
</i></font><b>var   byte </b><font color="#000080">LCD_animate1_state</font><font color="#808080"><i>; = 0
</i></font><b>var   byte </b><font color="#000080">LCD_animate2_state</font><font color="#808080"><i>; = 0
</i></font><b>var   bit  </b><font color="#000080">LCD_animate3_state
</font><b>var   byte </b><font color="#000080">LCD_animate4_state</font><font color="#808080"><i>; = 0


-- some constants to save code memory
</i></font><b>const byte </b><font color="#FF0000">_LCD_animate1_pos  </font><font color="#000080"><b>= </b></font><font color="#FF0000">LCD_animate1_pos </font><font color="#000080"><b>&lt;&lt; </b></font><font color="#FF0000">3
</font><b>const byte </b><font color="#FF0000">_LCD_animate2_pos  </font><font color="#000080"><b>= </b></font><font color="#FF0000">LCD_animate2_pos </font><font color="#000080"><b>&lt;&lt; </b></font><font color="#FF0000">3
</font><b>const byte </b><font color="#FF0000">_LCD_animate3_pos  </font><font color="#000080"><b>= </b></font><font color="#FF0000">LCD_animate3_pos </font><font color="#000080"><b>&lt;&lt; </b></font><font color="#FF0000">3


</font><font color="#808080"><i>-- ----------------------------------------------------------------------------
-- sends low nibble from value to the LCD
-- can be used for both commands and data
-- (requires no wait cycli inbetween upper and lower nibble)
-- (this routine is only used inside this file)
-- ----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">_HD44780_write_low_nibble <b>( </b></font><b>byte in </b><font color="#000080">value <b>) </b></font><b>is
var bit </b><font color="#000080">bit0 </font><b>at </b><font color="#000080">value <b>: </b></font><font color="#FF0000">0
</font><b>var bit </b><font color="#000080">bit1 </font><b>at </b><font color="#000080">value <b>: </b></font><font color="#FF0000">1
</font><b>var bit </b><font color="#000080">bit2 </font><b>at </b><font color="#000080">value <b>: </b></font><font color="#FF0000">2
</font><b>var bit </b><font color="#000080">bit3 </font><b>at </b><font color="#000080">value <b>: </b></font><font color="#FF0000">3

  </font><font color="#808080"><i>-- if multiplexed IO-pins, be sure all pins are set to output
  </i></font><b>if </b><font color="#FF0000">HD44780_multiplexed_output </font><b>then
    </b><font color="#000080">HD44780_b4_direction <b>= </b></font><font color="#FF0000">output
    </font><font color="#000080">HD44780_b5_direction <b>= </b></font><font color="#FF0000">output
    </font><font color="#000080">HD44780_b6_direction <b>= </b></font><font color="#FF0000">output
    </font><font color="#000080">HD44780_b7_direction <b>= </b></font><font color="#FF0000">output
    </font><font color="#000080">HD44780_DataCmd_direction <b>= </b></font><font color="#FF0000">output
  </font><b>end if

  </b><font color="#808080"><i>-- setup databits
  </i></font><font color="#000080">HD44780_b4_pin <b>= </b>bit0
  HD44780_b5_pin <b>= </b>bit1
  HD44780_b6_pin <b>= </b>bit2
  HD44780_b7_pin <b>= </b>bit3
  
  
  </font><font color="#808080"><i>-- generate clockpuls
  </i></font><font color="#000080">HD44780_Enable_pin  <b>= </b></font><b>high   </b><font color="#808080"><i>-- enable high
  </i></font><font color="#000080">HD44780_Enable_pin  <b>= </b></font><b>low    </b><font color="#808080"><i>-- enable  high --&gt; low = clock data
</i></font><b>end procedure
</b><font color="#808080"><i>-- ----------------------------------------------------------------------------



-- ----------------------------------------------------------------------------
-- sends command byte in value to LCD
-- for slow commands an extra delay should be added
-- (this routine is only used inside this file)
-- ----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">_HD44780_Command<b>( </b></font><b>byte in </b><font color="#000080">value <b>) </b></font><b>is
   </b><font color="#000080">hd44780_DataCmd_pin <b>= </b></font><b>low                   </b><font color="#808080"><i>-- select instruction
   </i></font><font color="#000080">_HD44780_write_low_nibble<b>( </b>value <b>&gt;&gt; </b></font><font color="#FF0000">4 </font><font color="#000080"><b>) </b></font><font color="#808080"><i>-- output high nibble
   </i></font><font color="#000080">_HD44780_write_low_nibble<b>( </b>value <b>)      </b></font><font color="#808080"><i>-- output low nibble
   </i></font><font color="#000080">delay_10uS<b>( </b></font><font color="#FF0000">_HD44780_short_delay </font><font color="#000080"><b>)      </b></font><font color="#808080"><i>-- required delay
</i></font><b>end procedure
</b><font color="#808080"><i>-- ----------------------------------------------------------------------------

-- ----------------------------------------------------------------------------
-- transports the global settings (display, cursor, blink) to the LCD
-- ----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">_HD44780_Do_Settings </font><b>is
var byte </b><font color="#000080">cmd
  cmd <b>= </b></font><font color="#FF0000">_HD44780_display_onoff
  </font><b>if </b><font color="#000080">_HD44780_display </font><b>then </b><font color="#000080">cmd <b>= </b>cmd <b>+ </b></font><font color="#FF0000">4 </font><b>end if
  if </b><font color="#000080">_HD44780_cursor  </font><b>then </b><font color="#000080">cmd <b>= </b>cmd <b>+ </b></font><font color="#FF0000">2 </font><b>end if
  if </b><font color="#000080">_HD44780_blink   </font><b>then </b><font color="#000080">cmd <b>= </b>cmd <b>+ </b></font><font color="#FF0000">1 </font><b>end if
  </b><font color="#000080">_HD44780_Command <b>( </b>cmd <b>)
</b></font><b>end procedure
</b><font color="#808080"><i>-- ----------------------------------------------------------------------------


-- ----------------------------------------------------------------------------
-- Turn Cursor on / off
-- ----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">LCD_cursor<b>'</b></font><b>put 
  </b><font color="#000080"><b>( </b></font><b>bit in </b><font color="#000080">on_off <b>) </b></font><b>is
  </b><font color="#000080">_HD44780_cursor <b>= </b>on_off
  _HD44780_Do_Settings
</font><b>end procedure
</b><font color="#808080"><i>-- ----------------------------------------------------------------------------

-- ----------------------------------------------------------------------------
-- Turn Blink on / off
-- ----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">LCD_blink<b>'</b></font><b>put 
  </b><font color="#000080"><b>( </b></font><b>bit in </b><font color="#000080">on_off <b>) </b></font><b>is
  </b><font color="#000080">_HD44780_blink <b>= </b>on_off
  _HD44780_Do_Settings
</font><b>end procedure
</b><font color="#808080"><i>-- ----------------------------------------------------------------------------

-- ----------------------------------------------------------------------------
-- Turn Display on / off
-- ----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">LCD_display<b>'</b></font><b>put 
  </b><font color="#000080"><b>( </b></font><b>bit in </b><font color="#000080">on_off <b>) </b></font><b>is
  </b><font color="#000080">_HD44780_display <b>= </b>on_off
  _HD44780_Do_Settings
</font><b>end procedure
</b><font color="#808080"><i>-- ----------------------------------------------------------------------------


-- ----------------------------------------------------------------------------
-- sends data byte in value to LCD,
-- use this routine to send data to the character rom
-- (requires no extra wait cycli afterwards)
-- (this routine is only used inside this file)
-- ----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">_LCD<b>'</b></font><b>put </b><font color="#000080"><b>( </b></font><b>byte in </b><font color="#000080">ascii <b>) </b></font><b>is
   </b><font color="#000080">HD44780_DataCmd_pin <b>= </b></font><b>high   </b><font color="#808080"><i>-- select data
   </i></font><font color="#000080">_HD44780_write_low_nibble<b>( </b>ascii <b>&gt;&gt; </b></font><font color="#FF0000">4 </font><font color="#000080"><b>) </b></font><font color="#808080"><i>-- output high nibble
   </i></font><font color="#000080">_HD44780_write_low_nibble<b>( </b>ascii <b>)      </b></font><font color="#808080"><i>-- output low nibble
   </i></font><font color="#000080">delay_10uS<b>( </b></font><font color="#FF0000">_HD44780_short_delay </font><font color="#000080"><b>)      </b></font><font color="#808080"><i>-- required delay
</i></font><b>end procedure
</b><font color="#808080"><i>-- ----------------------------------------------------------------------------



-- ----------------------------------------------------------------------------
-- sets the cursor of the LCD to the position in the shadow register
-- ----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">_LCD_restore_cursor </font><b>is
  </b><font color="#808080"><i>-- set LCD back to normal operation
  </i></font><font color="#000080">_HD44780_Command <b>( </b></font><font color="#FF0000">_HD44780_set_DDRAM_address </font><font color="#000080"><b>| </b>LCD_pos <b>)
</b></font><b>end procedure
</b><font color="#808080"><i>-- ----------------------------------------------------------------------------



-- ----------------------------------------------------------------------------
-- sets the cursor of the LCD to position POS
-- ----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">LCD_cursor_pos<b>'</b></font><b>put 
  </b><font color="#000080"><b>( </b></font><b>byte in </b><font color="#000080">pos <b>) </b></font><b>is
  </b><font color="#000080">LCD_pos <b>= </b>pos
  _LCD_restore_cursor
</font><b>end procedure
</b><font color="#808080"><i>-- ----------------------------------------------------------------------------



-- ----------------------------------------------------------------------------
-- shifts display (that is all lines) one position to the left
-- ----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">LCD_shift_left </font><b>is
  </b><font color="#808080"><i>-- set LCD back to normal operation
  </i></font><font color="#000080">_HD44780_Command <b>( </b></font><font color="#FF0000">_HD44780_display_shift_left </font><font color="#000080"><b>)
</b></font><b>end procedure
</b><font color="#808080"><i>-- ----------------------------------------------------------------------------

-- ----------------------------------------------------------------------------
-- shifts display (that is all lines) one position to the right
-- ----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">LCD_shift_right </font><b>is
  </b><font color="#808080"><i>-- set LCD back to normal operation
  </i></font><font color="#000080">_HD44780_Command <b>( </b></font><font color="#FF0000">_HD44780_display_shift_right </font><font color="#000080"><b>)
</b></font><b>end procedure
</b><font color="#808080"><i>-- ----------------------------------------------------------------------------



-- ----------------------------------------------------------------------------
-- Send character ASCII to LCD,
-- cursor position is held in a shadow register,
-- (necessary if animations are running
-- or useful if the display must be full rotating)
-- ----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">LCD_char<b>'</b></font><b>put 
  </b><font color="#000080"><b>( </b></font><b>byte in </b><font color="#000080">ascii <b>) </b></font><b>is
  </b><font color="#808080"><i>-- send ASCII character to current position of display
  </i></font><font color="#000080">_LCD <b>= </b>ascii
  
  </font><font color="#808080"><i>-- now increment shadow counter,
  -- incrementing is done in such a way that the whole display area is used
  </i></font><font color="#000080">LCD_POS <b>= </b>LCD_POS <b>+ </b></font><font color="#FF0000">1
  </font><b>if </b><font color="#FF0000">LCD_number_of_display_lines </font><font color="#000080"><b>== </b></font><font color="#FF0000">1 </font><b>then
    if </b><font color="#000080">LCD_POS <b>== </b></font><font color="#FF0000">LCD_number_of_display_characters </font><b>then </b><font color="#000080">LCD_POS <b>= </b></font><font color="#FF0000">0
    </font><b>end if

  elsif </b><font color="#FF0000">LCD_number_of_display_lines </font><font color="#000080"><b>== </b></font><font color="#FF0000">2 </font><b>then
    if    </b><font color="#000080">LCD_POS <b>==        </b></font><font color="#FF0000">LCD_number_of_display_characters </font><b>then </b><font color="#000080">LCD_POS <b>= </b></font><font color="#FF0000">0x40
    </font><b>elsif </b><font color="#000080">LCD_POS <b>== </b></font><font color="#FF0000">0x40 </font><font color="#000080"><b>+ </b></font><font color="#FF0000">LCD_number_of_display_characters </font><b>then </b><font color="#000080">LCD_POS <b>= </b></font><font color="#FF0000">0
    </font><b>end if

  else </b><font color="#808080"><i>-- 4 lines
    </i></font><b>if    </b><font color="#000080">LCD_POS <b>==        </b></font><font color="#FF0000">LCD_number_of_display_characters </font><b>then </b><font color="#000080">LCD_POS <b>= </b></font><font color="#FF0000">0x40
    </font><b>elsif </b><font color="#000080">LCD_POS <b>== </b></font><font color="#FF0000">0x40 </font><font color="#000080"><b>+ </b></font><font color="#FF0000">LCD_number_of_display_characters </font><b>then </b><font color="#000080">LCD_POS <b>= </b></font><font color="#FF0000">0x10
    </font><b>elsif </b><font color="#000080">LCD_POS <b>== </b></font><font color="#FF0000">0x10 </font><font color="#000080"><b>+ </b></font><font color="#FF0000">LCD_number_of_display_characters </font><b>then </b><font color="#000080">LCD_POS <b>= </b></font><font color="#FF0000">0x50
    </font><b>elsif </b><font color="#000080">LCD_POS <b>== </b></font><font color="#FF0000">0x50 </font><font color="#000080"><b>+ </b></font><font color="#FF0000">LCD_number_of_display_characters </font><b>then </b><font color="#000080">LCD_POS <b>= </b></font><font color="#FF0000">0
    </font><b>end if

  end if

  </b><font color="#808080"><i>-- set LCD back to normal operation
  </i></font><font color="#000080">_LCD_restore_cursor
</font><b>end procedure
</b><font color="#808080"><i>-- ----------------------------------------------------------------------------



-- ----------------------------------------------------------------------------
-- writes charactes ASCII to the LCD at postion POS
-- positions refers to the oficial LCD position [ 0 .. 79 ],
--   so writing to 0x42 in a 2*16 display, will write at the third position
--   of the second line
-- therefore it's also possible to write outside the physical display
-- ----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">LCD_char_pos 
  <b>( </b></font><b>byte in </b><font color="#000080">ASCII <b>, </b></font><b>byte in </b><font color="#000080">pos <b>) </b></font><b>is
  </b><font color="#000080">LCD_cursor_pos <b>= </b>pos
  LCD_char <b>= </b>ASCII
</font><b>end procedure
</b><font color="#808080"><i>-- ----------------------------------------------------------------------------



-- ----------------------------------------------------------------------------
-- writes charactes ASCII to the LCD at postion POS on line LINE [0..1]
-- see also remarks for routine LCD_CHAR_POS
-- ----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">LCD_char_line_pos 
  <b>( </b></font><b>byte in </b><font color="#000080">ASCII <b>, </b></font><b>byte in </b><font color="#000080">line<b>, </b></font><b>byte in </b><font color="#000080">pos <b>) </b></font><b>is
  if </b><font color="#FF0000">LCD_number_of_display_lines </font><font color="#000080"><b>== </b></font><font color="#FF0000">1 </font><b>then
    </b><font color="#000080">LCD_pos <b>= </b>pos

  </font><b>elsif </b><font color="#FF0000">LCD_number_of_display_lines </font><font color="#000080"><b>== </b></font><font color="#FF0000">2 </font><b>then
    if </b><font color="#000080">line <b>== </b></font><font color="#FF0000">0 </font><b>then </b><font color="#000080">LCD_pos <b>= </b>pos
    </font><b>else              </b><font color="#000080">LCD_pos <b>= </b>pos <b>+ </b></font><font color="#FF0000">0x40
    </font><b>end if

  else </b><font color="#808080"><i>-- 4 lines
    </i></font><b>if    </b><font color="#000080">line <b>== </b></font><font color="#FF0000">0 </font><b>then </b><font color="#000080">LCD_pos <b>= </b>pos
    </font><b>elsif </b><font color="#000080">line <b>== </b></font><font color="#FF0000">1 </font><b>then </b><font color="#000080">LCD_pos <b>= </b>pos <b>+ </b></font><font color="#FF0000">0x40
    </font><b>elsif </b><font color="#000080">line <b>== </b></font><font color="#FF0000">2 </font><b>then </b><font color="#000080">LCD_pos <b>= </b>pos <b>+ </b></font><font color="#FF0000">0x10
    </font><b>else                 </b><font color="#000080">LCD_pos <b>= </b>pos <b>+ </b></font><font color="#FF0000">0x50
    </font><b>end if

  end if

  </b><font color="#000080">_LCD_restore_cursor
  LCD_char <b>= </b>ASCII
</font><b>end procedure
</b><font color="#808080"><i>-- ----------------------------------------------------------------------------



-- ----------------------------------------------------------------------------
-- clears the selected line [0..1] and
-- sets the cursor at the start of that line
-- ----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">LCD_clear_line 
  <b>( </b></font><b>byte in </b><font color="#000080">line <b>= </b></font><font color="#FF0000">0 </font><font color="#000080"><b>) </b></font><b>is
  </b><font color="#808080"><i>-- set LCD-cursor at start of line
  </i></font><b>if </b><font color="#000080">line <b>== </b></font><font color="#FF0000">0 </font><b>then </b><font color="#000080">LCD_pos <b>= </b></font><font color="#FF0000">0 </font><b>else </b><font color="#000080">LCD_pos <b>= </b></font><font color="#FF0000">0x40 </font><b>end if
  </b><font color="#000080">_LCD_restore_cursor

  </font><font color="#808080"><i>-- now fill line with spaces
  </i></font><b>for </b><font color="#FF0000">LCD_number_of_display_characters </font><b>loop
    </b><font color="#000080">_LCD <b>= </b></font><font color="#808000">&quot; &quot;
  </font><b>end loop

  </b><font color="#808080"><i>-- set LCD back to normal operation
  </i></font><font color="#000080">_LCD_restore_cursor
</font><b>end procedure
</b><font color="#808080"><i>-- ----------------------------------------------------------------------------



-- ----------------------------------------------------------------------------
-- Gets the next character from a string in one of the tables
-- The index is auto incremented, so it's easy to do consecutive calls
-- (this routine is only used inside this file)
-- Ofcourse it's easy to extend this routine to more than 2 tables.
-- after the example E0005.JAL from Wouter van Ooijen
-- ----------------------------------------------------------------------------
</i></font><b>function </b><font color="#000080">_get_string_element <b>( </b></font><b>byte in </b><font color="#000080">table<b>,      </b></font><font color="#808080"><i>-- tablenumber [ 0 .. 1 ]
                               </i></font><b>byte in  out </b><font color="#000080">indx<b>,  </b></font><font color="#808080"><i>-- index in table [ 0 ..   ]
                               </i></font><b>byte out </b><font color="#000080">x          </font><font color="#808080"><i>-- character from table
                             </i></font><font color="#000080"><b>) </b></font><b>return bit is       </b><font color="#808080"><i>-- true if character &lt;&gt; 0
  </i></font><b>if </b><font color="#000080">table <b>== </b></font><font color="#FF0000">0 </font><b>then
   </b><font color="#800080"><i>assembler
      bank  </i></font><font color="#000080">movfw  indx
      </font><font color="#800080"><i>page  </i></font><font color="#000080">call   _string_table_1
      </font><font color="#800080"><i>bank  </i></font><font color="#000080">movwf  x
   </font><b>end </b><font color="#800080"><i>assembler
  </i></font><b>else
   </b><font color="#800080"><i>assembler
      bank  </i></font><font color="#000080">movfw  indx
      </font><font color="#800080"><i>page  </i></font><font color="#000080">call   _string_table_2
      </font><font color="#800080"><i>bank  </i></font><font color="#000080">movwf  x
   </font><b>end </b><font color="#800080"><i>assembler
  </i></font><b>end if
  </b><font color="#000080">indx <b>= </b>indx <b>+ </b></font><font color="#FF0000">1
  </font><b>return </b><font color="#000080"><b>! ( </b>x <b>== </b></font><font color="#FF0000">0 </font><font color="#000080"><b>)
</b></font><b>end function
</b><font color="#808080"><i>-- ----------------------------------------------------------------------------



-- ----------------------------------------------------------------------------
-- routine to get next element from table for character generation
-- auto increment of index
-- (this routine is only used inside this file)
-- ----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">_get_string_element_chargen<b>( </b></font><b>byte in  out </b><font color="#000080">indx<b>, </b></font><b>byte out </b><font color="#000080">x <b>) </b></font><b>is
   </b><font color="#800080"><i>assembler
      bank  </i></font><font color="#000080">movfw  indx
      </font><font color="#800080"><i>page  </i></font><font color="#000080">call   _string_table_character_generator
      </font><font color="#800080"><i>bank  </i></font><font color="#000080">movwf  x
   </font><b>end </b><font color="#800080"><i>assembler
   </i></font><font color="#000080">indx <b>= </b>indx <b>+ </b></font><font color="#FF0000">1
</font><b>end procedure
</b><font color="#808080"><i>-- ----------------------------------------------------------------------------



-- ----------------------------------------------------------------------------
-- Displays a complete string from a table on the LCD
-- writing to the LCD is started at the current cursor location
-- ----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">LCD_display_string 
  <b>( </b></font><b>byte in </b><font color="#000080">table<b>,          </b></font><font color="#808080"><i>-- table [ 0 .. 1 ]
    </i></font><b>byte in </b><font color="#000080">stringnr <b>) </b></font><b>is   </b><font color="#808080"><i>-- string in table [ 0 .. ]
</i></font><b>var byte </b><font color="#000080">x
</font><b>var byte </b><font color="#000080">i <b>= </b></font><font color="#FF0000">0  </font><font color="#808080"><i>-- start at the first location of the table

  -- first locate the correct string (countdown pos)
  </i></font><b>while </b><font color="#000080">stringnr <b>&gt; </b></font><font color="#FF0000">0 </font><b>loop
    </b><font color="#808080"><i>-- find the start of the next string
    -- (every string in the table has a trailing NULL)
    </i></font><b>while </b><font color="#000080">_get_string_element<b>( </b>table<b>, </b>i <b>, </b>x <b>) </b></font><b>loop
    end loop
    </b><font color="#808080"><i>-- now update string counter
    </i></font><font color="#000080">stringnr <b>= </b>stringnr <b>- </b></font><font color="#FF0000">1
  </font><b>end loop

  </b><font color="#808080"><i>-- display the string
  </i></font><b>while </b><font color="#000080">_get_string_element <b>( </b>table<b>, </b>i <b>, </b>x <b>) </b></font><b>loop
    </b><font color="#000080">LCD_char <b>= </b>x
  </font><b>end loop
end procedure
</b><font color="#808080"><i>-- ----------------------------------------------------------------------------



-- ----------------------------------------------------------------------------
-- definies a user character,
-- by copying the pixel definitions from a table to the character rom
-- table is definied in HD44780_INS.JAL
-- ----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">LCD_define_character
            <b>( </b></font><b>byte in </b><font color="#000080">LCD_char_pos<b>,       </b></font><font color="#808080"><i>-- ASCII location [ 0..7]
              </i></font><b>byte in </b><font color="#000080">char_generator <b>) </b></font><b>is </b><font color="#808080"><i>-- stringnumber in table [0..]
</i></font><b>var byte </b><font color="#000080">x
  </font><font color="#808080"><i>-- command write to character rom at location LCD_char_pos
  </i></font><font color="#000080">_HD44780_Command <b>( </b></font><font color="#FF0000">_HD44780_set_CGRAM_address </font><font color="#000080"><b>+ ( </b>LCD_char_pos <b>&lt;&lt; </b></font><font color="#FF0000">3 </font><font color="#000080"><b>))

  </b></font><font color="#808080"><i>-- locate the position of the pixels in the table
  -- (all character definitions must have 8 words)
  </i></font><font color="#000080">char_generator <b>= </b>char_generator <b>&lt;&lt; </b></font><font color="#FF0000">3

  </font><font color="#808080"><i>-- now copy 8 pixel lines from table to character rom
  </i></font><b>for </b><font color="#FF0000">8 </font><b>loop
    </b><font color="#000080">_get_string_element_chargen <b>( </b>char_generator <b>, </b>x <b>)
    </b>_LCD <b>= </b>x
  </font><b>end loop

  </b><font color="#808080"><i>-- set LCD back to normal operation
  </i></font><font color="#000080">_LCD_restore_cursor
</font><b>end procedure
</b><font color="#808080"><i>-- ---------------------------------------------------------------------------



-- ----------------------------------------------------------------------------
</i></font><b>var volatile byte </b><font color="#000080">_LCD_scroll_table
</font><b>var volatile byte </b><font color="#000080">_LCD_scroll_counter
</font><b>var volatile byte </b><font color="#000080">_LCD_scroll_counter_init
</font><b>var volatile byte </b><font color="#000080">_LCD_scroll_leading_spaces
</font><b>var volatile byte </b><font color="#000080">_LCD_scroll_trailing_spaces
</font><font color="#808080"><i>-- ----------------------------------------------------------------------------
-- Displays a scrolling string at the top line
-- the string is a normal string from one of the standard string tables
-- after calling init, LCD_SCROLL_STRING should be called on a regular base
-- ----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">LCD_scroll_string_init 
  <b>( </b></font><b>byte in </b><font color="#000080">table<b>,          </b></font><font color="#808080"><i>-- table [ 0 .. 1 ]
    </i></font><b>byte in </b><font color="#000080">stringnr <b>) </b></font><b>is   </b><font color="#808080"><i>-- string in table [ 0 .. ]

</i></font><b>var byte </b><font color="#000080">kar

  </font><font color="#808080"><i>-- first locate the correct string (countdown pos)
  </i></font><font color="#000080">_LCD_scroll_counter_init <b>= </b></font><font color="#FF0000">0
  </font><b>while </b><font color="#000080">stringnr <b>&gt; </b></font><font color="#FF0000">0 </font><b>loop
    </b><font color="#808080"><i>-- find the start of the next string
    -- (every string in the table has a trailing NULL)
    </i></font><b>while </b><font color="#000080">_get_string_element<b>( </b>table<b>, </b>_LCD_scroll_counter_init <b>, </b>kar<b>) </b></font><b>loop
    end loop
    </b><font color="#808080"><i>-- now update string counter
    </i></font><font color="#000080">stringnr <b>= </b>stringnr <b>- </b></font><font color="#FF0000">1
  </font><b>end loop

  </b><font color="#000080">LCD_clear_line <b>( </b></font><font color="#FF0000">0 </font><font color="#000080"><b>)
  </b>_LCD_scroll_table <b>= </b>table
  _LCD_scroll_trailing_spaces <b>= </b></font><font color="#FF0000">LCD_number_of_display_characters
</font><b>end procedure
</b><font color="#808080"><i>-- ----------------------------------------------------------------------------
-- ----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">LCD_scroll_string </font><b>is
var byte </b><font color="#000080">_kar
</font><b>var byte </b><font color="#000080">_to_prevent_NULL_pointer_error
</font><b>var byte </b><font color="#000080">_string_pointer

  </font><font color="#808080"><i>-- initialisation if line is totally passed
  </i></font><b>if </b><font color="#000080">_LCD_scroll_trailing_spaces <b>== </b></font><font color="#FF0000">LCD_number_of_display_characters </font><b>then
    </b><font color="#000080">_LCD_scroll_leading_spaces <b>= </b></font><font color="#FF0000">LCD_number_of_display_characters
    </font><font color="#000080">_LCD_scroll_trailing_spaces <b>= </b></font><font color="#FF0000">0
    </font><font color="#000080">_LCD_scroll_counter <b>= </b>_LCD_scroll_counter_init
  </font><b>end if

  </b><font color="#808080"><i>-- set the cursor at the start position
  -- and if necessary decrement leading spaces
  </i></font><b>if </b><font color="#000080">_LCD_scroll_leading_spaces <b>&gt; </b></font><font color="#FF0000">0 </font><b>then
    </b><font color="#000080">_LCD_scroll_leading_spaces <b>= </b>_LCD_scroll_leading_spaces <b>- </b></font><font color="#FF0000">1
  </font><b>end if
  </b><font color="#000080">LCD_pos <b>= </b>_LCD_scroll_leading_spaces
  _LCD_restore_cursor

  </font><font color="#808080"><i>-- write the actual characters
  </i></font><font color="#000080">_string_pointer <b>= </b>_LCD_scroll_counter
  _kar <b>= </b></font><font color="#FF0000">0
  </font><font color="#000080">_to_prevent_NULL_pointer_error <b>=
     ( </b></font><font color="#FF0000">LCD_number_of_display_characters </font><font color="#000080"><b>- </b>_LCD_scroll_leading_spaces <b>)
       - </b>_LCD_scroll_trailing_spaces
  </font><b>for </b><font color="#000080">_to_prevent_NULL_pointer_error </font><b>loop
    </b><font color="#000080">_get_string_element<b>( </b>_LCD_scroll_table<b>, </b>_LCD_scroll_counter <b>, </b>_kar <b>)
    </b></font><b>if </b><font color="#000080">_kar <b>!= </b></font><font color="#FF0000">0 </font><b>then
      </b><font color="#000080">LCD_char <b>= </b>_kar
    </font><b>else
      </b><font color="#000080">LCD_char <b>= </b></font><font color="#808000">&quot; &quot;
    </font><b>end if
  end loop
  
  </b><font color="#808080"><i>-- now keep the updated string pointer
  -- and increment trailing spaces if necessary
  </i></font><b>if </b><font color="#000080">_kar <b>== </b></font><font color="#FF0000">0 </font><b>then
    </b><font color="#000080">_LCD_scroll_trailing_spaces <b>= </b>_LCD_scroll_trailing_spaces <b>+ </b></font><font color="#FF0000">1
    </font><font color="#000080">_string_pointer <b>= </b>_string_pointer <b>+ </b></font><font color="#FF0000">1
  </font><b>elsif </b><font color="#000080">_LCD_scroll_leading_spaces <b>== </b></font><font color="#FF0000">0 </font><b>then
    </b><font color="#000080">_string_pointer <b>= </b>_string_pointer <b>+ </b></font><font color="#FF0000">1
  </font><b>end if
  </b><font color="#000080">_LCD_scroll_counter <b>= </b>_string_pointer
  
</font><b>end procedure
</b><font color="#808080"><i>-- ----------------------------------------------------------------------------



-- ----------------------------------------------------------------------------
-- table for animation of rotating line
-- (this routine is only used inside this file)
-- ----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">_string_clock_animation </font><b>is
   </b><font color="#800080"><i>pragma </i></font><font color="#000080">jump_table
   </font><font color="#800080"><i>assembler
      </i></font><font color="#000080">addwf PCL<b>, </b>f
        retlw   </font><font color="#FF0000">0b_00100  </font><font color="#808080"><i>-- vertical
        </i></font><font color="#000080">retlw   </font><font color="#FF0000">0b_00100
        </font><font color="#000080">retlw   </font><font color="#FF0000">0b_00100
        </font><font color="#000080">retlw   </font><font color="#FF0000">0b_00100
        </font><font color="#000080">retlw   </font><font color="#FF0000">0b_00100

        </font><font color="#000080">retlw   </font><font color="#FF0000">0b_00001  </font><font color="#808080"><i>-- upper right corner
        </i></font><font color="#000080">retlw   </font><font color="#FF0000">0b_00010
        </font><font color="#000080">retlw   </font><font color="#FF0000">0b_00100
        </font><font color="#000080">retlw   </font><font color="#FF0000">0b_01000
        </font><font color="#000080">retlw   </font><font color="#FF0000">0b_10000

        </font><font color="#000080">retlw   </font><font color="#FF0000">0b_00000  </font><font color="#808080"><i>-- horzontal
        </i></font><font color="#000080">retlw   </font><font color="#FF0000">0b_00000
        </font><font color="#000080">retlw   </font><font color="#FF0000">0b_11111
        </font><font color="#000080">retlw   </font><font color="#FF0000">0b_00000
        </font><font color="#000080">retlw   </font><font color="#FF0000">0b_00000
        
        </font><font color="#000080">retlw   </font><font color="#FF0000">0b_10000  </font><font color="#808080"><i>-- upper left corner
        </i></font><font color="#000080">retlw   </font><font color="#FF0000">0b_01000
        </font><font color="#000080">retlw   </font><font color="#FF0000">0b_00100
        </font><font color="#000080">retlw   </font><font color="#FF0000">0b_00010
        </font><font color="#000080">retlw   </font><font color="#FF0000">0b_00001
        
   </font><b>end </b><font color="#800080"><i>assembler
</i></font><b>end procedure
</b><font color="#808080"><i>-- ----------------------------------------------------------------------------



-- ----------------------------------------------------------------------------
-- routine to get next element from table for animation of rotating line
-- auto increment of index
-- (this routine is only used inside this file)
-- ----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">_get_string_clock_animation<b>( </b></font><b>byte in  out </b><font color="#000080">indx<b>, </b></font><b>byte out </b><font color="#000080">x <b>) </b></font><b>is
   </b><font color="#800080"><i>assembler
      bank  </i></font><font color="#000080">movfw  indx
      </font><font color="#800080"><i>page  </i></font><font color="#000080">call   _string_clock_animation
      </font><font color="#800080"><i>bank  </i></font><font color="#000080">movwf  x
   </font><b>end </b><font color="#800080"><i>assembler
   </i></font><font color="#000080">indx <b>= </b>indx <b>+ </b></font><font color="#FF0000">1
</font><b>end procedure
</b><font color="#808080"><i>-- ----------------------------------------------------------------------------



-- ----------------------------------------------------------------------------
-- Animates a growing / decreasing stack (like a progress gauge)
-- should be called at regular intervals
-- Every time this routine is called, just one line is written to the character rom
-- ----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">LCD_animate1 </font><b>is
  </b><font color="#808080"><i>-- building up stack image
  </i></font><b>if </b><font color="#000080">LCD_animate1_state <b>&lt;= </b></font><font color="#FF0000">7 </font><b>then
    </b><font color="#000080">_HD44780_Command <b>( </b></font><font color="#FF0000">_HD44780_set_CGRAM_address </font><font color="#000080"><b>+ </b></font><font color="#FF0000">_LCD_animate1_pos </font><font color="#000080"><b>+
                      ( </b></font><font color="#FF0000">7 </font><font color="#000080"><b>- </b>LCD_animate1_state <b>))
    </b>_LCD <b>= </b></font><font color="#FF0000">0b_11111
  </font><b>else  </b><font color="#808080"><i>-- decreasing the stack image
    </i></font><font color="#000080">_HD44780_Command <b>( </b></font><font color="#FF0000">_HD44780_set_CGRAM_address </font><font color="#000080"><b>+ </b></font><font color="#FF0000">_LCD_animate1_pos </font><font color="#000080"><b>+
                      ( </b>LCD_animate1_state <b>- </b></font><font color="#FF0000">8 </font><font color="#000080"><b>))
    </b>_LCD <b>= </b></font><font color="#FF0000">0b_00000
  </font><b>end if

  </b><font color="#808080"><i>-- update state counter
  </i></font><font color="#000080">LCD_animate1_state <b>= ( </b>LCD_animate1_state <b>+ </b></font><font color="#FF0000">1 </font><font color="#000080"><b>) &amp; </b></font><font color="#FF0000">0x0F

  </font><font color="#808080"><i>-- set LCD back to normal operation
  </i></font><font color="#000080">_LCD_restore_cursor
</font><b>end procedure
</b><font color="#808080"><i>-- ----------------------------------------------------------------------------



-- ----------------------------------------------------------------------------
-- Animates a rotating line.
-- should be called at regular intervals
-- Every time this routine is called, all the character lines are written,
-- to save as much codespace as possible.
-- This animation uses a (partial) code table.
-- ----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">LCD_animate2 </font><b>is
var byte </b><font color="#000080">x
  _HD44780_Command <b>( </b></font><font color="#FF0000">_HD44780_set_CGRAM_address </font><font color="#000080"><b>+ </b></font><font color="#FF0000">_LCD_animate2_pos </font><font color="#000080"><b>)
  </b>_LCD <b>= </b></font><font color="#FF0000">0
  </font><font color="#000080">_LCD <b>= </b></font><font color="#FF0000">0
  </font><b>for </b><font color="#FF0000">5 </font><b>loop
    </b><font color="#000080">_get_string_clock_animation <b>( </b>LCD_animate2_state <b>, </b>x <b>)
    </b>_LCD <b>= </b>x
  </font><b>end loop
  </b><font color="#000080">_LCD <b>= </b></font><font color="#FF0000">0

  </font><font color="#808080"><i>-- update state counter
  </i></font><b>if </b><font color="#000080">LCD_animate2_state <b>&gt;= </b></font><font color="#FF0000">20 </font><b>then </b><font color="#000080">LCD_animate2_state <b>= </b></font><font color="#FF0000">0 </font><b>end if

  </b><font color="#808080"><i>-- set LCD back to normal operation
  </i></font><font color="#000080">_LCD_restore_cursor
</font><b>end procedure
</b><font color="#808080"><i>-- ----------------------------------------------------------------------------



-- ----------------------------------------------------------------------------
-- Animates a smiley with a winking eye,
-- should be called at regular intervals (500 msec is a good interval)
-- Every time this routine is called, all the character lines are written,
-- to save as much codespace as possible.
-- ----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">LCD_animate3 </font><b>is
  </b><font color="#000080">_HD44780_Command <b>( </b></font><font color="#FF0000">_HD44780_set_CGRAM_address </font><font color="#000080"><b>+ </b></font><font color="#FF0000">_LCD_animate3_pos</font><font color="#000080"><b>)
  </b></font><b>if </b><font color="#000080">LCD_animate3_state </font><b>then
    </b><font color="#000080">_LCD <b>= </b></font><font color="#FF0000">0b_11011
  </font><b>else
    </b><font color="#000080">_LCD <b>= </b></font><font color="#FF0000">0b_00011
  </font><b>end if

  </b><font color="#808080"><i>-- although it's not necessary to define these lines every time,
  -- this is the way to use the least code space
  </i></font><font color="#000080">_LCD <b>= </b></font><font color="#FF0000">0b_11011
  </font><font color="#000080">_LCD <b>= </b></font><font color="#FF0000">0b_00000
  </font><font color="#000080">_LCD <b>= </b></font><font color="#FF0000">0b_00100
  </font><font color="#000080">_LCD <b>= </b></font><font color="#FF0000">0b_00000
  </font><font color="#000080">_LCD <b>= </b></font><font color="#FF0000">0b_10001
  </font><font color="#000080">_LCD <b>= </b></font><font color="#FF0000">0b_01110
  </font><font color="#000080">_LCD <b>= </b></font><font color="#FF0000">0b_00000

  </font><font color="#808080"><i>-- update state
  </i></font><font color="#000080">LCD_animate3_state <b>= ! </b>LCD_animate3_state

  </font><font color="#808080"><i>-- set LCD back to normal operation
  </i></font><font color="#000080">_LCD_restore_cursor
</font><b>end procedure
</b><font color="#808080"><i>-- ----------------------------------------------------------------------------


-- -----------------------------------------------------------------------------
-- Displays a value of 10X on 3 positions
-- 10X = 13   will be displayed as &quot;1.3&quot;
-- 10X = 113  will be displayed as &quot; 11&quot;
-- rounding is correctly handled
-- 10X = 115  will be displayed as &quot; 12&quot;
-- -----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">value_to_LCD_10X_3pos 
  <b>(</b></font><b>byte in </b><font color="#000080">BH<b>, </b></font><b>byte in </b><font color="#000080">BL<b>, </b></font><b>byte in </b><font color="#000080">poskar<b>) </b></font><b>is
var byte </b><font color="#000080">D100<b>, </b>D10
  Y2 <b>= </b>BH
  Y1 <b>= </b>BL
  <b>&lt;</b></font><font color="#800080"><i>mac</i></font><font color="#000080"><b>&gt; </b>byte2_assign  X <b>= </b></font><font color="#FF0000">100
  </font><font color="#000080">D100 <b>= </b></font><font color="#FF0000">0
  </font><b>while </b><font color="#000080"><b>(</b>Y2 <b>&gt; </b></font><font color="#FF0000">0</font><font color="#000080"><b>) | (</b>Y1 <b>&gt;= </b></font><font color="#FF0000">100</font><font color="#000080"><b>) </b></font><b>loop
    </b><font color="#000080">byte2_SUB
    D100 <b>= </b>D100 <b>+ </b></font><font color="#FF0000">1
  </font><b>end loop
  
  </b><font color="#000080">D10 <b>= </b></font><font color="#FF0000">0
  </font><b>while </b><font color="#000080">Y1 <b>&gt;= </b></font><font color="#FF0000">10 </font><b>loop
    </b><font color="#000080">Y1 <b>= </b>Y1 <b>- </b></font><font color="#FF0000">10
    </font><font color="#000080">D10 <b>= </b>D10 <b>+ </b></font><font color="#FF0000">1
  </font><b>end loop
  
  </b><font color="#808080"><i>-- rounding 10.6 ==&gt; 11
  </i></font><b>if </b><font color="#000080">D100 <b>&gt; </b></font><font color="#FF0000">0 </font><b>then
    if </b><font color="#000080">Y1 <b>&gt;= </b></font><font color="#FF0000">5 </font><b>then
      </b><font color="#000080">D10 <b>= </b>D10 <b>+ </b></font><font color="#FF0000">1
      </font><b>if </b><font color="#000080">D10 <b>== </b></font><font color="#FF0000">10 </font><b>then
        </b><font color="#000080">D100 <b>= </b>D100 <b>+ </b></font><font color="#FF0000">1
        </font><font color="#000080">D10 <b>= </b></font><font color="#FF0000">0
      </font><b>end if
    end if
</b><font color="#C0C0C0">  	</font><font color="#000080">LCD_char_pos <b>(</b></font><font color="#808000">&quot; &quot;</font><font color="#000080"><b>, </b>poskar<b>)
</b></font><font color="#C0C0C0">  	</font><font color="#000080">poskar <b>= </b>poskar <b>+ </b></font><font color="#FF0000">1
</font><font color="#C0C0C0">  	</font><font color="#000080">LCD_char_pos <b>(</b></font><font color="#FF0000">0x30 </font><font color="#000080"><b>+ </b>D100<b>, </b>poskar<b>)
</b></font><font color="#C0C0C0">  	</font><font color="#000080">poskar <b>= </b>poskar <b>+ </b></font><font color="#FF0000">1
</font><font color="#C0C0C0">  	</font><font color="#000080">LCD_char_pos <b>(</b></font><font color="#FF0000">0x30 </font><font color="#000080"><b>+ </b>D10<b>, </b>poskar<b>)
  </b></font><b>else
</b><font color="#C0C0C0">  	</font><font color="#000080">LCD_char_pos <b>(</b></font><font color="#FF0000">0x30 </font><font color="#000080"><b>+ </b>D10<b>, </b>poskar<b>)
</b></font><font color="#C0C0C0">  	</font><font color="#000080">poskar <b>= </b>poskar <b>+ </b></font><font color="#FF0000">1
</font><font color="#C0C0C0">  	</font><font color="#000080">LCD_char_pos <b>(</b></font><font color="#808000">&quot;.&quot;</font><font color="#000080"><b>, </b>poskar<b>)
</b></font><font color="#C0C0C0">  	</font><font color="#000080">poskar <b>= </b>poskar <b>+ </b></font><font color="#FF0000">1
</font><font color="#C0C0C0">  	</font><font color="#000080">LCD_char_pos <b>(</b></font><font color="#FF0000">0x30 </font><font color="#000080"><b>+ </b>Y1<b>, </b>poskar<b>)
  </b></font><b>end if
end procedure
</b><font color="#808080"><i>-- -----------------------------------------------------------------------------


-- -----------------------------------------------------------------------------
-- Displays a value of 10X on 4 positions
-- 10X = 13   will be displayed as &quot; 1.3&quot;
-- 10X = 113  will be displayed as &quot;11.3&quot;
-- -----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">value_to_LCD_10X_4pos 
  <b>(</b></font><b>byte in </b><font color="#000080">BH<b>, </b></font><b>byte in </b><font color="#000080">BL<b>, </b></font><b>byte in </b><font color="#000080">poskar<b>) </b></font><b>is
var byte </b><font color="#000080">D100<b>, </b>D10
  Y2 <b>= </b>BH
  Y1 <b>= </b>BL
  <b>&lt;</b></font><font color="#800080"><i>mac</i></font><font color="#000080"><b>&gt; </b>byte2_assign  X <b>= </b></font><font color="#FF0000">100
  </font><font color="#000080">D100 <b>= </b></font><font color="#FF0000">0
  </font><b>while </b><font color="#000080"><b>(</b>Y2 <b>&gt; </b></font><font color="#FF0000">0</font><font color="#000080"><b>) | (</b>Y1 <b>&gt;= </b></font><font color="#FF0000">100</font><font color="#000080"><b>) </b></font><b>loop
    </b><font color="#000080">byte2_SUB
    D100 <b>= </b>D100 <b>+ </b></font><font color="#FF0000">1
  </font><b>end loop
  
  </b><font color="#000080">D10 <b>= </b></font><font color="#FF0000">0
  </font><b>while </b><font color="#000080">Y1 <b>&gt;= </b></font><font color="#FF0000">10 </font><b>loop
    </b><font color="#000080">Y1 <b>= </b>Y1 <b>- </b></font><font color="#FF0000">10
    </font><font color="#000080">D10 <b>= </b>D10 <b>+ </b></font><font color="#FF0000">1
  </font><b>end loop
  
  if </b><font color="#000080">D100 <b>&gt; </b></font><font color="#FF0000">0 </font><b>then
</b><font color="#C0C0C0">  	</font><font color="#000080">LCD_char_pos <b>(</b></font><font color="#FF0000">0x30 </font><font color="#000080"><b>+ </b>D100<b>, </b>poskar<b>)
  </b></font><b>else
</b><font color="#C0C0C0">  	</font><font color="#000080">LCD_char_pos <b>(</b></font><font color="#808000">&quot; &quot;</font><font color="#000080"><b>, </b>poskar<b>)
  </b></font><b>end if
</b><font color="#C0C0C0">	</font><font color="#000080">poskar <b>= </b>poskar <b>+ </b></font><font color="#FF0000">1

  </font><font color="#808080"><i>-- always dsiplay 0 before decimal sign
</i></font><font color="#C0C0C0">	</font><font color="#000080">LCD_char_pos <b>(</b></font><font color="#FF0000">0x30 </font><font color="#000080"><b>+ </b>D10<b>, </b>poskar<b>)
</b></font><font color="#C0C0C0"> 	</font><font color="#000080">poskar <b>= </b>poskar <b>+ </b></font><font color="#FF0000">1
</font><font color="#C0C0C0"> 	</font><font color="#000080">LCD_char_pos <b>(</b></font><font color="#808000">&quot;.&quot;</font><font color="#000080"><b>, </b>poskar<b>)
</b></font><font color="#C0C0C0"> 	</font><font color="#000080">poskar <b>= </b>poskar <b>+ </b></font><font color="#FF0000">1
</font><font color="#C0C0C0"> 	</font><font color="#000080">LCD_char_pos <b>(</b></font><font color="#FF0000">0x30 </font><font color="#000080"><b>+ </b>Y1<b>, </b>poskar<b>)
</b></font><b>end procedure
</b><font color="#808080"><i>-- -----------------------------------------------------------------------------




-- ----------------------------------------------------------------------------
-- Software reset / initialisation
-- ----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">LCD_init </font><b>is
  </b><font color="#808080"><i>-- if multiplexed IO-pins, these values will be set just before sending
  </i></font><b>if </b><font color="#000080"><b>! </b></font><font color="#FF0000">HD44780_multiplexed_output </font><b>then
    </b><font color="#000080">HD44780_b4_pin        <b>= </b></font><b>low
    </b><font color="#000080">HD44780_b5_pin        <b>= </b></font><b>low
    </b><font color="#000080">HD44780_b6_pin        <b>= </b></font><b>low
    </b><font color="#000080">HD44780_b7_pin        <b>= </b></font><b>low
    </b><font color="#000080">HD44780_DataCmd_pin   <b>= </b></font><b>low

    </b><font color="#000080">HD44780_b4_direction  <b>= </b></font><font color="#FF0000">output
    </font><font color="#000080">HD44780_b5_direction  <b>= </b></font><font color="#FF0000">output
    </font><font color="#000080">HD44780_b6_direction  <b>= </b></font><font color="#FF0000">output
    </font><font color="#000080">HD44780_b7_direction  <b>= </b></font><font color="#FF0000">output
    </font><font color="#000080">HD44780_DataCmd_direction <b>= </b></font><font color="#FF0000">output
  </font><b>end if

  </b><font color="#000080">HD44780_Enable_pin       <b>= </b></font><b>low
  </b><font color="#000080">HD44780_Enable_direction <b>= </b></font><font color="#FF0000">output

  </font><font color="#000080">delay_1mS <b>( </b></font><font color="#FF0000">40 </font><font color="#000080"><b>)                      </b></font><font color="#808080"><i>-- even long enough for Vcc as low as 2.7V
  </i></font><font color="#000080">HD44780_DataCmd_pin <b>= </b></font><b>low                 </b><font color="#808080"><i>-- select command
  </i></font><font color="#000080">_HD44780_write_low_nibble <b>( </b></font><font color="#FF0000">0b_0011 </font><font color="#000080"><b>) </b></font><font color="#808080"><i>-- first init
  </i></font><font color="#000080">delay_1mS <b>( </b></font><font color="#FF0000">5 </font><font color="#000080"><b>)                       </b></font><font color="#808080"><i>-- extra delay
  </i></font><font color="#000080">_HD44780_write_low_nibble <b>( </b></font><font color="#FF0000">0b_0011 </font><font color="#000080"><b>) </b></font><font color="#808080"><i>-- second init
  </i></font><font color="#000080">delay_10uS<b>( </b></font><font color="#FF0000">10 </font><font color="#000080"><b>)                      </b></font><font color="#808080"><i>-- extra delay
  </i></font><font color="#000080">_HD44780_write_low_nibble <b>( </b></font><font color="#FF0000">0b_0011 </font><font color="#000080"><b>) </b></font><font color="#808080"><i>-- third init

  </i></font><font color="#000080">_HD44780_write_low_nibble <b>( </b></font><font color="#FF0000">0b_0010 </font><font color="#000080"><b>) </b></font><font color="#808080"><i>-- set 4-bit interface
</i></font><font color="#C0C0C0">	</font><font color="#000080">delay_10uS<b>( </b></font><font color="#FF0000">_HD44780_short_delay </font><font color="#000080"><b>)    </b></font><font color="#808080"><i>-- FOR SOME DISPLAYS (VARITRONIX) required delay
  </i></font><font color="#000080">_HD44780_Command<b>( </b></font><font color="#FF0000">0b_0010_1000 </font><font color="#000080"><b>)      </b></font><font color="#808080"><i>-- two lines, 5x7 (high nibble)
  </i></font><font color="#000080">_HD44780_Command<b>( </b></font><font color="#FF0000">0b_0000_1111 </font><font color="#000080"><b>)      </b></font><font color="#808080"><i>-- display on, cursor on, blink on
  </i></font><font color="#000080">_HD44780_Command<b>( </b></font><font color="#FF0000">0b_0000_0001 </font><font color="#000080"><b>)      </b></font><font color="#808080"><i>-- clear display
  </i></font><font color="#000080">_HD44780_Command<b>( </b></font><font color="#FF0000">0b_0000_0110 </font><font color="#000080"><b>)      </b></font><font color="#808080"><i>-- increment and no shift


  -- now display version of this lib
</i></font><font color="#C0C0C0">	</font><font color="#000080">delay_1ms<b>(</b></font><font color="#FF0000">100</font><font color="#000080"><b>)
  </b>LCD_char_pos <b>( </b></font><font color="#808000">&quot;V&quot;</font><font color="#000080"><b>, </b></font><font color="#FF0000">1</font><font color="#000080"><b>)
  </b>LCD_char_pos <b>( </b></font><font color="#808000">&quot; &quot;</font><font color="#000080"><b>, </b></font><font color="#FF0000">2</font><font color="#000080"><b>)
  </b>LCD_char_pos <b>( </b></font><font color="#808000">&quot;1&quot;</font><font color="#000080"><b>, </b></font><font color="#FF0000">3</font><font color="#000080"><b>)
  </b>LCD_char_pos <b>( </b></font><font color="#808000">&quot;.&quot;</font><font color="#000080"><b>, </b></font><font color="#FF0000">4</font><font color="#000080"><b>)
  </b>LCD_char_pos <b>( </b></font><font color="#808000">&quot;2&quot;</font><font color="#000080"><b>, </b></font><font color="#FF0000">5</font><font color="#000080"><b>)
</b></font><b>end procedure
</b><font color="#808080"><i>-- ----------------------------------------------------------------------------


-- ----------------------------------------------------------------------------
-- Initialisation
-- ----------------------------------------------------------------------------
</i></font><font color="#000080">LCD_init

</font></font>
</code></pre>
</body>
</html>
