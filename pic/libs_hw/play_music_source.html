<html>
<head>
<title>JALcc SourceCode exporting of play_music_source.html</title>
</head>
<!-- Generated by SynEdit HTML exporter -->
<body text="#000000" bgcolor="#FFFFFF">
<pre>
<code><font  size=3 face="Courier New"><font color="#000080"><A href="play_music.jal">download&nbsp;play_music.jal</A>
</font><font color="#808080"><i>-- -----------------------------------------------------------------------------
-- &lt;title generate Sound
-- &lt;License
-- freeware, under the terms of the GNU GPL
--  Copyright (C) 2002 Stef Mientki
-- -----------------------------------------------------------------------------
-- &lt;Description
-- Library for generating sounds, using TMR0
--
-- Use of this library
--   make a local copy of this file in the program directory
-- Then change the following, according to your needs
--   define the IO pin
--   define the frequency of each note in table1
--   define the duration of each note in table2
--   from the main program, include this file and call PLAY_SONG
--
-- &lt;Version: 1.0  07-04-2002   Stef Mientki
--    - orginal release
-- -----------------------------------------------------------------------------


-- -----------------------------------------------------------------------------
-- &lt;Example RS232
; -- see MUSIC.JAL
-- -----------------------------------------------------------------------------


-- &lt;code

-- -----------------------------------------------------------------------------
-- the value of 128 is somewhat historical,
-- at first I used the Timer0 prescaler which can only be set at powers of 2
-- -----------------------------------------------------------------------------
</i></font><b>const </b><font color="#000080">_tmr0_preset       <b>= </b></font><font color="#FF0000">128        </font><font color="#808080"><i>; 128*02 uSec = 25.6 usec
                                      ; it's more efficient to use this method than
                                      ; the prescaler and secondly
                                      ; you can achieve a more accurate timing
</i></font><b>const </b><font color="#000080">_trm0_count_preset <b>= </b></font><font color="#FF0000">5000 </font><font color="#000080"><b>/ </b></font><font color="#FF0000">28  </font><font color="#808080"><i>; counts ISR upto 5 msec
                                      ; = 5000 us / &lt;length ISR&gt;
                                      ; ISR is a few seconds longer than calculated
                                      ; by _TMR0_PRESET
-- -----------------------------------------------------------------------------



-- -----------------------------------------------------------------------------
-- variables to communicate with the ISR
-- MAIN can manipulate TONE_ON to enable/disable sound generation
-- MAIN can manipulate TONE_PRESET to set the frequency
-- MAIN can use TMR0_5MSEC to time events
-- -----------------------------------------------------------------------------
</i></font><b>var bit  </b><font color="#000080">_tone_on             </font><font color="#808080"><i>;tone or long pauze active
</i></font><b>var byte </b><font color="#000080">_tone_preset
</font><b>var byte </b><font color="#000080">_tmr0_5msec
</font><b>var bit  </b><font color="#000080">song_playing <b>= </b></font><font color="#FF0000">false </font><font color="#808080"><i>;indicates if a song is currently playing
</i></font><b>var bit  </b><font color="#000080">play_constant_tone   </font><font color="#808080"><i>;song or constant tone playing
</i></font><b>var bit </b><font color="#000080">_sound_pausing        </font><font color="#808080"><i>;short pause inbetween tones is active
</i></font><b>var byte </b><font color="#000080">_duration            </font><font color="#808080"><i>;duration of the current tone
</i></font><b>var byte </b><font color="#000080">_period              </font><font color="#808080"><i>;perios (frequency) of the current tone
</i></font><b>var byte </b><font color="#000080">_sound_index1        </font><font color="#808080"><i>;current index within a table
</i></font><b>var byte </b><font color="#000080">_sound_index2        </font><font color="#808080"><i>;current tablenumber
-- -----------------------------------------------------------------------------



-- -----------------------------------------------------------------------------
-- variables which are owned and may only be used by the ISR
-- -----------------------------------------------------------------------------
</i></font><b>var bit  </b><font color="#000080">_sound_pin_shadow    </font><font color="#808080"><i>;copy of the current level of the sound-pin
</i></font><b>var byte </b><font color="#000080">_tmr0_count <b>= </b></font><font color="#FF0000">0      </font><font color="#808080"><i>;counts ISR's and when 0, increments _tmr0_5msec
                              ;will be reloaded with _tmr0_5msec
</i></font><b>var byte </b><font color="#000080">_tone                </font><font color="#808080"><i>;counst ISR's and when 0, toggles soundpin
                              ;will be reloaded with _tone_preset
-- -----------------------------------------------------------------------------





-- ----------------------------------------------------------------------------
-- For every table a procedure _get_next_table_X must be made
-- At the moment there are 5 tables declared by default,
-- given a total capacity of 5*254/2 = 635 notes.
-- If these tables are not used, they will not consume any memory space,
-- because they will be wiped out by the compiler
-- ----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">_get_next_from_table_1 <b>(  </b></font><b>byte in  out </b><font color="#000080">indx<b>, </b></font><b>byte out </b><font color="#000080">x <b>) </b></font><b>is
  </b><font color="#800080"><i>assembler
    bank  </i></font><font color="#000080">movfw  indx
    </font><font color="#800080"><i>page  </i></font><font color="#000080">call   _table_tone_duration_1  </font><font color="#808080"><i>;fill in the correct table
    </i></font><font color="#800080"><i>bank  </i></font><font color="#000080">movwf  x
  </font><b>end </b><font color="#800080"><i>assembler
  </i></font><font color="#000080">indx <b>= </b>indx <b>+ </b></font><font color="#FF0000">1
</font><b>end procedure
</b><font color="#808080"><i>-- ----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">_get_next_from_table_2 <b>(  </b></font><b>byte in  out </b><font color="#000080">indx<b>, </b></font><b>byte out </b><font color="#000080">x <b>) </b></font><b>is
  </b><font color="#800080"><i>assembler
    bank  </i></font><font color="#000080">movfw  indx
    </font><font color="#800080"><i>page  </i></font><font color="#000080">call   _table_tone_duration_2  </font><font color="#808080"><i>;fill in the correct table
    </i></font><font color="#800080"><i>bank  </i></font><font color="#000080">movwf  x
  </font><b>end </b><font color="#800080"><i>assembler
  </i></font><font color="#000080">indx <b>= </b>indx <b>+ </b></font><font color="#FF0000">1
</font><b>end procedure
</b><font color="#808080"><i>-- ----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">_get_next_from_table_3 <b>(  </b></font><b>byte in  out </b><font color="#000080">indx<b>, </b></font><b>byte out </b><font color="#000080">x <b>) </b></font><b>is
  </b><font color="#800080"><i>assembler
    bank  </i></font><font color="#000080">movfw  indx
    </font><font color="#800080"><i>page  </i></font><font color="#000080">call   _table_tone_duration_3  </font><font color="#808080"><i>;fill in the correct table
    </i></font><font color="#800080"><i>bank  </i></font><font color="#000080">movwf  x
  </font><b>end </b><font color="#800080"><i>assembler
  </i></font><font color="#000080">indx <b>= </b>indx <b>+ </b></font><font color="#FF0000">1
</font><b>end procedure
</b><font color="#808080"><i>-- ----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">_get_next_from_table_4 <b>(  </b></font><b>byte in  out </b><font color="#000080">indx<b>, </b></font><b>byte out </b><font color="#000080">x <b>) </b></font><b>is
  </b><font color="#800080"><i>assembler
    bank  </i></font><font color="#000080">movfw  indx
    </font><font color="#800080"><i>page  </i></font><font color="#000080">call   _table_tone_duration_4  </font><font color="#808080"><i>;fill in the correct table
    </i></font><font color="#800080"><i>bank  </i></font><font color="#000080">movwf  x
  </font><b>end </b><font color="#800080"><i>assembler
  </i></font><font color="#000080">indx <b>= </b>indx <b>+ </b></font><font color="#FF0000">1
</font><b>end procedure
</b><font color="#808080"><i>-- ----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">_get_next_from_table_5 <b>(  </b></font><b>byte in  out </b><font color="#000080">indx<b>, </b></font><b>byte out </b><font color="#000080">x <b>) </b></font><b>is
  </b><font color="#800080"><i>assembler
    bank  </i></font><font color="#000080">movfw  indx
    </font><font color="#800080"><i>page  </i></font><font color="#000080">call   _table_tone_duration_5  </font><font color="#808080"><i>;fill in the correct table
    </i></font><font color="#800080"><i>bank  </i></font><font color="#000080">movwf  x
  </font><b>end </b><font color="#800080"><i>assembler
  </i></font><font color="#000080">indx <b>= </b>indx <b>+ </b></font><font color="#FF0000">1
</font><b>end procedure
</b><font color="#808080"><i>-- ----------------------------------------------------------------------------



-- ----------------------------------------------------------------------------
-- Get the next tone and duration from a combined frequency / duration table,
-- and prepeare the global variables to start a new tone.
-- The table may consist of a number of tables of each 254 bytes (except the last)
-- This includes the multi-table from Brick's Music Studio by Guido Truffelli.
-- ----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">_get_next_tone_and_duration </font><b>is
  </b><font color="#808080"><i>-- check for end of a subtable,
  -- if so, goto the start of the next subtable
  </i></font><b>if </b><font color="#000080">_sound_index1 <b>== </b></font><font color="#FF0000">254 </font><b>then
    </b><font color="#000080">_sound_index2 <b>= </b>_sound_index2 <b>+ </b></font><font color="#FF0000">1
    </font><font color="#000080">_sound_index1 <b>= </b></font><font color="#FF0000">0
  </font><b>end if
  
  </b><font color="#808080"><i>-- select the correct table and get the next tone/duration from it
  </i></font><b>if </b><font color="#000080">_sound_index2 <b>== </b></font><font color="#FF0000">0 </font><b>then
    </b><font color="#000080">_get_next_from_table_1 <b>( </b>_sound_index1<b>, </b>_period <b>)
    </b>_get_next_from_table_1 <b>( </b>_sound_index1<b>, </b>_duration<b>)

  </b></font><b>elsif </b><font color="#000080">_sound_index2 <b>== </b></font><font color="#FF0000">1 </font><b>then
    </b><font color="#808080"><i>-- here an &quot;compiler&quot; if-statement will wipe out the code if it's not necessary
    </i></font><b>if </b><font color="#000080">_BMS_table <b>&gt; </b></font><font color="#FF0000">1 </font><b>then
      </b><font color="#000080">_get_next_from_table_2 <b>( </b>_sound_index1<b>, </b>_period <b>)
      </b>_get_next_from_table_2 <b>( </b>_sound_index1<b>, </b>_duration<b>)
    </b></font><b>end if

  elsif </b><font color="#000080">_sound_index2 <b>== </b></font><font color="#FF0000">2 </font><b>then
    if </b><font color="#000080">_BMS_table <b>&gt; </b></font><font color="#FF0000">2 </font><b>then
      </b><font color="#000080">_get_next_from_table_3 <b>( </b>_sound_index1<b>, </b>_period <b>)
      </b>_get_next_from_table_3 <b>( </b>_sound_index1<b>, </b>_duration<b>)
    </b></font><b>end if

  elsif </b><font color="#000080">_sound_index2 <b>== </b></font><font color="#FF0000">3 </font><b>then
    if </b><font color="#000080">_BMS_table <b>&gt; </b></font><font color="#FF0000">3 </font><b>then
      </b><font color="#000080">_get_next_from_table_4 <b>( </b>_sound_index1<b>, </b>_period <b>)
      </b>_get_next_from_table_4 <b>( </b>_sound_index1<b>, </b>_duration<b>)
    </b></font><b>end if

  elsif </b><font color="#000080">_sound_index2 <b>== </b></font><font color="#FF0000">4 </font><b>then
    if </b><font color="#000080">_BMS_table <b>&gt; </b></font><font color="#FF0000">4 </font><b>then
      </b><font color="#000080">_get_next_from_table_5 <b>( </b>_sound_index1<b>, </b>_period <b>)
      </b>_get_next_from_table_5 <b>( </b>_sound_index1<b>, </b>_duration<b>)
    </b></font><b>end if

  end if
  
  </b><font color="#808080"><i>-- transport some variables to some other globals
  -- assuming a new note must be started
  </i></font><font color="#000080">_tone_on <b>= </b>_period <b>!= </b></font><font color="#FF0000">0
  </font><font color="#000080">_tone_preset <b>= </b>_period
  _tmr0_5msec <b>= </b></font><font color="#FF0000">0
  
  </font><font color="#808080"><i>-- check if it's the end of the song
  </i></font><b>if </b><font color="#000080">_duration <b>== </b></font><font color="#FF0000">0 </font><b>then
    </b><font color="#000080">song_playing <b>= </b></font><font color="#FF0000">false
    </font><font color="#000080">T0IE <b>= </b></font><font color="#FF0000">false
  </font><b>end if
end procedure
</b><font color="#808080"><i>-- ----------------------------------------------------------------------------


-- -----------------------------------------------------------------------------
-- entered every 25,6 usec + 12..15 instructions = 28 usec
-- this routine will also run if no tones are produced,
-- you can either disable it
-- -----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">_TMR0_interrupt </font><b>is
</b><font color="#000080"><b>&lt;</b></font><font color="#800080"><i>mac</i></font><font color="#000080"><b>&gt; </b>interrupt_sub _TMR0_interrupt T0IF </font><font color="#FF0000">5
</font><font color="#808080"><i>;pragma interrupt

  -- must be (one of) the first statement for accurate timing
  </i></font><font color="#000080">TMR0 <b>= </b>_tmr0_preset  </font><font color="#808080"><i>-- preset counter again

  </i></font><b>if </b><font color="#000080">song_playing </font><b>then
    </b><font color="#808080"><i>-- generate tone
    </i></font><b>if </b><font color="#000080">_tone_on </font><b>then
      </b><font color="#000080">_tone <b>= </b>_tone <b>- </b></font><font color="#FF0000">1
      </font><b>if </b><font color="#000080">_tone <b>== </b></font><font color="#FF0000">0 </font><b>then
        </b><font color="#000080">sound_pin <b>= </b>_sound_pin_shadow
        _sound_pin_shadow <b>= ! </b>_sound_pin_shadow
        _tone <b>= </b>_tone_preset
      </font><b>end if
    end if

    </b><font color="#808080"><i>-- generate 5 msec signal
    </i></font><font color="#000080">_tmr0_count <b>= </b>_tmr0_count <b>+ </b></font><font color="#FF0000">1
    </font><b>if </b><font color="#000080">_tmr0_count <b>&gt;= </b>_trm0_count_preset </font><b>then   </b><font color="#808080"><i>-- count units of 5 msec
      </i></font><font color="#000080">_tmr0_5msec <b>= </b>_tmr0_5msec <b>+ </b></font><font color="#FF0000">1
      </font><font color="#000080">_tmr0_count <b>= </b></font><font color="#FF0000">0
    </font><b>end if

    </b><font color="#808080"><i>-- generation of a constant tone
    -- it's essential that this case is handled before
    --   play_music_mode_interrupt !!!
    </i></font><b>if </b><font color="#000080">play_constant_tone </font><b>then
      if </b><font color="#000080">_tmr0_5msec <b>&gt;= </b>_duration </font><b>then
        </b><font color="#000080">song_playing <b>= </b></font><font color="#FF0000">false
        </font><font color="#000080">T0IE <b>= </b></font><font color="#FF0000">false
      </font><b>end if
      
    </b><font color="#808080"><i>-- generation of a song, completly in interrupt mode
    </i></font><b>elsif </b><font color="#000080">play_music_mode_interrupt </font><b>then
      if </b><font color="#000080">_tmr0_5msec <b>&gt;= </b>_duration </font><b>then

        </b><font color="#808080"><i>-- if it was pausing, now play note again
        </i></font><b>if </b><font color="#000080">_sound_pausing </font><b>then
          </b><font color="#000080">_get_next_tone_and_duration
          _sound_pausing <b>= </b></font><font color="#FF0000">false
          
        </font><font color="#808080"><i>-- pause between notes if necessary
        </i></font><b>else
          if </b><font color="#000080">sound_pause <b>&gt; </b></font><font color="#FF0000">0 </font><b>then
            </b><font color="#000080">_tone_on <b>= </b></font><font color="#FF0000">false
            </font><font color="#000080">_duration <b>= </b>sound_pause
            _tmr0_5msec <b>= </b></font><font color="#FF0000">0
            </font><font color="#000080">_sound_pausing <b>= </b></font><font color="#FF0000">true
          </font><b>end if
        end if
        
      end if
    end if
  end if
  
  </b><font color="#808080"><i>-- must be the last statement, to prevent reentrance
  </i></font><font color="#000080">T0IF <b>= </b></font><font color="#FF0000">false        </font><font color="#808080"><i>-- clear TMR0 interrupt flag
</i></font><b>end procedure
</b><font color="#808080"><i>-- -----------------------------------------------------------------------------



-- ----------------------------------------------------------------------------
-- Plays the song indicated by TUNE [0..]
-- ----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">play_tune 
  <b>( </b></font><b>byte in </b><font color="#000080">tune <b>) </b></font><b>is </b><font color="#808080"><i>-- tune in table [ 0 .. ]
  </i></font><font color="#000080">play_constant_tone <b>= </b></font><font color="#FF0000">false
  </font><font color="#000080">_sound_index1 <b>= </b></font><font color="#FF0000">0
  </font><font color="#000080">_sound_index2 <b>= </b></font><font color="#FF0000">0

  </font><font color="#808080"><i>-- first locate the correct tune (countdown pos)
  </i></font><b>while </b><font color="#000080">tune <b>&gt; </b></font><font color="#FF0000">0 </font><b>loop
    </b><font color="#808080"><i>-- find the start of the next tune
    -- (every tune in the table has a duration of NULL)
    </i></font><font color="#000080">_duration <b>= </b></font><font color="#FF0000">1              </font><font color="#808080"><i>-- to start while loop
    </i></font><b>while </b><font color="#000080">_duration <b>!= </b></font><font color="#FF0000">0 </font><b>loop
      </b><font color="#000080">_get_next_tone_and_duration
    </font><b>end loop
    </b><font color="#808080"><i>-- now update tune counter
    </i></font><font color="#000080">tune <b>= </b>tune <b>- </b></font><font color="#FF0000">1
  </font><b>end loop

  </b><font color="#000080">song_playing <b>= </b></font><font color="#FF0000">true
  </font><font color="#000080">T0IE <b>= </b></font><font color="#FF0000">true
  </font><font color="#000080">T0IF <b>= </b></font><font color="#FF0000">false

  </font><font color="#808080"><i>-- non interrupt driven playing of a song is handled here
  </i></font><b>if </b><font color="#000080"><b>! </b>play_music_mode_interrupt </font><b>then
    </b><font color="#000080">_duration <b>= </b></font><font color="#FF0000">1  </font><font color="#808080"><i>-- to get while loop started
    </i></font><b>while </b><font color="#000080">_duration <b>&gt; </b></font><font color="#FF0000">0 </font><b>loop
      if </b><font color="#000080">_tmr0_5msec <b>&gt;= </b>_duration </font><b>then
        </b><font color="#808080"><i>-- insert a pause if necessary
        </i></font><b>if </b><font color="#000080">sound_pause <b>&gt; </b></font><font color="#FF0000">0 </font><b>then
          </b><font color="#000080">_tone_on <b>= </b></font><font color="#FF0000">false
          </font><font color="#000080">_duration <b>= </b>sound_pause
          _tmr0_5msec <b>= </b></font><font color="#FF0000">0
          </font><b>while </b><font color="#000080">_tmr0_5msec <b>&lt; </b>_duration </font><b>loop end loop
        end if
        </b><font color="#808080"><i>-- get on with the next note
        </i></font><font color="#000080">_get_next_tone_and_duration
      </font><b>end if
    end loop
  end if
end procedure
</b><font color="#808080"><i>-- ----------------------------------------------------------------------------



-- ----------------------------------------------------------------------------
-- plays the first tune in the table
-- ----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">play_song </font><b>is
  </b><font color="#000080">play_tune <b>( </b></font><font color="#FF0000">0 </font><font color="#000080"><b>)
</b></font><b>end procedure
</b><font color="#808080"><i>-- ----------------------------------------------------------------------------



-- -----------------------------------------------------------------------------
-- Plays the first song in the table
-- -----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">stop_song </font><b>is
  </b><font color="#000080">song_playing <b>= </b></font><font color="#FF0000">false
  </font><font color="#000080">T0IE <b>= </b></font><font color="#FF0000">false
</font><b>end procedure
</b><font color="#808080"><i>-- -----------------------------------------------------------------------------



-- ----------------------------------------------------------------------------
-- Play constant tone
-- playing a constant tone is always done in interrupt mode
-- ----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">play_tone 
  <b>( </b></font><b>byte in </b><font color="#000080">period<b>, </b></font><b>byte in </b><font color="#000080">duration <b>) </b></font><b>is
  </b><font color="#000080">play_constant_tone <b>= </b></font><font color="#FF0000">true
  </font><font color="#000080">song_playing <b>= </b></font><font color="#FF0000">true
  </font><font color="#000080">T0IE <b>= </b></font><font color="#FF0000">true
  </font><font color="#000080">T0IF <b>= </b></font><font color="#FF0000">false
  </font><font color="#000080">_duration <b>= </b>duration
  _tone_on <b>= </b></font><font color="#FF0000">true
  </font><font color="#000080">_tmr0_5msec <b>= </b></font><font color="#FF0000">0
  </font><font color="#000080">_tone_preset <b>= </b>period
</font><b>end procedure
</b><font color="#808080"><i>-- -----------------------------------------------------------------------------



-- ----------------------------------------------------------------------------
-- play constant tone and wait till ready
-- ----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">play_tone_and_wait 
  <b>( </b></font><b>byte in </b><font color="#000080">period<b>, </b></font><b>byte in </b><font color="#000080">duration <b>) </b></font><b>is
  </b><font color="#000080">play_tone <b>( </b>period<b>, </b>duration <b>)
    </b></font><font color="#808080"><i>-- wait till tone completly done
  </i></font><b>while </b><font color="#000080">song_playing </font><b>loop end loop
end procedure
</b><font color="#808080"><i>-- -----------------------------------------------------------------------------



-- -----------------------------------------------------------------------------
-- initialisation of the timer and interrupts
-- -----------------------------------------------------------------------------
</i></font><font color="#000080">OPTION_REG <b>= ( </b>OPTION_REG <b>&amp; ! ( </b></font><font color="#FF0000">_b_T0CS </font><font color="#000080"><b>))   </b></font><font color="#808080"><i>-- set TMR0 to main oscillator
</i></font><font color="#000080">OPTION_REG <b>= ( </b>OPTION_REG <b>| </b></font><font color="#FF0000">_b_PSA </font><font color="#000080"><b>)         </b></font><font color="#808080"><i>-- disable prescaler for TMR0
;T0IE = true   -- enable TMR0 interrupt
</i></font><font color="#000080">GIE  <b>= </b></font><font color="#FF0000">true   </font><font color="#808080"><i>-- enable general interrupts
;T0IF = false  -- clear TMR0 interrupt flag
-- -----------------------------------------------------------------------------
</i></font></font>
</code></pre>
</body>
</html>
