<html>
<head>
<title>JALcc SourceCode exporting of dac_tlv5638_source.html</title>
</head>
<!-- Generated by SynEdit HTML exporter -->
<body text="#000000" bgcolor="#FFFFFF">
<pre>
<code><font  size=3 face="Courier New"><font color="#000080"><A href="dac_tlv5638.jal">download&nbsp;dac_tlv5638.jal</A>
</font><font color="#808080"><i>-- -----------------------------------------------------------------------------
-- &lt;title DAC TLV5638
-- &lt;License
-- freeware, under the terms of the GNU GPL
--  Copyright (C) 2002 Stef Mientki  
-- -----------------------------------------------------------------------------
-- &lt;Description
-- Library for the control of the DAC TLV5638 (2 channel 12 bits DAC)
--  SPI control through both USART and MSSP are supported.
--
-- &lt;non-tag
-- procedures
--   DAC_TLV5638_init      set speed, power, Vref
--	 DAC_TLV5638_set_AB 	 set both DACs with new value
--
-- Data is transported through the variable
--   DAC_TLV5638_A_MSB, DAC_TLV5638_A_, DAC_TLV5638_B_MSB, DAC_TLV5638_B_LSB
--
-- &lt;Version: 1.3    ,03-09-2004 , Stef Mientki
--    - uses 1 register less
--		- testroutine added, generates 2 different sawtooths
--
-- &lt;Version: 1.2    ,07-07-2004 , Stef Mientki
--		- pin names changed, so macro pin definitions can be used
--		- CS pin will be set automatically to output
--
-- &lt;Version: 1.1    ,10-2-2004 , Stef Mientki
--   - if controled by MSSP, SPI settings are done before every DAC writing,
-- 	 	 so these DACs can be used on the same SPI bus with devices that has other
--		 SPI bus settings
--
-- &lt;Version: 1.0    ,25-09-2003, Stef Mientki
--   orginal release
--   tested: only control through MSSP-device
-- -----------------------------------------------------------------------------
-- -----------------------------------------------------------------------------



-- -----------------------------------------------------------------------------
-- &lt;Example DAC_TLV5638
;
; -- this DAC must have CS toggled, so define the CS-pin
; &lt;mac&gt; io_pin  DAC_TLV5638_CS = pin_E0
;
; -- define speed and Vref of the DAC, and the PIC device for SPI-communication
; -- define the DA converter settings
; const DAC_TLV_5638_fastmode = true
; const DAC_TLV_5638_Vref		 = 2      -- 0 = external
;																			-- 1 = 1.024 Volt
;																			-- 2 = 2.048 Volt
; const DAC_TLV5638_spi_usart = false  -- false = MSSP is used
;																			-- true  = USART is used
;
;
; -- include the DAC library
; include DAC_TLV5638
;
;
; -- init DAC and turn it on
;    DAC_TLV5638_init ( on )   -- with power on
;
;
;  -- write both channels to DAC, first fill globalvariables, then call set_AB
;  DAC_TLV5638_A_MSB = ...
;  DAC_TLV5638_A_LSB = ...
;  DAC_TLV5638_B_MSB = ...
;  DAC_TLV5638_B_LSB = ...
;  DAC_TLV5638_set_AB
;
;
;  -- turn DAC off
;  DAC_TLV5638_init ( off )  
-- -----------------------------------------------------------------------------

-- &lt;code
-- -----------------------------------------------------------------------------
-- needed library files
-- -----------------------------------------------------------------------------
-- all SPI routines
</i></font><font color="#FF00FF">include rs232_hw
include master_sync_ser_port
</font><font color="#808080"><i>-- for reversing bits
</i></font><font color="#FF00FF">include bit_calcs
</font><font color="#808080"><i>-- -----------------------------------------------------------------------------


-- -----------------------------------------------------------------------------
-- definitions of the DATA registers, to be filled by the user
-- -----------------------------------------------------------------------------
</i></font><b>var volatile byte </b><font color="#000080">DAC_TLV5638_A_MSB
</font><b>var volatile byte </b><font color="#000080">DAC_TLV5638_A_LSB
</font><b>var volatile byte </b><font color="#000080">DAC_TLV5638_B_MSB
</font><b>var volatile byte </b><font color="#000080">DAC_TLV5638_B_LSB

</font><b>var volatile byte </b><font color="#000080">SSPSTAT_old
</font><b>var volatile byte </b><font color="#000080">SSPCON_old
</font><font color="#808080"><i>-- -----------------------------------------------------------------------------


-- -----------------------------------------------------------------------------
-- Sets CS to the DAC,
-- but first sets the SPI-mode in the correct way
-- there are 2 correct ways:
--   CKE = CKP = 1
--   CKE = CKP = 0
-- -----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">DAC_TLV5638_set_CS </font><b>is
  </b><font color="#000080">SSPSTAT_old <b>= </b>SSPSTAT
  SSPSTAT <b>= </b>SSPSTAT <b>| </b></font><font color="#FF0000">0b_1100_0000  </font><font color="#808080"><i>;(SMP=1), CKE=1
  </i></font><font color="#000080">SSPCON_old <b>= </b>SSPCON
  SSPCON <b>= </b>SSPCON <b>| </b></font><font color="#FF0000">0b_0001_0000</font><font color="#C0C0C0">		</font><font color="#808080"><i>;CKP=1
  </i></font><font color="#000080">DAC_TLV5638_CS_pin <b>= </b></font><b>low
end procedure
</b><font color="#808080"><i>-- -----------------------------------------------------------------------------


-- -----------------------------------------------------------------------------
-- clear CS to the DAC
-- and restore the old SPI settings
-- -----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">DAC_TLV5638_clear_CS </font><b>is
  </b><font color="#000080">DAC_TLV5638_CS_pin <b>= </b></font><b>high
  </b><font color="#000080">SSPSTAT <b>= </b>SSPSTAT_old
  SSPCON <b>= </b>SSPCON_old
</font><b>end procedure
</b><font color="#808080"><i>-- -----------------------------------------------------------------------------


-- -----------------------------------------------------------------------------
-- SET DAC control register
-- speed and Vref are set through the constants
--    const DAC_TLV_5638_fastmode = true
--    const DAC_TLV_5638_Vref			= 2     -- 0 = external
-- 	    																	-- 1 = 1.024 Volt
--  		  																-- 2 = 2.048 Volt
-- power = on / off, (NOTE, different from the final bit transport !!)
-- -----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">DAC_TLV5638_init 
  <b>(</b></font><b>bit in </b><font color="#000080">power<b>)  </b></font><b>is
var byte </b><font color="#000080">lsb<b>, </b>msb
  msb <b>= </b></font><font color="#FF0000">0b_1001_0000  </font><font color="#808080"><i>-- always power on
  </i></font><b>if </b><font color="#FF0000">DAC_TLV_5638_fastmode </font><b>then </b><font color="#000080">msb <b>= </b>msb <b>| </b></font><font color="#FF0000">0x40 </font><b>end if
  if </b><font color="#000080"><b>! </b>power</font><font color="#C0C0C0"> 							 </font><b>then </b><font color="#000080">msb <b>= </b>msb <b>| </b></font><font color="#FF0000">0x20 </font><b>end if
  </b><font color="#000080">lsb <b>= </b>DAC_TLV_5638_Vref
  
  </font><font color="#808080"><i>-- speed + all other settings will be sent to DAC
  </i></font><b>if </b><font color="#000080">DAC_TLV5638_spi_usart </font><b>then
    </b><font color="#000080">DAC_TLV5638_CS_pin <b>= </b></font><b>low
    </b><font color="#000080">reverse_bits <b>( </b>msb <b>)
    </b>spi_send_hw  <b>( </b>msb <b>)
    </b>reverse_bits <b>( </b>lsb <b>)
    </b>spi_send_hw  <b>( </b>lsb <b>)
</b></font><font color="#C0C0C0">	  </font><font color="#808080"><i>-- no wait required, because SPI_SEND_HW already waits
    </i></font><font color="#000080">DAC_TLV5638_CS_pin <b>= </b></font><b>high
  else
    </b><font color="#000080">DAC_TLV5638_set_CS
</font><font color="#C0C0C0">	  </font><font color="#000080">spi_send_mssp <b>( </b>msb <b>)
</b></font><font color="#C0C0C0">	  </font><font color="#000080">spi_send_mssp <b>( </b>lsb <b>)
    </b>spi_mssp_wait_until_ready
    DAC_TLV5638_clear_CS 
</font><font color="#C0C0C0">	</font><b>end if
end procedure
</b><font color="#808080"><i>-- -----------------------------------------------------------------------------


-- -----------------------------------------------------------------------------
-- SET both DACs with the (new) 12-bit value from globals
--      DAC_TLV5638_A_MSB , DAC_TLV5638_A_LSB
--      DAC_TLV5638_B_MSB , DAC_TLV5638_B_LSB
-- (bits 15..12 are ignored)
-- power bit will always be 0 = normal operation
-- speed bit will be set according to the global DAC_TLV_5638_fastmode
--
-- this device only seems to work, when
--    * control bytes are sent first
--		* CS is toggled in between all commands
-- -----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">DAC_TLV5638_set_AB </font><b>is
var byte </b><font color="#000080">lsb<b>, </b>msb<b>, </b>MSBA<b>, </b>MSBB
  msb <b>= </b></font><font color="#FF0000">0b_1001_0000  </font><font color="#808080"><i>-- always power on
  </i></font><b>if </b><font color="#FF0000">DAC_TLV_5638_fastmode </font><b>then
    </b><font color="#000080">msb <b>= </b>msb <b>| </b></font><font color="#FF0000">0x40
    </font><font color="#000080">MSBA <b>= ( </b>DAC_TLV5638_A_MSB <b>&amp; </b></font><font color="#FF0000">0x0F </font><font color="#000080"><b>) | </b></font><font color="#FF0000">0b_1100_0000
    </font><font color="#000080">MSBB <b>= ( </b>DAC_TLV5638_B_MSB <b>&amp; </b></font><font color="#FF0000">0x0F </font><font color="#000080"><b>) | </b></font><font color="#FF0000">0b_0101_0000
  </font><b>else
    </b><font color="#000080">MSBA <b>= ( </b>DAC_TLV5638_A_MSB <b>&amp; </b></font><font color="#FF0000">0x0F </font><font color="#000080"><b>) | </b></font><font color="#FF0000">0b_1000_0000
    </font><font color="#000080">MSBB <b>= ( </b>DAC_TLV5638_B_MSB <b>&amp; </b></font><font color="#FF0000">0x0F </font><font color="#000080"><b>) | </b></font><font color="#FF0000">0b_0001_0000
  </font><b>end if

  </b><font color="#808080"><i>-- if USART is used for SPI
  </i></font><b>if </b><font color="#000080">DAC_TLV5638_spi_usart </font><b>then
    </b><font color="#000080">lsb <b>= </b>DAC_TLV_5638_Vref

    DAC_TLV5638_CS_pin <b>= </b></font><b>low
    </b><font color="#000080">reverse_bits <b>( </b>msb <b>)
</b></font><font color="#C0C0C0">	  </font><font color="#000080">spi_send_hw <b>( </b>msb <b>)
    </b>reverse_bits <b>( </b>lsb <b>)
</b></font><font color="#C0C0C0">	  </font><font color="#000080">spi_send_hw <b>( </b>lsb <b>)
</b></font><font color="#C0C0C0">	  </font><font color="#808080"><i>-- no wait required, because SPI_SEND_HW already waits
    </i></font><font color="#000080">DAC_TLV5638_CS_pin <b>= </b></font><b>high

    </b><font color="#000080">DAC_TLV5638_CS_pin <b>= </b></font><b>low
    </b><font color="#000080">reverse_bits <b>( </b>MSBB <b>)
    </b>spi_send_hw  <b>( </b>MSBB <b>)
    </b>lsb <b>= </b>DAC_TLV5638_B_LSB
    reverse_bits <b>( </b>lsb <b>)
</b></font><font color="#C0C0C0">	  </font><font color="#000080">spi_send_hw  <b>( </b>lsb <b>)
    </b>DAC_TLV5638_CS_pin <b>= </b></font><b>high
    
    </b><font color="#000080">DAC_TLV5638_CS_pin <b>= </b></font><b>low
    </b><font color="#000080">reverse_bits <b>( </b>MSBA <b>)
</b></font><font color="#C0C0C0">	  </font><font color="#000080">spi_send_hw  <b>( </b>MSBA <b>)
</b></font><font color="#C0C0C0">	  </font><font color="#000080">lsb <b>= </b>DAC_TLV5638_A_LSB
    reverse_bits <b>( </b>lsb <b>)
</b></font><font color="#C0C0C0">	  </font><font color="#000080">spi_send_hw  <b>( </b>lsb <b>)
    </b>DAC_TLV5638_CS_pin <b>= </b></font><b>high
    
  </b><font color="#808080"><i>-- if MSSP is used for SPI
  </i></font><b>else
    </b><font color="#000080">DAC_TLV5638_set_CS
</font><font color="#C0C0C0">	  </font><font color="#000080">spi_send_mssp <b>( </b>msb <b>)
</b></font><font color="#C0C0C0">	  </font><font color="#000080">spi_send_mssp <b>( </b>DAC_TLV_5638_Vref <b>)
    </b>spi_mssp_wait_until_ready
    DAC_TLV5638_clear_CS 

    DAC_TLV5638_set_CS 
</font><font color="#C0C0C0">	  </font><font color="#000080">spi_send_mssp <b>( </b>MSBB <b>)
</b></font><font color="#C0C0C0">	  </font><font color="#000080">spi_send_mssp <b>( </b>DAC_TLV5638_B_LSB <b>)
    </b>spi_mssp_wait_until_ready
    DAC_TLV5638_clear_CS 

    DAC_TLV5638_set_CS 
</font><font color="#C0C0C0">	  </font><font color="#000080">spi_send_mssp <b>( </b>MSBA <b>)
</b></font><font color="#C0C0C0">	  </font><font color="#000080">spi_send_mssp <b>( </b>DAC_TLV5638_A_LSB <b>)
    </b>spi_mssp_wait_until_ready
    DAC_TLV5638_clear_CS 
</font><font color="#C0C0C0">	</font><b>end if
end procedure
</b><font color="#808080"><i>-- -----------------------------------------------------------------------------


-- -----------------------------------------------------------------------------
-- Test routine, produces 2 different saw-tooths
--   output A (pin 4) rising sawtooth
--   output B (pin 7) falling sawtooth
-- -----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">DAC_TLV5638_test </font><b>is
var byte </b><font color="#000080">x1<b>,</b>x2
</font><font color="#C0C0C0">	</font><font color="#000080">DAC_TLV5638_A_MSB <b>= </b></font><font color="#FF0000">0
</font><font color="#C0C0C0">	</font><font color="#000080">DAC_TLV5638_A_LSB <b>= </b></font><font color="#FF0000">0
</font><font color="#C0C0C0">	</font><font color="#000080">DAC_TLV5638_B_MSB <b>= </b></font><font color="#FF0000">0
</font><font color="#C0C0C0">	</font><font color="#000080">DAC_TLV5638_B_LSB <b>= </b></font><font color="#FF0000">0
  </font><b>forever loop
    </b><font color="#000080">DAC_TLV5638_A_LSB <b>= </b>DAC_TLV5638_A_LSB <b>+ </b></font><font color="#FF0000">16</font><font color="#808080"><i>;
    </i></font><b>if </b><font color="#000080">DAC_TLV5638_A_LSB <b>== </b></font><font color="#FF0000">0 </font><b>then </b><font color="#000080">DAC_TLV5638_A_MSB <b>= </b>DAC_TLV5638_A_MSB <b>+ </b></font><font color="#FF0000">1 </font><b>end if
    </b><font color="#808080"><i>; note that clipping is done in routine set_AB
    </i></font><font color="#000080">DAC_TLV5638_B_LSB <b>= </b>DAC_TLV5638_B_LSB <b>- </b></font><font color="#FF0000">16</font><font color="#808080"><i>;
    </i></font><b>if </b><font color="#000080">DAC_TLV5638_B_LSB <b>== </b></font><font color="#FF0000">240 </font><b>then </b><font color="#000080">DAC_TLV5638_B_MSB <b>= </b>DAC_TLV5638_B_MSB <b>- </b></font><font color="#FF0000">1 </font><b>end if
    </b><font color="#000080">DAC_TLV5638_set_AB

</font><font color="#C0C0C0">		</font><font color="#808080"><i>-- delay loop
</i></font><font color="#C0C0C0">		</font><font color="#000080">x1 <b>= </b></font><font color="#FF0000">1    
    </font><b>while </b><font color="#000080"><b>(</b>x1 <b>+ </b>x2<b>) != </b></font><font color="#FF0000">0 </font><b>loop
      </b><font color="#000080">x1 <b>= </b>x1 <b>+ </b></font><font color="#FF0000">1
      </font><b>if </b><font color="#000080">x1 <b>== </b></font><font color="#FF0000">0 </font><b>then </b><font color="#000080">x2 <b>= </b>x2 <b>+ </b></font><font color="#FF0000">1 </font><b>end if
    end loop
  end loop
end procedure
</b><font color="#808080"><i>-- -----------------------------------------------------------------------------


-- -----------------------------------------------------------------------------
-- initialization
-- -----------------------------------------------------------------------------
  </i></font><font color="#000080">DAC_TLV5638_CS_direction <b>= </b></font><font color="#FF0000">output
  </font><font color="#000080">DAC_TLV5638_init <b>( </b></font><font color="#FF0000">off </font><font color="#000080"><b>) </b></font><font color="#808080"><i>-- start with power off for the moment
-- -----------------------------------------------------------------------------



</i></font></font>
</code></pre>
</body>
</html>
