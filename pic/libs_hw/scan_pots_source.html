<html>
<head>
<title>JALcc SourceCode exporting of scan_pots_source.html</title>
</head>
<!-- Generated by SynEdit HTML exporter -->
<body text="#000000" bgcolor="#FFFFFF">
<pre>
<code><font  size=3 face="Courier New"><font color="#000080"><A href="scan_pots.jal">download&nbsp;scan_pots.jal</A>
</font><font color="#808080"><i>-- -----------------------------------------------------------------------------
-- &lt;title Scans 2 potmeters
-- &lt;License
-- freeware, under the terms of the GNU GPL
--  Copyright (C) 2002 Stef Mientki
-- -----------------------------------------------------------------------------
-- &lt;Description
-- Library to scan 2 potmeters on a 16F628
--
-- Scans 2 potmeters of which the sliders are pin_a0 and pin_a1
-- One end of the potmeters must be tight to ground and
-- the other end through a resistor of half the potmeters value to +5V
--
-- Use it by regulary calling,
-- which toggles reading of the 2 potmeters
--   scan_2_pots (key)
--
-- Return values
--   key == 0 no change of potmeters was detected
--   0x80 &lt;= key &lt;= 0x87 , key is the (changed) value on pin_a0
--   0x90 &lt;= key &lt;= 0x97 , key is the (changed) value on pin_a1
--   a low value agrees with the slider to ground
--  This routine can be used in combination with scan extended keymatrix.
--
-- The last scanned value of both potmeters can be read at each moment through
-- the pseudo variables
--     potmeter1
--     potmeter2
--
-- There's no definition or initialization necessary
--
-- &lt;version 1.1   ,11-01-2002,  Stef Mientki
--   - delay for settling comparator in scan_2_pots made shorter,
--         (a little faster, no functional change)
-- &lt;Version 1.0   ,6-12-2001,   Stef Mientki
--   - first release
-- --------------------------------------------------------------------


-- -----------------------------------------------------------------------------
-- &lt;Example scan potmeters
; -- include scan library
; include scan_pots
;
; var byte key
; forever loop
;  -- scan one of the 2 potmeters
;  scan_2_pots ( key )
;
;  -- if a different key was pressed, execute the command
;  if key != 0 then
;    asynch_send_hw(key)
;  end if
;
;   ... do other things here, maybe a fixed delay ?
; end loop
-- -----------------------------------------------------------------------------


-- &lt;code


-- routines for the special hardware
</i></font><font color="#FF00FF">include 16f628_spec


</font><font color="#808080"><i>-- --------------------------------------------------------------------
-- global variables, only to used by this library
-- --------------------------------------------------------------------
</i></font><b>var bit  </b><font color="#000080">_pot_scan1  <b>= </b></font><font color="#FF0000">false  </font><font color="#808080"><i>-- indicates which of 2 pots will be scanned
</i></font><b>var byte </b><font color="#000080">_pot_value1 <b>= </b></font><font color="#FF0000">0      </font><font color="#808080"><i>-- store the previous value of potmeter 1
</i></font><b>var byte </b><font color="#000080">_pot_value2 <b>= </b></font><font color="#FF0000">0      </font><font color="#808080"><i>-- store the previous value of potmeter 2
-- --------------------------------------------------------------------



-- --------------------------------------------------------------------
-- local (re-)definition of power levels
-- this has nothing to do with the standard RCX library,
-- but just depends on the way you want to control the motor power,
-- in this case from 2 potmeters
-- therefor it reads the internal variables of scan_pots
-- --------------------------------------------------------------------
</i></font><b>function </b><font color="#000080">potmeter1<b>'</b></font><b>get return byte is
  return </b><font color="#000080">_pot_value1 <b>/ </b></font><font color="#FF0000">2
</font><b>end function
function </b><font color="#000080">potmeter2<b>'</b></font><b>get return byte is
  return </b><font color="#000080">_pot_value2 <b>/ </b></font><font color="#FF0000">2
</font><b>end function
</b><font color="#808080"><i>-- --------------------------------------------------------------------



-- --------------------------------------------------------------------
-- Scans 2 potmeters of which the sliders are pin_a0 and pin_a1
-- one end of the potmeters must be tight to ground and
-- the other end through a resistor of half the potmeters value to +5V
-- --------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">scan_2_pots <b>( </b></font><b>byte out </b><font color="#000080">_pot_key <b>) </b></font><b>is

var byte </b><font color="#000080">comparator
</font><b>var byte </b><font color="#000080">Vref
</font><b>var bit  </b><font color="#000080">found

  </font><font color="#808080"><i>-- initialize output (if no change found)
  </i></font><font color="#000080">_pot_key <b>= </b></font><font color="#FF0000">0

  </font><font color="#808080"><i>-- initialize Vref on maximum+1
  </i></font><font color="#000080">Vref <b>= </b></font><font color="#FF0000">16

  </font><font color="#808080"><i>-- search until Vref reached the end
  -- or until found
  </i></font><font color="#000080">found <b>= </b></font><font color="#FF0000">false
  </font><b>while </b><font color="#000080"><b>( </b>Vref <b>&gt; </b></font><font color="#FF0000">0 </font><font color="#000080"><b>) &amp; ! </b>found  </font><b>loop
    </b><font color="#000080">Vref <b>= </b>Vref <b>- </b></font><font color="#FF0000">1
    </font><font color="#000080">Vref_set <b>( </b>Vref <b>)

    </b></font><font color="#808080"><i>-- delay to settle the comparator (typical 150 ns, max 400 ns)
    -- for 20 Mhz a maximu of 2 instructions is enough
    -- total while loop is about 50 usec
    </i></font><font color="#800080"><i>asm </i></font><font color="#000080">nop
    </font><font color="#800080"><i>asm </i></font><font color="#000080">nop

    </font><font color="#808080"><i>-- now read comparator
    </i></font><font color="#000080">comparator <b>= </b>CMCON

    </font><font color="#808080"><i>-- now test the actual comparator
    </i></font><b>if </b><font color="#000080">_pot_scan1 </font><b>then
      </b><font color="#000080">comparator <b>= ( </b>comparator <b>&amp; </b></font><font color="#FF0000">0x80 </font><font color="#000080"><b>)
    </b></font><b>else
      </b><font color="#000080">comparator <b>= ( </b>comparator <b>&amp; </b></font><font color="#FF0000">0x40 </font><font color="#000080"><b>)
    </b></font><b>end if
    </b><font color="#000080">found <b>= ( </b>comparator <b>== </b></font><font color="#FF0000">0 </font><font color="#000080"><b>)

  </b></font><b>end loop
  </b><font color="#808080"><i>-- set focus on other potmeter
  </i></font><font color="#000080">_pot_scan1 <b>= ! </b>_pot_scan1

  </font><font color="#808080"><i>-- determine (absolute) difference
  </i></font><b>if </b><font color="#000080">_pot_scan1 </font><b>then </b><font color="#000080">comparator <b>= </b>Vref <b>- </b>_pot_value1
  </font><b>else </b><font color="#000080">comparator <b>= </b>Vref <b>- </b>_pot_value2 </font><b>end if


  </b><font color="#808080"><i>-- if overflow, correct to absolute value (negative --&gt; positive)
  </i></font><b>if </b><font color="#000080"><b>( ( </b>comparator <b>&amp; </b></font><font color="#FF0000">0x80 </font><font color="#000080"><b>) != </b></font><font color="#FF0000">0 </font><font color="#000080"><b>) </b></font><b>then
    </b><font color="#000080">comparator <b>= ( ! </b>comparator <b>) + </b></font><font color="#FF0000">1
  </font><b>end if

  </b><font color="#808080"><i>-- if difference large enough (hysteresis),
  -- export the value
  </i></font><b>if </b><font color="#000080">comparator <b>&gt;= </b></font><font color="#FF0000">2 </font><b>then
    if </b><font color="#000080">_pot_scan1 </font><b>then
      </b><font color="#000080">_pot_value1 <b>= </b>Vref
      _pot_key <b>= </b></font><font color="#FF0000">0x80 </font><font color="#000080"><b>+ </b>Vref <b>/ </b></font><font color="#FF0000">2
    </font><b>else
      </b><font color="#000080">_pot_value2 <b>= </b>Vref
      _pot_key <b>= </b></font><font color="#FF0000">0x90 </font><font color="#000080"><b>+ </b>Vref <b>/ </b></font><font color="#FF0000">2
    </font><b>end if
  end if
end procedure
</b><font color="#808080"><i>-- --------------------------------------------------------------------


-- --------------------------------------------------------------------
-- initialization
-- --------------------------------------------------------------------
  -- setup comparator, mode 2 is the only mode where both comparators are
  -- connected to the internal Vref
  </i></font><font color="#000080">CMCON <b>= </b>_CMCOM_mode2

  </font><font color="#808080"><i>-- setup Vref, high range and output enabled
  </i></font><font color="#000080">Vref_init <b>( </b></font><font color="#FF0000">true </font><font color="#000080"><b>, </b></font><font color="#FF0000">true </font><font color="#000080"><b>)

  </b></font><font color="#808080"><i>-- setup correct IO directions
  -- because these are the only comparator registers,
  -- where the scan routine for works
  -- other pins are possible, but then the CIS biot must be controled
  -- next statements not necessary, because
  -- it's assumed that ports are intialized as inputs
  -- pin_a0_direction = input
  -- pin_a1_direction = input

</i></font></font>
</code></pre>
</body>
</html>
