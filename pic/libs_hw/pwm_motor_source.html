<html>
<head>
<title>JALcc SourceCode exporting of pwm_motor_source.html</title>
</head>
<!-- Generated by SynEdit HTML exporter -->
<body text="#000000" bgcolor="#FFFFFF">
<pre>
<code><font  size=3 face="Courier New"><font color="#000080"><A href="pwm_motor.jal">download&nbsp;pwm_motor.jal</A>
</font><font color="#808080"><i>-- -----------------------------------------------------------------------------
-- &lt;title 8 PWM signals
-- &lt;License
-- freeware, under the terms of the GNU GPL
--  Copyright (C) 2002 Stef Mientki
-- -----------------------------------------------------------------------------
-- &lt;Description
-- Library that can control up to 8 pwm-signals (i.e. 8 motors).
-- uses   : TMR0 as interrupt generator
--
--
-- &lt;Version: 1.0  14-09-2002   Stef Mientki
--   - orginal release
-- -----------------------------------------------------------------------------
-- -----------------------------------------------------------------------------


-- -----------------------------------------------------------------------------
-- &lt;Example pwm motors
; -- define which motors will be available (motor1 = bit0 etc)
; const pwm_motors = 0b_0000_0011
;
; -- define to which pin each motor is connected,
; -- all 8 motor-pins must be definied,
; -- if motors are not avalaible, just define it to a valid io-pin
; &lt;mac&gt; io_pin  pwm1_pin = pin_b0
; &lt;mac&gt; io_pin  pwm2_pin = pin_b1
; &lt;mac&gt; io_pin  pwm3_pin = pin_b1
; &lt;mac&gt; io_pin  pwm4_pin = pin_b1
; &lt;mac&gt; io_pin  pwm5_pin = pin_b1
; &lt;mac&gt; io_pin  pwm6_pin = pin_b1
; &lt;mac&gt; io_pin  pwm7_pin = pin_b1
; &lt;mac&gt; io_pin  pwm8_pin = pin_b1
;
; -- include the motor library
; include pwm_motor
;
; -- calculate and set TMR0, to the desired resolution of the PWM
; &lt;mac&gt; TMR0 20, 1000  ;Xtal=20 MHz , period=1 msec
;
; -- now the interrupt procedure should be called if T0IF is set,
; -- the easyist way of doing this by the macro statement &quot;interrupt_main&quot;
;
; -- now motors an be controled by just setting
; --     pwm1_period_preset = 10    ;the total period time
; --     pwm1_active_preset = 5     ;the active time
; --     -- ------------------------------------------
; --     -- period / active = 10 / 0    means 0%   high
; --     -- period / active = 10 / 1    means 10%  high
; --     -- ....
; --     -- period / active = 10 / 10   means 100% high
-- -----------------------------------------------------------------------------



-- &lt;code


-- -----------------------------------------------------------------------------
-- definition of the global variables
-- -----------------------------------------------------------------------------
</i></font><b>var volatile byte </b><font color="#000080">_tmr0_preset

</font><b>var volatile byte </b><font color="#000080">pwm1_period
</font><b>var volatile byte </b><font color="#000080">pwm1_period_preset
</font><b>var volatile byte </b><font color="#000080">pwm1_active
</font><b>var volatile byte </b><font color="#000080">pwm1_active_preset

</font><b>var volatile byte </b><font color="#000080">pwm2_period
</font><b>var volatile byte </b><font color="#000080">pwm2_period_preset
</font><b>var volatile byte </b><font color="#000080">pwm2_active
</font><b>var volatile byte </b><font color="#000080">pwm2_active_preset

</font><b>var volatile byte </b><font color="#000080">pwm3_period
</font><b>var volatile byte </b><font color="#000080">pwm3_period_preset
</font><b>var volatile byte </b><font color="#000080">pwm3_active
</font><b>var volatile byte </b><font color="#000080">pwm3_active_preset

</font><b>var volatile byte </b><font color="#000080">pwm4_period
</font><b>var volatile byte </b><font color="#000080">pwm4_period_preset
</font><b>var volatile byte </b><font color="#000080">pwm4_active
</font><b>var volatile byte </b><font color="#000080">pwm4_active_preset

</font><b>var volatile byte </b><font color="#000080">pwm5_period
</font><b>var volatile byte </b><font color="#000080">pwm5_period_preset
</font><b>var volatile byte </b><font color="#000080">pwm5_active
</font><b>var volatile byte </b><font color="#000080">pwm5_active_preset

</font><b>var volatile byte </b><font color="#000080">pwm6_period
</font><b>var volatile byte </b><font color="#000080">pwm6_period_preset
</font><b>var volatile byte </b><font color="#000080">pwm6_active
</font><b>var volatile byte </b><font color="#000080">pwm6_active_preset

</font><b>var volatile byte </b><font color="#000080">pwm7_period
</font><b>var volatile byte </b><font color="#000080">pwm7_period_preset
</font><b>var volatile byte </b><font color="#000080">pwm7_active
</font><b>var volatile byte </b><font color="#000080">pwm7_active_preset

</font><b>var volatile byte </b><font color="#000080">pwm8_period
</font><b>var volatile byte </b><font color="#000080">pwm8_period_preset
</font><b>var volatile byte </b><font color="#000080">pwm8_active
</font><b>var volatile byte </b><font color="#000080">pwm8_active_preset



</font><font color="#808080"><i>-- -----------------------------------------------------------------------------
-- internal routine
-- this is the procedure that should be called by the interrupt routine
-- If you're using JALcc, it's most convenient done by a macro statement
-- -----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">_pwm_motor_TMR0_interrupt </font><b>is
</b><font color="#000080"><b>&lt;</b></font><font color="#800080"><i>mac</i></font><font color="#000080"><b>&gt; </b>interrupt_sub _pwm_motor_TMR0_interrupt T0IF </font><font color="#FF0000">5

  </font><font color="#808080"><i>-- must be (one of) the first statement for accurate timing
  </i></font><font color="#000080">TMR0 <b>= </b>_tmr0_preset  </font><font color="#808080"><i>-- preset counter again

  -- motor 1
  -- the following if-statement is a compiler directive
  -- so it won't use any time- or code-space when this motor is present
  </i></font><b>if </b><font color="#000080"><b>(</b>pwm_motors <b>&amp; </b></font><font color="#FF0000">0b_0000_0001 </font><font color="#000080"><b>) != </b></font><font color="#FF0000">0 </font><b>then  </b><font color="#808080"><i>-- compiler directive !!
    </i></font><font color="#000080">pwm1_period <b>= </b>pwm1_period <b>+ </b></font><font color="#FF0000">1
    
</font><font color="#808080"><i>;MOET DIT NIET &gt;= WORDEN
    </i></font><b>if </b><font color="#000080">pwm1_period <b>== </b>pwm1_period_preset </font><b>then
      </b><font color="#000080">pwm1_period <b>= </b></font><font color="#FF0000">0
      </font><font color="#000080">pwm1_active <b>= </b></font><font color="#FF0000">0
    </font><b>else
      if </b><font color="#000080">pwm1_active <b>!= </b>pwm1_active_preset </font><b>then </b><font color="#000080">pwm1_active <b>= </b>pwm1_active <b>+ </b></font><font color="#FF0000">1 </font><b>end if
    end if
    </b><font color="#000080">pwm1_pin_pin <b>= (</b>pwm1_active <b>!= </b>pwm1_active_preset<b>)
  </b></font><b>end if

  </b><font color="#808080"><i>-- motor 2
  </i></font><b>if </b><font color="#000080"><b>(</b>pwm_motors <b>&amp; </b></font><font color="#FF0000">0b_0000_0010 </font><font color="#000080"><b>) != </b></font><font color="#FF0000">0 </font><b>then  </b><font color="#808080"><i>-- compiler directive !!
    </i></font><font color="#000080">pwm2_period <b>= </b>pwm2_period <b>+ </b></font><font color="#FF0000">1
    </font><b>if </b><font color="#000080">pwm2_period <b>== </b>pwm2_period_preset </font><b>then
      </b><font color="#000080">pwm2_period <b>= </b></font><font color="#FF0000">0
      </font><font color="#000080">pwm2_active <b>= </b></font><font color="#FF0000">0
    </font><b>else
      if </b><font color="#000080">pwm2_active <b>!= </b>pwm2_active_preset </font><b>then </b><font color="#000080">pwm2_active <b>= </b>pwm2_active <b>+ </b></font><font color="#FF0000">1 </font><b>end if
    end if
    </b><font color="#000080">pwm2_pin_pin <b>= (</b>pwm2_active <b>!= </b>pwm2_active_preset<b>)
  </b></font><b>end if

  </b><font color="#808080"><i>-- motor 3
  </i></font><b>if </b><font color="#000080"><b>(</b>pwm_motors <b>&amp; </b></font><font color="#FF0000">0b_0000_0100 </font><font color="#000080"><b>) != </b></font><font color="#FF0000">0 </font><b>then  </b><font color="#808080"><i>-- compiler directive !!
    </i></font><font color="#000080">pwm3_period <b>= </b>pwm3_period <b>+ </b></font><font color="#FF0000">1
    </font><b>if </b><font color="#000080">pwm3_period <b>== </b>pwm3_period_preset </font><b>then
      </b><font color="#000080">pwm3_period <b>= </b></font><font color="#FF0000">0
      </font><font color="#000080">pwm3_active <b>= </b></font><font color="#FF0000">0
    </font><b>else
      if </b><font color="#000080">pwm3_active <b>!= </b>pwm3_active_preset </font><b>then </b><font color="#000080">pwm3_active <b>= </b>pwm3_active <b>+ </b></font><font color="#FF0000">1 </font><b>end if
    end if
    </b><font color="#000080">pwm3_pin_pin <b>= (</b>pwm3_active <b>!= </b>pwm3_active_preset<b>)
  </b></font><b>end if

  </b><font color="#808080"><i>-- motor 4
  </i></font><b>if </b><font color="#000080"><b>(</b>pwm_motors <b>&amp; </b></font><font color="#FF0000">0b_0000_1000 </font><font color="#000080"><b>) != </b></font><font color="#FF0000">0 </font><b>then  </b><font color="#808080"><i>-- compiler directive !!
    </i></font><font color="#000080">pwm4_period <b>= </b>pwm4_period <b>+ </b></font><font color="#FF0000">1
    </font><b>if </b><font color="#000080">pwm4_period <b>== </b>pwm4_period_preset </font><b>then
      </b><font color="#000080">pwm4_period <b>= </b></font><font color="#FF0000">0
      </font><font color="#000080">pwm4_active <b>= </b></font><font color="#FF0000">0
    </font><b>else
      if </b><font color="#000080">pwm4_active <b>!= </b>pwm4_active_preset </font><b>then </b><font color="#000080">pwm4_active <b>= </b>pwm4_active <b>+ </b></font><font color="#FF0000">1 </font><b>end if
    end if
    </b><font color="#000080">pwm4_pin_pin <b>= (</b>pwm4_active <b>!= </b>pwm4_active_preset<b>)
  </b></font><b>end if

  </b><font color="#808080"><i>-- motor 5
  </i></font><b>if </b><font color="#000080"><b>(</b>pwm_motors <b>&amp; </b></font><font color="#FF0000">0b_0001_0000 </font><font color="#000080"><b>) != </b></font><font color="#FF0000">0 </font><b>then  </b><font color="#808080"><i>-- compiler directive !!
    </i></font><font color="#000080">pwm5_period <b>= </b>pwm5_period <b>+ </b></font><font color="#FF0000">1
    </font><b>if </b><font color="#000080">pwm5_period <b>== </b>pwm5_period_preset </font><b>then
      </b><font color="#000080">pwm5_period <b>= </b></font><font color="#FF0000">0
      </font><font color="#000080">pwm5_active <b>= </b></font><font color="#FF0000">0
    </font><b>else
      if </b><font color="#000080">pwm5_active <b>!= </b>pwm5_active_preset </font><b>then </b><font color="#000080">pwm5_active <b>= </b>pwm5_active <b>+ </b></font><font color="#FF0000">1 </font><b>end if
    end if
    </b><font color="#000080">pwm5_pin_pin <b>= (</b>pwm5_active <b>!= </b>pwm5_active_preset<b>)
  </b></font><b>end if

  </b><font color="#808080"><i>-- motor 6
  </i></font><b>if </b><font color="#000080"><b>(</b>pwm_motors <b>&amp; </b></font><font color="#FF0000">0b_0010_0000 </font><font color="#000080"><b>) != </b></font><font color="#FF0000">0 </font><b>then  </b><font color="#808080"><i>-- compiler directive !!
    </i></font><font color="#000080">pwm6_period <b>= </b>pwm6_period <b>+ </b></font><font color="#FF0000">1
    </font><b>if </b><font color="#000080">pwm6_period <b>== </b>pwm6_period_preset </font><b>then
      </b><font color="#000080">pwm6_period <b>= </b></font><font color="#FF0000">0
      </font><font color="#000080">pwm6_active <b>= </b></font><font color="#FF0000">0
    </font><b>else
      if </b><font color="#000080">pwm6_active <b>!= </b>pwm6_active_preset </font><b>then </b><font color="#000080">pwm6_active <b>= </b>pwm6_active <b>+ </b></font><font color="#FF0000">1 </font><b>end if
    end if
    </b><font color="#000080">pwm6_pin_pin <b>= (</b>pwm6_active <b>!= </b>pwm6_active_preset<b>)
  </b></font><b>end if

  </b><font color="#808080"><i>-- motor 7
  </i></font><b>if </b><font color="#000080"><b>(</b>pwm_motors <b>&amp; </b></font><font color="#FF0000">0b_0100_0000 </font><font color="#000080"><b>) != </b></font><font color="#FF0000">0 </font><b>then  </b><font color="#808080"><i>-- compiler directive !!
    </i></font><font color="#000080">pwm7_period <b>= </b>pwm7_period <b>+ </b></font><font color="#FF0000">1
    </font><b>if </b><font color="#000080">pwm7_period <b>== </b>pwm7_period_preset </font><b>then
      </b><font color="#000080">pwm7_period <b>= </b></font><font color="#FF0000">0
      </font><font color="#000080">pwm7_active <b>= </b></font><font color="#FF0000">0
    </font><b>else
      if </b><font color="#000080">pwm7_active <b>!= </b>pwm7_active_preset </font><b>then </b><font color="#000080">pwm7_active <b>= </b>pwm7_active <b>+ </b></font><font color="#FF0000">1 </font><b>end if
    end if
    </b><font color="#000080">pwm7_pin_pin <b>= (</b>pwm7_active <b>!= </b>pwm7_active_preset<b>)
  </b></font><b>end if

  </b><font color="#808080"><i>-- motor 8
  </i></font><b>if </b><font color="#000080"><b>(</b>pwm_motors <b>&amp; </b></font><font color="#FF0000">0b_1000_0000 </font><font color="#000080"><b>) != </b></font><font color="#FF0000">0 </font><b>then  </b><font color="#808080"><i>-- compiler directive !!
    </i></font><font color="#000080">pwm8_period <b>= </b>pwm8_period <b>+ </b></font><font color="#FF0000">1
    </font><b>if </b><font color="#000080">pwm8_period <b>== </b>pwm8_period_preset </font><b>then
      </b><font color="#000080">pwm8_period <b>= </b></font><font color="#FF0000">0
      </font><font color="#000080">pwm8_active <b>= </b></font><font color="#FF0000">0
    </font><b>else
      if </b><font color="#000080">pwm8_active <b>!= </b>pwm8_active_preset </font><b>then </b><font color="#000080">pwm8_active <b>= </b>pwm8_active <b>+ </b></font><font color="#FF0000">1 </font><b>end if
    end if
    </b><font color="#000080">pwm8_pin_pin <b>= (</b>pwm8_active <b>!= </b>pwm8_active_preset<b>)
  </b></font><b>end if

  </b><font color="#808080"><i>-- must be the last statement, to prevent reentrance
  </i></font><font color="#000080">T0IF <b>= </b></font><font color="#FF0000">false        </font><font color="#808080"><i>-- clear TMR0 interrupt flag
</i></font><b>end procedure
</b><font color="#808080"><i>-- -----------------------------------------------------------------------------



-- ---------------------------------------------------------------------
-- initializes all output pins used for the motors
-- this procedure is automatic called by the include of this library
-- and should rarely be called be the user
-- ---------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">pwm_motor_init </font><b>is
  </b><font color="#808080"><i>-- set all motor pins to output
  </i></font><b>if </b><font color="#000080"><b>(</b>pwm_motors <b>&amp; </b></font><font color="#FF0000">0b_0000_0001 </font><font color="#000080"><b>) != </b></font><font color="#FF0000">0 </font><b>then </b><font color="#000080">pwm1_pin_direction <b>= </b></font><font color="#FF0000">output </font><b>end if
  if </b><font color="#000080"><b>(</b>pwm_motors <b>&amp; </b></font><font color="#FF0000">0b_0000_0010 </font><font color="#000080"><b>) != </b></font><font color="#FF0000">0 </font><b>then </b><font color="#000080">pwm2_pin_direction <b>= </b></font><font color="#FF0000">output </font><b>end if
  if </b><font color="#000080"><b>(</b>pwm_motors <b>&amp; </b></font><font color="#FF0000">0b_0000_0100 </font><font color="#000080"><b>) != </b></font><font color="#FF0000">0 </font><b>then </b><font color="#000080">pwm3_pin_direction <b>= </b></font><font color="#FF0000">output </font><b>end if
  if </b><font color="#000080"><b>(</b>pwm_motors <b>&amp; </b></font><font color="#FF0000">0b_0000_1000 </font><font color="#000080"><b>) != </b></font><font color="#FF0000">0 </font><b>then </b><font color="#000080">pwm4_pin_direction <b>= </b></font><font color="#FF0000">output </font><b>end if
  if </b><font color="#000080"><b>(</b>pwm_motors <b>&amp; </b></font><font color="#FF0000">0b_0001_0000 </font><font color="#000080"><b>) != </b></font><font color="#FF0000">0 </font><b>then </b><font color="#000080">pwm5_pin_direction <b>= </b></font><font color="#FF0000">output </font><b>end if
  if </b><font color="#000080"><b>(</b>pwm_motors <b>&amp; </b></font><font color="#FF0000">0b_0010_0000 </font><font color="#000080"><b>) != </b></font><font color="#FF0000">0 </font><b>then </b><font color="#000080">pwm6_pin_direction <b>= </b></font><font color="#FF0000">output </font><b>end if
  if </b><font color="#000080"><b>(</b>pwm_motors <b>&amp; </b></font><font color="#FF0000">0b_0100_0000 </font><font color="#000080"><b>) != </b></font><font color="#FF0000">0 </font><b>then </b><font color="#000080">pwm7_pin_direction <b>= </b></font><font color="#FF0000">output </font><b>end if
  if </b><font color="#000080"><b>(</b>pwm_motors <b>&amp; </b></font><font color="#FF0000">0b_1000_0000 </font><font color="#000080"><b>) != </b></font><font color="#FF0000">0 </font><b>then </b><font color="#000080">pwm8_pin_direction <b>= </b></font><font color="#FF0000">output </font><b>end if

  </b><font color="#808080"><i>-- enable interrupts
  </i></font><font color="#000080">T0IE <b>= </b></font><font color="#FF0000">true   </font><font color="#808080"><i>-- enable TMR0 interrupt
  </i></font><font color="#000080">GIE  <b>= </b></font><font color="#FF0000">true   </font><font color="#808080"><i>-- enable general interrupts
  </i></font><font color="#000080">T0IF <b>= </b></font><font color="#FF0000">false  </font><font color="#808080"><i>-- clear TMR0 interrupt flag
</i></font><b>end procedure
</b><font color="#808080"><i>-- ---------------------------------------------------------------------


-- ---------------------------------------------------------------------
-- perform the stepper intialisation
-- ---------------------------------------------------------------------
</i></font><font color="#000080">pwm_motor_init




</font></font>
</code></pre>
</body>
</html>
