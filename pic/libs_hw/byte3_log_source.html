<html>
<head>
<title>JALcc SourceCode exporting of byte3_log_source.html</title>
</head>
<!-- Generated by SynEdit HTML exporter -->
<body text="#000000" bgcolor="#FFFFFF">
<pre>
<code><font  size=3 face="Courier New"><font color="#000080"><A href="byte3_log.jal">download&nbsp;byte3_log.jal</A>
</font><font color="#808080"><i>-- -----------------------------------------------------------------------------
-- &lt;title Integer LOG Math (3 byte)
-- &lt;License
-- freeware, under the terms of the GNU GPL
--  Copyright (C) 2002 Stef Mientki
-- -----------------------------------------------------------------------------
-- &lt;Description
--
-- The math routines acts on fixed variables X and Y, definied in Byte3_math.jal
-- The use of JALcc macros makes the use of this library very simple
--
-- overview of the available routines
--  byte3_LOG              Y = log ( X )  , X CHANGED !!
--  Accuracy of the LOG function must be set by the user, through the constant
--    const LOG_ACCURACY = 3
--
-- &lt;Version: 1.0  12-09-2004,  Stef Mientki
--   - LOG routines moved from Byte3_log.jal to here
--   - initial release
-- -----------------------------------------------------------------------------
-- -----------------------------------------------------------------------------



-- -----------------------------------------------------------------------------
-- &lt;Example RS232
; -- define settings
-- -----------------------------------------------------------------------------


</i></font><font color="#FF00FF">include byte3_math

</font><font color="#808080"><i>-- &lt;code


-- -----------------------------------------------------------------------------
-- this contents determines the length of the lookuptable for log calculation
-- and thereby the accuracy, length = 2 ^ ( LUT_Nbits - 1 )
-- LUT_Nbits       error           argument which gives the largest error
--    3            0.3 %           0x09
--    4            0.06 %          0x11
--    5            0.013 %         0x21
--    6            0.003 %         0x41
</i></font><b>const </b><font color="#000080">LUT_Nbits <b>= </b>LOG_ACCURACY
</font><font color="#808080"><i>-- -----------------------------------------------------------------------------


-- -----------------------------------------------------------------------------
-- -----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">_table_log_msb <b>(</b></font><b>byte in </b><font color="#000080">indx<b>, </b></font><b>byte out </b><font color="#000080">x<b>) </b></font><b>is
  </b><font color="#800080"><i>pragma </i></font><font color="#000080">jump_table
  </font><b>if </b><font color="#000080">LUT_Nbits <b>&lt;= </b></font><font color="#FF0000">2 </font><b>then
  elsif </b><font color="#000080">LUT_Nbits <b>== </b></font><font color="#FF0000">3 </font><b>then
    </b><font color="#800080"><i>assembler
      local </i></font><font color="#000080">table<b>,</b>exit
      </font><font color="#800080"><i>page </i></font><font color="#000080">exit
          movfw       indx        </font><font color="#808080"><i>;
          </i></font><font color="#000080">call        table       </font><font color="#808080"><i>;
          </i></font><font color="#000080">movwf       x           </font><font color="#808080"><i>;
          </i></font><font color="#000080">goto        exit        </font><font color="#808080"><i>;
      </i></font><font color="#000080">table<b>:                      </b></font><font color="#808080"><i>;
          </i></font><font color="#000080">addwf       PCL<b>,</b>F       </font><font color="#808080"><i>;
          ; PIC 24 bits log tables
          ; for 3 bits lookup
          ; gainfactor = $080000
          ; largest value = $00BFFFF9
          ;  MSB table (3bit)
          </i></font><font color="#000080">retlw   </font><font color="#FF0000">0x10
          </font><font color="#000080">retlw   </font><font color="#FF0000">0x12
          </font><font color="#000080">retlw   </font><font color="#FF0000">0x14
          </font><font color="#000080">retlw   </font><font color="#FF0000">0x16
          </font><font color="#000080">retlw   </font><font color="#FF0000">0x18
      </font><font color="#000080">exit<b>:                       </b></font><font color="#808080"><i>;
    </i></font><b>end </b><font color="#800080"><i>assembler
  </i></font><b>elsif </b><font color="#000080">LUT_Nbits <b>== </b></font><font color="#FF0000">4 </font><b>then
    </b><font color="#800080"><i>assembler
      local </i></font><font color="#000080">table<b>,</b>exit
      </font><font color="#800080"><i>page </i></font><font color="#000080">exit
          movfw       indx        </font><font color="#808080"><i>;
          </i></font><font color="#000080">call        table       </font><font color="#808080"><i>;
          </i></font><font color="#000080">movwf       x           </font><font color="#808080"><i>;
          </i></font><font color="#000080">goto        exit        </font><font color="#808080"><i>;
      </i></font><font color="#000080">table<b>:                      </b></font><font color="#808080"><i>;
          </i></font><font color="#000080">addwf       PCL<b>,</b>F       </font><font color="#808080"><i>;
        ; PIC 24 bits log tables
        ; for 4 bits lookup
        ; gainfactor = $080000
        ; largest value = $00BFFFF7
        ;  MSB table (4bit)
           </i></font><font color="#000080">retlw   </font><font color="#FF0000">0x18
           </font><font color="#000080">retlw   </font><font color="#FF0000">0x19
           </font><font color="#000080">retlw   </font><font color="#FF0000">0x1A
           </font><font color="#000080">retlw   </font><font color="#FF0000">0x1B
           </font><font color="#000080">retlw   </font><font color="#FF0000">0x1C
           </font><font color="#000080">retlw   </font><font color="#FF0000">0x1D
           </font><font color="#000080">retlw   </font><font color="#FF0000">0x1E
           </font><font color="#000080">retlw   </font><font color="#FF0000">0x1F
           </font><font color="#000080">retlw   </font><font color="#FF0000">0x20
    </font><font color="#000080">exit<b>:                       </b></font><font color="#808080"><i>;
    </i></font><b>end </b><font color="#800080"><i>assembler
  </i></font><b>elsif </b><font color="#000080">LUT_Nbits <b>== </b></font><font color="#FF0000">5 </font><b>then
    </b><font color="#800080"><i>assembler
      local </i></font><font color="#000080">table<b>,</b>exit
      </font><font color="#800080"><i>page </i></font><font color="#000080">exit
          movfw       indx        </font><font color="#808080"><i>;
          </i></font><font color="#000080">call        table       </font><font color="#808080"><i>;
          </i></font><font color="#000080">movwf       x           </font><font color="#808080"><i>;
          </i></font><font color="#000080">goto        exit        </font><font color="#808080"><i>;
      </i></font><font color="#000080">table<b>:                      </b></font><font color="#808080"><i>;
          </i></font><font color="#000080">addwf       PCL<b>,</b>F       </font><font color="#808080"><i>;
        ; PIC 24 bits log tables
        ; for 5 bits lookup
        ; gainfactor = $080000
        ; largest value = $00BFFFF6
        ;  MSB table (5bit)
           </i></font><font color="#000080">retlw   </font><font color="#FF0000">0x20
           </font><font color="#000080">retlw   </font><font color="#FF0000">0x20
           </font><font color="#000080">retlw   </font><font color="#FF0000">0x21
           </font><font color="#000080">retlw   </font><font color="#FF0000">0x21
           </font><font color="#000080">retlw   </font><font color="#FF0000">0x22
           </font><font color="#000080">retlw   </font><font color="#FF0000">0x23
           </font><font color="#000080">retlw   </font><font color="#FF0000">0x23
           </font><font color="#000080">retlw   </font><font color="#FF0000">0x24
           </font><font color="#000080">retlw   </font><font color="#FF0000">0x24
           </font><font color="#000080">retlw   </font><font color="#FF0000">0x25
           </font><font color="#000080">retlw   </font><font color="#FF0000">0x25
           </font><font color="#000080">retlw   </font><font color="#FF0000">0x26
           </font><font color="#000080">retlw   </font><font color="#FF0000">0x26
           </font><font color="#000080">retlw   </font><font color="#FF0000">0x26
           </font><font color="#000080">retlw   </font><font color="#FF0000">0x27
           </font><font color="#000080">retlw   </font><font color="#FF0000">0x27
           </font><font color="#000080">retlw   </font><font color="#FF0000">0x28
      </font><font color="#000080">exit<b>:                       </b></font><font color="#808080"><i>;
    </i></font><b>end </b><font color="#800080"><i>assembler
  </i></font><b>else
    </b><font color="#800080"><i>assembler
      local </i></font><font color="#000080">table<b>,</b>exit
      </font><font color="#800080"><i>page </i></font><font color="#000080">exit
          movfw       indx        </font><font color="#808080"><i>;
          </i></font><font color="#000080">call        table       </font><font color="#808080"><i>;
          </i></font><font color="#000080">movwf       x           </font><font color="#808080"><i>;
          </i></font><font color="#000080">goto        exit        </font><font color="#808080"><i>;
      </i></font><font color="#000080">table<b>:                      </b></font><font color="#808080"><i>;
          </i></font><font color="#000080">addwf       PCL<b>,</b>F       </font><font color="#808080"><i>;
      ; PIC 24 bits log tables
      ; for 6 bits lookup
      ; gainfactor = $080000
      ; largest value = $00BFFFFA
      ;  MSB table (6bit)
         </i></font><font color="#000080">retlw   </font><font color="#FF0000">0x28
         </font><font color="#000080">retlw   </font><font color="#FF0000">0x28
         </font><font color="#000080">retlw   </font><font color="#FF0000">0x28
         </font><font color="#000080">retlw   </font><font color="#FF0000">0x29
         </font><font color="#000080">retlw   </font><font color="#FF0000">0x29
         </font><font color="#000080">retlw   </font><font color="#FF0000">0x29
         </font><font color="#000080">retlw   </font><font color="#FF0000">0x29
         </font><font color="#000080">retlw   </font><font color="#FF0000">0x2A
         </font><font color="#000080">retlw   </font><font color="#FF0000">0x2A
         </font><font color="#000080">retlw   </font><font color="#FF0000">0x2A
         </font><font color="#000080">retlw   </font><font color="#FF0000">0x2B
         </font><font color="#000080">retlw   </font><font color="#FF0000">0x2B
         </font><font color="#000080">retlw   </font><font color="#FF0000">0x2B
         </font><font color="#000080">retlw   </font><font color="#FF0000">0x2B
         </font><font color="#000080">retlw   </font><font color="#FF0000">0x2C
         </font><font color="#000080">retlw   </font><font color="#FF0000">0x2C
         </font><font color="#000080">retlw   </font><font color="#FF0000">0x2C
         </font><font color="#000080">retlw   </font><font color="#FF0000">0x2C
         </font><font color="#000080">retlw   </font><font color="#FF0000">0x2D
         </font><font color="#000080">retlw   </font><font color="#FF0000">0x2D
         </font><font color="#000080">retlw   </font><font color="#FF0000">0x2D
         </font><font color="#000080">retlw   </font><font color="#FF0000">0x2D
         </font><font color="#000080">retlw   </font><font color="#FF0000">0x2E
         </font><font color="#000080">retlw   </font><font color="#FF0000">0x2E
         </font><font color="#000080">retlw   </font><font color="#FF0000">0x2E
         </font><font color="#000080">retlw   </font><font color="#FF0000">0x2E
         </font><font color="#000080">retlw   </font><font color="#FF0000">0x2E
         </font><font color="#000080">retlw   </font><font color="#FF0000">0x2F
         </font><font color="#000080">retlw   </font><font color="#FF0000">0x2F
         </font><font color="#000080">retlw   </font><font color="#FF0000">0x2F
         </font><font color="#000080">retlw   </font><font color="#FF0000">0x2F
         </font><font color="#000080">retlw   </font><font color="#FF0000">0x2F
         </font><font color="#000080">retlw   </font><font color="#FF0000">0x30
      </font><font color="#000080">exit<b>:                       </b></font><font color="#808080"><i>;
    </i></font><b>end </b><font color="#800080"><i>assembler
  </i></font><b>end if
end procedure
</b><font color="#808080"><i>-- -----------------------------------------------------------------------------



-- -----------------------------------------------------------------------------
-- -----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">_table_log_middle <b>(</b></font><b>byte in </b><font color="#000080">indx<b>, </b></font><b>byte out </b><font color="#000080">x<b>) </b></font><b>is
  </b><font color="#800080"><i>pragma </i></font><font color="#000080">jump_table
  </font><b>if </b><font color="#000080">LUT_Nbits <b>&lt;= </b></font><font color="#FF0000">2 </font><b>then
  elsif </b><font color="#000080">LUT_Nbits <b>== </b></font><font color="#FF0000">3 </font><b>then
    </b><font color="#800080"><i>assembler
      local </i></font><font color="#000080">table<b>,</b>exit
      </font><font color="#800080"><i>page </i></font><font color="#000080">exit
          movfw       indx        </font><font color="#808080"><i>;
          </i></font><font color="#000080">call        table       </font><font color="#808080"><i>;
          </i></font><font color="#000080">movwf       x           </font><font color="#808080"><i>;
          </i></font><font color="#000080">goto        exit        </font><font color="#808080"><i>;
      </i></font><font color="#000080">table<b>:                      </b></font><font color="#808080"><i>;
          </i></font><font color="#000080">addwf       PCL<b>,</b>F       </font><font color="#808080"><i>;
         ;  middle table (3bit)
         </i></font><font color="#000080">retlw   </font><font color="#FF0000">0x00
         </font><font color="#000080">retlw   </font><font color="#FF0000">0x93
         </font><font color="#000080">retlw   </font><font color="#FF0000">0xAE
         </font><font color="#000080">retlw   </font><font color="#FF0000">0x75
         </font><font color="#000080">retlw   </font><font color="#FF0000">0x00
      </font><font color="#000080">exit<b>:                       </b></font><font color="#808080"><i>;
    </i></font><b>end </b><font color="#800080"><i>assembler
  </i></font><b>elsif </b><font color="#000080">LUT_Nbits <b>== </b></font><font color="#FF0000">4 </font><b>then
    </b><font color="#800080"><i>assembler
      local </i></font><font color="#000080">table<b>,</b>exit
      </font><font color="#800080"><i>page </i></font><font color="#000080">exit
          movfw       indx        </font><font color="#808080"><i>;
          </i></font><font color="#000080">call        table       </font><font color="#808080"><i>;
          </i></font><font color="#000080">movwf       x           </font><font color="#808080"><i>;
          </i></font><font color="#000080">goto        exit        </font><font color="#808080"><i>;
      </i></font><font color="#000080">table<b>:                      </b></font><font color="#808080"><i>;
          </i></font><font color="#000080">addwf       PCL<b>,</b>F       </font><font color="#808080"><i>;
         ;  middle table (4bit)
           </i></font><font color="#000080">retlw   </font><font color="#FF0000">0x00
           </font><font color="#000080">retlw   </font><font color="#FF0000">0x5C
           </font><font color="#000080">retlw   </font><font color="#FF0000">0x93
           </font><font color="#000080">retlw   </font><font color="#FF0000">0xAC
           </font><font color="#000080">retlw   </font><font color="#FF0000">0xAE
           </font><font color="#000080">retlw   </font><font color="#FF0000">0x9A
           </font><font color="#000080">retlw   </font><font color="#FF0000">0x75
           </font><font color="#000080">retlw   </font><font color="#FF0000">0x41
           </font><font color="#000080">retlw   </font><font color="#FF0000">0x00
      </font><font color="#000080">exit<b>:                       </b></font><font color="#808080"><i>;
    </i></font><b>end </b><font color="#800080"><i>assembler
  </i></font><b>elsif </b><font color="#000080">LUT_Nbits <b>== </b></font><font color="#FF0000">5 </font><b>then
    </b><font color="#800080"><i>assembler
      local </i></font><font color="#000080">table<b>,</b>exit
      </font><font color="#800080"><i>page </i></font><font color="#000080">exit
          movfw       indx        </font><font color="#808080"><i>;
          </i></font><font color="#000080">call        table       </font><font color="#808080"><i>;
          </i></font><font color="#000080">movwf       x           </font><font color="#808080"><i>;
          </i></font><font color="#000080">goto        exit        </font><font color="#808080"><i>;
      </i></font><font color="#000080">table<b>:                      </b></font><font color="#808080"><i>;
          </i></font><font color="#000080">addwf       PCL<b>,</b>F       </font><font color="#808080"><i>;
         ;  middle table (5bit)
           </i></font><font color="#000080">retlw   </font><font color="#FF0000">0x00
           </font><font color="#000080">retlw   </font><font color="#FF0000">0xB3
           </font><font color="#000080">retlw   </font><font color="#FF0000">0x5C
           </font><font color="#000080">retlw   </font><font color="#FF0000">0xFB
           </font><font color="#000080">retlw   </font><font color="#FF0000">0x93
           </font><font color="#000080">retlw   </font><font color="#FF0000">0x23
           </font><font color="#000080">retlw   </font><font color="#FF0000">0xAC
           </font><font color="#000080">retlw   </font><font color="#FF0000">0x30
           </font><font color="#000080">retlw   </font><font color="#FF0000">0xAE
           </font><font color="#000080">retlw   </font><font color="#FF0000">0x26
           </font><font color="#000080">retlw   </font><font color="#FF0000">0x9A
           </font><font color="#000080">retlw   </font><font color="#FF0000">0x0A
           </font><font color="#000080">retlw   </font><font color="#FF0000">0x75
           </font><font color="#000080">retlw   </font><font color="#FF0000">0xDD
           </font><font color="#000080">retlw   </font><font color="#FF0000">0x41
           </font><font color="#000080">retlw   </font><font color="#FF0000">0xA2
           </font><font color="#000080">retlw   </font><font color="#FF0000">0x00
      </font><font color="#000080">exit<b>:                       </b></font><font color="#808080"><i>;
    </i></font><b>end </b><font color="#800080"><i>assembler
  </i></font><b>else
    </b><font color="#800080"><i>assembler
      local </i></font><font color="#000080">table<b>,</b>exit
      </font><font color="#800080"><i>page </i></font><font color="#000080">exit
          movfw       indx        </font><font color="#808080"><i>;
          </i></font><font color="#000080">call        table       </font><font color="#808080"><i>;
          </i></font><font color="#000080">movwf       x           </font><font color="#808080"><i>;
          </i></font><font color="#000080">goto        exit        </font><font color="#808080"><i>;
      </i></font><font color="#000080">table<b>:                      </b></font><font color="#808080"><i>;
          </i></font><font color="#000080">addwf       PCL<b>,</b>F       </font><font color="#808080"><i>;
        ;  middle table (6bit)
           </i></font><font color="#000080">retlw   </font><font color="#FF0000">0x00
           </font><font color="#000080">retlw   </font><font color="#FF0000">0x5A
           </font><font color="#000080">retlw   </font><font color="#FF0000">0xB3
           </font><font color="#000080">retlw   </font><font color="#FF0000">0x08
           </font><font color="#000080">retlw   </font><font color="#FF0000">0x5C
           </font><font color="#000080">retlw   </font><font color="#FF0000">0xAC
           </font><font color="#000080">retlw   </font><font color="#FF0000">0xFB
           </font><font color="#000080">retlw   </font><font color="#FF0000">0x48
           </font><font color="#000080">retlw   </font><font color="#FF0000">0x93
           </font><font color="#000080">retlw   </font><font color="#FF0000">0xDC
           </font><font color="#000080">retlw   </font><font color="#FF0000">0x23
           </font><font color="#000080">retlw   </font><font color="#FF0000">0x68
           </font><font color="#000080">retlw   </font><font color="#FF0000">0xAC
           </font><font color="#000080">retlw   </font><font color="#FF0000">0xEF
           </font><font color="#000080">retlw   </font><font color="#FF0000">0x30
           </font><font color="#000080">retlw   </font><font color="#FF0000">0x6F
           </font><font color="#000080">retlw   </font><font color="#FF0000">0xAE
           </font><font color="#000080">retlw   </font><font color="#FF0000">0xEA
           </font><font color="#000080">retlw   </font><font color="#FF0000">0x26
           </font><font color="#000080">retlw   </font><font color="#FF0000">0x61
           </font><font color="#000080">retlw   </font><font color="#FF0000">0x9A
           </font><font color="#000080">retlw   </font><font color="#FF0000">0xD2
           </font><font color="#000080">retlw   </font><font color="#FF0000">0x0A
           </font><font color="#000080">retlw   </font><font color="#FF0000">0x40
           </font><font color="#000080">retlw   </font><font color="#FF0000">0x75
           </font><font color="#000080">retlw   </font><font color="#FF0000">0xA9
           </font><font color="#000080">retlw   </font><font color="#FF0000">0xDD
           </font><font color="#000080">retlw   </font><font color="#FF0000">0x0F
           </font><font color="#000080">retlw   </font><font color="#FF0000">0x41
           </font><font color="#000080">retlw   </font><font color="#FF0000">0x72
           </font><font color="#000080">retlw   </font><font color="#FF0000">0xA2
           </font><font color="#000080">retlw   </font><font color="#FF0000">0xD1
           </font><font color="#000080">retlw   </font><font color="#FF0000">0x00
      </font><font color="#000080">exit<b>:                       </b></font><font color="#808080"><i>;
    </i></font><b>end </b><font color="#800080"><i>assembler
  </i></font><b>end if
end procedure
</b><font color="#808080"><i>-- -----------------------------------------------------------------------------



-- -----------------------------------------------------------------------------
-- -----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">_table_log_lsb <b>(</b></font><b>byte in </b><font color="#000080">indx<b>, </b></font><b>byte out </b><font color="#000080">x<b>) </b></font><b>is
  </b><font color="#800080"><i>pragma </i></font><font color="#000080">jump_table
  </font><b>if </b><font color="#000080">LUT_Nbits <b>&lt;= </b></font><font color="#FF0000">2 </font><b>then
  elsif </b><font color="#000080">LUT_Nbits <b>== </b></font><font color="#FF0000">3 </font><b>then
    </b><font color="#800080"><i>assembler
      local </i></font><font color="#000080">table<b>,</b>exit
      </font><font color="#800080"><i>page </i></font><font color="#000080">exit
          movfw       indx        </font><font color="#808080"><i>;
          </i></font><font color="#000080">call        table       </font><font color="#808080"><i>;
          </i></font><font color="#000080">movwf       x           </font><font color="#808080"><i>;
          </i></font><font color="#000080">goto        exit        </font><font color="#808080"><i>;
      </i></font><font color="#000080">table<b>:                      </b></font><font color="#808080"><i>;
          </i></font><font color="#000080">addwf       PCL<b>,</b>F       </font><font color="#808080"><i>;
          ;  LSB table (3bit)
          </i></font><font color="#000080">retlw   </font><font color="#FF0000">0x00
          </font><font color="#000080">retlw   </font><font color="#FF0000">0x4F
          </font><font color="#000080">retlw   </font><font color="#FF0000">0x01
          </font><font color="#000080">retlw   </font><font color="#FF0000">0x76
          </font><font color="#000080">retlw   </font><font color="#FF0000">0x00
      </font><font color="#000080">exit<b>:                       </b></font><font color="#808080"><i>;
    </i></font><b>end </b><font color="#800080"><i>assembler
  </i></font><b>elsif </b><font color="#000080">LUT_Nbits <b>== </b></font><font color="#FF0000">4 </font><b>then
    </b><font color="#800080"><i>assembler
      local </i></font><font color="#000080">table<b>,</b>exit
      </font><font color="#800080"><i>page </i></font><font color="#000080">exit
          movfw       indx        </font><font color="#808080"><i>;
          </i></font><font color="#000080">call        table       </font><font color="#808080"><i>;
          </i></font><font color="#000080">movwf       x           </font><font color="#808080"><i>;
          </i></font><font color="#000080">goto        exit        </font><font color="#808080"><i>;
      </i></font><font color="#000080">table<b>:                      </b></font><font color="#808080"><i>;
          </i></font><font color="#000080">addwf       PCL<b>,</b>F       </font><font color="#808080"><i>;
         ;  LSB table (4bit)
           </i></font><font color="#000080">retlw   </font><font color="#FF0000">0x00
           </font><font color="#000080">retlw   </font><font color="#FF0000">0x02
           </font><font color="#000080">retlw   </font><font color="#FF0000">0x4F
           </font><font color="#000080">retlw   </font><font color="#FF0000">0xEA
           </font><font color="#000080">retlw   </font><font color="#FF0000">0x01
           </font><font color="#000080">retlw   </font><font color="#FF0000">0x80
           </font><font color="#000080">retlw   </font><font color="#FF0000">0x76
           </font><font color="#000080">retlw   </font><font color="#FF0000">0x50
           </font><font color="#000080">retlw   </font><font color="#FF0000">0x00
      </font><font color="#000080">exit<b>:                       </b></font><font color="#808080"><i>;
    </i></font><b>end </b><font color="#800080"><i>assembler
  </i></font><b>elsif </b><font color="#000080">LUT_Nbits <b>== </b></font><font color="#FF0000">5 </font><b>then
    </b><font color="#800080"><i>assembler
      local </i></font><font color="#000080">table<b>,</b>exit
      </font><font color="#800080"><i>page </i></font><font color="#000080">exit
          movfw       indx        </font><font color="#808080"><i>;
          </i></font><font color="#000080">call        table       </font><font color="#808080"><i>;
          </i></font><font color="#000080">movwf       x           </font><font color="#808080"><i>;
          </i></font><font color="#000080">goto        exit        </font><font color="#808080"><i>;
      </i></font><font color="#000080">table<b>:                      </b></font><font color="#808080"><i>;
          </i></font><font color="#000080">addwf       PCL<b>,</b>F       </font><font color="#808080"><i>;
         ;  LSB table (5bit)
           </i></font><font color="#000080">retlw   </font><font color="#FF0000">0x00
           </font><font color="#000080">retlw   </font><font color="#FF0000">0x20
           </font><font color="#000080">retlw   </font><font color="#FF0000">0x02
           </font><font color="#000080">retlw   </font><font color="#FF0000">0xC1
           </font><font color="#000080">retlw   </font><font color="#FF0000">0x4F
           </font><font color="#000080">retlw   </font><font color="#FF0000">0x77
           </font><font color="#000080">retlw   </font><font color="#FF0000">0xEA
           </font><font color="#000080">retlw   </font><font color="#FF0000">0x41
           </font><font color="#000080">retlw   </font><font color="#FF0000">0x01
           </font><font color="#000080">retlw   </font><font color="#FF0000">0x9E
           </font><font color="#000080">retlw   </font><font color="#FF0000">0x80
           </font><font color="#000080">retlw   </font><font color="#FF0000">0x02
           </font><font color="#000080">retlw   </font><font color="#FF0000">0x76
           </font><font color="#000080">retlw   </font><font color="#FF0000">0x25
           </font><font color="#000080">retlw   </font><font color="#FF0000">0x50
           </font><font color="#000080">retlw   </font><font color="#FF0000">0x32
           </font><font color="#000080">retlw   </font><font color="#FF0000">0x00

      </font><font color="#000080">exit<b>:                       </b></font><font color="#808080"><i>;
    </i></font><b>end </b><font color="#800080"><i>assembler
  </i></font><b>else </b><font color="#808080"><i>-- LUT_Nbits == 6
    </i></font><font color="#800080"><i>assembler
      local </i></font><font color="#000080">table<b>,</b>exit
      </font><font color="#800080"><i>page </i></font><font color="#000080">exit
          movfw       indx        </font><font color="#808080"><i>;
          </i></font><font color="#000080">call        table       </font><font color="#808080"><i>;
          </i></font><font color="#000080">movwf       x           </font><font color="#808080"><i>;
          </i></font><font color="#000080">goto        exit        </font><font color="#808080"><i>;
      </i></font><font color="#000080">table<b>:                      </b></font><font color="#808080"><i>;
          </i></font><font color="#000080">addwf       PCL<b>,</b>F       </font><font color="#808080"><i>;
        ;  LSB table (6bit)
           </i></font><font color="#000080">retlw   </font><font color="#FF0000">0x00
           </font><font color="#000080">retlw   </font><font color="#FF0000">0xEB
           </font><font color="#000080">retlw   </font><font color="#FF0000">0x20
           </font><font color="#000080">retlw   </font><font color="#FF0000">0xC6
           </font><font color="#000080">retlw   </font><font color="#FF0000">0x02
           </font><font color="#000080">retlw   </font><font color="#FF0000">0xF6
           </font><font color="#000080">retlw   </font><font color="#FF0000">0xC1
           </font><font color="#000080">retlw   </font><font color="#FF0000">0x81
           </font><font color="#000080">retlw   </font><font color="#FF0000">0x4F
           </font><font color="#000080">retlw   </font><font color="#FF0000">0x44
           </font><font color="#000080">retlw   </font><font color="#FF0000">0x77
           </font><font color="#000080">retlw   </font><font color="#FF0000">0xFD
           </font><font color="#000080">retlw   </font><font color="#FF0000">0xEA
           </font><font color="#000080">retlw   </font><font color="#FF0000">0x51
           </font><font color="#000080">retlw   </font><font color="#FF0000">0x41
           </font><font color="#000080">retlw   </font><font color="#FF0000">0xCC
           </font><font color="#000080">retlw   </font><font color="#FF0000">0x01
           </font><font color="#000080">retlw   </font><font color="#FF0000">0xED
           </font><font color="#000080">retlw   </font><font color="#FF0000">0x9E
           </font><font color="#000080">retlw   </font><font color="#FF0000">0x21
           </font><font color="#000080">retlw   </font><font color="#FF0000">0x80
           </font><font color="#000080">retlw   </font><font color="#FF0000">0xC8
           </font><font color="#000080">retlw   </font><font color="#FF0000">0x02
           </font><font color="#000080">retlw   </font><font color="#FF0000">0x3A
           </font><font color="#000080">retlw   </font><font color="#FF0000">0x76
           </font><font color="#000080">retlw   </font><font color="#FF0000">0xC2
           </font><font color="#000080">retlw   </font><font color="#FF0000">0x25
           </font><font color="#000080">retlw   </font><font color="#FF0000">0xA7
           </font><font color="#000080">retlw   </font><font color="#FF0000">0x50
           </font><font color="#000080">retlw   </font><font color="#FF0000">0x26
           </font><font color="#000080">retlw   </font><font color="#FF0000">0x32
           </font><font color="#000080">retlw   </font><font color="#FF0000">0x78
           </font><font color="#000080">retlw   </font><font color="#FF0000">0x00
      </font><font color="#000080">exit<b>:                       </b></font><font color="#808080"><i>;
    </i></font><b>end </b><font color="#800080"><i>assembler
  </i></font><b>end if
end procedure
</b><font color="#808080"><i>-- -----------------------------------------------------------------------------



-- -----------------------------------------------------------------------------
-- 24 bit LOG routine
-- Y = log ( X )
-- X is CHANGED !!
-- -----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">byte3_LOG </font><b>is

const </b><font color="#000080">TOT_Nbits <b>= </b></font><font color="#FF0000">24
</font><b>const </b><font color="#000080">frac_bit  <b>= </b></font><font color="#FF0000">7 </font><font color="#000080"><b>- </b>LUT_Nbits   </font><font color="#808080"><i>-- 4

</i></font><b>var byte </b><font color="#000080">lut_index
</font><b>var byte </b><font color="#000080">lut_mask
</font><b>var byte </b><font color="#000080">nshift
</font><b>var byte </b><font color="#000080">x
</font><b>var byte </b><font color="#000080">x_shl
</font><b>var byte </b><font color="#000080">z3<b>,</b>z2<b>,</b>z1


      </font><font color="#808080"><i>-- limit lower argument value at 1
      </i></font><b>if </b><font color="#000080"><b>(</b>x3 <b>== </b></font><font color="#FF0000">0</font><font color="#000080"><b>) &amp; (</b>x2 <b>== </b></font><font color="#FF0000">0</font><font color="#000080"><b>) &amp; (</b>x1 <b>== </b></font><font color="#FF0000">0</font><font color="#000080"><b>) </b></font><b>then </b><font color="#000080">x1 <b>= </b></font><font color="#FF0000">1 </font><b>end if

      </b><font color="#808080"><i>-- determine X_SHL
      </i></font><font color="#000080">x_shl <b>= </b></font><font color="#FF0000">0
      </font><font color="#800080"><i>assembler
      local </i></font><font color="#000080">next_rot<b>, </b>test_msb<b>, </b>finish
      </font><font color="#800080"><i>page </i></font><font color="#000080">finish
        bcf     status<b>,</b>C   </font><font color="#808080"><i>;clear Carry
        </i></font><font color="#000080">goto    test_msb   </font><font color="#808080"><i>;
      </i></font><font color="#000080">next_rot<b>:            </b></font><font color="#808080"><i>;shift X until msb is &quot;1&quot;
        </i></font><font color="#000080">rlf     x1<b>,</b>f       </font><font color="#808080"><i>;
        </i></font><font color="#000080">rlf     x2<b>,</b>f       </font><font color="#808080"><i>;
        </i></font><font color="#000080">rlf     x3<b>,</b>f       </font><font color="#808080"><i>;
      </i></font><font color="#000080">test_msb<b>:            </b></font><font color="#808080"><i>;
        </i></font><font color="#000080">btfsc   x3<b>,</b></font><font color="#FF0000">7       </font><font color="#808080"><i>;test msb
        </i></font><font color="#000080">goto    finish     </font><font color="#808080"><i>;
        </i></font><font color="#000080">incf    x_shl<b>,</b>f    </font><font color="#808080"><i>;remember number of shifts
        </i></font><font color="#000080">goto    next_rot   </font><font color="#808080"><i>;
      </i></font><font color="#000080">finish<b>:              </b></font><font color="#808080"><i>;
      </i></font><b>end </b><font color="#800080"><i>assembler

      </i></font><font color="#808080"><i>-- determine lookupindex
      </i></font><font color="#000080">LUT_mask <b>= </b></font><font color="#FF0000">0xFF </font><font color="#000080"><b>&gt;&gt; </b>LUT_Nbits
      x <b>= ( </b>x3 <b>&amp; ! </b>LUT_mask <b>) &gt;&gt; ( </b></font><font color="#FF0000">8 </font><font color="#000080"><b>- </b>LUT_Nbits <b>)

      </b></font><font color="#808080"><i>-- determine fraction
      </i></font><font color="#000080">z1 <b>= </b>x1
      z2 <b>= </b>x2
      z3 <b>= </b>x3 <b>&amp; </b>LUT_mask


      </font><font color="#808080"><i>-- calculate the difference between the 2 consecutive table values
      </i></font><font color="#000080">x <b>= </b>x <b>- (</b></font><font color="#FF0000">1 </font><font color="#000080"><b>&lt;&lt; (</b>LUT_Nbits <b>- </b></font><font color="#FF0000">1</font><font color="#000080"><b>))
      </b>_table_log_msb    <b>( </b>x<b>, </b>X3 <b>)
      </b>_table_log_middle <b>( </b>x<b>, </b>X2 <b>)
      </b>_table_log_lsb    <b>( </b>x<b>, </b>X1 <b>)
      </b>x <b>= </b>x <b>+ </b></font><font color="#FF0000">1
      </font><font color="#000080">_table_log_msb    <b>( </b>x<b>, </b>Y3 <b>)
      </b>_table_log_middle <b>( </b>x<b>, </b>Y2 <b>)
      </b>_table_log_lsb    <b>( </b>x<b>, </b>Y1 <b>)

      </b>byte3_sub  </font><font color="#808080"><i>-- y = LUT[i+1] - LUT[i]
                 -- x = LUT[i]



      </i></font><font color="#000080">byte3_xchg  </font><font color="#808080"><i>-- exchange x an y
      -- so now y = LUT[i] and here the result of the fraction will be added
      -- x = delta-LUT = LUT[i+1] - LUT[i]


      </i></font><font color="#000080">nshift <b>= </b>TOT_Nbits <b>- </b>LUT_Nbits
      </font><font color="#800080"><i>assembler
      local </i></font><font color="#000080">next_frac<b>, </b>no_add
      </font><font color="#800080"><i>page </i></font><font color="#000080">no_add

      </font><font color="#808080"><i>;shift delta_LUT one bit to the right
      </i></font><font color="#000080">next_frac<b>:           </b></font><font color="#808080"><i>;
        </i></font><font color="#000080">bcf     status<b>,</b>C   </font><font color="#808080"><i>;divide delta-LUT by 2
        </i></font><font color="#000080">rrf     X3<b>,</b>f       </font><font color="#808080"><i>;
        </i></font><font color="#000080">rrf     X2<b>,</b>f       </font><font color="#808080"><i>;
        </i></font><font color="#000080">rrf     X1<b>,</b>f       </font><font color="#808080"><i>;

      ;test the relevant bit of the fraction
        </i></font><font color="#000080">btfss   Z3<b>,</b>frac_bit</font><font color="#808080"><i>;
        </i></font><font color="#000080">goto    no_add     </font><font color="#808080"><i>;

      ;add another part of the fraction
        </i></font><font color="#000080">call    byte3_add  </font><font color="#808080"><i>; Y = Y + X = sum + delta-LUT

      ;shift fraction one bit to the left (Carry doesn't mind)
      </i></font><font color="#000080">no_add<b>:              </b></font><font color="#808080"><i>;
        </i></font><font color="#000080">rlf     Z1<b>,</b>f       </font><font color="#808080"><i>;
        </i></font><font color="#000080">rlf     Z2<b>,</b>f       </font><font color="#808080"><i>;
        </i></font><font color="#000080">rlf     Z3<b>,</b>f       </font><font color="#808080"><i>;

      ;test if ready
        </i></font><font color="#000080">decfsz  nshift<b>,</b>f   </font><font color="#808080"><i>;
        </i></font><font color="#000080">goto    next_frac  </font><font color="#808080"><i>;
      </i></font><b>end </b><font color="#800080"><i>assembler
      </i></font><font color="#808080"><i>-- now Y is the result, except for the X_SHL correction

      -- exchange X and Y, so X = result
      </i></font><font color="#000080">byte3_xchg

      </font><font color="#808080"><i>-- fill Y
      </i></font><font color="#000080">Y1 <b>= ( </b>TOT_Nbits <b>- </b>LUT_Nbits <b>)  - </b>x_shl
      Y2 <b>= </b></font><font color="#FF0000">0
      </font><font color="#000080">Y3 <b>= </b></font><font color="#FF0000">0
      </font><font color="#000080">byte3_shl <b>( </b>TOT_Nbits <b>- </b></font><font color="#FF0000">5 </font><font color="#000080"><b>)

      </b></font><font color="#808080"><i>-- now get the final result
      </i></font><font color="#000080">byte3_add

</font><b>end procedure
</b><font color="#808080"><i>-- -----------------------------------------------------------------------------

</i></font></font>
</code></pre>
</body>
</html>
