<html>
<head>
<title>JALcc SourceCode exporting of stepper_rs232_source.html</title>
</head>
<!-- Generated by SynEdit HTML exporter -->
<body text="#000000" bgcolor="#FFFFFF">
<pre>
<code><font  size=3 face="Courier New"><font color="#000080"><A href="stepper_rs232.jal">download&nbsp;stepper_rs232.jal</A>
</font><font color="#808080"><i>-- -----------------------------------------------------------------------------
-- &lt;title RS232-stepper
-- &lt;License
-- freeware, under the terms of the GNU GPL
--  Copyright (C) 2002 Stef Mientki
-- -----------------------------------------------------------------------------
-- &lt;Description
-- Controls 2 stepper motors, directly through RS232
--
-- &lt;non-tag
-- procedure SPI_init is

-- &lt;Version: 1.0  24-08-2002   Stef Mientki
--    - orginal release
-- --------------------------------------------------------------------


-- -----------------------------------------------------------------------------
-- &lt;Example RS232-stepper
; -- define the number of motors [1..2]
; -- defining only motor 1 decreases the amount of program code
; const stepper_Nmotors = 2
;
; -- define hardware position of motor 1
; var volatile byte _stepper1_port     is port_b_high
; var volatile byte _stepper1_port_dir is port_b_high_direction
;
; -- define hardware position of motor 1
; -- if only 1 motor is used, just make the next variables equal to the first motor
; var volatile byte _stepper2_port     is port_a_low
; var volatile byte _stepper2_port_dir is port_a_low_direction
;
; include stepper_RS232
;
; stepper_button_control_enabled = true
; forever loop
;   -- see if there's a RS232 command, and if so, also execute it
;   stepper_rs232
; end loop
-- -----------------------------------------------------------------------------


-- &lt;code


;include RS232_hw_ins
</i></font><font color="#FF00FF">include stepper

</font><b>var volatile bit  </b><font color="#000080">stepper_button_control_enabled <b>= </b></font><font color="#FF0000">false
</font><b>var volatile byte </b><font color="#000080">_stepper_timeout_counter
</font><b>var volatile bit  </b><font color="#000080">_asynch_read_timeout           <b>= </b></font><font color="#FF0000">false

</font><font color="#808080"><i>-- -----------------------------------------------------------------------------
-- code $00 .. $7F controls motor1
-- code $80 .. $FF controls motor2
--
-- every command byte (not the data bytes) is echoed inverted
-- multi-byte data is received and transmitted LS-byte first
-- position and steps are always specified in half-steps,
-- even when motor is running at full steps
--
-- -----------------------------------------------------------------------------
-- $00 not used
-- $01 start running soft (with acceleration)
-- $02 start running direct
-- $03 stop soft (with deceleration)
-- $04 stop direct
-- $05 set direction forward
-- $06 set direction backward
-- $07 set full-step, leave forced windings unchanged
-- $08 set half-step
-- $09 set fullstep, force 1-winding
-- $0A set fullstep, force 2-windings
-- $0B set fullstep, no force windings

-- $10 hello
-- $11 disable button-control
-- $12 enable button-control

-- $20 power on
-- $21 power off
-- $22 set acceleration on
-- $23 set acceleration off
-- $24 define origin at current location

-- commands $30 .. $3F all require an extra 1-byte integer to receive (LSByte first)
-- $30 &lt;1 byte&gt; set speed by defining TMR0 preset value
-- $31 &lt;1 byte&gt; set speed from table [ 0 .. _stepper_max_speed_index + 1 ]

-- commands $40 .. $4F all require an extra 4-bytes integer to receive (LSByte first)
-- $40 &lt;4 bytes&gt; goto half-step position N
-- $41 &lt;4 bytes&gt; do N steps more

-- commands $50 .. $5F all return a 4-bytes integer
-- $50 get position
-- $51 get target
-- $52 get steps togo

-- status of motors, if only 1 motor available only the status of 1 motor is returned,
-- if 2 motors are available, then first the status of motor2 is given
-- $60 get current speed of both motors(timer preset value)
-- $61 get current status of both motors
--    bit-0 = stepper_forward
--    bit-1 = stepper_full_steps
--    bit-2 = stepper_full_force_1_winding
--    bit-3 = stepper_full_force_2_winding
--    bit-4 = stepper_accelerate_on
--    bit-5 = _stepper_not_decelerating
-- $62 get accelaration table
--    _stepper_max_speed_index
--    _tmr0_preset
--    accelaration [0]
--    repeat[0]
--    accelaration [1]
--    repeat[1]
--    ...
--    accelaration [_stepper_max_speed_index]
--    repeat[_stepper_max_speed_index]
-- -----------------------------------------------------------------------------



-- -----------------------------------------------------------------------------
-- -----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">stepper_rs232 </font><b>is
var byte </b><font color="#000080">x
</font><b>var bit </b><font color="#000080">msb_x </font><b>at </b><font color="#000080">x <b>: </b></font><font color="#FF0000">7
</font><b>var byte </b><font color="#000080">motor
</font><b>var bit </b><font color="#000080">lsb_motor </font><b>at </b><font color="#000080">motor <b>: </b></font><font color="#FF0000">0
</font><b>var byte </b><font color="#000080">value
</font><b>var volatile byte </b><font color="#000080">rec_x
</font><b>var byte </b><font color="#000080">t1<b>, </b>t2<b>, </b>t3<b>, </b>t4
</font><b>var bit </b><font color="#000080">t1_0 </font><b>at </b><font color="#000080">t1 <b>: </b></font><font color="#FF0000">0
</font><b>var bit </b><font color="#000080">t1_1 </font><b>at </b><font color="#000080">t1 <b>: </b></font><font color="#FF0000">1
</font><b>var bit </b><font color="#000080">t1_2 </font><b>at </b><font color="#000080">t1 <b>: </b></font><font color="#FF0000">2
</font><b>var bit </b><font color="#000080">t1_3 </font><b>at </b><font color="#000080">t1 <b>: </b></font><font color="#FF0000">3
</font><b>var bit </b><font color="#000080">t1_4 </font><b>at </b><font color="#000080">t1 <b>: </b></font><font color="#FF0000">4
</font><b>var bit </b><font color="#000080">t1_5 </font><b>at </b><font color="#000080">t1 <b>: </b></font><font color="#FF0000">5

  </font><b>if </b><font color="#000080">asynch_read_hw <b>(</b>x<b>) </b></font><b>then

    </b><font color="#808080"><i>-- first echo the byte
    </i></font><font color="#000080">asynch_send_hw <b>(! </b>x<b>)
    
    </b></font><font color="#808080"><i>-- determine which motor is selected
    </i></font><b>if </b><font color="#000080">msb_x </font><b>then </b><font color="#000080">motor <b>= </b></font><font color="#FF0000">2 </font><b>else </b><font color="#000080">motor <b>= </b></font><font color="#FF0000">1 </font><b>end if
    
    </b><font color="#808080"><i>-- strip off the motornr from the command
    </i></font><font color="#000080">x <b>= </b>x <b>&amp; </b></font><font color="#FF0000">0x7F
    
    </font><font color="#808080"><i>-- soft start
    </i></font><b>if    </b><font color="#000080">x <b>== </b></font><font color="#FF0000">1 </font><b>then
      </b><font color="#000080">stepper_run_continuous_smooth <b>(</b>motor<b>)
      
    </b></font><font color="#808080"><i>-- direct start
    </i></font><b>elsif </b><font color="#000080">x <b>== </b></font><font color="#FF0000">2 </font><b>then
      </b><font color="#000080">stepper_run_continuous <b>(</b>motor<b>)

    </b></font><font color="#808080"><i>-- soft stop
    </i></font><b>elsif </b><font color="#000080">x <b>== </b></font><font color="#FF0000">3 </font><b>then
      </b><font color="#000080">stepper_stop_smooth <b>(</b>motor<b>)

    </b></font><font color="#808080"><i>-- direct stop
    </i></font><b>elsif </b><font color="#000080">x <b>== </b></font><font color="#FF0000">4 </font><b>then
      </b><font color="#000080">stepper_stop <b>(</b>motor<b>)

    </b></font><font color="#808080"><i>-- NOTE:
    -- here the &quot;compiler directive&quot; stepper_Nmotors is used
    -- as an extra element in the comparison, reducing code-size
    -- when only 1 motor is used
    -- forward
    </i></font><b>elsif </b><font color="#000080">x <b>== </b></font><font color="#FF0000">5 </font><b>then
      if </b><font color="#000080"><b>(</b>stepper_Nmotors <b>== </b></font><font color="#FF0000">2</font><font color="#000080"><b>) &amp; (! </b>lsb_motor<b>) </b></font><b>then
        </b><font color="#000080">stepper2_forward <b>= </b></font><font color="#FF0000">true
      </font><b>else </b><font color="#000080">stepper1_forward <b>= </b></font><font color="#FF0000">true
      </font><b>end if

    </b><font color="#808080"><i>-- backward
    </i></font><b>elsif </b><font color="#000080">x <b>== </b></font><font color="#FF0000">6 </font><b>then
      if </b><font color="#000080"><b>(</b>stepper_Nmotors <b>== </b></font><font color="#FF0000">2</font><font color="#000080"><b>) &amp; (! </b>lsb_motor<b>) </b></font><b>then
        </b><font color="#000080">stepper2_forward <b>= </b></font><font color="#FF0000">false
      </font><b>else </b><font color="#000080">stepper1_forward <b>= </b></font><font color="#FF0000">false
      </font><b>end if

    </b><font color="#808080"><i>-- full-step
    </i></font><b>elsif </b><font color="#000080">x <b>== </b></font><font color="#FF0000">7 </font><b>then
      if </b><font color="#000080"><b>(</b>stepper_Nmotors <b>== </b></font><font color="#FF0000">2</font><font color="#000080"><b>) &amp; (! </b>lsb_motor<b>) </b></font><b>then
        </b><font color="#000080">stepper2_full_steps <b>= </b></font><font color="#FF0000">true
      </font><b>else </b><font color="#000080">stepper1_full_steps <b>= </b></font><font color="#FF0000">true
      </font><b>end if

    </b><font color="#808080"><i>-- half-step
    </i></font><b>elsif </b><font color="#000080">x <b>== </b></font><font color="#FF0000">8 </font><b>then
      if </b><font color="#000080"><b>(</b>stepper_Nmotors <b>== </b></font><font color="#FF0000">2</font><font color="#000080"><b>) &amp; (! </b>lsb_motor<b>) </b></font><b>then
        </b><font color="#000080">stepper2_full_steps <b>= </b></font><font color="#FF0000">false
      </font><b>else </b><font color="#000080">stepper1_full_steps <b>= </b></font><font color="#FF0000">false
      </font><b>end if

    </b><font color="#808080"><i>-- force 1-winding in full-step mode
    </i></font><b>elsif </b><font color="#000080">x <b>== </b></font><font color="#FF0000">9 </font><b>then
      if </b><font color="#000080"><b>(</b>stepper_Nmotors <b>== </b></font><font color="#FF0000">2</font><font color="#000080"><b>) &amp; (! </b>lsb_motor<b>) </b></font><b>then
        </b><font color="#000080">stepper2_full_force_1_winding <b>= </b></font><font color="#FF0000">true
        </font><font color="#000080">stepper2_full_force_2_winding <b>= </b></font><font color="#FF0000">false
      </font><b>else
        </b><font color="#000080">stepper1_full_force_1_winding <b>= </b></font><font color="#FF0000">true
        </font><font color="#000080">stepper1_full_force_2_winding <b>= </b></font><font color="#FF0000">false
      </font><b>end if

    </b><font color="#808080"><i>-- force 2-winding2 in full-step mode
    </i></font><b>elsif </b><font color="#000080">x <b>== </b></font><font color="#FF0000">0x0A </font><b>then
      if </b><font color="#000080"><b>(</b>stepper_Nmotors <b>== </b></font><font color="#FF0000">2</font><font color="#000080"><b>) &amp; (! </b>lsb_motor<b>) </b></font><b>then
        </b><font color="#000080">stepper2_full_force_2_winding <b>= </b></font><font color="#FF0000">true
        </font><font color="#000080">stepper2_full_force_1_winding <b>= </b></font><font color="#FF0000">false
      </font><b>else
        </b><font color="#000080">stepper1_full_force_2_winding <b>= </b></font><font color="#FF0000">true
        </font><font color="#000080">stepper1_full_force_1_winding <b>= </b></font><font color="#FF0000">false
      </font><b>end if

    </b><font color="#808080"><i>-- no force windings in full-step mode
    </i></font><b>elsif </b><font color="#000080">x <b>== </b></font><font color="#FF0000">0x0B </font><b>then
      if </b><font color="#000080"><b>(</b>stepper_Nmotors <b>== </b></font><font color="#FF0000">2</font><font color="#000080"><b>) &amp; (! </b>lsb_motor<b>) </b></font><b>then
        </b><font color="#000080">stepper2_full_force_1_winding <b>= </b></font><font color="#FF0000">false
        </font><font color="#000080">stepper2_full_force_2_winding <b>= </b></font><font color="#FF0000">false
      </font><b>else
        </b><font color="#000080">stepper1_full_force_1_winding <b>= </b></font><font color="#FF0000">false
        </font><font color="#000080">stepper1_full_force_2_winding <b>= </b></font><font color="#FF0000">false
      </font><b>end if

    </b><font color="#808080"><i>-- disable button control
    </i></font><b>elsif </b><font color="#000080">x <b>== </b></font><font color="#FF0000">0x11 </font><b>then
      </b><font color="#000080">stepper_button_control_enabled <b>= </b></font><font color="#FF0000">false
      </font><font color="#000080">stepper1_accelerate_on <b>= </b></font><font color="#FF0000">false
      
    </font><font color="#808080"><i>-- enable button control
    </i></font><b>elsif </b><font color="#000080">x <b>== </b></font><font color="#FF0000">0x12 </font><b>then
      </b><font color="#000080">stepper1_accelerate_on <b>= </b></font><font color="#FF0000">false
      </font><font color="#000080">stepper_button_control_enabled <b>= </b></font><font color="#FF0000">true

    </font><font color="#808080"><i>-- power on
    </i></font><b>elsif </b><font color="#000080">x <b>== </b></font><font color="#FF0000">0x20 </font><b>then
      if </b><font color="#000080"><b>(</b>stepper_Nmotors <b>== </b></font><font color="#FF0000">2</font><font color="#000080"><b>) &amp; (! </b>lsb_motor<b>) </b></font><b>then
        </b><font color="#000080">_get_stepper_value <b>( </b>_stepper2_index<b>, </b>value <b>)
        </b>_stepper2_port <b>= </b>value
      </font><b>else
        </b><font color="#000080">_get_stepper_value <b>( </b>_stepper1_index<b>, </b>value <b>)
        </b>_stepper1_port <b>= </b>value
      </font><b>end if

    </b><font color="#808080"><i>-- power off
    </i></font><b>elsif </b><font color="#000080">x <b>== </b></font><font color="#FF0000">0x21 </font><b>then
      if </b><font color="#000080"><b>(</b>stepper_Nmotors <b>== </b></font><font color="#FF0000">2</font><font color="#000080"><b>) &amp; (! </b>lsb_motor<b>) </b></font><b>then
        </b><font color="#000080">_stepper2_port <b>= </b></font><font color="#FF0000">0
      </font><b>else
        </b><font color="#000080">_stepper1_port <b>= </b></font><font color="#FF0000">0
      </font><b>end if
      
    </b><font color="#808080"><i>-- acceleration on
    </i></font><b>elsif </b><font color="#000080">x <b>== </b></font><font color="#FF0000">0x22 </font><b>then
      if </b><font color="#000080"><b>(</b>stepper_Nmotors <b>== </b></font><font color="#FF0000">2</font><font color="#000080"><b>) &amp; (! </b>lsb_motor<b>) </b></font><b>then
        </b><font color="#000080">stepper2_accelerate_on <b>= </b></font><font color="#FF0000">true
      </font><b>else
        </b><font color="#000080">stepper1_accelerate_on <b>= </b></font><font color="#FF0000">true
      </font><b>end if

    </b><font color="#808080"><i>-- acceleration off
    </i></font><b>elsif </b><font color="#000080">x <b>== </b></font><font color="#FF0000">0x23 </font><b>then
      if </b><font color="#000080"><b>(</b>stepper_Nmotors <b>== </b></font><font color="#FF0000">2</font><font color="#000080"><b>) &amp; (! </b>lsb_motor<b>) </b></font><b>then
        </b><font color="#000080">stepper2_accelerate_on <b>= </b></font><font color="#FF0000">false
      </font><b>else
        </b><font color="#000080">stepper1_accelerate_on <b>= </b></font><font color="#FF0000">false
      </font><b>end if
      
    </b><font color="#808080"><i>-- define origin at current location
    </i></font><b>elsif </b><font color="#000080">x <b>== </b></font><font color="#FF0000">0x24 </font><b>then
      </b><font color="#000080">stepper_set_null<b>(</b>motor<b>)

    </b></font><font color="#808080"><i>-- all communication requiring 1 byte extra to receive
    </i></font><b>elsif </b><font color="#000080"><b>(</b>x <b>&gt;= </b></font><font color="#FF0000">0x30</font><font color="#000080"><b>) &amp; (</b>x <b>&lt;= </b></font><font color="#FF0000">0x3F</font><font color="#000080"><b>) </b></font><b>then
      </b><font color="#000080">x <b>= </b>x <b>- </b></font><font color="#FF0000">0x30
      </font><font color="#000080">_asynch_read_timeout <b>= </b></font><font color="#FF0000">false
      </font><b>while </b><font color="#000080"><b>(! </b>asynch_read_hw <b>(</b>t1<b>)) &amp; (! </b>_asynch_read_timeout<b>) </b></font><b>loop end loop
      if </b><font color="#000080"><b>! </b>_asynch_read_timeout </font><b>then
        </b><font color="#808080"><i>-- set speed
        </i></font><b>if </b><font color="#000080">x <b>== </b></font><font color="#FF0000">0 </font><b>then
          if </b><font color="#000080"><b>(</b>stepper_Nmotors <b>== </b></font><font color="#FF0000">2</font><font color="#000080"><b>) &amp; (! </b>lsb_motor<b>) </b></font><b>then
            </b><font color="#000080">_stepper2_period_preset <b>= </b>t1
          </font><b>else
            </b><font color="#000080">_stepper1_period_preset <b>= </b>t1
          </font><b>end if
          
        </b><font color="#808080"><i>-- set speed from table
        </i></font><b>elsif </b><font color="#000080">x <b>== </b></font><font color="#FF0000">1 </font><b>then
          if </b><font color="#000080">t1 <b>&gt; </b>_stepper_max_speed_index </font><b>then </b><font color="#000080">t1 <b>= </b>_stepper_max_speed_index </font><b>end if
          </b><font color="#000080">stepper_acc1<b>(</b>t1<b>,</b>t2<b>)
          </b></font><b>if </b><font color="#000080"><b>(</b>stepper_Nmotors <b>== </b></font><font color="#FF0000">2</font><font color="#000080"><b>) &amp; (! </b>lsb_motor<b>) </b></font><b>then
            </b><font color="#000080">_stepper2_index <b>= </b>t1
            _stepper2_period_preset <b>= </b>t2
          </font><b>else
            </b><font color="#000080">_stepper1_index <b>= </b>t1
            _stepper1_period_preset <b>= </b>t2
          </font><b>end if
        end if
      end if
      
    </b><font color="#808080"><i>-- all communicatione requiring 4 bytes extra to receive
    </i></font><b>elsif </b><font color="#000080"><b>(</b>x <b>&gt;= </b></font><font color="#FF0000">0x40</font><font color="#000080"><b>) &amp; (</b>x <b>&lt;= </b></font><font color="#FF0000">0x41</font><font color="#000080"><b>) </b></font><b>then
      </b><font color="#000080">x <b>= </b>x <b>- </b></font><font color="#FF0000">0x40
      </font><font color="#000080">_asynch_read_timeout <b>= </b></font><font color="#FF0000">false
      </font><b>while </b><font color="#000080"><b>(! </b>asynch_read_hw <b>(</b>t1<b>)) &amp; (! </b>_asynch_read_timeout<b>) </b></font><b>loop end loop
      if </b><font color="#000080"><b>! </b>_asynch_read_timeout </font><b>then
        while </b><font color="#000080"><b>! </b>asynch_read_hw <b>(</b>t2<b>) &amp; (! </b>_asynch_read_timeout<b>) </b></font><b>loop end loop
      end if
      if </b><font color="#000080"><b>! </b>_asynch_read_timeout </font><b>then
        while </b><font color="#000080"><b>! </b>asynch_read_hw <b>(</b>t3<b>) &amp; (! </b>_asynch_read_timeout<b>) </b></font><b>loop end loop
      end if
      if </b><font color="#000080"><b>! </b>_asynch_read_timeout </font><b>then
        while </b><font color="#000080"><b>! </b>asynch_read_hw <b>(</b>t4<b>) &amp; (! </b>_asynch_read_timeout<b>) </b></font><b>loop end loop
      end if
      if </b><font color="#000080"><b>! </b>_asynch_read_timeout </font><b>then
        </b><font color="#808080"><i>-- goto half-step position
        </i></font><b>if    </b><font color="#000080">x <b>== </b></font><font color="#FF0000">0 </font><b>then </b><font color="#000080">stepper_run_into <b>(</b>motor<b>, </b>t1<b>, </b>t2<b>, </b>t3<b>, </b>t4<b>)

        </b></font><font color="#808080"><i>-- do N steps more
        </i></font><b>elsif </b><font color="#000080">x <b>== </b></font><font color="#FF0000">1 </font><b>then </b><font color="#000080">stepper_do_steps <b>(</b>motor<b>, </b>t1<b>, </b>t2<b>, </b>t3<b>, </b>t4<b>)
        </b></font><b>end if
      end if

    
    </b><font color="#808080"><i>-- get current position
    </i></font><b>elsif </b><font color="#000080"><b>(</b>x <b>&gt;= </b></font><font color="#FF0000">0x50</font><font color="#000080"><b>) &amp; (</b>x <b>&lt;= </b></font><font color="#FF0000">0x52</font><font color="#000080"><b>) </b></font><b>then
      </b><font color="#000080">x <b>= </b>x <b>- </b></font><font color="#FF0000">0x50
      
      </font><font color="#808080"><i>-- interrupts must be disabled,
      -- because some multi-byte variables could be changed by interrpt
      </i></font><font color="#000080">T0IE <b>= </b></font><font color="#FF0000">false
      
      </font><b>if </b><font color="#000080"><b>(</b>stepper_Nmotors <b>== </b></font><font color="#FF0000">2</font><font color="#000080"><b>) &amp; (! </b>lsb_motor<b>) </b></font><b>then
        if </b><font color="#000080">x <b>== </b></font><font color="#FF0000">0 </font><b>then
          </b><font color="#000080"><b>&lt;</b></font><font color="#800080"><i>mac</i></font><font color="#000080"><b>&gt; </b>byte4_assign  t <b>= </b>stepper2_pos
        </font><b>elsif </b><font color="#000080">x <b>== </b></font><font color="#FF0000">1 </font><b>then
          </b><font color="#000080"><b>&lt;</b></font><font color="#800080"><i>mac</i></font><font color="#000080"><b>&gt; </b>byte4_assign  t <b>= </b>_stepper2_target_pos
        </font><b>elsif </b><font color="#000080">x <b>== </b></font><font color="#FF0000">2 </font><b>then
          if </b><font color="#000080">stepper1_forward </font><b>then
            </b><font color="#000080"><b>&lt;</b></font><font color="#800080"><i>mac</i></font><font color="#000080"><b>&gt; </b>byte4_SUB  t <b>= </b>stepper2_pos<b>, </b>_stepper2_target_pos
          </font><b>else
            </b><font color="#000080"><b>&lt;</b></font><font color="#800080"><i>mac</i></font><font color="#000080"><b>&gt; </b>byte4_SUB  t <b>= </b>_stepper2_target_pos<b>, </b>stepper2_pos
          </font><b>end if
        end if
      else
        if </b><font color="#000080">x <b>== </b></font><font color="#FF0000">0 </font><b>then
          </b><font color="#000080"><b>&lt;</b></font><font color="#800080"><i>mac</i></font><font color="#000080"><b>&gt; </b>byte4_assign  t <b>= </b>stepper1_pos
        </font><b>elsif </b><font color="#000080">x <b>== </b></font><font color="#FF0000">1 </font><b>then
          </b><font color="#000080"><b>&lt;</b></font><font color="#800080"><i>mac</i></font><font color="#000080"><b>&gt; </b>byte4_assign  t <b>= </b>_stepper1_target_pos
        </font><b>elsif </b><font color="#000080">x <b>== </b></font><font color="#FF0000">2 </font><b>then
          if </b><font color="#000080">stepper1_forward </font><b>then
            </b><font color="#000080"><b>&lt;</b></font><font color="#800080"><i>mac</i></font><font color="#000080"><b>&gt; </b>byte4_SUB  t <b>= </b>stepper1_pos<b>, </b>_stepper1_target_pos
          </font><b>else
            </b><font color="#000080"><b>&lt;</b></font><font color="#800080"><i>mac</i></font><font color="#000080"><b>&gt; </b>byte4_SUB  t <b>= </b>_stepper1_target_pos<b>, </b>stepper1_pos
          </font><b>end if
        end if
      end if
      </b><font color="#808080"><i>-- enable interrupts again
      </i></font><font color="#000080">T0IE <b>= </b></font><font color="#FF0000">true
      </font><font color="#000080">asynch_send_hw <b>(</b>t1<b>)
      </b>asynch_send_hw <b>(</b>t2<b>)
      </b>asynch_send_hw <b>(</b>t3<b>)
      </b>asynch_send_hw <b>(</b>t4<b>)

    </b></font><font color="#808080"><i>-- get current speed of both motors(timer preset value)
    </i></font><b>elsif </b><font color="#000080">x <b>== </b></font><font color="#FF0000">0x60 </font><b>then
      if </b><font color="#000080">stepper_Nmotors <b>== </b></font><font color="#FF0000">2 </font><b>then
        if </b><font color="#000080">stepper2_status <b>!= </b>_stepper_status_stopped </font><b>then
          </b><font color="#000080">t1 <b>= </b>_stepper2_period_preset
        </font><b>else
          </b><font color="#000080">t1 <b>= </b></font><font color="#FF0000">0
        </font><b>end if
        </b><font color="#000080">asynch_send_hw<b>(</b>t1<b>)
      </b></font><b>else
        if </b><font color="#000080">stepper1_status <b>!= </b>_stepper_status_stopped </font><b>then
          </b><font color="#000080">t1 <b>= </b>_stepper1_period_preset
        </font><b>else
          </b><font color="#000080">t1 <b>= </b></font><font color="#FF0000">0
        </font><b>end if
      end if
      </b><font color="#000080">asynch_send_hw<b>(</b>t1<b>)

    </b></font><font color="#808080"><i>-- get current status of both motors
    </i></font><b>elsif </b><font color="#000080">x <b>== </b></font><font color="#FF0000">0x61 </font><b>then
      if </b><font color="#000080">stepper_Nmotors <b>== </b></font><font color="#FF0000">2 </font><b>then
        </b><font color="#000080">t1_0 <b>= </b>stepper2_forward
        t1_1 <b>= </b>stepper2_full_steps
        t1_2 <b>= </b>stepper2_full_force_1_winding
        t1_3 <b>= </b>stepper2_full_force_2_winding
        t1_4 <b>= </b>stepper2_accelerate_on
        t1_5 <b>= </b>_stepper2_not_decelerating
        asynch_send_hw<b>(</b>t1<b>)
      </b></font><b>end if
      </b><font color="#000080">t1_0 <b>= </b>stepper1_forward
      t1_1 <b>= </b>stepper1_full_steps
      t1_2 <b>= </b>stepper1_full_force_1_winding
      t1_3 <b>= </b>stepper1_full_force_2_winding
      t1_4 <b>= </b>stepper1_accelerate_on
      t1_5 <b>= </b>_stepper1_not_decelerating
      asynch_send_hw<b>(</b>t1<b>)

    </b></font><font color="#808080"><i>-- get accelaration table
    </i></font><b>elsif </b><font color="#000080">x <b>== </b></font><font color="#FF0000">0x62 </font><b>then
      </b><font color="#000080">asynch_send_hw<b>(</b>_stepper_max_speed_index<b>)
      </b>asynch_send_hw<b>(</b>_tmr0_preset<b>)
      </b>t2 <b>= </b></font><font color="#FF0000">0
      </font><b>for </b><font color="#000080"><b>(</b>_stepper_max_speed_index <b>+ </b></font><font color="#FF0000">1</font><font color="#000080"><b>) </b></font><b>loop
        </b><font color="#000080">stepper_acc1 <b>(</b>t2<b>,</b>t1<b>)
        </b>asynch_send_hw<b>(</b>t1<b>)
        </b>stepper_acc1N <b>(</b>t2<b>,</b>t1<b>)
        </b>asynch_send_hw<b>(</b>t1<b>)
        </b>t2 <b>= </b>t2 <b>+ </b></font><font color="#FF0000">1
      </font><b>end loop

    end if

  end if
end procedure
</b><font color="#808080"><i>-- -----------------------------------------------------------------------------


-- -----------------------------------------------------------------------------
-- interrupt routine to detect timeout of a asynch receive
-- -----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">_stepper_asynch_timeout </font><b>is
</b><font color="#000080"><b>&lt;</b></font><font color="#800080"><i>mac</i></font><font color="#000080"><b>&gt; </b>interrupt_sub _stepper_asynch_timeout<b>, </b>T0IF<b>, </b></font><font color="#FF0000">3
  </font><b>if </b><font color="#000080"><b>! </b>_asynch_read_timeout </font><b>then
    </b><font color="#000080">_stepper_timeout_counter <b>= </b>_stepper_timeout_counter <b>+ </b></font><font color="#FF0000">1
  </font><b>else
  end if
  if </b><font color="#000080">_stepper_timeout_counter <b>== </b></font><font color="#FF0000">0 </font><b>then
    </b><font color="#000080">_asynch_read_timeout <b>= </b></font><font color="#FF0000">true
  </font><b>end if
end procedure
</b><font color="#808080"><i>-- -----------------------------------------------------------------------------



</i></font></font>
</code></pre>
</body>
</html>
