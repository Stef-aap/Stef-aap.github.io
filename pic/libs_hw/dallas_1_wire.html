<HTML><HEAD><TITLE>Dallas 1-wire bus JAL library</TITLE>
<STYLE type="text/css"><!--
BODY {
  margin: 5px 5px 5px 5px;
  background-color: #E8E8E8;
}

--></STYLE>
<LINK type="text/css" href="rvf.css" rel=STYLESHEET>
<link rel="icon" href="jalccring_small.gif" type="image/gif"></HEAD>
<BODY>

<P><SPAN class=RVTS1>Dallas 1-wire bus JAL library</SPAN></P>
<P><SPAN class=RVTS7>This html document is automatically generated by JALcc, from the JAL-sourcefile</SPAN></P>
<P><SPAN class=RVTS7>dallas_1_wire.jal&nbsp;&nbsp; 12-01-2005</SPAN></P>
<P>&nbsp;&nbsp;</P>
<P><SPAN class=RVTS2>Description&nbsp;</SPAN></P>
<P>JAL library for control of Dallas 1-wire bus and specially the DS18B20.&nbsp;</P>
<P>The serach algorithm is based on:&nbsp;&nbsp;</P>
<P><A class=RVTS4 href="http://pdfserv.maxim-ic.com/en/an/app187.pdf">http://pdfserv.maxim-ic.com/en/an/app187.pdf</A></P>
<P>&nbsp;&nbsp;&nbsp;</P>
<P>the basic 1-wire routines are based on&nbsp;</P>
<P>previous libs from Philip Pemberton and Vasile Surducan (thanks!)&nbsp;</P>
<P>&nbsp;&nbsp;</P>
<P>interface&nbsp;</P>
<P>function Dallas_1_wire_get_devices_all&nbsp;</P>
<P>procedure DS18B20_set_resolution_and_alarms&nbsp;</P>
<P>procedure DS18B20_get_resolution_and_alarms&nbsp;</P>
<P>procedure DS18B20_load_settings_from_EEprom&nbsp;</P>
<P>procedure DS18B20_save_settings_to_EEprom&nbsp;</P>
<P>procedure DS18B20_start_conversion&nbsp;</P>
<P>procedure DS18B20_get_raw_temperature&nbsp;</P>
<P>&nbsp;&nbsp;</P>
<P>globals:&nbsp;</P>
<P>Dallas_1_wire_device_count&nbsp;</P>
<P>ROM-codes of the found devices are stored in ARRAY3&nbsp;</P>
<P>&nbsp;&nbsp;</P>
<P><SPAN class=RVTS2>Example&nbsp;</SPAN></P>
<P>&nbsp;&nbsp;</P>
<P>&nbsp;const array_check_indices = false&nbsp;</P>
<P>&nbsp;&nbsp;&nbsp;</P>
<P>&nbsp;const array0_start = 0x70&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -- no array in bank 0 wanted&nbsp;</P>
<P>&nbsp;const array0_end&nbsp;&nbsp; = 0x6F&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --&nbsp;&nbsp; so make end-index smaller than start_index&nbsp;</P>
<P>&nbsp;-- the first 8 positions of bank1 are used to store ROM_NO&nbsp;</P>
<P>&nbsp;const array1_start = 0xA0&nbsp;</P>
<P>&nbsp;const array1_end&nbsp;&nbsp; = 0xEF&nbsp;</P>
<P>&nbsp;const array2_start = 0x120&nbsp;</P>
<P>&nbsp;const array2_end&nbsp;&nbsp; = 0x11F&nbsp;</P>
<P>&nbsp;-- bank3 is used completly (except the common registers at the end)&nbsp;</P>
<P>&nbsp;-- so that gives room for a maximum of 12 pieces of 1-wire devices&nbsp;</P>
<P>&nbsp;const array3_start = 0x190&nbsp;</P>
<P>&nbsp;const array3_end&nbsp;&nbsp; = 0x1EF&nbsp;</P>
<P>&nbsp;&nbsp;&nbsp;</P>
<P>&nbsp;-- include the ARRAY implementation&nbsp;</P>
<P>&nbsp;include bank_arrays&nbsp;</P>
<P>&nbsp;&nbsp;&nbsp;</P>
<P>&nbsp;-- Temperature sensors&nbsp;</P>
<P>&nbsp;&lt;mac&gt; io_pin&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _1_wire = pin_d0&nbsp;</P>
<P>&nbsp;include DS18B20&nbsp;</P>
<P>&nbsp;var byte Tmsb, Tlsb&nbsp;</P>
<P>&nbsp;&nbsp;&nbsp;</P>
<P>&nbsp;-- Start a search for all 1-wire devices&nbsp;</P>
<P>&nbsp;Dallas_1_wire_get_devices_all&nbsp;</P>
<P>&nbsp;-- Display the number of found devices&nbsp;</P>
<P>&nbsp;asynch_send_hw (Dallas_1_wire_device_count)&nbsp;</P>
<P>&nbsp;&nbsp;&nbsp;</P>
<P>&nbsp;-- Display the ROM-code of all devices&nbsp;</P>
<P>&nbsp;array3_get_index = 0&nbsp;</P>
<P>&nbsp;for Dallas_1_wire_device_count loop&nbsp;</P>
<P>&nbsp;&nbsp; for 8 loop&nbsp;</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp; asynch_send_hw (array3)&nbsp;</P>
<P>&nbsp;&nbsp; end loop&nbsp;</P>
<P>&nbsp;end loop&nbsp;</P>
<P>&nbsp;&nbsp;&nbsp;</P>
<P>&nbsp;forever loop&nbsp;</P>
<P>&nbsp;&nbsp; -- start temperature measurement for all devices&nbsp;</P>
<P>&nbsp;&nbsp; DS18B20_start_conversion&nbsp;</P>
<P>&nbsp;&nbsp; -- get the temperature of the first sensor&nbsp;</P>
<P>&nbsp;&nbsp; DS18B20_get_raw_temperature (1, Tmsb, Tlsb)&nbsp;</P>
<P>&nbsp;&nbsp; -- display the temperature detected by the first sensor&nbsp;</P>
<P>&nbsp;&nbsp; asynch_send_hw(Tmsb)&nbsp;</P>
<P>&nbsp;&nbsp; asynch_send_hw(Tlsb)&nbsp;</P>
<P>&nbsp;&nbsp; -- now the same for the second sensor&nbsp;</P>
<P>&nbsp;&nbsp; DS18B20_get_raw_temperature (2, Tmsb, Tlsb)&nbsp;</P>
<P>&nbsp;&nbsp; asynch_send_hw(Tmsb)&nbsp;</P>
<P>&nbsp;&nbsp; asynch_send_hw(Tlsb)&nbsp;</P>
<P>&nbsp;end loop&nbsp;</P>
<P>&nbsp;&nbsp;</P>
<P><SPAN class=RVTS2>License&nbsp;</SPAN></P>
<P>freeware, under the terms of the GNU/GPL&nbsp;</P>
<P>, Copyright (C) 2004 Stef Mientki&nbsp;</P>
<P>&nbsp;&nbsp;</P>
<P><SPAN class=RVTS1>Version History</SPAN></P>
<P><A class=RVTS4 href="dallas_1_wire.jal">download&nbsp; dallas_1_wire.jal</A></P>
<P><A class=RVTS4 href="dallas_1_wire_source.html">colorcoded HTML&nbsp; dallas_1_wire_source.html</A></P>
<P>&nbsp;&nbsp;</P>
<P><SPAN class=RVTS2>Version: 1.2&nbsp;&nbsp;&nbsp; ,12-01-2005, Stef Mientki&nbsp;</SPAN></P>
<P>- bug fixed, no more then 2 sensors could be detected, otherwise hanged&nbsp;</P>
<P>- 1-wire device ROM-codes moved to array3, which gives room for 12 devices&nbsp;</P>
<P>- array1 is needed to store temporary ROM-codes&nbsp;</P>
<P>&nbsp;&nbsp;</P>
<P><SPAN class=RVTS2>Version: 1.1&nbsp;&nbsp;&nbsp; ,10-09-2004, Stef Mientki&nbsp;</SPAN></P>
<P>- added procedure DS18B20_get_raw_temperature_nowait&nbsp;</P>
<P>&nbsp;&nbsp;</P>
<P><SPAN class=RVTS2>Version: 1.0&nbsp;&nbsp;&nbsp; ,10-07-2004, Stef Mientki&nbsp;</SPAN></P>
<P>- orginal release&nbsp;</P>
<P>&nbsp;&nbsp;</P>
<P><SPAN class=RVTS2>Included Files</SPAN></P>
<P>03-09-2004&nbsp;&nbsp;&nbsp;<A class=RVTS4 href="bank_arrays.jal">bank_arrays.jal</A>&nbsp;&nbsp;&nbsp; d:\pic-tools\jal\lib\</P>
<P>09-09-2004&nbsp;&nbsp;&nbsp;<A class=RVTS4 href="delay_20mc.jal">delay_20mc.jal</A>&nbsp;&nbsp;&nbsp; d:\pic-tools\jal\lib\</P>
<P>&nbsp;&nbsp;</P>
<P>&nbsp;&nbsp;</P>
<P><SPAN class=RVTS1>Public Procedures</SPAN></P>
<P><SPAN class=RVTS2>function Dallas_1_wire_get_devices_all</SPAN></P>
<P>-- This procedure searches for all devices on the 1-wire-bus</P>
<P>-- returns the number of devices</P>
<P>-- the number of devices is stored in the global Dallas_1_wire_device_count</P>
<P>-- the RM-code of the devices are stored in the global array ARRAY3</P>
<P>-- The addressing of the sensors in all other routines is done by an index</P>
<P>-- to the array ARRAY3 [1.. 8*Dallas_1_wire_device_count].</P>
<P>-- Each device occupies 8 bytes in the ARRAY3</P>
<P>-- Index=0 means all devices !!</P>
<P>&nbsp;&nbsp;</P>
<P><SPAN class=RVTS2>procedure DS18B20_set_resolution_and_alarms</SPAN></P>
<P>-- Sets resolution and alarms into the selected devices.</P>
<P>-- NOTE, if internal alarms are not used,</P>
<P>-- these locations can be used to store (permanently) other information.</P>
<P>-- Resolution must be specified in "human" indices, i.e. 9,10,11,12</P>
<P>-- After settings are done, the values can be stored permantly in the eeprom&nbsp;</P>
<P>-- of the device by the procedure DS18B20_save_settings_to_EEprom.</P>
<P>-- (device_index=0 means all devices)</P>
<P>&nbsp;&nbsp;</P>
<P><SPAN class=RVTS2>procedure DS18B20_get_resolution_and_alarms</SPAN></P>
<P>-- Reads resolution and alarms from the selected devices.</P>
<P>-- Resolution is translated to "human" indices, i.e. 9,10,11,12</P>
<P>-- Index=0 means all devices !! (this is not meaningfull !!)</P>
<P>&nbsp;&nbsp;</P>
<P><SPAN class=RVTS2>procedure DS18B20_load_settings_from_EEprom</SPAN></P>
<P>-- loads alarm and resolution settings from the EEprom into the device's scratchpad</P>
<P>&nbsp;&nbsp;</P>
<P><SPAN class=RVTS2>procedure DS18B20_save_settings_to_EEprom</SPAN></P>
<P>-- saves alarm and resolution settings from the device's scratchpad to the EEprom</P>
<P>&nbsp;&nbsp;</P>
<P><SPAN class=RVTS2>procedure DS18B20_start_conversion</SPAN></P>
<P>-- Starts the temperature conversion for the selected device.</P>
<P>-- (device_index=0 means all devices)</P>
<P>&nbsp;&nbsp;</P>
<P><SPAN class=RVTS2>procedure DS18B20_get_raw_temperature_nowait</SPAN></P>
<P>-- Reads the temperature from the selected device.</P>
<P>-- same as DS18B20_get_raw_temperature, (see below)</P>
<P>-- except it doesn't wait.</P>
<P>-- In cases where it's ensured that the conversion time of the sensor is satisfied,</P>
<P>-- this procedure has the advantage that it doesn't hang for a while,</P>
<P>-- in case something is wrong with the sensors</P>
<P>&nbsp;&nbsp;</P>
<P><SPAN class=RVTS2>procedure DS18B20_get_raw_temperature</SPAN></P>
<P>-- Reads the temperature from the selected device.</P>
<P>-- device_index=0 reads all the sensors and stores them in array ...</P>
<P>--&nbsp;&nbsp; in that case temp_high and temp_low will contain the temparture from the first sensor</P>
<P>-- IMPORTANT reading of each sensor takes about 4 msec !!</P>
<P>-- In case a temerature measurement is still in progress, the procedure waits.</P>
</BODY></HTML>
