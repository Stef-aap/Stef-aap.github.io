<html>
<head>
<title>JALcc SourceCode exporting of delay_20mc_source.html</title>
</head>
<!-- Generated by SynEdit HTML exporter -->
<body text="#000000" bgcolor="#FFFFFF">
<pre>
<code><font  size=3 face="Courier New"><font color="#000080"><A href="delay_20mc.jal">download&nbsp;delay_20mc.jal</A>
</font><font color="#808080"><i>-- -----------------------------------------------------------------------------
-- &lt;title delays at 20 MHz
-- &lt;License
-- freeware, under the terms of the GNU GPL
--  Copyright (C) 2002 Stef Mientki
-- -----------------------------------------------------------------------------
-- &lt;Description
-- -----------------------------------------------------------------------------
-- Library for delays at 20 MHz (target_clock is checked)
--
-- For the smallest time (1 uS) a file to included is available
--  delay_1uS_10MC.jal
--
-- Fixed delays for the small times
--   delay_2uS, delay_3uS, delay_4uS, delay_5uS,
--   delay_6uS, delay_7uS, delay_8uS, delay_9uS
--
-- For the larger delays, routines with paramter N  ( 1.. 255)
--   delay_10uS  ( N )
--   delay_1mS   ( N )
--   delay_100mS ( N )
--
-- The accuracy of the small delays may depend on the JAL compiler.
-- I found that in most cases, a call to a delay routine is done in JAL
-- by a GOTO, followed by a CALL , the delay routine and a RETURN
--
-- Background Information
-- general delay methods
--    http://www.piclist.com/techref/microchip/delay/general.htm
-- JAVA generation of an optimal exact delay
--    http://www.piclist.com/techref/piclist/codegen/delay.htm
--
-- &lt;Version: 1.0  01-03-2002,  Stef Mientki
--   - orginal release
-- -----------------------------------------------------------------------------
-- -----------------------------------------------------------------------------


-- -----------------------------------------------------------------------------
-- &lt;Example delay_20Mc
;
; delay_3uS
;
; delay_10us (20)
-- -----------------------------------------------------------------------------


-- &lt;code



-- -----------------------------------------------------------------------------
-- These routines only have valid delays for 20 MHz, so test it !!
-- -----------------------------------------------------------------------------
</i></font><b>if </b><font color="#000080">target_clock <b>!= </b></font><font color="#FF0000">20_000_000 </font><b>then
  </b><font color="#800080"><i>pragma </i></font><b>error  </b><font color="#808080"><i>-- this library is only for 20 MHz, JAL 4.40
</i></font><b>end if
</b><font color="#808080"><i>-- -----------------------------------------------------------------------------



-- -----------------------------------------------------------------------------
-- Delay 1 uS, this must be accomplished by inclusion of the file,
-- (according to the idea of Wouter van Ooijen)
--   DELAY_1uS_20_MC.JAL
--
-- In fact this file delays only 0.8 usec.
-- The reason for this is that the purpose of a delay is always an (re-)action
-- to the outerworld (IO-pins).
-- Take for instance the next example
--    bsf   pin_b0
--    delay_1uS        -- included file !!
--    bcf   pin_b0
-- The goal of these statements is to generate a 1 uS puls on b0.
-- Therfore the time distance between BSF and BCF includes one instruction extra,
-- assuming that setting a bit costs as much time as resetting a bit.
-- So delay_1uS may only last 0.8 usec !!
-- (Remark: using JAL statements like pin_b0 = high will yield higher delays)
-- -----------------------------------------------------------------------------
-- procedure delay_1uS is
--  assembler
--  local delay1, delay2
--  page delay2
--    goto delay1
--  delay1:
--    goto delay2
--  delay2:
--  end assembler
-- -----------------------------------------------------------------------------



-- -----------------------------------------------------------------------------
-- fixed delay of 2 usec (no arguments)
-- -----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">delay_2uS </font><b>is
  </b><font color="#808080"><i>-- call + retrun  = (4)
  -- JAL 4.40 inserts an extra GOTO = (2)
  </i></font><font color="#800080"><i>assembler
  local </i></font><font color="#000080">delay
  </font><font color="#800080"><i>page </i></font><font color="#000080">delay
      goto     delay 
    delay<b>:           
      </b>nop
  </font><b>end </b><font color="#800080"><i>assembler
</i></font><b>end procedure
</b><font color="#808080"><i>-- -----------------------------------------------------------------------------



-- -----------------------------------------------------------------------------
-- fixed delay of 3 usec (no arguments)
-- -----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">delay_3uS </font><b>is
var byte </b><font color="#000080">x
  </font><font color="#800080"><i>assembler
  local </i></font><font color="#000080">delay
  </font><font color="#800080"><i>page </i></font><font color="#000080">delay
      </font><font color="#800080"><i>movlw    </i></font><font color="#FF0000">2
      </font><font color="#000080">movwf    x     
      nop
    delay<b>:           
      </b>decfsz   x<b>,</b>f  
      goto     delay
  </font><b>end </b><font color="#800080"><i>assembler
</i></font><b>end procedure
</b><font color="#808080"><i>-- -----------------------------------------------------------------------------



-- -----------------------------------------------------------------------------
-- fixed delay of 4 usec (no arguments)
-- -----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">delay_4uS </font><b>is
var byte </b><font color="#000080">x
  </font><font color="#800080"><i>assembler
  local </i></font><font color="#000080">delay
  </font><font color="#800080"><i>page </i></font><font color="#000080">delay
      </font><font color="#800080"><i>movlw    </i></font><font color="#FF0000">4
      </font><font color="#000080">movwf    x   
    delay<b>:         
      </b>decfsz   x<b>,</b>f  
      goto     delay 
  </font><b>end </b><font color="#800080"><i>assembler
</i></font><b>end procedure
</b><font color="#808080"><i>-- -----------------------------------------------------------------------------



-- -----------------------------------------------------------------------------
-- fixed delay of 5 usec (no arguments)
-- -----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">delay_5uS </font><b>is
var byte </b><font color="#000080">x
  </font><font color="#800080"><i>assembler
  local </i></font><font color="#000080">delay
  </font><font color="#800080"><i>page </i></font><font color="#000080">delay
      </font><font color="#800080"><i>movlw    </i></font><font color="#FF0000">5
      </font><font color="#000080">movwf    x   
      nop
      nop
    delay<b>:        
      </b>decfsz   x<b>,</b>f  
      goto     delay 
  </font><b>end </b><font color="#800080"><i>assembler
</i></font><b>end procedure
</b><font color="#808080"><i>-- -----------------------------------------------------------------------------



-- -----------------------------------------------------------------------------
-- fixed delay of 6 usec (no arguments)
-- -----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">delay_6uS </font><b>is
var byte </b><font color="#000080">x
  </font><font color="#800080"><i>assembler
  local </i></font><font color="#000080">delay
  </font><font color="#800080"><i>page </i></font><font color="#000080">delay
      </font><font color="#800080"><i>movlw    </i></font><font color="#FF0000">7
      </font><font color="#000080">movwf    x   
      nop
    delay<b>:          
      </b>decfsz   x<b>,</b>f 
      goto     delay 
  </font><b>end </b><font color="#800080"><i>assembler
</i></font><b>end procedure
</b><font color="#808080"><i>-- -----------------------------------------------------------------------------



-- -----------------------------------------------------------------------------
-- fixed delay of 7 usec (no arguments)
-- -----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">delay_7uS </font><b>is
var byte </b><font color="#000080">x
  </font><font color="#800080"><i>assembler
  local </i></font><font color="#000080">delay
  </font><font color="#800080"><i>page </i></font><font color="#000080">delay
      </font><font color="#800080"><i>movlw    </i></font><font color="#FF0000">9
      </font><font color="#000080">movwf    x    
    delay<b>:          
      </b>decfsz   x<b>,</b>f  
      goto     delay 
  </font><b>end </b><font color="#800080"><i>assembler
</i></font><b>end procedure
</b><font color="#808080"><i>-- -----------------------------------------------------------------------------



-- -----------------------------------------------------------------------------
-- fixed delay of 8 usec (no arguments)
-- -----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">delay_8uS </font><b>is
var byte </b><font color="#000080">x
  </font><font color="#800080"><i>assembler
  local </i></font><font color="#000080">delay
  </font><font color="#800080"><i>page </i></font><font color="#000080">delay
      </font><font color="#800080"><i>movlw    </i></font><font color="#FF0000">10
      </font><font color="#000080">movwf    x    
      nop
      nop
    delay<b>:           
      </b>decfsz   x<b>,</b>f   
      goto     delay 
  </font><b>end </b><font color="#800080"><i>assembler
</i></font><b>end procedure
</b><font color="#808080"><i>-- -----------------------------------------------------------------------------



-- -----------------------------------------------------------------------------
-- fixed delay of 9 usec (no arguments)
-- -----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">delay_9uS </font><b>is
var byte </b><font color="#000080">x
  </font><font color="#800080"><i>assembler
  local </i></font><font color="#000080">delay
  </font><font color="#800080"><i>page </i></font><font color="#000080">delay
      </font><font color="#800080"><i>movlw    </i></font><font color="#FF0000">12
      </font><font color="#000080">movwf    x    
      nop
    delay<b>:           
      </b>decfsz   x<b>,</b>f  
      goto     delay 
  </font><b>end </b><font color="#800080"><i>assembler
</i></font><b>end procedure
</b><font color="#808080"><i>-- -----------------------------------------------------------------------------



-- -----------------------------------------------------------------------------
-- Delays for N * 10 usec
-- only valid for 20 MHz Xtal
-- -----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">delay_10uS <b>(</b></font><b>byte in </b><font color="#000080">N <b>= </b></font><font color="#FF0000">1 </font><font color="#000080"><b>) </b></font><b>is
var byte </b><font color="#000080">counter1
</font><b>var byte </b><font color="#000080">counter2
  </font><b>if </b><font color="#000080">target_clock <b>!= </b></font><font color="#FF0000">20_000_000 </font><b>then
    </b><font color="#800080"><i>pragma </i></font><b>error </b><font color="#808080"><i>-- this delay only works voor 20 MHz
  </i></font><b>end if

  </b><font color="#808080"><i>-- do NOTHING for N == 0
  </i></font><b>if </b><font color="#000080">N <b>== </b></font><font color="#FF0000">0 </font><b>then

  </b><font color="#808080"><i>-- for N == 1 normal overhead is already so heavy that double loop
  -- adds too much, so for N == 1 a separate trimmed routine is made
  </i></font><b>elsif </b><font color="#000080">N <b>== </b></font><font color="#FF0000">1 </font><b>then
    </b><font color="#800080"><i>assembler
    local </i></font><font color="#000080">delay0
        </font><font color="#800080"><i>movlw     </i></font><font color="#FF0000">10          </font><font color="#808080"><i>;
        </i></font><font color="#000080">movwf     counter1    </font><font color="#808080"><i>;
        </i></font><font color="#000080">nop
        nop                  </font><font color="#808080"><i>;
      </i></font><font color="#000080">delay0<b>:                 </b></font><font color="#808080"><i>;
        </i></font><font color="#000080">decfsz    counter1<b>,</b>f  </font><font color="#808080"><i>;
        </i></font><font color="#000080">goto      delay0      </font><font color="#808080"><i>;
    </i></font><b>end </b><font color="#800080"><i>assembler
  </i></font><b>else
    </b><font color="#000080">counter2 <b>=  </b>N <b>- </b></font><font color="#FF0000">1
    </font><font color="#800080"><i>assembler
    local </i></font><font color="#000080">delay0<b>, </b>delay1<b>, </b>delay2
        </font><font color="#808080"><i>; pre loop to compensate for decrement of X
        </i></font><font color="#800080"><i>movlw     </i></font><font color="#FF0000">10           </font><font color="#808080"><i>;
        </i></font><font color="#000080">movwf     counter1    </font><font color="#808080"><i>;
      </i></font><font color="#000080">delay0<b>:                 </b></font><font color="#808080"><i>;
        </i></font><font color="#000080">decfsz    counter1<b>,</b>f  </font><font color="#808080"><i>;
        </i></font><font color="#000080">goto      delay0      </font><font color="#808080"><i>;

      ;double loop, with outerloop set by X-1
      </i></font><font color="#000080">delay1<b>:                 </b></font><font color="#808080"><i>;
        </i></font><font color="#800080"><i>movlw     </i></font><font color="#FF0000">15          </font><font color="#808080"><i>;(1)
        </i></font><font color="#000080">movwf     counter1    </font><font color="#808080"><i>;(1)
      </i></font><font color="#000080">delay2<b>:
        </b>decfsz    counter1<b>,</b>f  </font><font color="#808080"><i>;(1)
        </i></font><font color="#000080">goto      delay2      </font><font color="#808080"><i>;(2)
                              ;(1)
        </i></font><font color="#000080">decfsz    counter2<b>,</b>f  </font><font color="#808080"><i>;(1)
        </i></font><font color="#000080">goto      delay1      </font><font color="#808080"><i>;(2)
                              ;(1)
    </i></font><b>end </b><font color="#800080"><i>assembler
  </i></font><b>end if
end procedure
</b><font color="#808080"><i>-- -----------------------------------------------------------------------------



-- -----------------------------------------------------------------------------
-- Delays for N * 1 msec
-- only valid for 20 MHz Xtal
-- -----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">delay_1ms <b>( </b></font><b>byte in </b><font color="#000080">N <b>= </b></font><font color="#FF0000">1 </font><font color="#000080"><b>) </b></font><b>is
var byte </b><font color="#000080">counter1
</font><b>var byte </b><font color="#000080">counter2
  </font><b>for </b><font color="#000080">N </font><b>loop
      </b><font color="#000080">counter1 <b>= </b></font><font color="#FF0000">7
      </font><font color="#000080">counter2 <b>= </b></font><font color="#FF0000">100
      </font><font color="#800080"><i>assembler
      local </i></font><font color="#000080">delay
      </font><font color="#800080"><i>page </i></font><font color="#000080">delay
      delay<b>:
        </b>decfsz    counter2<b>,</b>f  </font><font color="#808080"><i>;(1)
        </i></font><font color="#000080">goto      delay       </font><font color="#808080"><i>;(2)
        </i></font><font color="#000080">decfsz    counter1<b>,</b>f  </font><font color="#808080"><i>;(1)
        </i></font><font color="#000080">goto      delay      </font><font color="#808080"><i>;(2)
      </i></font><b>end </b><font color="#800080"><i>assembler
  </i></font><b>end loop
end procedure
</b><font color="#808080"><i>-- -----------------------------------------------------------------------------



-- -----------------------------------------------------------------------------
-- Delays for N * 100 msec
-- only valid for 20 MHz Xtal
-- -----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">delay_100ms <b>( </b></font><b>byte in </b><font color="#000080">N <b>= </b></font><font color="#FF0000">1 </font><font color="#000080"><b>) </b></font><b>is
var byte </b><font color="#000080">counter0
</font><b>var byte </b><font color="#000080">counter1
</font><b>var byte </b><font color="#000080">counter2
  </font><b>for </b><font color="#000080">N </font><b>loop
      </b><font color="#000080">counter0 <b>= </b></font><font color="#FF0000">3
      </font><font color="#000080">counter1 <b>= </b></font><font color="#FF0000">130
      </font><font color="#000080">counter2 <b>= </b></font><font color="#FF0000">0
      </font><font color="#800080"><i>assembler
      local </i></font><font color="#000080">delay
      </font><font color="#800080"><i>page </i></font><font color="#000080">delay
      delay<b>:
        </b>decfsz    counter2<b>,</b>f  </font><font color="#808080"><i>;(1)
        </i></font><font color="#000080">goto      delay       </font><font color="#808080"><i>;(2)
        </i></font><font color="#000080">decfsz    counter1<b>,</b>f  </font><font color="#808080"><i>;(1)
        </i></font><font color="#000080">goto      delay       </font><font color="#808080"><i>;(2)
        </i></font><font color="#000080">decfsz    counter0<b>,</b>f  </font><font color="#808080"><i>;(1)
        </i></font><font color="#000080">goto      delay       </font><font color="#808080"><i>;(2)
      </i></font><b>end </b><font color="#800080"><i>assembler
  </i></font><b>end loop
end procedure
</b><font color="#808080"><i>-- -----------------------------------------------------------------------------

</i></font></font>
</code></pre>
</body>
</html>
