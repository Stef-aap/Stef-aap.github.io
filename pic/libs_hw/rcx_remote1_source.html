<html>
<head>
<title>JALcc SourceCode exporting of rcx_remote1_source.html</title>
</head>
<!-- Generated by SynEdit HTML exporter -->
<body text="#000000" bgcolor="#FFFFFF">
<pre>
<code><font  size=3 face="Courier New"><font color="#000080"><A href="rcx_remote1.jal">download&nbsp;rcx_remote1.jal</A>

</font><font color="#808080"><i>-- --------------------------------------------------------------------
-- 16F628_DEFS.JAL
-- This file is best inserted in the main program,
-- so the typical hardware parameters can be set
--
-- This part is ugly and too long, it must be reduced some time
-- --------------------------------------------------------------------
--
-- include automatic translation of mikrochips file 16F628.inc
-- it also includes INDF.JAL
-- and does some special actions,
--   like all ports are input and disable all interrupts
</i></font><font color="#FF00FF">include 16F628_inc
</font><font color="#808080"><i>--
-- for debugging facilities set constant DEBUG to true
</i></font><b>const </b><font color="#000080">debug <b>= </b></font><font color="#FF0000">false
</font><font color="#808080"><i>-- only include if debug mode (saves memory)
</i></font><b>const </b><font color="#FF0000">usart_asynch </font><font color="#000080"><b>= </b></font><font color="#FF0000">true      </font><font color="#808080"><i>;true = RS232, false = SPI
</i></font><b>const </b><font color="#FF0000">baudrate     </font><font color="#000080"><b>= </b></font><font color="#FF0000">115_200   </font><font color="#808080"><i>;Baudrate
</i></font><font color="#FF00FF">include RS232_hw
</font><font color="#808080"><i>--
--
--
</i></font><font color="#800080"><i>pragma target chip        </i></font><font color="#FF0000">16F628
</font><font color="#800080"><i>pragma target </i></font><b>clock       </b><font color="#FF0000">20_000_000
</font><font color="#800080"><i>pragma target </i></font><b>osc         </b><font color="#FF0000">hs
</font><font color="#808080"><i>-- pragma target watchdog    off
-- pragma target powerup     on
-- pragma target protection  off
--
</i></font><font color="#800080"><i>pragma target </i></font><b>fuses       </b><font color="#FF0000">0x3F22
</font><font color="#808080"><i>-- --------------------------------------------------------------------
-- word  cpd lvp boden mclr pwrt wdt osc         observation
-- 3FC1  off on  on    io   off  off xt
-- 3FD0  off on  on    io   off  off intrc+io
-- 3FF0  off on  on    mclr off  off intrc+io
-- 3F22  off off off   mclr off  off hs
-- 3F62  off off on    mclr off  off hs          default
-- -------------------------------------------------------------
--
-- pic 16F62x
-- RA2 / AN2   / Vref     1 === 18   RA1 / AN1
-- RA3 / AN3   / CMP1     2 === 17   RA0 / AN0
-- RA4 / TOCK1 / CMP2     3 === 16   RA7 / OSC1 / CLKIN
-- RA5 / -MCLR / THV      4 === 15   RA6 / OSC2 / CLKOUT
-- Vss                    5 === 14   VDD
-- RB0 / INT              6 === 13   RB7 / T1OSI
-- RB1 / RX    / DT       7 === 12   RB6 / T1OSO / T1CK1
-- RB2 / TX    / CK       8 === 11   RB5
-- RB3 / CCP1             9 === 10   RB4 / PGM
-- include jpic_basic
-- include 16F628_spec
-- --------------------------------------------------------------------
-- END OF 16F628_DEFS.JAL
-- --------------------------------------------------------------------



-- --------------------------------------------------------------------
-- SCAN_MATRIX_INS.JAL
-- This file is best inserted in the main program,
-- so the typical hardware parameters can be set
-- --------------------------------------------------------------------
--
-- define the number of total scanlines (2 ... 5)
</i></font><b>const byte </b><font color="#000080">key_nr_scanlines <b>= </b></font><font color="#FF0000">5
</font><font color="#808080"><i>--
-- define the port where scanlines resides
-- (all scan lines must be on the same port)
</i></font><b>var volatile byte </b><font color="#000080">key_port </font><b>is </b><font color="#000080">PORTB
</font><font color="#808080"><i>--
-- define the pinnumbers where the scanlines are
-- always define the maximum number of pins,
-- don't worry if you have less scanlines,
-- only the active scanlines will be affected
</i></font><b>const </b><font color="#000080">key_scanpin_1 <b>= </b></font><font color="#FF0000">0
</font><b>const </b><font color="#000080">key_scanpin_2 <b>= </b></font><font color="#FF0000">4
</font><b>const </b><font color="#000080">key_scanpin_3 <b>= </b></font><font color="#FF0000">5
</font><b>const </b><font color="#000080">key_scanpin_4 <b>= </b></font><font color="#FF0000">7
</font><b>const </b><font color="#000080">key_scanpin_5 <b>= </b></font><font color="#FF0000">6
</font><font color="#808080"><i>--
-- the scanmatrix must have pull-up resistors at all lines
-- the user must set the pull-ups active
-- if portB is used you can use the next statement
  </i></font><font color="#000080">OPTION_REG <b>= </b>OPTION_REG <b>&amp; </b></font><font color="#FF0000">0x7F
</font><font color="#808080"><i>--
-- here the real matrix routines are automatic included
</i></font><font color="#FF00FF">include scan_matrix
</font><font color="#808080"><i>-- --------------------------------------------------------------------
-- END OF SCAN_MATRIX_INS.JAL
-- --------------------------------------------------------------------



</i></font><font color="#FF00FF">include scan_pots
</font><font color="#808080"><i>-- --------------------------------------------------------------------
-- connect the power level of the motors to the 2 potmeters
-- --------------------------------------------------------------------
</i></font><b>var byte </b><font color="#000080">RCX_motor_power_A </font><b>is </b><font color="#000080">potmeter1
</font><b>var byte </b><font color="#000080">RCX_motor_power_B </font><b>is </b><font color="#000080">potmeter2
</font><b>var byte </b><font color="#000080">RCX_motor_power_C </font><b>is </b><font color="#000080">potmeter1
</font><font color="#808080"><i>-- --------------------------------------------------------------------



-- -----------------------------------------------------------------------------
-- RCX_INS.JAL must be inserted into the user program
-- version 0.0
--
-- this library implements an interrupt routine
-- -----------------------------------------------------------------------------
</i></font><b>var volatile bit </b><font color="#000080">IR_out </font><b>is </b><font color="#000080">pin_a4           </font><font color="#808080"><i>-- IR diode
</i></font><b>var volatile bit </b><font color="#000080">IR_dir </font><b>is </b><font color="#000080">pin_a4_direction </font><font color="#808080"><i>-- to set it as an ouput
</i></font><b>const bit        </b><font color="#000080">IR_off <b>=  </b></font><b>high             </b><font color="#808080"><i>-- IR diodes between IO and +5V
                                            -- if IR diodes between IO and GND
                                            -- then set IR_off = low
-- now insert automatically RCX.JAL
</i></font><font color="#FF00FF">include RCX
</font><font color="#808080"><i>-- -----------------------------------------------------------------------------
-- end of RCX_INS.JAL
-- -----------------------------------------------------------------------------



-- --------------------------------------------------------------------
-- THE MAIN PROGRAM
--
-- at this moment most commands are orginal RCX-remote commands
-- except for the motor control commands (keys and potmeters) which are
-- normal immediate RCX-commands.
-- The advantage of the normal RCX commands is that they are shorter/faster
-- and you don't have to wait for a reply.
-- --------------------------------------------------------------------
</i></font><b>var byte </b><font color="#000080">key <b>= </b></font><font color="#FF0000">0
</font><b>forever loop

  </b><font color="#808080"><i>-- first scan keybord
  </i></font><font color="#000080">scan_keymatrix_ext <b>( </b>key <b>)
  </b></font><font color="#808080"><i>-- if no (different) key pressed, scan potmeter
  </i></font><b>if </b><font color="#000080">key <b>== </b></font><font color="#FF0000">0 </font><b>then </b><font color="#000080">scan_2_pots <b>( </b>key <b>) </b></font><b>end if

  </b><font color="#808080"><i>-- if a different key was pressed, execute the command
  </i></font><b>if </b><font color="#000080">key <b>!= </b></font><font color="#FF0000">0 </font><b>then
</b><font color="#000080">asynch_send_hw<b>(</b>key<b>)
    </b></font><font color="#808080"><i>-- motor A forward
    </i></font><b>if </b><font color="#000080">key <b>== </b></font><font color="#FF0000">4 </font><b>then
      </b><font color="#000080">RCX_motor_A_on <b>= </b>RCX_motor_on
      RCX_motor_A_direction <b>= </b>RCX_motor_forward
      RCX_motor_power <b>= </b>RCX_motor_power_A
      RCX_update_motor <b>(</b>motor_A<b>)

    </b></font><font color="#808080"><i>-- motor A backward
    </i></font><b>elsif </b><font color="#000080">key <b>== </b></font><font color="#FF0000">16 </font><b>then
      </b><font color="#000080">RCX_motor_A_on <b>= </b>RCX_motor_on
      RCX_motor_A_direction <b>= </b>RCX_motor_backward
      RCX_motor_power <b>= </b>RCX_motor_power_A
      RCX_update_motor <b>(</b>motor_A<b>)


    </b></font><font color="#808080"><i>-- motor B forward
    </i></font><b>elsif </b><font color="#000080">key <b>== </b></font><font color="#FF0000">21 </font><b>then
      </b><font color="#000080">RCX_motor_B_on <b>= </b>RCX_motor_on
      RCX_motor_B_direction <b>= </b>RCX_motor_forward
      RCX_motor_power <b>= </b>RCX_motor_power_B
      RCX_update_motor <b>(</b>motor_B<b>)

    </b></font><font color="#808080"><i>-- motor B backward
    </i></font><b>elsif </b><font color="#000080">key <b>== </b></font><font color="#FF0000">6 </font><b>then
      </b><font color="#000080">RCX_motor_B_on <b>= </b>RCX_motor_on
      RCX_motor_B_direction <b>= </b>RCX_motor_backward
      RCX_motor_power <b>= </b>RCX_motor_power_B
      RCX_update_motor <b>(</b>motor_B<b>)

    </b></font><font color="#808080"><i>-- motor C forward
    </i></font><b>elsif </b><font color="#000080">key <b>== </b></font><font color="#FF0000">3 </font><b>then
      </b><font color="#000080">RCX_motor_C_on <b>= </b>RCX_motor_on
      RCX_motor_C_direction <b>= </b>RCX_motor_forward
      RCX_motor_power <b>= </b>RCX_motor_power_C
      RCX_update_motor <b>(</b>motor_C<b>)

    </b></font><font color="#808080"><i>-- motor C backward
    </i></font><b>elsif </b><font color="#000080">key <b>== </b></font><font color="#FF0000">11 </font><b>then
      </b><font color="#000080">RCX_motor_C_on <b>= </b>RCX_motor_on
      RCX_motor_C_direction <b>= </b>RCX_motor_backward
      RCX_motor_power <b>= </b>RCX_motor_power_C
      RCX_update_motor <b>(</b>motor_C<b>)

    </b></font><font color="#808080"><i>-- first potmeter, controls power of moter A+C,
    -- motors must be ON, otherwise nothing happens
    </i></font><b>elsif </b><font color="#000080"><b>( </b>key <b>&gt;= </b></font><font color="#FF0000">0x80 </font><font color="#000080"><b>) &amp; ( </b>key <b>&lt; </b></font><font color="#FF0000">0x90 </font><font color="#000080"><b>) </b></font><b>then
      </b><font color="#000080">RCX_motor_list <b>= </b>motor_A <b>| </b>motor_C
      RCX_motor_power <b>= </b>key <b>&amp; </b></font><font color="#FF0000">7
      </font><font color="#000080">RCX_send_command_and_wait <b>( </b>RCX_cmd_motor_power <b>)
      
    </b></font><font color="#808080"><i>-- second potmeter, controls power of moter B,
    -- motors must be ON, otherwise nothing happens
    </i></font><b>elsif </b><font color="#000080">key <b>&gt;= </b></font><font color="#FF0000">0x90 </font><b>then
      </b><font color="#000080">RCX_motor_list <b>= </b>motor_B
      RCX_motor_power <b>= </b>key <b>&amp; </b></font><font color="#FF0000">7
      </font><font color="#000080">RCX_send_command_and_wait <b>( </b>RCX_cmd_motor_power <b>)


    </b></font><b>elsif </b><font color="#000080">key <b>== </b></font><font color="#FF0000">24 </font><b>then
      </b><font color="#000080">RCX_send_command_and_wait <b>( </b>RCX_remcmd_Prog1 <b>)
    </b></font><b>elsif </b><font color="#000080">key <b>== </b></font><font color="#FF0000">12 </font><b>then
      </b><font color="#000080">RCX_send_command_and_wait <b>( </b>RCX_remcmd_Prog2 <b>)
    </b></font><b>elsif </b><font color="#000080">key <b>== </b></font><font color="#FF0000">8 </font><b>then
      </b><font color="#000080">RCX_send_command_and_wait <b>( </b>RCX_remcmd_Prog3 <b>)
    </b></font><b>elsif </b><font color="#000080">key <b>== </b></font><font color="#FF0000">9 </font><b>then
      </b><font color="#000080">RCX_send_command_and_wait <b>( </b>RCX_remcmd_Prog4 <b>)
    </b></font><b>elsif </b><font color="#000080">key <b>== </b></font><font color="#FF0000">17 </font><b>then
      </b><font color="#000080">RCX_send_command_and_wait <b>( </b>RCX_remcmd_Prog5 <b>)
    </b></font><b>elsif </b><font color="#000080">key <b>== </b></font><font color="#FF0000">2 </font><b>then
      </b><font color="#808080"><i>-- to garantee, command needs Null command before
      </i></font><font color="#000080">RCX_send_command_and_wait <b>( </b>RCX_cmd_NULL <b>)
      </b>RCX_send_command_and_wait <b>( </b>RCX_remcmd_stop <b>)

    </b></font><font color="#808080"><i>-- messages not tested yet
    </i></font><b>elsif </b><font color="#000080">key <b>== </b></font><font color="#FF0000">14 </font><b>then
      </b><font color="#000080">RCX_send_command_and_wait <b>( </b>RCX_remcmd_mess1 <b>)
    </b></font><b>elsif </b><font color="#000080">key <b>== </b></font><font color="#FF0000">22 </font><b>then
      </b><font color="#000080">RCX_send_command_and_wait <b>( </b>RCX_remcmd_mess2 <b>)
    </b></font><b>elsif </b><font color="#000080">key <b>== </b></font><font color="#FF0000">23 </font><b>then
      </b><font color="#000080">RCX_send_command_and_wait <b>( </b>RCX_remcmd_mess3 <b>)

    </b></font><font color="#808080"><i>-- elsif key == 18 then
    -- for all other commands do remote sound
    </i></font><b>else
      </b><font color="#808080"><i>-- to garantee, remote sounds needs Null command before
      </i></font><font color="#000080">RCX_send_command_and_wait <b>( </b>RCX_cmd_NULL <b>)
      </b>RCX_send_command_and_wait <b>( </b>RCX_remcmd_sound <b>)
    </b></font><b>end if
  end if

  </b><font color="#808080"><i>-- now always delay some time
  </i></font><font color="#000080">RCX_wait_for_respons

</font><b>end loop
</b></font>
</code></pre>
</body>
</html>
