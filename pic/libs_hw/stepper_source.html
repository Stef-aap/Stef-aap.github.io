<html>
<head>
<title>JALcc SourceCode exporting of stepper_source.html</title>
</head>
<!-- Generated by SynEdit HTML exporter -->
<body text="#000000" bgcolor="#FFFFFF">
<pre>
<code><font  size=3 face="Courier New"><font color="#000080"><A href="stepper.jal">download&nbsp;stepper.jal</A>
</font><font color="#808080"><i>-- -----------------------------------------------------------------------------
-- &lt;title 2 stepper
-- &lt;License
-- freeware, under the terms of the GNU GPL
--  Copyright (C) 2002 Stef Mientki
-- -----------------------------------------------------------------------------
-- &lt;Description
-- Library that can control up to 2 stepper motors.
-- Features
--    * position control (in half-steps) controled by a 4 byte number
--    * both half-stepping and full-stepping implemented
--    * on full-stepping, 1 or 2 windings can be forced
--    * acceleration / deceleration supported
--  uses   : byte3_math, TMR0 as interrupt generator
--
--
-- &lt;Version: 1.0  24-08-2002   Stef Mientki
--    - orginal release
-- -----------------------------------------------------------------------------
-- -----------------------------------------------------------------------------



-- -----------------------------------------------------------------------------
-- &lt;Example stepper
; -- SEE STEPPER_RS232.JAL
-- -----------------------------------------------------------------------------


-- &lt;code



-- -----------------------------------------------------------------------------
-- automatic include the necessary files
</i></font><b>const </b><font color="#000080">LOG_ACCURACY <b>= </b></font><font color="#FF0000">2  </font><font color="#808080"><i>-- necessary for byte3_math
</i></font><font color="#FF00FF">include byte3_math
</font><font color="#808080"><i>-- -----------------------------------------------------------------------------



-- motor status constants
</i></font><b>const byte </b><font color="#000080">_stepper_status_stopped      <b>= </b></font><font color="#FF0000">0
</font><b>const byte </b><font color="#000080">_stepper_status_running      <b>= </b></font><font color="#FF0000">1
</font><b>const byte </b><font color="#000080">_stepper_status_continuous   <b>= </b></font><font color="#FF0000">2


</font><font color="#808080"><i>-- variables for motor1
</i></font><b>var volatile byte </b><font color="#000080">_stepper1_period
</font><b>var volatile byte </b><font color="#000080">_stepper1_period_preset <b>= </b></font><font color="#FF0000">40
</font><b>var volatile byte </b><font color="#000080">_stepper1_index <b>= </b></font><font color="#FF0000">0
</font><b>var volatile byte </b><font color="#000080">stepper1_status
</font><b>var volatile bit  </b><font color="#000080">stepper1_full_steps
</font><b>var volatile bit  </b><font color="#000080">stepper1_full_force_1_winding
</font><b>var volatile bit  </b><font color="#000080">stepper1_full_force_2_winding
</font><b>var volatile bit  </b><font color="#000080">stepper1_forward
</font><b>var volatile byte </b><font color="#000080">stepper1_pos1
</font><b>var volatile byte </b><font color="#000080">stepper1_pos2
</font><b>var volatile byte </b><font color="#000080">stepper1_pos3
</font><b>var volatile byte </b><font color="#000080">stepper1_pos4
</font><b>var volatile byte </b><font color="#000080">_stepper1_target_pos1
</font><b>var volatile byte </b><font color="#000080">_stepper1_target_pos2
</font><b>var volatile byte </b><font color="#000080">_stepper1_target_pos3
</font><b>var volatile byte </b><font color="#000080">_stepper1_target_pos4
</font><b>var volatile bit  </b><font color="#000080">stepper1_accelerate_on
</font><b>var volatile byte </b><font color="#000080">_stepper1_acc_count
</font><b>var volatile byte </b><font color="#000080">_stepper1_acc_index
</font><b>var volatile bit  </b><font color="#000080">_stepper1_not_decelerating


</font><font color="#808080"><i>-- identical variables for motor 2
</i></font><b>var volatile byte </b><font color="#000080">_stepper2_period
</font><b>var volatile byte </b><font color="#000080">_stepper2_period_preset <b>= </b></font><font color="#FF0000">40
</font><b>var volatile byte </b><font color="#000080">_stepper2_index <b>= </b></font><font color="#FF0000">0
</font><b>var volatile byte </b><font color="#000080">stepper2_status
</font><b>var volatile bit  </b><font color="#000080">stepper2_full_steps
</font><b>var volatile bit  </b><font color="#000080">stepper2_full_force_1_winding
</font><b>var volatile bit  </b><font color="#000080">stepper2_full_force_2_winding
</font><b>var volatile bit  </b><font color="#000080">stepper2_forward
</font><b>var volatile byte </b><font color="#000080">stepper2_pos1
</font><b>var volatile byte </b><font color="#000080">stepper2_pos2
</font><b>var volatile byte </b><font color="#000080">stepper2_pos3
</font><b>var volatile byte </b><font color="#000080">stepper2_pos4
</font><b>var volatile byte </b><font color="#000080">_stepper2_target_pos1
</font><b>var volatile byte </b><font color="#000080">_stepper2_target_pos2
</font><b>var volatile byte </b><font color="#000080">_stepper2_target_pos3
</font><b>var volatile byte </b><font color="#000080">_stepper2_target_pos4
</font><b>var volatile bit  </b><font color="#000080">stepper2_accelerate_on
</font><b>var volatile byte </b><font color="#000080">_stepper2_acc_count
</font><b>var volatile byte </b><font color="#000080">_stepper2_acc_index
</font><b>var volatile bit  </b><font color="#000080">_stepper2_not_decelerating



</font><font color="#808080"><i>-- ----------------------------------------------------------------------------
-- internal routine
-- This table can be used for both half-stepping and full-stepping of 4-phase motors
-- for full-stepping the table indices are incremented or decremented by 2
-- NOTE: depending on the moment of switching form half-stepping to full-stepping
--       the odd or the even indices can be used !!
--
-- If these tables are not used, they will not consume any memory space,
-- because they will be wiped out by the compiler
-- ----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">_stepper_table_4_phase_forward </font><b>is
   </b><font color="#800080"><i>pragma </i></font><font color="#000080">jump_table
   </font><font color="#800080"><i>assembler
      </i></font><font color="#000080">addwf   PCL<b>,</b>f
      retlw   </font><font color="#FF0000">0b_0001
      </font><font color="#000080">retlw   </font><font color="#FF0000">0b_0011
      </font><font color="#000080">retlw   </font><font color="#FF0000">0b_0010
      </font><font color="#000080">retlw   </font><font color="#FF0000">0b_0110
      </font><font color="#000080">retlw   </font><font color="#FF0000">0b_0100
      </font><font color="#000080">retlw   </font><font color="#FF0000">0b_1100
      </font><font color="#000080">retlw   </font><font color="#FF0000">0b_1000
      </font><font color="#000080">retlw   </font><font color="#FF0000">0b_1001
   </font><b>end </b><font color="#800080"><i>assembler
</i></font><b>end procedure
</b><font color="#808080"><i>-- ----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">_get_stepper_value <b>(  </b></font><b>byte in  out </b><font color="#000080">indx<b>, </b></font><b>byte out </b><font color="#000080">x <b>) </b></font><b>is
  </b><font color="#800080"><i>assembler
    bank  </i></font><font color="#000080">movfw  indx
    </font><font color="#800080"><i>page  </i></font><font color="#000080">call   _stepper_table_4_phase_forward
    </font><font color="#800080"><i>bank  </i></font><font color="#000080">movwf  x
  </font><b>end </b><font color="#800080"><i>assembler
</i></font><b>end procedure
</b><font color="#808080"><i>-- ----------------------------------------------------------------------------



-- -----------------------------------------------------------------------------
-- internal routine
-- increment the current position counter of motor=1
-- -----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">_stepper1_inc_pos </font><b>is
  </b><font color="#800080"><i>assembler
  local </i></font><font color="#000080">non_zero
    incfsz   stepper1_pos1<b>,</b>f
    goto     non_zero
    incfsz   stepper1_pos2<b>,</b>f
    goto     non_zero
    incfsz   stepper1_pos3<b>,</b>f
    goto     non_zero
    incfsz   stepper1_pos4<b>,</b>f
  non_zero<b>:
  </b></font><b>end </b><font color="#800080"><i>assembler
</i></font><b>end procedure
</b><font color="#808080"><i>-- -----------------------------------------------------------------------------



-- -----------------------------------------------------------------------------
-- internal routine
-- increment the current position counter of motor=2
-- -----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">_stepper2_inc_pos </font><b>is
  </b><font color="#800080"><i>assembler
  local </i></font><font color="#000080">non_zero
    incfsz   stepper2_pos1<b>,</b>f
    goto     non_zero
    incfsz   stepper2_pos2<b>,</b>f
    goto     non_zero
    incfsz   stepper2_pos3<b>,</b>f
    goto     non_zero
    incfsz   stepper2_pos4<b>,</b>f
  non_zero<b>:
  </b></font><b>end </b><font color="#800080"><i>assembler
</i></font><b>end procedure
</b><font color="#808080"><i>-- -----------------------------------------------------------------------------



-- -----------------------------------------------------------------------------
-- internal routine
-- decrement the current position counter of motor=1
-- -----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">_stepper1_dec_pos </font><b>is
  </b><font color="#800080"><i>assembler
  local </i></font><font color="#000080">non_zero
    </font><font color="#800080"><i>movlw    </i></font><font color="#FF0000">1
    </font><font color="#000080">subwf    stepper1_pos1<b>,</b>f
    btfsc    C
    goto     non_zero
    subwf    stepper1_pos2<b>,</b>f
    btfsc    C
    goto     non_zero
    subwf    stepper1_pos3<b>,</b>f
    btfsc    C
    goto     non_zero
    subwf    stepper1_pos4<b>,</b>f
  non_zero<b>:
  </b></font><b>end </b><font color="#800080"><i>assembler
</i></font><b>end procedure
</b><font color="#808080"><i>-- -----------------------------------------------------------------------------



-- -----------------------------------------------------------------------------
-- internal routine
-- decrement the current position counter of motor=2
-- -----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">_stepper2_dec_pos </font><b>is
  </b><font color="#800080"><i>assembler
  local </i></font><font color="#000080">non_zero
    </font><font color="#800080"><i>movlw    </i></font><font color="#FF0000">1
    </font><font color="#000080">subwf    stepper2_pos1<b>,</b>f
    btfsc    C
    goto     non_zero
    subwf    stepper2_pos2<b>,</b>f
    btfsc    C
    goto     non_zero
    subwf    stepper2_pos3<b>,</b>f
    btfsc    C
    goto     non_zero
    subwf    stepper2_pos4<b>,</b>f
  non_zero<b>:
  </b></font><b>end </b><font color="#800080"><i>assembler
</i></font><b>end procedure
</b><font color="#808080"><i>-- -----------------------------------------------------------------------------



-- -----------------------------------------------------------------------------
-- internal routine
-- compare the current postion and the target position of motor=1
-- returns TRUE if both are equal
-- ..?..result stored in gloabl ??
-- -----------------------------------------------------------------------------
</i></font><b>function </b><font color="#000080">_stepper1_cmp_pos </font><b>return bit is
  </b><font color="#800080"><i>assembler
  local </i></font><font color="#000080">not_equal<b>, </b>finish
    movf     stepper1_pos1<b>,</b>w
    subwf    _stepper1_target_pos1<b>,</b>w
    btfss    Z
    goto     not_equal

    movf     stepper1_pos2<b>,</b>w
    subwf    _stepper1_target_pos2<b>,</b>w
    btfss    Z
    goto     not_equal

    movf     stepper1_pos3<b>,</b>w
    subwf    _stepper1_target_pos3<b>,</b>w
    btfss    Z
    goto     not_equal

    movf     stepper1_pos4<b>,</b>w
    subwf    _stepper1_target_pos4<b>,</b>w
    btfss    Z
    goto     not_equal

</font><font color="#808080"><i>;    movlw    0           ;equal
;    goto     finish      ;
  </i></font><font color="#000080">not_equal<b>:             </b></font><font color="#808080"><i>;
;    movlw    1           ;
  </i></font><font color="#000080">finish<b>:                </b></font><font color="#808080"><i>;
;    movwf    _stepper1_z          ;
  </i></font><b>end </b><font color="#800080"><i>assembler
  </i></font><b>return </b><font color="#000080">Z
</font><b>end function
</b><font color="#808080"><i>-- -----------------------------------------------------------------------------



-- -----------------------------------------------------------------------------
-- internal routine
-- compare the current postion and the target position of motor=2
-- returns TRUE if both are equal
-- ..?..result stored in gloabl ??
-- -----------------------------------------------------------------------------
</i></font><b>function </b><font color="#000080">_stepper2_cmp_pos </font><b>return bit is
  </b><font color="#800080"><i>assembler
  local </i></font><font color="#000080">not_equal<b>, </b>finish
    movf     stepper2_pos1<b>,</b>w
    subwf    _stepper2_target_pos1<b>,</b>w
    btfss    Z
    goto     not_equal

    movf     stepper2_pos2<b>,</b>w
    subwf    _stepper2_target_pos2<b>,</b>w
    btfss    Z
    goto     not_equal

    movf     stepper2_pos3<b>,</b>w
    subwf    _stepper2_target_pos3<b>,</b>w
    btfss    Z
    goto     not_equal

    movf     stepper2_pos4<b>,</b>w
    subwf    _stepper2_target_pos4<b>,</b>w
    btfss    Z
    goto     not_equal

</font><font color="#808080"><i>;    movlw    0           ;equal
;    goto     finish      ;
  </i></font><font color="#000080">not_equal<b>:             </b></font><font color="#808080"><i>;
;    movlw    1           ;
  </i></font><font color="#000080">finish<b>:                </b></font><font color="#808080"><i>;
;    movwf    _stepper1_z          ;
  </i></font><b>end </b><font color="#800080"><i>assembler
  </i></font><b>return </b><font color="#000080">Z
</font><b>end function
</b><font color="#808080"><i>-- -----------------------------------------------------------------------------



-- -----------------------------------------------------------------------------
-- internal routine
-- tests in full step mode if forced windings 1/2 are ok for motor=1
-- TRUE if no forced windings or forced windings are wrong
-- -----------------------------------------------------------------------------
</i></font><b>function </b><font color="#000080">_stepper1_test_forced_windings </font><b>return bit is
var bit </b><font color="#000080">index_lsb </font><b>at </b><font color="#000080">_stepper1_index <b>: </b></font><font color="#FF0000">0
  </font><b>return
    </b><font color="#000080"><b>((! </b>stepper1_full_force_1_winding<b>) &amp; (! </b>stepper1_full_force_2_winding<b>)) |
    (</b>stepper1_full_force_1_winding <b>&amp; </b>index_lsb<b>)|
    (</b>stepper1_full_force_2_winding <b>&amp; (! </b>index_lsb<b>))
</b></font><b>end function
</b><font color="#808080"><i>-- -----------------------------------------------------------------------------



-- -----------------------------------------------------------------------------
-- internal routine
-- tests in full step mode if forced windings 1/2 are ok for motor=2
-- TRUE if no forced windings or forced windings are wrong
-- -----------------------------------------------------------------------------
</i></font><b>function </b><font color="#000080">_stepper2_test_forced_windings </font><b>return bit is
var bit </b><font color="#000080">index_lsb </font><b>at </b><font color="#000080">_stepper2_index <b>: </b></font><font color="#FF0000">0
  </font><b>return
    </b><font color="#000080"><b>((! </b>stepper2_full_force_1_winding<b>) &amp; (! </b>stepper2_full_force_2_winding<b>)) |
    (</b>stepper2_full_force_1_winding <b>&amp; </b>index_lsb<b>)|
    (</b>stepper2_full_force_2_winding <b>&amp; (! </b>index_lsb<b>))
</b></font><b>end function
</b><font color="#808080"><i>-- -----------------------------------------------------------------------------



-- -----------------------------------------------------------------------------
-- internal routine
-- steps motor=1 a half- or full-step forward
-- if motor is not in continuous mode and target position is reached,
-- no motor movement will be made.
-- in fullstep mode, also the settings of force full windings is checked
-- -----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">_stepper1_step_forward </font><b>is
  </b><font color="#808080"><i>;increment indices
  </i></font><font color="#000080">_stepper1_index <b>= </b>_stepper1_index <b>+ </b></font><font color="#FF0000">1
  </font><font color="#000080">_stepper1_inc_pos

  </font><font color="#808080"><i>;on full steps, take another half step
  </i></font><b>if </b><font color="#000080">stepper1_full_steps <b>&amp;
     ( (! </b>_stepper1_cmp_pos<b>) |
       (</b>stepper1_status <b>== </b>_stepper_status_continuous<b>)
     ) </b></font><b>then
     </b><font color="#808080"><i>;only step if no forced windings or forced windings are wrong
     </i></font><b>if </b><font color="#000080">_stepper1_test_forced_windings </font><b>then
      </b><font color="#000080">_stepper1_index <b>= </b>_stepper1_index <b>+ </b></font><font color="#FF0000">1
      </font><font color="#000080">_stepper1_inc_pos
     </font><b>end if
  end if

  </b><font color="#808080"><i>;correct table overflow
  </i></font><b>if </b><font color="#000080">_stepper1_index <b>&gt;= </b></font><font color="#FF0000">8 </font><b>then
    </b><font color="#000080">_stepper1_index <b>= </b>_stepper1_index <b>- </b></font><font color="#FF0000">8
  </font><b>end if
end procedure
</b><font color="#808080"><i>-- -----------------------------------------------------------------------------



-- -----------------------------------------------------------------------------
-- internal routine
-- steps motor=2 a half- or full-step forward
-- if motor is not in continuous mode and target position is reached,
-- no motor movement will be made.
-- in fullstep mode, also the settings of force full windings is checked
-- -----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">_stepper2_step_forward </font><b>is
  </b><font color="#808080"><i>;increment indices
  </i></font><font color="#000080">_stepper2_index <b>= </b>_stepper2_index <b>+ </b></font><font color="#FF0000">1
  </font><font color="#000080">_stepper2_inc_pos

  </font><font color="#808080"><i>;on full steps, take another half step
  </i></font><b>if </b><font color="#000080">stepper2_full_steps <b>&amp;
     ( (! </b>_stepper2_cmp_pos<b>) |
       (</b>stepper2_status <b>== </b>_stepper_status_continuous<b>)
     ) </b></font><b>then
     </b><font color="#808080"><i>;only step if no forced windings or forced windings are wrong
     ;only step if no forced windings or forced windings are wrong
     </i></font><b>if </b><font color="#000080">_stepper2_test_forced_windings </font><b>then
      </b><font color="#000080">_stepper2_index <b>= </b>_stepper2_index <b>+ </b></font><font color="#FF0000">1
      </font><font color="#000080">_stepper2_inc_pos
     </font><b>end if
  end if

  </b><font color="#808080"><i>;correct table overflow
  </i></font><b>if </b><font color="#000080">_stepper2_index <b>&gt;= </b></font><font color="#FF0000">8 </font><b>then
    </b><font color="#000080">_stepper2_index <b>= </b>_stepper2_index <b>- </b></font><font color="#FF0000">8
  </font><b>end if
end procedure
</b><font color="#808080"><i>-- -----------------------------------------------------------------------------



-- -----------------------------------------------------------------------------
-- internal routine
-- steps motor=1 a half- or full-step backward
-- if motor is not in continuous mode and target position is reached,
-- no motor movement will be made.
-- in fullstep mode, also the settings of force full windings is checked
-- -----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">_stepper1_step_backward </font><b>is
var bit </b><font color="#000080">_stepper1_index_msb </font><b>at </b><font color="#000080">_stepper1_index <b>: </b></font><font color="#FF0000">7

  </font><font color="#808080"><i>;decrement indices
  </i></font><font color="#000080">_stepper1_index <b>= </b>_stepper1_index <b>- </b></font><font color="#FF0000">1
  </font><font color="#000080">_stepper1_dec_pos

  </font><font color="#808080"><i>;on full steps, take another half step
  </i></font><b>if </b><font color="#000080">stepper1_full_steps <b>&amp;
     ( (! </b>_stepper1_cmp_pos<b>) |
       (</b>stepper1_status <b>== </b>_stepper_status_continuous<b>)
     ) </b></font><b>then
     </b><font color="#808080"><i>;only step if no forced windings or forced windings are wrong
     </i></font><b>if </b><font color="#000080">_stepper1_test_forced_windings </font><b>then
      </b><font color="#000080">_stepper1_index <b>= </b>_stepper1_index <b>- </b></font><font color="#FF0000">1
      </font><font color="#000080">_stepper1_dec_pos
     </font><b>end if
  end if

  </b><font color="#808080"><i>;correct table overflow
  </i></font><b>if </b><font color="#000080">_stepper1_index_msb </font><b>then
    </b><font color="#000080">_stepper1_index <b>= </b>_stepper1_index <b>+ </b></font><font color="#FF0000">8
  </font><b>end if
end procedure
</b><font color="#808080"><i>-- -----------------------------------------------------------------------------



-- -----------------------------------------------------------------------------
-- internal routine
-- steps motor=2 a half- or full-step backward
-- if motor is not in continuous mode and target position is reached,
-- no motor movement will be made.
-- in fullstep mode, also the settings of force full windings is checked
-- -----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">_stepper2_step_backward </font><b>is
var bit </b><font color="#000080">_stepper2_index_msb </font><b>at </b><font color="#000080">_stepper2_index <b>: </b></font><font color="#FF0000">7

  </font><font color="#808080"><i>;decrement indices
  </i></font><font color="#000080">_stepper2_index <b>= </b>_stepper2_index <b>- </b></font><font color="#FF0000">1
  </font><font color="#000080">_stepper2_dec_pos

  </font><font color="#808080"><i>;on full steps, take another half step
  </i></font><b>if </b><font color="#000080">stepper2_full_steps <b>&amp;
     ( (! </b>_stepper2_cmp_pos<b>) |
       (</b>stepper2_status <b>== </b>_stepper_status_continuous<b>)
     ) </b></font><b>then
     </b><font color="#808080"><i>;only step if no forced windings or forced windings are wrong
     </i></font><b>if </b><font color="#000080">_stepper2_test_forced_windings </font><b>then
      </b><font color="#000080">_stepper2_index <b>= </b>_stepper2_index <b>- </b></font><font color="#FF0000">1
      </font><font color="#000080">_stepper2_dec_pos
     </font><b>end if
  end if

  </b><font color="#808080"><i>;correct table overflow
  </i></font><b>if </b><font color="#000080">_stepper2_index_msb </font><b>then
    </b><font color="#000080">_stepper2_index <b>= </b>_stepper2_index <b>+ </b></font><font color="#FF0000">8
  </font><b>end if
end procedure
</b><font color="#808080"><i>-- -----------------------------------------------------------------------------



-- -----------------------------------------------------------------------------
-- internal routine
-- this is the procedure that should be called by the interrupt routine
-- If you're using JALcc, it's most convenient done by a macro statement
-- -----------------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">_stepper_TMR0_interrupt </font><b>is
</b><font color="#000080"><b>&lt;</b></font><font color="#800080"><i>mac</i></font><font color="#000080"><b>&gt; </b>interrupt_sub _stepper_TMR0_interrupt T0IF </font><font color="#FF0000">5
</font><b>var byte </b><font color="#000080">value
</font><b>var bit </b><font color="#000080">_stepper1_acc_index_msb </font><b>at </b><font color="#000080">_stepper1_acc_index <b>: </b></font><font color="#FF0000">7
</font><b>var bit </b><font color="#000080">_stepper2_acc_index_msb </font><b>at </b><font color="#000080">_stepper2_acc_index <b>: </b></font><font color="#FF0000">7

  </font><font color="#808080"><i>-- must be (one of) the first statement for accurate timing
  </i></font><font color="#000080">TMR0 <b>= </b>_tmr0_preset  </font><font color="#808080"><i>-- preset counter again

  ;if motor is running
  </i></font><b>if </b><font color="#000080">stepper1_status <b>!= </b>_stepper_status_stopped </font><b>then
    </b><font color="#808080"><i>;only decrement period counter when it's not already zero,
    ;this could happen if a motor has reached his target position,
    ;while still in running mode
    ;if this limiting is not done, it could take quiet a while to restart
    </i></font><b>if </b><font color="#000080">_stepper1_period <b>!= </b></font><font color="#FF0000">0 </font><b>then </b><font color="#000080">_stepper1_period <b>= </b>_stepper1_period <b>- </b></font><font color="#FF0000">1 </font><b>end if

    </b><font color="#808080"><i>;if motor puls finished
    </i></font><b>if </b><font color="#000080">_stepper1_period <b>== </b></font><font color="#FF0000">0 </font><b>then

      </b><font color="#808080"><i>;as long as position not reached or running continuous
      </i></font><b>if </b><font color="#000080"><b>(! </b>_stepper1_cmp_pos<b>) |
         (</b>stepper1_status <b>== </b>_stepper_status_continuous<b>) </b></font><b>then

        if </b><font color="#000080">stepper1_accelerate_on </font><b>then
          </b><font color="#000080">_stepper1_acc_count <b>= </b>_stepper1_acc_count <b>- </b></font><font color="#FF0000">1
          </font><b>if </b><font color="#000080">_stepper1_acc_count <b>== </b></font><font color="#FF0000">0 </font><b>then
            if </b><font color="#000080">_stepper1_not_decelerating </font><b>then
              </b><font color="#000080">_stepper1_acc_index <b>= </b>_stepper1_acc_index <b>+ </b></font><font color="#FF0000">1
              </font><b>if </b><font color="#000080">_stepper1_acc_index <b>&gt; </b>_stepper_max_speed_index </font><b>then
                </b><font color="#000080">_stepper1_acc_index <b>= </b>_stepper_max_speed_index
              </font><b>end if
            else
              </b><font color="#000080">_stepper1_acc_index <b>= </b>_stepper1_acc_index <b>- </b></font><font color="#FF0000">1
              </font><b>if </b><font color="#000080">_stepper1_acc_index_msb </font><b>then
                </b><font color="#000080">_stepper1_acc_index <b>= </b></font><font color="#FF0000">0
                </font><font color="#000080">stepper1_status <b>= </b>_stepper_status_stopped
              </font><b>end if
            end if
            </b><font color="#000080">stepper_acc1 <b>(</b>_stepper1_acc_index<b>,</b>_stepper1_period_preset<b>)
            </b>stepper_acc1N <b>(</b>_stepper1_acc_index<b>,</b>_stepper1_acc_count<b>)
          </b></font><b>end if
        end if

        </b><font color="#808080"><i>;reload the counter for this loop
        </i></font><font color="#000080">_stepper1_period <b>= </b>_stepper1_period_preset

        </font><font color="#808080"><i>;now get value for next step and send to port
        </i></font><b>if </b><font color="#000080">stepper1_forward </font><b>then </b><font color="#000080">_stepper1_step_forward
        </font><b>else </b><font color="#000080">_stepper1_step_backward
        </font><b>end if

        </b><font color="#808080"><i>;get table value, output to port
        </i></font><font color="#000080">_get_stepper_value <b>( </b>_stepper1_index<b>, </b>value <b>)
        </b>_stepper1_port <b>= </b>value
      </font><b>end if
    end if
  end if

  if </b><font color="#000080">stepper_Nmotors <b>== </b></font><font color="#FF0000">2 </font><b>then  </b><font color="#808080"><i>-- compiler directive !!
  ;if motor is running
  </i></font><b>if </b><font color="#000080">stepper2_status <b>!= </b>_stepper_status_stopped </font><b>then
    if </b><font color="#000080">_stepper2_period <b>!= </b></font><font color="#FF0000">0 </font><b>then </b><font color="#000080">_stepper2_period <b>= </b>_stepper2_period <b>- </b></font><font color="#FF0000">1 </font><b>end if

    </b><font color="#808080"><i>;if motor puls finished
    </i></font><b>if </b><font color="#000080">_stepper2_period <b>== </b></font><font color="#FF0000">0 </font><b>then

      </b><font color="#808080"><i>;as long as position not reached or running continuous
      </i></font><b>if </b><font color="#000080"><b>(! </b>_stepper2_cmp_pos<b>) |
         (</b>stepper2_status <b>== </b>_stepper_status_continuous<b>) </b></font><b>then

         if </b><font color="#000080">stepper2_accelerate_on </font><b>then
           </b><font color="#000080">_stepper2_acc_count <b>= </b>_stepper2_acc_count <b>- </b></font><font color="#FF0000">1
           </font><b>if </b><font color="#000080">_stepper2_acc_count <b>== </b></font><font color="#FF0000">0 </font><b>then
             if </b><font color="#000080">_stepper2_not_decelerating </font><b>then
               </b><font color="#000080">_stepper2_acc_index <b>= </b>_stepper2_acc_index <b>+ </b></font><font color="#FF0000">1
               </font><b>if </b><font color="#000080">_stepper2_acc_index <b>&gt; </b>_stepper_max_speed_index </font><b>then
                 </b><font color="#000080">_stepper2_acc_index <b>= </b>_stepper_max_speed_index
               </font><b>end if
             else
               </b><font color="#000080">_stepper2_acc_index <b>= </b>_stepper2_acc_index <b>- </b></font><font color="#FF0000">1
               </font><b>if </b><font color="#000080">_stepper2_acc_index_msb </font><b>then
                 </b><font color="#000080">_stepper2_acc_index <b>= </b></font><font color="#FF0000">0
                 </font><font color="#000080">stepper2_status <b>= </b>_stepper_status_stopped
               </font><b>end if
             end if
             </b><font color="#000080">stepper_acc1 <b>(</b>_stepper2_acc_index<b>,</b>_stepper2_period_preset<b>)
             </b>stepper_acc1N <b>(</b>_stepper2_acc_index<b>,</b>_stepper2_acc_count<b>)
           </b></font><b>end if
         end if

        </b><font color="#808080"><i>;reload the counter for this loop
        </i></font><font color="#000080">_stepper2_period <b>= </b>_stepper2_period_preset

        </font><font color="#808080"><i>;now get value for next step and send to port
        </i></font><b>if </b><font color="#000080">stepper2_forward </font><b>then </b><font color="#000080">_stepper2_step_forward
        </font><b>else </b><font color="#000080">_stepper2_step_backward
        </font><b>end if

        </b><font color="#808080"><i>;get table value, output to port
        </i></font><font color="#000080">_get_stepper_value <b>( </b>_stepper2_index<b>, </b>value <b>)
        </b>_stepper2_port <b>= </b>value
      </font><b>end if
    end if
  end if
  end if

  </b><font color="#808080"><i>-- must be the last statement, to prevent reentrance
  </i></font><font color="#000080">T0IF <b>= </b></font><font color="#FF0000">false        </font><font color="#808080"><i>-- clear TMR0 interrupt flag
</i></font><b>end procedure
</b><font color="#808080"><i>-- -----------------------------------------------------------------------------



-- ---------------------------------------------------------------------
-- sets motor to run continuously in the current speed and direction,
-- without any acceleration
-- ---------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">stepper_run_continuous 
  <b>(</b></font><b>byte in </b><font color="#000080">motor_nr <b>= </b></font><font color="#FF0000">1</font><font color="#000080"><b>) </b></font><b>is
  if </b><font color="#000080">motor_nr <b>== </b></font><font color="#FF0000">1 </font><b>then
    </b><font color="#000080">stepper1_accelerate_on <b>= </b></font><font color="#FF0000">false
    </font><font color="#000080">stepper1_status <b>= </b>_stepper_status_continuous
  </font><b>else
    </b><font color="#000080">stepper2_accelerate_on <b>= </b></font><font color="#FF0000">false
    </font><font color="#000080">stepper2_status <b>= </b>_stepper_status_continuous
  </font><b>end if
end procedure
</b><font color="#808080"><i>-- ---------------------------------------------------------------------



-- ---------------------------------------------------------------------
-- sets motor to run continuously, with smooth start in the current direction
-- motor is supposed to be initial not running
-- ---------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">stepper_run_continuous_smooth 
  <b>(</b></font><b>byte in </b><font color="#000080">motor_nr <b>= </b></font><font color="#FF0000">1</font><font color="#000080"><b>) </b></font><b>is
  
  if </b><font color="#000080">motor_nr <b>== </b></font><font color="#FF0000">1 </font><b>then
    </b><font color="#000080">stepper1_accelerate_on <b>= </b></font><font color="#FF0000">true
    </font><font color="#000080">_stepper1_not_decelerating <b>= </b></font><font color="#FF0000">true
    </font><font color="#000080">_stepper1_acc_index <b>= </b></font><font color="#FF0000">0
    </font><font color="#000080">stepper_acc1 <b>(</b>_stepper1_acc_index<b>,</b>_stepper1_period_preset<b>)
    </b>stepper_acc1N <b>(</b>_stepper1_acc_index<b>,</b>_stepper1_acc_count<b>)
    </b>stepper1_status <b>= </b>_stepper_status_continuous
  </font><b>else
    </b><font color="#000080">stepper2_accelerate_on <b>= </b></font><font color="#FF0000">true
    </font><font color="#000080">_stepper2_not_decelerating <b>= </b></font><font color="#FF0000">true
    </font><font color="#000080">_stepper2_acc_index <b>= </b></font><font color="#FF0000">0
    </font><font color="#000080">stepper_acc1 <b>(</b>_stepper2_acc_index<b>,</b>_stepper2_period_preset<b>)
    </b>stepper_acc1N <b>(</b>_stepper2_acc_index<b>,</b>_stepper2_acc_count<b>)
    </b>stepper2_status <b>= </b>_stepper_status_continuous
  </font><b>end if
end procedure
</b><font color="#808080"><i>-- ---------------------------------------------------------------------



-- ---------------------------------------------------------------------
-- Runs motor to the specified target position,
-- using the current direction, speed and accereration settings
-- This routine can also be called as a macro,
-- allowing to use large integer values
--     stepper_run_into  1,23300
-- ---------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">stepper_run_into 
  <b>(</b></font><b>byte in </b><font color="#000080">motor_nr <b>= </b></font><font color="#FF0000">1</font><font color="#000080"><b>,
                       </b></font><b>byte in </b><font color="#000080">target_pos1 <b>= </b></font><font color="#FF0000">0</font><font color="#000080"><b>,
                       </b></font><b>byte in </b><font color="#000080">target_pos2 <b>= </b></font><font color="#FF0000">0</font><font color="#000080"><b>,
                       </b></font><b>byte in </b><font color="#000080">target_pos3 <b>= </b></font><font color="#FF0000">0</font><font color="#000080"><b>,
                       </b></font><b>byte in </b><font color="#000080">target_pos4 <b>= </b></font><font color="#FF0000">0</font><font color="#000080"><b>) </b></font><b>is
  if </b><font color="#000080">motor_nr <b>== </b></font><font color="#FF0000">1 </font><b>then
    </b><font color="#000080">stepper1_status <b>= </b>_stepper_status_running
    </font><font color="#808080"><i>-- it's not necessary to disable interrupts here !!
    </i></font><font color="#000080"><b>&lt;</b></font><font color="#800080"><i>mac</i></font><font color="#000080"><b>&gt; </b>byte4_assign _stepper1_target_pos <b>= </b>target_pos
  </font><b>else
    </b><font color="#000080">stepper2_status <b>= </b>_stepper_status_running
    </font><font color="#808080"><i>-- it's not necessary to disable interrupts here !!
    </i></font><font color="#000080"><b>&lt;</b></font><font color="#800080"><i>mac</i></font><font color="#000080"><b>&gt; </b>byte4_assign _stepper2_target_pos <b>= </b>target_pos
  </font><b>end if
end procedure
</b><font color="#808080"><i>-- ---------------------------------------------------------------------



-- ---------------------------------------------------------------------
-- Runs motor for the specified HALF-STEPS !!
-- using the current direction, speed and accereration settings
-- If motor is running, the specified steps will be added to the target position
-- This routine can also be called as a macro,
-- allowing to use large integer values
--     stepper_do_steps  1,23300
-- ---------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">stepper_do_steps 
  <b>(</b></font><b>byte in </b><font color="#000080">motor_nr <b>= </b></font><font color="#FF0000">1</font><font color="#000080"><b>,
                       </b></font><b>byte in </b><font color="#000080">n_steps1 <b>= </b></font><font color="#FF0000">0</font><font color="#000080"><b>,
                       </b></font><b>byte in </b><font color="#000080">n_steps2 <b>= </b></font><font color="#FF0000">0</font><font color="#000080"><b>,
                       </b></font><b>byte in </b><font color="#000080">n_steps3 <b>= </b></font><font color="#FF0000">0</font><font color="#000080"><b>,
                       </b></font><b>byte in </b><font color="#000080">n_steps4 <b>= </b></font><font color="#FF0000">0</font><font color="#000080"><b>) </b></font><b>is
  </b><font color="#808080"><i>-- interrupts must be disabled, because target-position is changes
  </i></font><font color="#000080">T0IE <b>= </b></font><font color="#FF0000">false
  </font><b>if </b><font color="#000080">motor_nr <b>== </b></font><font color="#FF0000">1 </font><b>then
    if </b><font color="#000080">stepper1_forward </font><b>then
      </b><font color="#000080"><b>&lt;</b></font><font color="#800080"><i>mac</i></font><font color="#000080"><b>&gt; </b>byte4_add  _stepper1_target_pos <b>= </b>_stepper1_target_pos <b>, </b>n_steps
    </font><b>else
      </b><font color="#000080"><b>&lt;</b></font><font color="#800080"><i>mac</i></font><font color="#000080"><b>&gt; </b>byte4_sub  _stepper1_target_pos <b>= </b>_stepper1_target_pos <b>, </b>n_steps
    </font><b>end if
    </b><font color="#000080">stepper1_status <b>= </b>_stepper_status_running
  </font><b>else
    if </b><font color="#000080">stepper2_forward </font><b>then
      </b><font color="#000080"><b>&lt;</b></font><font color="#800080"><i>mac</i></font><font color="#000080"><b>&gt; </b>byte4_add  _stepper2_target_pos <b>= </b>_stepper2_target_pos <b>, </b>n_steps
    </font><b>else
      </b><font color="#000080"><b>&lt;</b></font><font color="#800080"><i>mac</i></font><font color="#000080"><b>&gt; </b>byte4_sub  _stepper2_target_pos <b>= </b>_stepper2_target_pos <b>, </b>n_steps
    </font><b>end if
    </b><font color="#000080">stepper2_status <b>= </b>_stepper_status_running
  </font><b>end if
  </b><font color="#808080"><i>-- enable interrupts again
  </i></font><font color="#000080">T0IE <b>= </b></font><font color="#FF0000">true
</font><b>end procedure
</b><font color="#808080"><i>-- ---------------------------------------------------------------------



-- ---------------------------------------------------------------------
-- internal routine used by stop and null
-- stops the motor (sets also stopped mode)
-- if NULL, defines current-position as NULL
-- sets target-position to current-position
-- ---------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">_stepper_stop_null 
  <b>(</b></font><b>byte in </b><font color="#000080">motor_nr<b>, </b></font><b>bit in </b><font color="#000080">null<b>) </b></font><b>is
  if </b><font color="#000080">motor_nr <b>== </b></font><font color="#FF0000">1 </font><b>then
    </b><font color="#000080">stepper1_status <b>= </b>_stepper_status_stopped

    </font><font color="#808080"><i>-- at this point interrupts have or will see the stop status and will do nothing
    -- so it's save to change the target-position

    -- define current position as NULLpoint
    </i></font><b>if </b><font color="#000080">null </font><b>then
      </b><font color="#000080"><b>&lt;</b></font><font color="#800080"><i>mac</i></font><font color="#000080"><b>&gt; </b>byte4_assign   stepper1_pos <b>= </b></font><font color="#FF0000">0
    </font><b>end if

    </b><font color="#808080"><i>-- set target-position to current-position
    </i></font><font color="#000080"><b>&lt;</b></font><font color="#800080"><i>mac</i></font><font color="#000080"><b>&gt; </b>byte4_assign   _stepper1_target_pos <b>= </b>stepper1_pos

  </font><b>else
    </b><font color="#000080">stepper2_status <b>= </b>_stepper_status_stopped

    </font><font color="#808080"><i>-- define current position as NULLpoint
    </i></font><b>if </b><font color="#000080">null </font><b>then
      </b><font color="#000080"><b>&lt;</b></font><font color="#800080"><i>mac</i></font><font color="#000080"><b>&gt; </b>byte4_assign   stepper2_pos <b>= </b></font><font color="#FF0000">0
    </font><b>end if

    </b><font color="#808080"><i>-- set target-position to current-position
    </i></font><font color="#000080"><b>&lt;</b></font><font color="#800080"><i>mac</i></font><font color="#000080"><b>&gt; </b>byte4_assign   _stepper2_target_pos <b>= </b>stepper2_pos

  </font><b>end if
end procedure
</b><font color="#808080"><i>-- ---------------------------------------------------------------------



-- ---------------------------------------------------------------------
-- stops motor directly
-- sets motor status to stopped
-- sets position target=current
-- ---------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">stepper_stop 
  <b>(</b></font><b>byte in </b><font color="#000080">motor_nr <b>= </b></font><font color="#FF0000">1</font><font color="#000080"><b>) </b></font><b>is
  </b><font color="#000080">_stepper_stop_null <b>(</b>motor_nr<b>, </b></font><font color="#FF0000">false</font><font color="#000080"><b>)
</b></font><b>end procedure
</b><font color="#808080"><i>-- ---------------------------------------------------------------------



-- ---------------------------------------------------------------------
-- stops motor smoothly
-- ---------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">stepper_stop_smooth 
  <b>(</b></font><b>byte in </b><font color="#000080">motor_nr <b>= </b></font><font color="#FF0000">1</font><font color="#000080"><b>) </b></font><b>is
  </b><font color="#000080">T0IE <b>= </b></font><font color="#FF0000">false  </font><font color="#808080"><i>; disable interrupts
  </i></font><b>if </b><font color="#000080">motor_nr <b>== </b></font><font color="#FF0000">1 </font><b>then
    </b><font color="#000080">stepper1_accelerate_on <b>= </b></font><font color="#FF0000">true
    </font><font color="#000080">_stepper1_acc_count <b>= </b></font><font color="#FF0000">1
    </font><font color="#000080">_stepper1_not_decelerating <b>= </b></font><font color="#FF0000">false
  </font><b>else
    </b><font color="#000080">stepper2_accelerate_on <b>= </b></font><font color="#FF0000">true
    </font><font color="#000080">_stepper2_acc_count <b>= </b></font><font color="#FF0000">1
    </font><font color="#000080">_stepper2_not_decelerating <b>= </b></font><font color="#FF0000">false
  </font><b>end if
  </b><font color="#000080">T0IE <b>= </b></font><font color="#FF0000">true  </font><font color="#808080"><i>; enable interrupts
</i></font><b>end procedure
</b><font color="#808080"><i>-- ---------------------------------------------------------------------



-- ---------------------------------------------------------------------
-- stops motor directly and nulls position
-- sets motor status to stopped
-- sets position current=0
-- sets position target=current
-- ---------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">stepper_set_null 
  <b>(</b></font><b>byte in </b><font color="#000080">motor_nr <b>= </b></font><font color="#FF0000">1</font><font color="#000080"><b>) </b></font><b>is
  </b><font color="#000080">_stepper_stop_null <b>(</b>motor_nr<b>, </b></font><font color="#FF0000">true</font><font color="#000080"><b>)
</b></font><b>end procedure
</b><font color="#808080"><i>-- ---------------------------------------------------------------------



-- ---------------------------------------------------------------------
-- initializes all stepper motors
-- this procedure is automatic called by the include of this library
-- and should rarely be called be the user
-- ---------------------------------------------------------------------
</i></font><b>procedure </b><font color="#000080">stepper_init </font><b>is
var byte </b><font color="#000080">value

  stepper1_status <b>= </b>_stepper_status_stopped
  stepper_set_null <b>(</b></font><font color="#FF0000">1</font><font color="#000080"><b>)

  </b>stepper1_full_steps <b>= </b></font><font color="#FF0000">true
  </font><font color="#000080">stepper1_forward <b>= </b></font><font color="#FF0000">true
  </font><font color="#000080">stepper1_full_force_2_winding <b>= </b></font><font color="#FF0000">false
  </font><font color="#000080">stepper1_full_force_1_winding <b>= </b></font><font color="#FF0000">true

  </font><font color="#000080">stepper1_accelerate_on <b>= </b></font><font color="#FF0000">false
  </font><font color="#000080">_stepper1_index <b>= </b></font><font color="#FF0000">0
  </font><font color="#000080">_stepper1_not_decelerating <b>= </b></font><font color="#FF0000">true

  </font><font color="#808080"><i>-- get table value, output to port
  </i></font><font color="#000080">_get_stepper_value <b>( </b>_stepper1_index<b>, </b>value <b>)
  </b>_stepper1_port_dir <b>= </b></font><font color="#FF0000">all_output
  </font><font color="#000080">_stepper1_port <b>= </b>value
  
  </font><b>if </b><font color="#000080">stepper_Nmotors <b>== </b></font><font color="#FF0000">2 </font><b>then  </b><font color="#808080"><i>-- compiler directive !!
    </i></font><font color="#000080">stepper2_status <b>= </b>_stepper_status_stopped
    stepper_set_null <b>(</b></font><font color="#FF0000">2</font><font color="#000080"><b>)

    </b>stepper2_full_steps <b>= </b></font><font color="#FF0000">true
    </font><font color="#000080">stepper2_forward <b>= </b></font><font color="#FF0000">true
    </font><font color="#000080">stepper2_full_force_2_winding <b>= </b></font><font color="#FF0000">false
    </font><font color="#000080">stepper2_full_force_1_winding <b>= </b></font><font color="#FF0000">true

    </font><font color="#000080">stepper2_accelerate_on <b>= </b></font><font color="#FF0000">false
    </font><font color="#000080">_stepper2_index <b>= </b></font><font color="#FF0000">0
    </font><font color="#000080">_stepper2_not_decelerating <b>= </b></font><font color="#FF0000">true

    </font><font color="#808080"><i>-- get table value, output to port
    </i></font><font color="#000080">_get_stepper_value <b>( </b>_stepper2_index<b>, </b>value <b>)
    </b>_stepper2_port_dir <b>= </b></font><font color="#FF0000">all_output
    </font><font color="#000080">_stepper2_port <b>= </b>value

  </font><b>end if

  </b><font color="#808080"><i>-- intialize TMR0 prescaler
  </i></font><font color="#000080">OPTION_REG <b>= ( </b>OPTION_REG <b>&amp; ! ( </b></font><font color="#FF0000">_b_T0CS </font><font color="#000080"><b>))   </b></font><font color="#808080"><i>-- set TMR0 to main oscillator
  </i></font><font color="#000080">OPTION_REG <b>= ( </b>OPTION_REG <b>&amp; ! ( </b></font><font color="#FF0000">_b_PSA </font><font color="#000080"><b>))    </b></font><font color="#808080"><i>-- enable prescaler for TMR0
  </i></font><font color="#000080">OPTION_REG <b>= ( </b>OPTION_REG <b>&amp; </b></font><font color="#FF0000">0xF8 </font><font color="#000080"><b>) | </b></font><font color="#FF0000">0x06    </font><font color="#808080"><i>-- set prescaler to 6 = 1:128
  -- in that case a timer value of -39 will give 0.9984 msec

  -- enable interrupts
  </i></font><font color="#000080">T0IE <b>= </b></font><font color="#FF0000">true   </font><font color="#808080"><i>-- enable TMR0 interrupt
  </i></font><font color="#000080">GIE  <b>= </b></font><font color="#FF0000">true   </font><font color="#808080"><i>-- enable general interrupts
  </i></font><font color="#000080">T0IF <b>= </b></font><font color="#FF0000">false  </font><font color="#808080"><i>-- clear TMR0 interrupt flag
</i></font><b>end procedure
</b><font color="#808080"><i>-- ---------------------------------------------------------------------



-- ---------------------------------------------------------------------
-- perform the stepper intialisation
-- ---------------------------------------------------------------------
</i></font><font color="#000080">stepper_init




</font></font>
</code></pre>
</body>
</html>
